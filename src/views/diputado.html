<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panel Diputado - Sistema de Votación</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/apple-theme.css">
    <link rel="stylesheet" href="/css/dark-theme.css">
    <script src="/js/theme-loader.js"></script>
    <style>
        body {
            background-color: var(--bg-primary);
            /* Prevenir zoom con pinch */
            touch-action: pan-x pan-y;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Permitir zoom solo en visualizador de PDF */
        .pdf-viewer, .pdf-container, iframe[src*="documentos-sesion"] {
            touch-action: auto !important;
            -webkit-user-select: text !important;
            user-select: text !important;
        }
        .navbar {
            background: var(--navbar-bg) !important;
            border-bottom: 1px solid var(--border-color);
        }
        
        /* Header del diputado */
        .deputy-header {
            background: var(--bg-card);
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            padding: 25px;
            margin: 20px auto;
            max-width: 900px;
            border-left: 5px solid var(--color-primary);
            transition: all 0.3s;
        }
        
        .deputy-info {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
        }
        
        .deputy-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            font-weight: bold;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }
        
        .deputy-details {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .deputy-text-info {
            flex: 1;
        }
        
        .deputy-name {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .deputy-cargo {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }
        
        .deputy-commission {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .deputy-party {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .party-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            background-color: #6c757d;
        }
        
        .party-logo {
            height: 30px;
            max-width: 60px;
            object-fit: contain;
        }
        
        /* Contenedor de votación */
        .vote-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .vote-card {
            background: var(--bg-card);
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            padding: 30px;
            margin-top: 20px;
            position: relative;
        }
        
        /* Botones de votación mejorados */
        .vote-btn {
            width: 100%;
            height: 100px;
            position: relative;
            font-size: 26px;
            font-weight: bold;
            margin: 15px 0;
            border: 3px solid transparent;
            border-radius: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        /* Botones de asistencia */
        .attendance-btn {
            width: 100%;
            height: 100px;
            position: relative;
            font-size: 26px;
            font-weight: bold;
            margin: 15px 0;
            border: 3px solid transparent;
            border-radius: 15px;
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            color: white;
        }
        
        .attendance-btn.btn-presente {
            background: linear-gradient(135deg, #28A745 0%, #20c997 100%);
            border-color: #28A745;
        }
        
        .attendance-btn.btn-presente:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #20c997 0%, #28A745 100%);
        }
        
        .attendance-btn.btn-presente:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .attendance-btn.btn-ausente {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border-color: #6c757d;
        }
        
        .attendance-btn.btn-ausente:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(108, 117, 125, 0.4);
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
        }
        
        .attendance-btn.btn-ausente:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }
        
        .attendance-btn i {
            font-size: 35px;
        }
        
        .attendance-btn.selected {
            box-shadow: 0 0 0 5px rgba(0, 123, 255, 0.5);
            animation: pulse 1.5s infinite;
        }
        
        .vote-btn i {
            font-size: 32px;
        }
        
        .vote-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .vote-btn.selected {
            border-color: #333;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
            animation: selectedPulse 2s infinite;
        }
        
        @keyframes selectedPulse {
            0% { box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.8); }
            50% { box-shadow: 0 0 0 8px rgba(255, 255, 255, 0.4); }
            100% { box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.8); }
        }
        
        .btn-favor {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }
        
        .btn-favor:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
        }
        
        .btn-contra {
            background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
            color: white;
        }
        
        .btn-contra:hover {
            background: linear-gradient(135deg, #bd2130 0%, #a71d2a 100%);
        }
        
        .btn-abstencion {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            color: white;
        }
        
        .btn-abstencion:hover {
            background: linear-gradient(135deg, #545b62 0%, #383d42 100%);
        }
        
        /* Estado sin votación */
        .no-voting {
            text-align: center;
            padding: 80px 20px;
            color: #6c757d;
        }
        
        .no-voting i {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        /* Badge de votado */
        .voted-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .pulse-animation {
            animation: pulse 1s ease-in-out 3;
            border: 3px solid #ffc107 !important;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.5) !important;
        }
        
        /* Botón EN VIVO flotante */
        .live-button-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1050;
        }
        
        .btn-live {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-live:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.5);
        }
        
        .btn-live .live-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }
        
        /* Contenedor del stream */
        .stream-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 450px;
            max-width: 90vw;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1040;
            display: none;
            overflow: hidden;
        }
        
        .stream-header {
            background: linear-gradient(135deg, #212529, #343a40);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stream-header .live-badge {
            background: #dc3545;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stream-header .live-badge .live-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        
        .stream-video {
            width: 100%;
            height: auto;
            background: black;
        }
        
        .stream-controls {
            background: #f8f9fa;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        .stream-controls .btn-group-sm .btn {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .viewer-count {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #6c757d;
            font-size: 14px;
        }
        
        /* Modo pantalla completa */
        .stream-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            max-width: 100%;
            border-radius: 0;
            z-index: 9999;
        }
        
        .stream-container.fullscreen .stream-video {
            height: calc(100vh - 100px);
        }
        
        /* Responsive para móviles */
        @media (max-width: 767px) {
            .navbar-collapse {
                background-color: rgba(0, 0, 0, 0.1);
                padding: 1rem;
                margin-top: 1rem;
                border-radius: 8px;
            }
            
            .navbar-nav {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            .navbar-nav > span {
                margin-bottom: 0.5rem;
            }
            
            /* Fix para mesa directiva */
            .president-controls {
                position: relative;
                z-index: 1;
            }
            
            .navbar-toggler {
                z-index: 2000 !important;
                position: relative !important;
                pointer-events: auto !important;
                cursor: pointer !important;
                border: 1px solid rgba(255,255,255,0.5) !important;
                padding: 0.25rem 0.5rem !important;
                background-color: transparent !important;
                transition: all 0.3s ease !important;
            }
            
            .navbar-toggler:hover {
                background-color: rgba(255,255,255,0.1) !important;
                border-color: rgba(255,255,255,0.8) !important;
            }
            
            .navbar-toggler:focus {
                box-shadow: 0 0 0 0.25rem rgba(255,255,255,0.25) !important;
                outline: none !important;
            }
            
            #navbarContent {
                z-index: 1099;
                background-color: inherit;
            }
            
            #navbarContent.show {
                display: block !important;
            }
            
            /* Asegurar que el botón sea clickeable */
            .navbar-toggler-icon {
                pointer-events: none;
                display: inline-block;
                width: 1.5em;
                height: 1.5em;
                vertical-align: middle;
                background-repeat: no-repeat;
                background-position: center;
                background-size: 100%;
            }
            
            /* Fix específico para mesa directiva */
            .navbar.navbar-expand-lg .navbar-toggler {
                display: none !important;
            }
            
            @media (max-width: 991.98px) {
                .navbar.navbar-expand-lg .navbar-toggler {
                    display: inline-block !important;
                }
                
                .navbar-collapse {
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                    padding: 1rem;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                }
            }
        }
        
        /* Responsive para tablets */
        @media (min-width: 768px) and (max-width: 1024px) {
            .vote-btn {
                height: 120px;
                font-size: 28px;
            }
            
            .vote-btn i {
                font-size: 36px;
            }
            
            .deputy-avatar {
                width: 90px;
                height: 90px;
                font-size: 32px;
            }
        }
        
        /* Timer de sesión */
        #sessionTimer {
            font-weight: bold;
            padding: 5px 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
        }
        
        /* Botón flotante discreto para PDF */
        .floating-pdf-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #dc3545);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        .floating-pdf-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.5);
        }
        
        .floating-pdf-btn.active {
            display: flex;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3); }
            50% { box-shadow: 0 4px 25px rgba(220, 53, 69, 0.6); }
            100% { box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3); }
        }
        
        .congress-logos {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-right: 10px;
        }
        
        .congress-logos img {
            height: 100px;
            object-fit: contain;
        }
        
        .secretary-menu {
            margin-top: 15px;
            width: 100%;
        }
        
        .secretary-menu .btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            font-size: 1em;
        }
        
        .secretary-menu .btn:hover {
            background: linear-gradient(135deg, #0056b3 0%, #003d82 100%);
        }
        
        .secretary-menu .dropdown-menu {
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 100%;
        }
        
        .secretary-menu .dropdown-item {
            color: #333;
            padding: 10px 20px;
        }
        
        .secretary-menu .dropdown-item:hover {
            background: #f0f0f0;
            color: #007bff;
        }
        
        .secretary-menu .dropdown-item i {
            margin-right: 8px;
            color: #007bff;
        }
        
        /* Notificación de resultado de votación */
        .result-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            max-width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideIn 0.5s ease-out;
            border-left: 5px solid #007bff;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .result-notification .notification-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-notification .notification-body {
            padding: 20px;
        }
        
        .result-notification .result-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        
        .result-notification .stat-item {
            text-align: center;
        }
        
        .result-notification .stat-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 20px;
            font-weight: bold;
            color: white;
        }
        
        .result-notification .stat-circle.favor { background: #28A745; }
        .result-notification .stat-circle.contra { background: #DC3545; }
        .result-notification .stat-circle.abstencion { background: #FFC107; }
        
        .result-notification .countdown-bar {
            height: 4px;
            background: #e0e0e0;
            position: relative;
            margin-top: 10px;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .result-notification .countdown-progress {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            animation: countdown 10s linear forwards;
        }
        
        @keyframes countdown {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        /* Menú hamburguesa */
        .menu-button {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1050;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .menu-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .side-menu {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.1);
            transition: right 0.3s ease-out;
            z-index: 1049;
            overflow-y: auto;
        }
        
        .side-menu.active {
            right: 0;
        }
        
        .side-menu-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .side-menu-content {
            padding: 20px;
        }
        
        .menu-item {
            display: block;
            padding: 15px;
            color: #333;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .menu-item:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }
        
        .menu-item i {
            font-size: 20px;
            width: 30px;
            text-align: center;
            color: #007bff;
        }
        
        /* Overlay para el menú */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1048;
            display: none;
        }
        
        .menu-overlay.active {
            display: block;
        }
        
    </style>
</head>
<body>
    <!-- Botón de menú hamburguesa -->
    <button class="menu-button" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Overlay del menú -->
    <div class="menu-overlay" onclick="toggleMenu()"></div>
    
    <!-- Menú lateral -->
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h5 class="mb-0">Opciones</h5>
            <button class="btn btn-sm btn-light" onclick="toggleMenu()" style="position: absolute; right: 20px;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="side-menu-content">
            <!-- Panel de Control del Presidente -->
            <div id="panelPresidente" style="display: none;">
                <h6 class="text-primary mb-3"><i class="fas fa-crown"></i> Panel de Control - Presidente</h6>
                <a href="#" class="menu-item" onclick="verIniciativasCargadas()">
                    <i class="fas fa-list"></i>
                    <div>
                        <div>Ver Iniciativas Cargadas</div>
                        <small class="text-muted">Consultar orden del día</small>
                    </div>
                </a>
                <!-- Removido enlace a Servicios Legislativos -->
                    <div>
                        <div>Servicios Legislativos</div>
                        <small class="text-muted">Cargar orden del día</small>
                    </div>
                </a>
                <a href="#" class="menu-item" onclick="verDiputadosPresentes()">
                    <i class="fas fa-users"></i>
                    <div>
                        <div>Diputados Presentes</div>
                        <small class="text-muted">Ver quórum actual</small>
                    </div>
                </a>
                <hr>
            </div>
            
            <!-- Panel de Control del Secretario -->
            <div id="panelSecretario" style="display: none;">
                <h6 class="text-warning mb-3"><i class="fas fa-user-tie"></i> Panel de Control - Secretario</h6>
                <a href="#" class="menu-item" onclick="abrirPaseLista()">
                    <i class="fas fa-user-check"></i>
                    <div>
                        <div>Pase de Lista</div>
                        <small class="text-muted">Realizar toma de asistencia</small>
                    </div>
                </a>
                <a href="#" class="menu-item" onclick="verEstadoAsistencia()">
                    <i class="fas fa-chart-pie"></i>
                    <div>
                        <div>Ver Estado del Sistema</div>
                        <small class="text-muted">Estado actual de asistencia y sesión</small>
                    </div>
                </a>
                <a href="#" class="menu-item" onclick="backToVoting()">
                    <i class="fas fa-vote-yea"></i>
                    <div>
                        <div>Regresar a Votación</div>
                        <small class="text-muted">Volver al panel de votación</small>
                    </div>
                </a>
                <hr>
            </div>
            
            <a href="#" class="menu-item" onclick="verTableroSimplificado()">
                <i class="fas fa-th"></i>
                <div>
                    <div>Ver Tablero de Votación</div>
                    <small class="text-muted">Vista simplificada del tablero</small>
                </div>
            </a>
            <a href="#" class="menu-item" onclick="consultarOrdenDelDia()">
                <i class="fas fa-file-pdf"></i>
                <div>
                    <div>Orden del Día</div>
                    <small class="text-muted">Consultar documento de la sesión</small>
                </div>
            </a>
            <a href="#" class="menu-item" onclick="abrirConfiguracion()">
                <i class="fas fa-cog"></i>
                <div>
                    <div>Configuración</div>
                    <small class="text-muted">Mis datos personales</small>
                </div>
            </a>
        </div>
    </div>
    
    <nav class="navbar navbar-dark navbar-expand-lg">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-user"></i> Panel de Votación - Diputado
            </span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" 
                    aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <div class="navbar-nav ms-auto d-flex align-items-center">
                    <span class="text-white me-3">
                        <i class="fas fa-clock"></i> <span id="currentTime">00:00:00</span>
                    </span>
                    <span class="text-white me-3" id="sessionTimerContainer" style="display: none;">
                        <i class="fas fa-hourglass-half"></i> Sesión: <span id="sessionTimer">00:00:00</span>
                    </span>
                        <span class="text-white me-3" id="coordinatorInfo" style="display: none;">
                        <span style="font-size: 0.9em; opacity: 0.8;">Coordinador:</span>
                        <img id="coordinatorPartyLogo" src="" alt="" style="height: 20px; margin: 0 5px; display: none;">
                        <span id="coordinatorName" style="font-weight: 500;"></span>
                    </span>
                    <button id="btnConsultarSesionMenu" class="btn btn-outline-warning btn-sm me-2" style="display: none;" onclick="consultarDocumentoOriginal()">
                        <i class="fas fa-file-pdf"></i> Consultar Sesión
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Indicador de Estado de Asistencia -->
    <div id="asistenciaStatus" class="alert m-3" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i id="iconoAsistencia" class="fas fa-user-check"></i> 
                <strong>Estado de Asistencia:</strong> 
                <span id="estadoAsistenciaTexto">No registrado</span>
            </div>
            <div id="mensajeAsistencia" class="text-muted small">
                <!-- Mensaje dinámico según estado -->
            </div>
        </div>
    </div>

    <!-- Botón EN VIVO flotante -->
    <div class="live-button-container" id="liveButtonContainer" style="display: none;">
        <button class="btn-live" onclick="toggleLiveStream()">
            <span class="live-dot"></span>
            <span>EN VIVO</span>
        </button>
    </div>
    
    <!-- Botón flotante para consultar PDF -->
    <button class="floating-pdf-btn" id="floatingPdfBtn" onclick="consultarDocumentoOriginal()" title="Ver documento PDF de la sesión">
        <i class="fas fa-file-pdf fa-lg"></i>
    </button>

    <!-- Contenedor del Stream -->
    <div class="stream-container" id="streamContainer">
        <div class="stream-header">
            <div class="d-flex align-items-center gap-2">
                <span class="live-badge">
                    <span class="live-dot"></span>
                    EN VIVO
                </span>
                <span>Transmisión del Pleno</span>
            </div>
            <button class="btn-close btn-close-white" onclick="closeLiveStream()"></button>
        </div>
        <video id="remoteVideo" class="stream-video" autoplay playsinline muted controls></video>
        <div class="stream-controls">
            <div class="viewer-count">
                <i class="fas fa-eye"></i>
                <span id="viewerCount">0</span> viendo
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="togglePiP()" title="Picture in Picture">
                    <i class="fas fa-external-link-alt"></i>
                </button>
                <button class="btn btn-outline-secondary" onclick="toggleFullscreen()" title="Pantalla Completa">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="btn btn-outline-secondary" onclick="toggleMinimal()" title="Modo Minimal">
                    <i class="fas fa-compress"></i>
                </button>
            </div>
            <select class="form-select form-select-sm" style="width: auto;" onchange="changeQuality(this.value)">
                <option value="high">Alta (720p)</option>
                <option value="medium" selected>Media (480p)</option>
                <option value="low">Baja (360p)</option>
            </select>
        </div>
    </div>

    <div class="container vote-container">
        <!-- Header del diputado mejorado -->
        <div class="deputy-header" id="deputyHeader">
            <div class="deputy-info">
                <div class="deputy-avatar" id="deputyAvatar">
                    <!-- Se llenará dinámicamente -->
                </div>
                <div class="deputy-details">
                    <div class="deputy-text-info">
                        <div class="deputy-name" id="fullName"></div>
                        <div class="deputy-cargo" id="userCargo"></div>
                        <div class="deputy-commission" id="userCommission"></div>
                        <div class="deputy-party">
                            <span class="party-badge" id="partyBadge"></span>
                            <img class="party-logo" id="partyLogo" style="display: none;">
                        </div>
                    </div>
                    <div class="congress-logos" id="congressLogos">
                        <!-- Se llenarán dinámicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Panel de control para presidente/vicepresidente -->
            <div class="president-controls" id="presidentControls" style="display: none;">
                <div class="card mt-3 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0"><i class="fas fa-gavel"></i> Control de Sesión</h6>
                    </div>
                    <div class="card-body">
                        <div id="sessionControlStatus" class="mb-3">
                            <!-- Se llenará dinámicamente -->
                        </div>
                        <!-- Cronómetro de pausa -->
                        <div id="pauseTimerContainer" class="alert alert-warning mb-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-pause-circle"></i> <strong>Sesión Pausada</strong>
                                </div>
                                <div class="text-end">
                                    <small>Tiempo en pausa:</small><br>
                                    <strong id="pauseTimer" class="fs-5">00:00:00</strong>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" id="btnIniciarSesion" onclick="iniciarSesion()" style="display: none;">
                                <i class="fas fa-play"></i> Iniciar Sesión Legislativa
                            </button>
                            <button class="btn btn-warning btn-lg" id="btnPausarSesion" onclick="pausarSesionSimple()" style="display: none;">
                                <i class="fas fa-pause"></i> Pausar Sesión
                            </button>
                            <button class="btn btn-info btn-lg" id="btnReanudarSesion" onclick="reanudarSesion()" style="display: none;">
                                <i class="fas fa-play-circle"></i> Reanudar Sesión
                            </button>
                            <button class="btn btn-danger btn-lg" id="btnClausurarSesion" onclick="clausurarSesion()" style="display: none;">
                                <i class="fas fa-stop"></i> Clausurar Sesión
                            </button>
                        </div>
                        <div id="sessionStats" class="mt-3" style="display: none;">
                            <!-- Estadísticas de sesión -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Panel de votación -->
        <div class="vote-card" id="votingPanel" style="display: none;">
            <div class="text-center mb-4">
                <h2 class="text-primary">INICIATIVA EN VOTACIÓN</h2>
                <div class="badge bg-info fs-6 mb-3">
                    Iniciativa <span id="initiativeNumber"></span>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h4 id="initiativeTitle" class="card-title flex-grow-1"></h4>
                        <button id="btnConsultarPDF" class="btn btn-outline-primary btn-sm" style="display: none;" onclick="consultarDocumentoOriginal()">
                            <i class="fas fa-file-pdf"></i> Consultar Sesión Impresa
                        </button>
                    </div>
                    <div id="initiativeDescriptionContainer">
                        <p id="initiativeDescription" class="card-text text-muted" style="max-height: 150px; overflow: hidden; position: relative;"></p>
                        <button id="btnVerMasTexto" class="btn btn-link btn-sm" style="display: none;" onclick="toggleTextoCompleto()">
                            <i class="fas fa-chevron-down"></i> Ver más
                        </button>
                    </div>
                    <div class="mt-2">
                        <span class="badge bg-secondary" id="majorityType"></span>
                        <span class="badge bg-info ms-2" id="presentadorBadge" style="display: none;"></span>
                    </div>
                </div>
            </div>
            
            <div id="votingButtons" class="text-center">
                <h5 class="mb-3">Emite tu voto:</h5>
                <div class="row">
                    <div class="col-md-4">
                        <button class="btn vote-btn btn-favor" onclick="vote('favor')" title="Presiona 1 para votar A Favor">
                            <i class="fas fa-check-circle"></i>
                            <span>A FAVOR</span>
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn vote-btn btn-contra" onclick="vote('contra')" title="Presiona 2 para votar En Contra">
                            <i class="fas fa-times-circle"></i>
                            <span>EN CONTRA</span>
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn vote-btn btn-abstencion" onclick="vote('abstencion')" title="Presiona 3 para Abstención">
                            <i class="fas fa-minus-circle"></i>
                            <span>ABSTENCIÓN</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="votedMessage" class="text-center mt-4" style="display: none;">
                <div class="alert alert-success">
                    <h4><i class="fas fa-check"></i> Voto Registrado</h4>
                    <p class="mb-0">Tu voto ha sido: <strong id="myVote"></strong></p>
                </div>
                <button class="btn btn-warning mt-3" onclick="changeVote()">
                    <i class="fas fa-edit"></i> Cambiar mi voto
                </button>
                <p class="text-muted mt-3">La votación sigue abierta. Puedes cambiar tu voto hasta que se cierre.</p>
            </div>
        </div>
        
        <!-- Panel removido - Los diputados NO pueden marcar su propia asistencia -->
        <!-- Solo los secretarios pueden marcar la asistencia desde su panel -->
        <!-- El estado de asistencia se muestra en la barra superior -->
        
        <!-- Mensaje sin votación -->
        <div class="vote-card no-voting" id="noVotingPanel">
            <i class="fas fa-clock fa-4x mb-3"></i>
            <h3>No hay iniciativa activa</h3>
            <p>Espera a que se active una iniciativa para votar</p>
            <div class="spinner-border text-primary mt-3" role="status">
                <span class="visually-hidden">Esperando...</span>
            </div>
        </div>
        
        <!-- Historial -->
        <div class="card mt-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-history"></i> Mi Historial de Votos</h5>
            </div>
            <div class="card-body">
                <div id="votingHistory" class="small">
                    <p class="text-muted text-center">Cargando historial...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Ver Detalle de Iniciativa -->
    <div class="modal fade" id="modalDetalleIniciativa" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="detalleIniciativaTitulo">Detalle de Iniciativa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detalleIniciativaContenido">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Gestión de Iniciativas (Solo Presidente) -->
    <div class="modal fade" id="gestionIniciativasModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-crown"></i> Gestión de Iniciativas - Presidente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Como Presidente de la Mesa Directiva, puedes activar iniciativas para votación.
                    </div>
                    
                    <!-- Indicador de Quórum -->
                    <div id="indicadorQuorum" class="mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="fas fa-users"></i> Estado del Quórum
                                </h6>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="h4 mb-0" id="quorumPresentes">0</div>
                                        <small class="text-muted">Presentes</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="h4 mb-0" id="quorumRequerido">0</div>
                                        <small class="text-muted">Requerido</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="h4 mb-0" id="quorumTotal">0</div>
                                        <small class="text-muted">Total</small>
                                    </div>
                                </div>
                                <div class="progress mt-3" style="height: 25px;">
                                    <div id="quorumProgressBar" class="progress-bar" role="progressbar" 
                                         style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        <span id="quorumProgressText">0%</span>
                                    </div>
                                </div>
                                <div id="quorumStatus" class="mt-2 text-center">
                                    <span class="badge bg-secondary">Calculando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FILTROS MEJORADOS -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary active" onclick="filtrarIniciativasPresidente('todas')">
                                            <i class="fas fa-list"></i> Todas
                                        </button>
                                        <button type="button" class="btn btn-outline-success" onclick="filtrarIniciativasPresidente('votadas')">
                                            <i class="fas fa-check-circle"></i> Votadas
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" onclick="filtrarIniciativasPresidente('pendientes')">
                                            <i class="fas fa-clock"></i> Pendientes
                                        </button>
                                        <button type="button" class="btn btn-outline-info" onclick="filtrarIniciativasPresidente('activas')">
                                            <i class="fas fa-play-circle"></i> En Votación
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="seleccionMultiple" onchange="toggleSeleccionMultiple()">
                                        <label class="form-check-label" for="seleccionMultiple">
                                            <i class="fas fa-check-double"></i> Selección Múltiple
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2" id="accionesMultiples" style="display: none;">
                                <div class="col-12">
                                    <button class="btn btn-sm btn-success" onclick="votarSeleccionadas()">
                                        <i class="fas fa-vote-yea"></i> Votar Seleccionadas
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="seleccionarTodas()">
                                        <i class="fas fa-check-square"></i> Seleccionar Todas
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="deseleccionarTodas()">
                                        <i class="fas fa-square"></i> Deseleccionar
                                    </button>
                                    <span class="ms-3 badge bg-primary" id="contadorSeleccionadas">0 seleccionadas</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="listaIniciativasPresidente" style="max-height: 400px; overflow-y: auto;">
                        <p class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando iniciativas...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://unpkg.com/mediasoup-client@3/lib/mediasoup-client.min.js"></script>
    <script>
        // ================ FUNCIONES GLOBALES DEL MENÚ (deben estar antes del HTML) ================
        
        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            if (menu.classList.contains('show')) {
                menu.classList.remove('show');
                overlay.classList.remove('show');
            } else {
                menu.classList.add('show');
                overlay.classList.add('show');
            }
        }
        
        function verTableroSimplificado() {
            toggleMenu();
            window.location.href = '/tablero-diputado';
        }
        
        // Función de configuración - Definición completa desde el inicio
        window.abrirConfiguracion = function() {
            toggleMenu();
            
            // Verificar que el usuario esté cargado
            if (!user) {
                alert('Información del usuario no disponible. Por favor, recarga la página.');
                return;
            }
            
            // Verificar que el modal exista
            const modalElement = document.getElementById('modalConfiguracion');
            if (!modalElement) {
                console.error('Modal de configuración no encontrado');
                alert('El modal de configuración no está disponible. Por favor, recarga la página.');
                return;
            }
            
            // Verificar que los elementos del formulario existan
            const configNombre = document.getElementById('configNombre');
            const configUsuario = document.getElementById('configUsuario');
            const configPartido = document.getElementById('configPartido');
            const configCargo = document.getElementById('configCargo');
            const previewFoto = document.getElementById('previewFoto');
            const configPassword = document.getElementById('configPassword');
            const configPasswordConfirm = document.getElementById('configPasswordConfirm');
            
            if (!configNombre || !configUsuario) {
                console.error('Elementos del formulario no encontrados');
                alert('Los elementos del formulario no están disponibles. Por favor, recarga la página.');
                return;
            }
            
            // Cargar datos actuales del usuario
            configNombre.value = user.nombre || user.nombre_completo || '';
            configUsuario.value = user.username || user.usuario || '';
            if (configPartido) {
                configPartido.value = user.partido || '';
                configPartido.disabled = true;  // Asegurar que esté deshabilitado
                configPartido.readOnly = true;
            }
            if (configCargo) {
                configCargo.value = user.cargo_mesa_directiva || 'Diputado';
                configCargo.disabled = true;  // Asegurar que esté deshabilitado
                configCargo.readOnly = true;
            }
            
            // Cargar foto actual
            const fotoPath = user.fotografia || '/images/diputados/default.png';
            if (previewFoto) previewFoto.src = fotoPath;
            
            // Limpiar campos de contraseña
            if (configPassword) configPassword.value = '';
            if (configPasswordConfirm) configPasswordConfirm.value = '';
            
            // Mostrar modal
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // Función para guardar configuración
        window.guardarConfiguracion = async function() {
            const nombre = document.getElementById('configNombre').value.trim();
            const usuario = document.getElementById('configUsuario').value.trim();
            const password = document.getElementById('configPassword').value;
            const passwordConfirm = document.getElementById('configPasswordConfirm').value;
            
            // Validaciones
            if (!nombre || !usuario) {
                alert('El nombre y usuario son obligatorios');
                return;
            }
            
            if (password && password !== passwordConfirm) {
                alert('Las contraseñas no coinciden');
                return;
            }
            
            if (password && password.length < 6) {
                alert('La contraseña debe tener al menos 6 caracteres');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('nombre', nombre);
                formData.append('usuario', usuario);
                
                if (password) {
                    formData.append('password', password);
                }
                
                // Agregar foto si se seleccionó una
                const inputFoto = document.getElementById('inputFoto');
                if (inputFoto && inputFoto.files && inputFoto.files[0]) {
                    formData.append('fotografia', inputFoto.files[0]);
                }
                
                const response = await fetch('/api/diputado/actualizar-perfil', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Configuración actualizada correctamente');
                    
                    // Actualizar datos locales del usuario
                    user.nombre = nombre;
                    user.usuario = usuario;
                    if (data.fotografia) {
                        user.fotografia = data.fotografia;
                    }
                    
                    // Actualizar header con el nuevo nombre
                    const deputyNameElement = document.getElementById('deputyName');
                    if (deputyNameElement) {
                        deputyNameElement.textContent = nombre;
                    }
                    
                    // Guardar en localStorage
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('modalConfiguracion')).hide();
                    
                    // Si cambió el usuario, sugerir relogin
                    if (usuario !== (user.username || user.usuario)) {
                        if (confirm('Has cambiado tu usuario. ¿Deseas cerrar sesión para ingresar con tu nuevo usuario?')) {
                            logout();
                        }
                    }
                } else {
                    alert(data.error || 'Error al actualizar la configuración');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar la configuración');
            }
        }
        
        // Preview de imagen para configuración
        window.previewImage = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewElement = document.getElementById('previewFoto');
                    if (previewElement) {
                        previewElement.src = e.target.result;
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // ================ INICIALIZACIÓN DE VARIABLES ================
        
        const socket = io();
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');
        let currentInitiative = null;
        let hasVoted = false;
        let partidosData = {};
        
        // Verificar si es presidente o secretario
        const isPresidente = user && user.cargo_mesa_directiva === 'Presidente de la Mesa Directiva';
        const isSecretario = user && (user.cargo_mesa_directiva === 'Secretario de la Mesa Directiva' || 
                                      user.cargo_mesa_directiva === 'secretario1' || 
                                      user.cargo_mesa_directiva === 'secretario2');
        const isVicepresidente = user && user.cargo_mesa_directiva === 'Vicepresidente';
        let sessionStartTime = null;
        let sessionTimerInterval = null;
        let pauseStartTime = null;
        let pauseTimerInterval = null;
        let sessionPaused = false;
        
        // Identificar usuario al conectarse
        if (user) {
            socket.emit('identificar-usuario', {
                nombre: user.nombre_completo || user.username,
                rol: 'Diputado',
                cargo: user.cargo_mesa_directiva || user.cargo_legislativo || ''
            });
        }
        
        if (!token || !user || user.role !== 'diputado') {
            window.location.href = '/';
        }
        
        // Función de logout (debe estar antes de ser usada)
        function logout() {
            if (sessionTimerInterval) clearInterval(sessionTimerInterval);
            localStorage.clear();
            window.location.href = '/';
        }
        
        // No mostrar el nombre del usuario aquí, se mostrará el coordinador después
        
        // Esperar a que el DOM esté listo y cargar información del usuario
        setTimeout(() => {
            loadUserInfo();
            // Mostrar panel del presidente si corresponde
            if (isPresidente) {
                document.getElementById('panelPresidente').style.display = 'block';
            }
            // Asegurar que la función de configuración esté disponible
            if (typeof window.abrirConfiguracion === 'function') {
                console.log('Función abrirConfiguracion cargada correctamente');
            }
        }, 100);
        
        // También cargar información de partidos (en paralelo)
        loadPartidos().catch(error => {
            console.error('Error cargando partidos:', error);
        });
        
        // Cargar iniciativa activa y historial al iniciar
        checkActiveInitiative();
        loadHistory();
        
        // Iniciar cronómetro de sesión
        startSessionTimer();
        
        // Función para toggle del menú (debe estar disponible globalmente)
        window.toggleMenu = function() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.querySelector('.menu-overlay');
            
            if (menu && overlay) {
                menu.classList.toggle('active');
                overlay.classList.toggle('active');
            } else {
                console.error('Elementos del menú no encontrados');
            }
        }
        
        // Agregar atajos de teclado para votación rápida
        document.addEventListener('keydown', function(event) {
            // Solo funcionar si hay una iniciativa activa y no se está escribiendo en un input
            if (!currentInitiative || hasVoted) return;
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;
            
            // Verificar que el panel de votación esté visible
            if (document.getElementById('votingPanel').style.display !== 'block') return;
            
            // Verificar que los botones de votación estén visibles (no haya votado ya)
            if (document.getElementById('votingButtons').style.display !== 'block') return;
            
            switch(event.key) {
                case '1':
                    event.preventDefault();
                    // Resaltar visualmente el botón antes de votar
                    const btnFavor = document.querySelector('.btn-favor.vote-btn');
                    if (btnFavor && !btnFavor.disabled) {
                        btnFavor.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            btnFavor.style.transform = '';
                            vote('favor');
                        }, 200);
                    }
                    break;
                    
                case '2':
                    event.preventDefault();
                    // Resaltar visualmente el botón antes de votar
                    const btnContra = document.querySelector('.btn-contra.vote-btn');
                    if (btnContra && !btnContra.disabled) {
                        btnContra.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            btnContra.style.transform = '';
                            vote('contra');
                        }, 200);
                    }
                    break;
                    
                case '3':
                    event.preventDefault();
                    // Resaltar visualmente el botón antes de votar
                    const btnAbstencion = document.querySelector('.btn-abstencion.vote-btn');
                    if (btnAbstencion && !btnAbstencion.disabled) {
                        btnAbstencion.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            btnAbstencion.style.transform = '';
                            vote('abstencion');
                        }, 200);
                    }
                    break;
            }
        });
        
        // Cargar información de partidos
        async function loadPartidos() {
            try {
                const response = await fetch('/api/pantalla/partidos');
                if (response.ok) {
                    const partidos = await response.json();
                    // Crear mapa de partidos por siglas
                    partidos.forEach(partido => {
                        partidosData[partido.siglas] = partido;
                    });
                }
            } catch (error) {
                console.error('Error cargando partidos:', error);
            }
        }
        
        // Verificar iniciativa activa
        async function checkActiveInitiative() {
            try {
                const response = await fetch('/api/diputado/iniciativa-activa', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.iniciativa) {
                    currentInitiative = data.iniciativa;
                    hasVoted = data.yaVoto;
                    showVotingPanel(data.iniciativa, data.yaVoto, data.miVoto);
                } else {
                    showNoVoting();
                }
            } catch (error) {
                console.error('Error:', error);
                showNoVoting();
            }
        }
        
        // Mostrar panel de votación
        function showVotingPanel(initiative, alreadyVoted, myVote) {
            document.getElementById('noVotingPanel').style.display = 'none';
            document.getElementById('votingPanel').style.display = 'block';
            
            const numeroFormato = initiative.numero_orden_dia ? 
                `${initiative.numero}/${initiative.numero_orden_dia}` : 
                initiative.numero;
            document.getElementById('initiativeNumber').textContent = numeroFormato;
            document.getElementById('initiativeTitle').textContent = initiative.titulo;
            
            // Manejar texto largo con botón "Ver más"
            const descripcion = initiative.descripcion || 'Sin descripción';
            const descElement = document.getElementById('initiativeDescription');
            const btnVerMas = document.getElementById('btnVerMasTexto');
            
            descElement.textContent = descripcion;
            descElement.setAttribute('data-texto-completo', descripcion);
            
            // Si el texto es muy largo, mostrar botón "Ver más"
            if (descripcion.length > 300) {
                descElement.style.maxHeight = '150px';
                descElement.style.overflow = 'hidden';
                btnVerMas.style.display = 'inline-block';
                btnVerMas.innerHTML = '<i class="fas fa-chevron-down"></i> Ver más';
                descElement.setAttribute('data-expandido', 'false');
            } else {
                descElement.style.maxHeight = 'none';
                descElement.style.overflow = 'visible';
                btnVerMas.style.display = 'none';
            }
            
            document.getElementById('majorityType').textContent = getMajorityLabel(initiative.tipo_mayoria);
            
            // Mostrar presentador si existe
            const presentadorBadge = document.getElementById('presentadorBadge');
            if (initiative.presentador) {
                presentadorBadge.textContent = `Por: ${initiative.presentador}`;
                presentadorBadge.style.display = 'inline-block';
            } else {
                presentadorBadge.style.display = 'none';
            }
            
            if (alreadyVoted) {
                document.getElementById('votingButtons').style.display = 'none';
                document.getElementById('votedMessage').style.display = 'block';
                document.getElementById('myVote').textContent = getVoteLabel(myVote);
                // Deshabilitar botones si ya votó
                document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = true);
            } else {
                document.getElementById('votingButtons').style.display = 'block';
                document.getElementById('votedMessage').style.display = 'none';
                // Habilitar botones si no ha votado
                document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = false);
            }
        }
        
        // Mostrar mensaje sin votación
        function showNoVoting() {
            const votingPanel = document.getElementById('votingPanel');
            const noVotingPanel = document.getElementById('noVotingPanel');
            
            if (votingPanel) {
                votingPanel.style.display = 'none';
            }
            
            // El panel de asistencia ya no existe en esta versión
            // Se removió la línea: document.getElementById('attendancePanel').style.display = 'none';
            
            if (noVotingPanel) {
                noVotingPanel.style.display = 'block';
            }
        }
        
        // Cambiar voto
        function changeVote() {
            // Mostrar botones de votación nuevamente
            document.getElementById('votingButtons').style.display = 'block';
            document.getElementById('votedMessage').style.display = 'none';
            document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = false);
            hasVoted = false;
        }
        
        // ================ FUNCIONES DE PASE DE LISTA ================
        
        let hasMarkedAttendance = false;
        let myAttendanceStatus = null;
        
        // Funciones de panel de asistencia removidas
        // Los diputados solo pueden ver su estado, no modificarlo
        
        // Verificar mi asistencia actual
        async function checkMyAttendance() {
            try {
                const response = await fetch('/api/pase-lista/mi-asistencia', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.asistencia) {
                        hasMarkedAttendance = true;
                        myAttendanceStatus = data.asistencia;
                        
                        // Actualizar indicador visual de asistencia
                        mostrarEstadoAsistencia(data.asistencia);
                        showAttendanceRegistered(data.asistencia);
                    }
                }
            } catch (error) {
                console.error('Error verificando asistencia:', error);
            }
        }
        
        // Funciones removidas - Los diputados no pueden marcar su propia asistencia
        // Solo los secretarios marcan la asistencia desde su panel
        
        // Variable para almacenar información de la sesión actual
        let sesionActualInfo = null;
        
        // Función para consultar el documento PDF original
        function consultarDocumentoOriginal() {
            if (sesionActualInfo && sesionActualInfo.archivo_pdf) {
                // Abrir el PDF en una nueva ventana
                window.open(`/documentos-sesion/${sesionActualInfo.archivo_pdf}`, '_blank');
            } else {
                alert('No hay documento PDF disponible para esta sesión');
            }
        }
        
        // Función para consultar la orden del día desde el menú
        async function consultarOrdenDelDia() {
            toggleMenu(); // Cerrar el menú
            
            try {
                // Obtener información de la sesión actual usando la ruta correcta para diputados
                const response = await fetch('/api/diputado/sesion-actual', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.sesion && data.sesion.archivo_pdf) {
                        // Abrir el PDF en una nueva ventana
                        window.open(`/documentos-sesion/${data.sesion.archivo_pdf}`, '_blank');
                    } else if (data.sesion) {
                        // Si no hay PDF pero hay iniciativas, mostrarlas
                        if (data.iniciativas && data.iniciativas.length > 0) {
                            mostrarModalIniciativas(data.iniciativas);
                        } else {
                            alert('No hay documento PDF disponible para esta sesión');
                        }
                    } else {
                        alert('No hay sesión activa en este momento');
                    }
                } else if (response.status === 404) {
                    alert('No hay sesión activa en este momento');
                } else {
                    alert('Error al obtener información de la sesión');
                }
            } catch (error) {
                console.error('Error consultando orden del día:', error);
                alert('Error al consultar la orden del día');
            }
        }
        
        // Prevenir zoom con pinch en toda la aplicación excepto PDFs
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
        });
        
        // Prevenir doble tap para zoom (excepto en elementos de navegación)
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            // No prevenir en elementos de navegación
            if (event.target.closest('.navbar-toggler') || 
                event.target.closest('.navbar-collapse') ||
                event.target.closest('.btn')) {
                return;
            }
            
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Prevenir zoom con ctrl + scroll
        document.addEventListener('wheel', function(event) {
            if (event.ctrlKey) {
                event.preventDefault();
            }
        }, { passive: false });
        
        // Función para expandir/contraer texto de descripción
        function toggleTextoCompleto() {
            const descElement = document.getElementById('initiativeDescription');
            const btnVerMas = document.getElementById('btnVerMasTexto');
            const expandido = descElement.getAttribute('data-expandido') === 'true';
            
            if (expandido) {
                // Contraer
                descElement.style.maxHeight = '150px';
                descElement.style.overflow = 'hidden';
                btnVerMas.innerHTML = '<i class="fas fa-chevron-down"></i> Ver más';
                descElement.setAttribute('data-expandido', 'false');
            } else {
                // Expandir
                descElement.style.maxHeight = 'none';
                descElement.style.overflow = 'visible';
                btnVerMas.innerHTML = '<i class="fas fa-chevron-up"></i> Ver menos';
                descElement.setAttribute('data-expandido', 'true');
            }
        }
        
        // Función para mostrar estado de asistencia
        function mostrarEstadoAsistencia(estado) {
            const statusDiv = document.getElementById('asistenciaStatus');
            const icono = document.getElementById('iconoAsistencia');
            const texto = document.getElementById('estadoAsistenciaTexto');
            const mensaje = document.getElementById('mensajeAsistencia');
            
            if (!statusDiv) return;
            
            statusDiv.style.display = 'block';
            
            switch(estado) {
                case 'presente':
                    statusDiv.className = 'alert alert-success m-3';
                    icono.className = 'fas fa-check-circle text-success';
                    texto.textContent = 'PRESENTE';
                    mensaje.innerHTML = '<i class="fas fa-vote-yea"></i> Puede participar en las votaciones';
                    break;
                    
                case 'ausente':
                    statusDiv.className = 'alert alert-danger m-3';
                    icono.className = 'fas fa-user-times text-danger';
                    texto.textContent = 'AUSENTE';
                    mensaje.innerHTML = '<i class="fas fa-ban"></i> No puede votar (marcado como ausente)';
                    break;
                    
                case 'permiso':
                    statusDiv.className = 'alert alert-info m-3';
                    icono.className = 'fas fa-user-clock text-info';
                    texto.textContent = 'CON PERMISO';
                    mensaje.innerHTML = '<i class="fas fa-info-circle"></i> Ausente con justificación';
                    break;
                    
                default:
                    statusDiv.className = 'alert alert-warning m-3';
                    icono.className = 'fas fa-exclamation-triangle text-warning';
                    texto.textContent = 'NO REGISTRADO';
                    mensaje.innerHTML = '<i class="fas fa-exclamation"></i> Esperando pase de lista';
            }
        }
        
        // Emitir voto
        async function vote(voto) {
            if (!currentInitiative) return;
            
            // Si ya votó, no permitir votar de nuevo (a menos que haya cambiado de opinión)
            if (hasVoted && document.getElementById('votedMessage').style.display === 'block') {
                return;
            }
            
            // Deshabilitar botones
            document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = true);
            
            try {
                const response = await fetch('/api/diputado/votar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        iniciativa_id: currentInitiative.id,
                        voto: voto
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    hasVoted = true;
                    document.getElementById('votingButtons').style.display = 'none';
                    document.getElementById('votedMessage').style.display = 'block';
                    document.getElementById('myVote').textContent = getVoteLabel(voto);
                    
                    // Recargar historial
                    setTimeout(loadHistory, 1000);
                } else {
                    // Verificar si es error de asistencia
                    if (data.estado_asistencia) {
                        mostrarEstadoAsistencia(data.estado_asistencia);
                        alert(`⚠️ ${data.error}\n\n${data.mensaje}`);
                    } else {
                        alert(data.error);
                    }
                    document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = false);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al registrar tu voto');
                document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = false);
            }
        }
        
        // Cargar historial
        async function loadHistory() {
            try {
                const response = await fetch('/api/diputado/mi-historial', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                const container = document.getElementById('votingHistory');
                
                if (data.votos.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">No has emitido votos aún</p>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Iniciativa</th>
                                    <th>Mi Voto</th>
                                    <th>Resultado</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.votos.map(v => `
                                    <tr>
                                        <td>${v.numero}</td>
                                        <td>${v.titulo}</td>
                                        <td>
                                            <span class="badge bg-${getVoteColor(v.voto)}">
                                                ${getVoteLabel(v.voto)}
                                            </span>
                                        </td>
                                        <td>
                                            ${v.resultado ? `
                                                <span class="badge bg-${v.resultado === 'aprobada' ? 'success' : 'danger'}">
                                                    ${v.resultado.toUpperCase()}
                                                </span>
                                            ` : '<span class="text-muted">Pendiente</span>'}
                                        </td>
                                        <td>${new Date(v.fecha_voto).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Utilidades
        function getMajorityLabel(tipo) {
            const labels = {
                'simple': 'Mayoría Simple',
                'absoluta': 'Mayoría Absoluta',
                'calificada': 'Mayoría Calificada (2/3)',
                'unanime': 'Unanimidad'
            };
            return labels[tipo] || 'Mayoría Simple';
        }
        
        function getVoteLabel(voto) {
            const labels = {
                'favor': 'A FAVOR',
                'contra': 'EN CONTRA',
                'abstencion': 'ABSTENCIÓN'
            };
            return labels[voto] || voto;
        }
        
        function getVoteColor(voto) {
            const colors = {
                'favor': 'success',
                'contra': 'danger',
                'abstencion': 'secondary'
            };
            return colors[voto] || 'secondary';
        }
        
        // Eventos de socket
        socket.on('iniciativa-activa', (iniciativa) => {
            currentInitiative = iniciativa;
            hasVoted = false;
            
            // Guardar información de la sesión incluyendo el PDF
            sesionActualInfo = {
                archivo_pdf: iniciativa.archivo_pdf
            };
            
            // Mostrar/ocultar botón de consultar PDF en la tarjeta
            const btnPDF = document.getElementById('btnConsultarPDF');
            if (btnPDF) {
                btnPDF.style.display = iniciativa.archivo_pdf ? 'block' : 'none';
            }
            
            // Mostrar/ocultar botón en el menú
            const btnPDFMenu = document.getElementById('btnConsultarSesionMenu');
            if (btnPDFMenu) {
                btnPDFMenu.style.display = iniciativa.archivo_pdf ? 'inline-block' : 'none';
            }
            
            // Mostrar/ocultar botón flotante
            const floatingBtn = document.getElementById('floatingPdfBtn');
            if (floatingBtn) {
                if (iniciativa.archivo_pdf) {
                    floatingBtn.classList.add('active');
                } else {
                    floatingBtn.classList.remove('active');
                }
            }
            
            // Re-habilitar botones cuando se activa una nueva iniciativa
            document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = false);
            showVotingPanel(iniciativa, false, null);
        });
        
        // Escuchar recordatorios de voto
        socket.on(`recordatorio-voto-${user.id}`, (data) => {
            console.log('Recordatorio recibido:', data);
            
            // Mostrar notificación no invasiva
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
            notificationDiv.style.zIndex = '9999';
            notificationDiv.style.maxWidth = '350px';
            notificationDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-bell fa-2x me-3 text-warning"></i>
                    <div>
                        <strong>Recordatorio</strong><br>
                        ${data.mensaje}
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notificationDiv);
            
            // Hacer parpadear el panel de votación
            if (currentInitiative && !hasVoted) {
                const votingPanel = document.getElementById('votingPanel');
                votingPanel.classList.add('pulse-animation');
                setTimeout(() => {
                    votingPanel.classList.remove('pulse-animation');
                }, 3000);
            }
            
            // Auto-cerrar después de 10 segundos
            setTimeout(() => {
                if (notificationDiv.parentNode) {
                    notificationDiv.remove();
                }
            }, 10000);
        });
        
        // Escuchar cambios de habilitación
        socket.on(`estado-habilitacion-${user.id}`, (data) => {
            console.log('Estado de habilitación cambiado:', data);
            
            if (!data.habilitado) {
                // Si fue deshabilitado, mostrar mensaje y bloquear votación
                alert(data.mensaje);
                
                // Deshabilitar botones de voto
                document.querySelectorAll('.vote-btn').forEach(btn => {
                    btn.disabled = true;
                });
                
                // Mostrar mensaje en el panel
                const votingPanel = document.getElementById('votingPanel');
                if (votingPanel) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger mt-3';
                    alertDiv.innerHTML = `
                        <i class="fas fa-ban"></i> 
                        ${data.mensaje}. Contacte al Secretario Legislativo.
                    `;
                    votingPanel.insertBefore(alertDiv, votingPanel.firstChild);
                }
                
                // Recargar página después de 3 segundos
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                // Si fue habilitado, recargar la página
                alert(data.mensaje);
                window.location.reload();
            }
        });
        
        socket.on('votacion-cerrada', (data) => {
            // Mostrar notificación de resultados
            mostrarNotificacionResultado(data);
            showNoVoting();
            loadHistory();
        });
        
        socket.on('votacion-completa', () => {
            if (hasVoted) {
                const msg = document.getElementById('votedMessage').querySelector('p.text-muted');
                if (msg) {
                    msg.innerHTML = '<i class="fas fa-check-circle text-success"></i> ¡Todos han votado! La votación se cerrará pronto.';
                }
            }
        });
        
        // Eventos de sesión
        // Notificación específica para el presidente cuando el secretario clausura
        socket.on('notificacion-presidente', (data) => {
            if (user.cargo_mesa_directiva === 'presidente') {
                if (data.tipo === 'sesion_clausurada_por_secretario') {
                    alert(`⚠️ NOTIFICACIÓN:\n\n${data.mensaje}\n\nEstadísticas de la sesión:\n- Iniciativas votadas: ${data.estadisticas.total_iniciativas}\n- Aprobadas: ${data.estadisticas.aprobadas}\n- Rechazadas: ${data.estadisticas.rechazadas}`);
                }
            }
        });
        
        // Escuchar notificación del operador para mesa directiva
        socket.on('sesion-lista-para-iniciar', (data) => {
            if (user.cargo_mesa_directiva === 'presidente' || 
                user.cargo_mesa_directiva === 'secretario1' || 
                user.cargo_mesa_directiva === 'secretario2') {
                
                // Crear notificación visual
                const notification = document.createElement('div');
                notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
                notification.style.cssText = 'top: 100px; right: 20px; z-index: 9999; max-width: 400px;';
                notification.innerHTML = `
                    <h5 class="alert-heading">
                        <i class="fas fa-bell"></i> Sesión Lista para Iniciar
                    </h5>
                    <hr>
                    <p><strong>Operador:</strong> ${data.operador}</p>
                    <p><strong>Sesión:</strong> ${data.sesion}</p>
                    <p><strong>Iniciativas cargadas:</strong> ${data.totalIniciativas}</p>
                    <hr>
                    <p class="mb-0">Ya puede iniciar la sesión legislativa</p>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(notification);
                
                // Habilitar botón de iniciar sesión si es presidente
                if (user.cargo_mesa_directiva === 'presidente') {
                    // Solo mostrar botón si la sesión no ha sido iniciada aún
                    checkSessionStatus();
                }
                
                // Auto-cerrar después de 30 segundos
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 30000);
            }
        });
        
        socket.on('sesion-iniciada', (data) => {
            console.log('Sesión iniciada:', data);
            if (user.cargo_mesa_directiva) {
                alert(`Sesión iniciada por ${data.iniciada_por}: ${data.nombre}`);
                checkSessionStatus();
                startSessionTimer();
            }
        });
        
        socket.on('sesion-clausurada', (data) => {
            console.log('Sesión clausurada:', data);
            alert(`Sesión clausurada por ${data.clausurada_por}\n\nEstadísticas finales:\n- Total iniciativas: ${data.estadisticas.total_iniciativas}\n- Aprobadas: ${data.estadisticas.aprobadas}\n- Rechazadas: ${data.estadisticas.rechazadas}`);
            
            // Detener cronómetro
            sessionStartTime = null;
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
                sessionTimerInterval = null;
            }
            document.getElementById('sessionTimer').textContent = '00:00:00';
            
            // Actualizar estado
            if (user.cargo_mesa_directiva === 'presidente' || user.cargo_mesa_directiva === 'vicepresidente') {
                checkSessionStatus();
            }
            
            // Ocultar panel de votación
            showNoVoting();
        });
        
        // Sincronización del pase de lista entre secretarios
        socket.on('pase-lista-activado', (data) => {
            console.log('Pase de lista activado:', data);
            
            // Los diputados SOLO reciben notificación, NO pueden marcar asistencia
            showNotification('📋 Pase de lista en curso', 'info');
            showNotification('El secretario está tomando asistencia', 'warning');
            
            // Verificar mi estado actual de asistencia
            checkMyAttendance();
        });
        
        // Escuchar cuando el secretario actualice mi asistencia
        socket.on('asistencia-actualizada', (data) => {
            if (data.usuario_id === user.id) {
                console.log('Mi asistencia fue actualizada:', data.estado);
                mostrarEstadoAsistencia(data.estado);
                
                // Mostrar notificación según el estado
                const mensaje = data.estado === 'presente' ? 
                    '✅ Has sido marcado como PRESENTE' :
                    data.estado === 'ausente' ?
                    '❌ Has sido marcado como AUSENTE' :
                    'ℹ️ Has sido marcado con PERMISO';
                    
                showNotification(mensaje, 
                    data.estado === 'presente' ? 'success' : 
                    data.estado === 'ausente' ? 'danger' : 'info');
            }
        });
        
        socket.on('pase-lista-desactivado', (data) => {
            console.log('Pase de lista finalizado:', data);
            showNotification('Pase de lista finalizado', 'info');
        });
        
        // Verificar periódicamente
        setInterval(checkActiveInitiative, 10000);
        
        // Cargar información del usuario
        async function loadUserInfo() {
            console.log('Iniciando carga de información del diputado...');
            try {
                const response = await fetch('/api/diputado/mi-informacion', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    console.error('Error en respuesta:', response.status);
                    // Mostrar información básica del localStorage
                    document.getElementById('fullName').textContent = user.nombre_completo || user.nombre || 'Diputado';
                    document.getElementById('userCargo').textContent = 'Diputado';
                    document.getElementById('userCommission').textContent = 'Sin comisión asignada';
                    document.getElementById('partyBadge').textContent = 'Sin partido';
                    return;
                }
                
                const data = await response.json();
                console.log('Datos del diputado cargados:', data);
                
                // Actualizar el objeto user con la información completa
                user.cargo_mesa_directiva = data.cargo_mesa_directiva;
                user.partido = data.partido;
                user.comision = data.comision;
                user.nombre = data.nombre;
                user.nombre_completo = data.nombre_completo;
                user.fotografia = data.fotografia;
                user.cargo_legislativo = data.cargo_legislativo;
                // Mantener el username original si no viene en la respuesta
                if (data.username) user.username = data.username;
                if (data.usuario) user.usuario = data.usuario;
                localStorage.setItem('user', JSON.stringify(user));
                
                // Verificar si es secretario después de cargar la información
                checkIfSecretary();
                
                // Mostrar información del coordinador en el navbar
                updateCoordinatorInfo(data);
                
                // Actualizar información en la interfaz (con verificación de elementos)
                const fullNameEl = document.getElementById('fullName');
                const userCargoEl = document.getElementById('userCargo');
                const userCommissionEl = document.getElementById('userCommission');
                
                if (fullNameEl) fullNameEl.textContent = data.nombre_completo || data.nombre || 'Diputado';
                if (userCargoEl) userCargoEl.textContent = data.cargo_legislativo || data.cargo_mesa_directiva || 'Diputado';
                if (userCommissionEl) userCommissionEl.textContent = data.comision || 'Sin comisión asignada';
                
                // Obtener datos del partido
                const partidoInfo = partidosData[data.partido] || null;
                const partyColor = partidoInfo ? partidoInfo.color_primario : '#6c757d';
                
                // Actualizar badge del partido
                const partyBadge = document.getElementById('partyBadge');
                if (partyBadge) {
                    partyBadge.textContent = data.partido || 'Independiente';
                    partyBadge.style.backgroundColor = partyColor;
                }
                
                // Mostrar logo del partido si existe
                if (partidoInfo && partidoInfo.logo_url) {
                    const partyLogo = document.getElementById('partyLogo');
                    if (partyLogo) {
                        partyLogo.src = partidoInfo.logo_url;
                        partyLogo.style.display = 'inline-block';
                    }
                }
                
                // Actualizar avatar con foto o iniciales
                const deputyAvatar = document.getElementById('deputyAvatar');
                if (deputyAvatar) {
                    if (data.foto_url) {
                        deputyAvatar.style.backgroundImage = `url(${data.foto_url})`;
                        deputyAvatar.innerHTML = '';
                    } else if (data.nombre_completo) {
                        const iniciales = data.nombre_completo.split(' ').map(n => n[0]).slice(0, 2).join('');
                        deputyAvatar.textContent = iniciales;
                        deputyAvatar.style.backgroundColor = partyColor;
                    } else {
                        deputyAvatar.textContent = 'D';
                        deputyAvatar.style.backgroundColor = '#6c757d';
                    }
                }
                
                // Aplicar colores del partido
                applyPartyColors(partyColor);
                
                // Código anterior del placeholder
                const photoContainer = document.getElementById('userPhotoContainer');
                if (photoContainer) {
                    if (data.foto_url) {
                        photoContainer.innerHTML = `<img src="${data.foto_url}" class="user-photo" alt="Foto">`;
                    } else {
                            photoContainer.innerHTML = `
                            <div class="user-photo-placeholder">
                                <i class="fas fa-user"></i>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error cargando información del usuario:', error);
                // Mostrar información básica en caso de error
                const fullNameEl = document.getElementById('fullName');
                const userCargoEl = document.getElementById('userCargo');
                const userCommissionEl = document.getElementById('userCommission');
                const partyBadge = document.getElementById('partyBadge');
                const deputyAvatar = document.getElementById('deputyAvatar');
                
                if (fullNameEl) fullNameEl.textContent = user.nombre_completo || user.nombre || 'Diputado';
                if (userCargoEl) userCargoEl.textContent = 'Diputado';
                if (userCommissionEl) userCommissionEl.textContent = 'Sin información disponible';
                if (partyBadge) {
                    partyBadge.textContent = 'Sin partido';
                    partyBadge.style.backgroundColor = '#6c757d';
                }
                if (deputyAvatar) {
                    deputyAvatar.textContent = 'D';
                    deputyAvatar.style.backgroundColor = '#6c757d';
                }
            }
        }
        
        // Reloj en tiempo real (para todos)
        function updateClock() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;
        }
        
        // Iniciar reloj
        setInterval(updateClock, 1000);
        updateClock();
        
        // Fix para el menú hamburguesa - Solución mejorada
        function initializeHamburgerMenu() {
            const navbarToggler = document.querySelector('.navbar-toggler');
            const navbarCollapse = document.querySelector('#navbarContent');
            
            if (!navbarToggler || !navbarCollapse) {
                console.log('Elementos del navbar no encontrados, reintentando...');
                setTimeout(initializeHamburgerMenu, 100);
                return;
            }
            
            // Limpiar cualquier listener previo
            const newToggler = navbarToggler.cloneNode(true);
            navbarToggler.parentNode.replaceChild(newToggler, navbarToggler);
            
            // Configurar manualmente sin depender de data-attributes
            newToggler.removeAttribute('data-bs-toggle');
            newToggler.removeAttribute('data-bs-target');
            
            // Crear nueva instancia de Collapse
            let bsCollapse;
            try {
                // Destruir instancia previa si existe
                const existingCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                if (existingCollapse) {
                    existingCollapse.dispose();
                }
                
                // Crear nueva instancia
                bsCollapse = new bootstrap.Collapse(navbarCollapse, {
                    toggle: false
                });
            } catch (e) {
                console.error('Error creando Collapse:', e);
                // Fallback: toggle manual de clases
                newToggler.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    navbarCollapse.classList.toggle('show');
                });
                return;
            }
            
            // Agregar evento click con múltiples intentos de toggle
            newToggler.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Hamburger clicked - estado actual:', navbarCollapse.classList.contains('show'));
                
                try {
                    bsCollapse.toggle();
                } catch (err) {
                    console.error('Error en toggle, usando fallback:', err);
                    navbarCollapse.classList.toggle('show');
                }
            });
            
            // Asegurar que el botón es clickeable
            newToggler.style.pointerEvents = 'auto';
            newToggler.style.cursor = 'pointer';
            newToggler.style.zIndex = '1200';
            
            // Debug para mesa directiva
            if (user && user.cargo_mesa_directiva) {
                console.log('Mesa directiva detectada:', user.cargo_mesa_directiva);
                console.log('Menú hamburguesa inicializado correctamente');
                console.log('Toggler clickeable:', window.getComputedStyle(newToggler).pointerEvents);
            }
        }
        
        // Esperar a que Bootstrap esté completamente cargado
        if (typeof bootstrap !== 'undefined' && bootstrap.Collapse) {
            setTimeout(initializeHamburgerMenu, 100);
        } else {
            // Si Bootstrap no está listo, esperar
            window.addEventListener('load', function() {
                setTimeout(initializeHamburgerMenu, 500);
            });
        }
        
        // Cronómetro de sesión (solo para mesa directiva, secretarios y superadmin)
        // Variables ya declaradas arriba, no duplicar
        
        function shouldShowSessionTimer() {
            return user.cargo_mesa_directiva || 
                   user.role === 'secretario' || 
                   user.role === 'superadmin';
        }
        
        async function startSessionTimer() {
            // Solo mostrar cronómetro a usuarios autorizados
            if (!shouldShowSessionTimer()) return;
            
            try {
                const response = await fetch('/api/diputado/tiempo-sesion', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.sesionActiva && data.inicioSesion) {
                    sessionStartTime = new Date(data.inicioSesion);
                    document.getElementById('sessionTimerContainer').style.display = 'inline-block';
                    
                    // Actualizar cada segundo
                    if (sessionTimerInterval) clearInterval(sessionTimerInterval);
                    sessionTimerInterval = setInterval(updateTimer, 1000);
                    updateTimer();
                }
            } catch (error) {
                console.error('Error obteniendo tiempo de sesión:', error);
            }
        }
        
        function updateTimer() {
            if (!sessionStartTime) return;
            
            const now = new Date();
            const elapsed = Math.floor((now - sessionStartTime) / 1000);
            
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('sessionTimer').textContent = timeString;
        }
        
        // Aplicar colores del partido dinámicamente
        function applyPartyColors(partyColor) {
            const style = document.createElement('style');
            style.innerHTML = `
                .deputy-header {
                    border-left-color: ${partyColor} !important;
                }
                .deputy-avatar {
                    border-color: ${partyColor} !important;
                }
                .vote-btn:hover {
                    box-shadow: 0 10px 25px ${partyColor}33 !important;
                }
                .party-badge {
                    background-color: ${partyColor} !important;
                }
            `;
            document.head.appendChild(style);
        }
        
        // Cargar configuración del sistema
        async function loadSystemConfig() {
            try {
                const response = await fetch('/api/configuracion/public');
                if (response.ok) {
                    const config = await response.json();
                    const logosDiv = document.getElementById('congressLogos');
                    
                    if (config.logo_congreso) {
                        logosDiv.innerHTML += `<img src="${config.logo_congreso}" alt="Logo Principal">`;
                    }
                    if (config.logo_secundario) {
                        logosDiv.innerHTML += `<img src="${config.logo_secundario}" alt="Logo Secundario">`;
                    }
                }
            } catch (error) {
                console.error('Error cargando configuración:', error);
            }
        }
        
        // Verificar cargo en mesa directiva
        function updateCoordinatorInfo(data) {
            // Obtener el nombre del coordinador desde la base de datos
            let coordinatorName = data.nombre_coordinador || '';
            let partyLogo = '';
            
            if (data.partido && coordinatorName) {
                
                // Configurar logo del partido
                const partyLogos = {
                    'MORENA': '/images/partidos/morena.svg',
                    'PAN': '/images/partidos/pan.svg',
                    'PRI': '/images/partidos/pri.svg',
                    'PT': '/images/partidos/pt.svg',
                    'PVEM': '/images/partidos/pvem.svg',
                    'MC': '/images/partidos/mc.svg',
                    'PRD': '/images/partidos/prd.svg',
                    'PNA': '/images/partidos/pna.svg',
                    'NUEVA ALIANZA': '/images/partidos/nueva-alianza.svg'
                };
                
                partyLogo = partyLogos[data.partido] || '';
                
                // Actualizar el navbar
                const coordinatorInfo = document.getElementById('coordinatorInfo');
                const coordinatorNameElement = document.getElementById('coordinatorName');
                const coordinatorPartyLogo = document.getElementById('coordinatorPartyLogo');
                
                if (coordinatorInfo && coordinatorNameElement) {
                    coordinatorNameElement.textContent = coordinatorName;
                    coordinatorInfo.style.display = 'inline-block';
                    
                    if (partyLogo && coordinatorPartyLogo) {
                        coordinatorPartyLogo.src = partyLogo;
                        coordinatorPartyLogo.alt = data.partido;
                        coordinatorPartyLogo.style.display = 'inline-block';
                    }
                }
            }
        }
        
        function checkIfSecretary() {
            console.log('Verificando cargo mesa directiva:', user.cargo_mesa_directiva);
            console.log('Usuario completo:', user);
            
            // Mostrar menú de secretario en el panel lateral
            if (user.cargo_mesa_directiva === 'secretario1' || user.cargo_mesa_directiva === 'secretario2') {
                console.log('Es secretario, mostrando panel en menú lateral');
                document.getElementById('panelSecretario').style.display = 'block'; // Panel en menú lateral
            }
            
            // Verificar estado del pase de lista para TODOS los diputados
            verificarEstadoPaseLista();
            
            // Mostrar panel de control de presidente/vicepresidente
            if (user.cargo_mesa_directiva === 'presidente') {
                console.log('Es presidente, mostrando panel de control');
                document.getElementById('presidentControls').style.display = 'block';
                document.getElementById('panelPresidente').style.display = 'block'; // Panel en menú lateral
                checkSessionStatus();
            } else if (user.cargo_mesa_directiva === 'vicepresidente') {
                console.log('Es vicepresidente, verificando autorización');
                verificarAutorizacionVicepresidente();
            }
        }
        
        // Verificar autorización del vicepresidente
        async function verificarAutorizacionVicepresidente() {
            try {
                const response = await fetch('/api/diputado/vicepresidente-autorizado', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.autorizado) {
                        console.log('Vicepresidente autorizado para funciones de presidente');
                        document.getElementById('presidentControls').style.display = 'block';
                        checkSessionStatus();
                    } else {
                        console.log('Vicepresidente no autorizado');
                        document.getElementById('presidentControls').style.display = 'none';
                    }
                } else {
                    // Si el endpoint no existe o hay error, mostrar controles por defecto para vicepresidente
                    console.log('Verificación de autorización no disponible, mostrando controles');
                    document.getElementById('presidentControls').style.display = 'block';
                    checkSessionStatus();
                }
            } catch (error) {
                console.error('Error verificando autorización:', error);
                // En caso de error, mostrar controles por defecto para vicepresidente
                document.getElementById('presidentControls').style.display = 'block';
                checkSessionStatus();
            }
        }
        
        // Listener para cambios de autorización en tiempo real
        socket.on('autorizacion-vicepresidente-cambiada', (data) => {
            if (user.cargo_mesa_directiva === 'vicepresidente') {
                if (data.autorizado) {
                    alert(`Has sido autorizado por ${data.autorizado_por} para usar funciones del Presidente`);
                    document.getElementById('presidentControls').style.display = 'block';
                    checkSessionStatus();
                } else {
                    alert('Tu autorización para usar funciones del Presidente ha sido revocada');
                    document.getElementById('presidentControls').style.display = 'none';
                }
            }
        });
        
        // Verificar estado de la sesión para presidente/vicepresidente
        async function checkSessionStatus() {
            try {
                const response = await fetch('/api/diputado/sesion-actual', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                updateSessionControls(data);
            } catch (error) {
                console.error('Error obteniendo estado de sesión:', error);
            }
        }
        
        function updateSessionControls(data) {
            const statusDiv = document.getElementById('sessionControlStatus');
            const btnIniciar = document.getElementById('btnIniciarSesion');
            const btnPausar = document.getElementById('btnPausarSesion');
            const btnReanudar = document.getElementById('btnReanudarSesion');
            const btnClausurar = document.getElementById('btnClausurarSesion');
            const statsDiv = document.getElementById('sessionStats');
            const pauseTimerContainer = document.getElementById('pauseTimerContainer');
            
            // Primero ocultar todos los botones
            btnIniciar.style.display = 'none';
            btnPausar.style.display = 'none';
            btnReanudar.style.display = 'none';
            btnClausurar.style.display = 'none';
            
            if (data.sesion_activa) {
                // Verificar si la sesión está iniciada o solo preparada
                const sesionIniciada = data.sesion.fecha_inicio && data.sesion.fecha_inicio !== null;
                const sesionClausurada = data.sesion.fecha_clausura && data.sesion.fecha_clausura !== null;
                
                statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        <strong>Sesión:</strong> ${data.sesion.nombre}<br>
                        <small>Estado: ${sesionClausurada ? 'Clausurada' : sesionIniciada ? 'Iniciada' : 'Preparada para iniciar'}</small>
                        ${sesionIniciada && !sesionClausurada ? `<br><small>Iniciada: ${new Date(data.sesion.fecha_inicio).toLocaleString('es-MX')}</small>` : ''}
                        ${data.sesion.pausada ? '<br><span class="badge bg-warning">PAUSADA</span>' : ''}
                        ${data.mensaje_iniciativas ? `<br><div class="alert alert-warning mt-2 mb-0"><i class="fas fa-exclamation-triangle"></i> ${data.mensaje_iniciativas}</div>` : ''}
                    </div>
                `;
                
                // Si la sesión NO está iniciada pero está activa (preparada)
                if (!sesionIniciada && !sesionClausurada && data.puede_iniciar) {
                    btnIniciar.style.display = 'block';
                }
                // Si la sesión ESTÁ iniciada pero NO clausurada
                else if (sesionIniciada && !sesionClausurada) {
                    console.log('Sesión iniciada - configurando botones de control');
                    // Mostrar botones de pausa/reanudar según estado
                    if (data.puede_pausar) {
                        if (data.sesion.pausada) {
                            btnPausar.style.display = 'none';
                            btnReanudar.style.display = 'block';
                            // Mostrar y activar cronómetro de pausa
                            pauseTimerContainer.style.display = 'block';
                            if (!pauseTimerInterval) {
                                startPauseTimer();
                            }
                        } else {
                            btnPausar.style.display = 'block';
                            btnPausar.innerHTML = '<i class="fas fa-pause"></i> Pausar Sesión';
                            btnPausar.className = 'btn btn-warning btn-lg';
                            btnReanudar.style.display = 'none';
                            // Ocultar cronómetro de pausa
                            pauseTimerContainer.style.display = 'none';
                            stopPauseTimer();
                        }
                    }
                    // Mostrar botón de clausurar solo si puede
                    if (data.puede_clausurar) {
                        btnClausurar.style.display = 'block';
                    }
                }
                
                // Mostrar botón de recordatorios si es presidente o vicepresidente autorizado
                const btnRecordatorios = document.getElementById('btnRecordatorios');
                if (btnRecordatorios) {
                    btnRecordatorios.style.display = (isPresidente || (user.cargo_mesa_directiva === 'vicepresidente' && data.puede_clausurar)) ? 'block' : 'none';
                }
                
                if (data.estadisticas) {
                    statsDiv.style.display = 'block';
                    statsDiv.innerHTML = `
                        <div class="row text-center">
                            <div class="col-4">
                                <h5>${data.estadisticas.total_iniciativas}</h5>
                                <small>Iniciativas</small>
                            </div>
                            <div class="col-4">
                                <h5>${data.estadisticas.votaciones_cerradas}</h5>
                                <small>Cerradas</small>
                            </div>
                            <div class="col-4">
                                <h5>${data.estadisticas.votaciones_activas}</h5>
                                <small>Activas</small>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Mensaje según si hay iniciativas cargadas o no
                let mensaje = '';
                if (data.mensaje_iniciativas) {
                    mensaje = `
                        <div class="alert alert-warning">
                            <strong>No hay sesión activa</strong><br>
                            <small class="text-danger">${data.mensaje_iniciativas}</small>
                        </div>
                    `;
                } else {
                    mensaje = `
                        <div class="alert alert-warning">
                            <strong>No hay sesión activa</strong><br>
                            <small>Puedes iniciar una nueva sesión legislativa</small>
                        </div>
                    `;
                }
                
                statusDiv.innerHTML = mensaje;
                
                // Mostrar botón solo si puede iniciar Y hay iniciativas
                btnIniciar.style.display = data.puede_iniciar ? 'block' : 'none';
                btnIniciar.disabled = !data.iniciativas_cargadas;
                
                // Actualizar texto del botón si está deshabilitado
                if (!data.iniciativas_cargadas && data.puede_iniciar) {
                    btnIniciar.title = 'El operador debe cargar las iniciativas primero';
                    btnIniciar.classList.add('btn-secondary');
                    btnIniciar.classList.remove('btn-success');
                } else if (data.puede_iniciar) {
                    btnIniciar.title = 'Iniciar nueva sesión legislativa';
                    btnIniciar.classList.add('btn-success');
                    btnIniciar.classList.remove('btn-secondary');
                }
                
                btnClausurar.style.display = 'none';
                statsDiv.style.display = 'none';
            }
        }
        
        // Funciones del cronómetro de pausa
        function startPauseTimer() {
            pauseStartTime = Date.now();
            if (pauseTimerInterval) clearInterval(pauseTimerInterval);
            pauseTimerInterval = setInterval(updatePauseTimer, 1000);
            updatePauseTimer();
        }
        
        function stopPauseTimer() {
            if (pauseTimerInterval) {
                clearInterval(pauseTimerInterval);
                pauseTimerInterval = null;
            }
            pauseStartTime = null;
            document.getElementById('pauseTimer').textContent = '00:00:00';
        }
        
        function updatePauseTimer() {
            if (!pauseStartTime) return;
            
            const elapsed = Date.now() - pauseStartTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('pauseTimer').textContent = timeString;
        }
        
        // Pausar sesión simple (sin modal)
        async function pausarSesionSimple() {
            if (!confirm('¿Deseas pausar la sesión?')) return;
            
            try {
                const response = await fetch('/api/diputado/pausar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ minutos: 0 }) // Sin tiempo límite
                });
                
                if (response.ok) {
                    sessionPaused = true;
                    // Pausar el cronómetro principal
                    if (sessionTimerInterval) {
                        clearInterval(sessionTimerInterval);
                    }
                    // Iniciar cronómetro de pausa
                    startPauseTimer();
                    checkSessionStatus();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al pausar sesión');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al pausar sesión');
            }
        }
        
        // Reanudar sesión
        async function reanudarSesion() {
            try {
                const response = await fetch('/api/diputado/reanudar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    sessionPaused = false;
                    // Detener cronómetro de pausa
                    stopPauseTimer();
                    // Reanudar cronómetro principal
                    startSessionTimer();
                    checkSessionStatus();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al reanudar sesión');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al reanudar sesión');
            }
        }
        
        // Iniciar sesión
        async function iniciarSesion() {
            if (!confirm('¿Deseas iniciar una nueva sesión legislativa?')) return;
            
            try {
                const response = await fetch('/api/diputado/iniciar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Sesión iniciada correctamente');
                    // Forzar actualización inmediata y después de un pequeño retraso
                    checkSessionStatus();
                    setTimeout(() => {
                        checkSessionStatus();
                        startSessionTimer(); // Reiniciar cronómetro
                    }, 500);
                } else {
                    // Mostrar mensaje más específico si es por falta de iniciativas
                    if (data.requiere_iniciativas) {
                        alert('❌ No se puede iniciar la sesión\n\n' + data.mensaje);
                    } else {
                        alert(data.error || 'Error al iniciar sesión');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al iniciar sesión');
            }
        }
        
        // Clausurar sesión
        async function clausurarSesion() {
            if (!confirm('¿Estás seguro de clausurar la sesión? Esto cerrará todas las votaciones activas.')) return;
            
            try {
                const response = await fetch('/api/diputado/clausurar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Sesión clausurada correctamente.\n\nEstadísticas:\n- Iniciativas: ${data.estadisticas.total_iniciativas}\n- Aprobadas: ${data.estadisticas.aprobadas}\n- Rechazadas: ${data.estadisticas.rechazadas}`);
                    checkSessionStatus();
                    sessionStartTime = null; // Detener cronómetro
                    if (sessionTimerInterval) {
                        clearInterval(sessionTimerInterval);
                        sessionTimerInterval = null;
                    }
                    document.getElementById('sessionTimer').textContent = '00:00:00';
                } else {
                    alert(data.error || 'Error al clausurar sesión');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al clausurar sesión');
            }
        }
        
        // Función para ir directamente al pase de lista (para Diputados-Secretarios)
        function abrirPaseLista() {
            // Redirigir directamente a la página de pase de lista
            window.location.href = '/pase-lista';
        }
        
        // Activar pase de lista (función legacy - mantener por compatibilidad)
        async function activarPaseLista() {
            if (!confirm('¿Activar el pase de lista?\n\nEsto mostrará la pantalla de asistencia pública.')) return;
            
            try {
                const response = await fetch('/api/pase-lista/activar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Emitir evento para actualizar pantalla pública
                    socket.emit('pase-lista-activado', {
                        activo: true,
                        sesion_id: data.sesion_id
                    });
                    
                    // Mostrar notificación
                    showNotification('✅ Pase de lista activado', 'success');
                    showNotification('La pantalla de asistencia está ahora visible', 'info');
                    
                    // Abrir ventana de control en nueva pestaña
                    window.open('/pase-lista', '_blank');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error activando pase de lista:', error);
                alert('Error al activar el pase de lista');
            }
        }
        
        // Ver estado de asistencia
        function verEstadoAsistencia() {
            window.open('/pantalla-asistencia', '_blank');
        }
        
        // Verificar estado del pase de lista al cargar
        async function verificarEstadoPaseLista() {
            try {
                const response = await fetch('/api/pase-lista/estado', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Estado del pase de lista:', data);
                    
                    if (data.activo) {
                        // Mostrar panel de pase de lista si está activo
                        showAttendancePanel();
                        
                        // Si el pase de lista ya está activo, actualizar botón para secretarios
                        const btnActivar = document.querySelector('#panelSecretario .menu-item[onclick*="activarPaseLista"]');
                        if (btnActivar) {
                            btnActivar.innerHTML = `
                                <i class="fas fa-check-circle text-success"></i>
                                <div>
                                    <div>Pase de Lista Activo</div>
                                    <small class="text-muted">Ya está habilitado</small>
                                </div>
                            `;
                            btnActivar.style.pointerEvents = 'none';
                            btnActivar.style.opacity = '0.6';
                        }
                    }
                }
            } catch (error) {
                console.error('Error verificando estado del pase de lista:', error);
            }
        }
        
        // Ir a pase de lista
        function goToAttendance() {
            window.location.href = '/pase-lista';
        }
        
        // Regresar a votación
        function backToVoting() {
            window.location.href = '/diputado';
        }
        
        
        // Funciones de recordatorios para presidente
        async function mostrarDiputadosSinVoto() {
            try {
                const response = await fetch('/api/diputado/diputados-sin-voto', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (!data.iniciativa) {
                    alert('No hay votación activa');
                    return;
                }
                
                // Mostrar info de iniciativa
                const numeroFormato = data.iniciativa.numero_orden_dia ? 
                    `${data.iniciativa.numero}/${data.iniciativa.numero_orden_dia}` : 
                    data.iniciativa.numero;
                document.getElementById('iniciativaInfo').innerHTML = `
                    <strong>Iniciativa ${numeroFormato}:</strong> ${data.iniciativa.titulo || data.iniciativa.descripcion || 'Sin descripción'}
                `;
                
                // Actualizar contador
                document.getElementById('totalSinVoto').textContent = data.total_sin_voto;
                
                // Mostrar lista de diputados
                const tbody = document.getElementById('listaDiputadosSinVoto');
                if (data.diputados_sin_voto.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-success">Todos los diputados han votado</td></tr>';
                } else {
                    tbody.innerHTML = data.diputados_sin_voto.map(dip => `
                        <tr>
                            <td>${dip.nombre_completo}</td>
                            <td><span class="badge bg-secondary">${dip.partido}</span></td>
                            <td>${dip.cargo_mesa_directiva || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="enviarRecordatorio(${dip.id}, ${data.iniciativa.id}, '${dip.nombre_completo}')">
                                    <i class="fas fa-bell"></i> Recordar
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
                
                // Guardar ID de iniciativa para uso posterior
                window.currentIniciativaId = data.iniciativa.id;
                
                recordatoriosModal.show();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar diputados sin voto');
            }
        }
        
        // Enviar recordatorio individual
        async function enviarRecordatorio(diputadoId, iniciativaId, nombreDiputado) {
            if (!confirm(`¿Enviar recordatorio a ${nombreDiputado}?`)) return;
            
            try {
                const response = await fetch('/api/diputado/enviar-recordatorio', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        diputado_id: diputadoId,
                        iniciativa_id: iniciativaId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(data.mensaje);
                    // Actualizar lista
                    mostrarDiputadosSinVoto();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al enviar recordatorio');
            }
        }

        // Configurar listener para recordatorios de voto
        function setupRecordatorioListener() {
            // Escuchar recordatorios específicos para este usuario
            socket.on(`recordatorio-voto-${user.id}`, (data) => {
                mostrarNotificacionRecordatorio(data);
            });
        }
        
        // Mostrar notificación no invasiva de recordatorio
        function mostrarNotificacionRecordatorio(data) {
            // Crear elemento de notificación si no existe
            let notifContainer = document.getElementById('notificacionRecordatorio');
            if (!notifContainer) {
                notifContainer = document.createElement('div');
                notifContainer.id = 'notificacionRecordatorio';
                notifContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                    max-width: 400px;
                `;
                document.body.appendChild(notifContainer);
            }
            
            // Crear notificación
            const notifId = 'notif-' + Date.now();
            const notifHtml = `
                <div id="${notifId}" class="alert alert-warning alert-dismissible fade show" role="alert">
                    <strong><i class="fas fa-bell"></i> Recordatorio de Votación</strong><br>
                    <small>De: ${data.cargo_enviador}</small><br>
                    <hr class="my-2">
                    ${data.mensaje}<br>
                    <button type="button" class="btn-close" onclick="document.getElementById('${notifId}').remove()"></button>
                </div>
            `;
            
            notifContainer.insertAdjacentHTML('beforeend', notifHtml);
            
            // Auto-remover después de 10 segundos
            setTimeout(() => {
                const notif = document.getElementById(notifId);
                if (notif) {
                    notif.classList.add('fade');
                    setTimeout(() => notif.remove(), 500);
                }
            }, 10000);
            
            // Si el diputado puede votar, resaltar el botón de voto
            if (!isPresidente && !isSecretario && currentInitiative) {
                const voteButtons = document.querySelectorAll('.vote-btn');
                voteButtons.forEach(btn => {
                    btn.classList.add('pulse-animation');
                    setTimeout(() => btn.classList.remove('pulse-animation'), 3000);
                });
            }
        }
        
        // Modal de recordatorios (solo para presidente)
        const recordatoriosModal = isPresidente ? new bootstrap.Modal(document.getElementById('recordatoriosModal')) : null;
        
        // Variables para streaming
        let streamSocket = null;
        let device = null;
        let transport = null;
        let consumer = null;
        let isStreamConnected = false;
        let streamMode = 'webrtc'; // 'webrtc' o 'hls'
        
        // Conectar al servidor de streaming
        function connectStreamingServer() {
            streamSocket = io('http://localhost:3001', {
                transports: ['websocket'],
                reconnection: true
            });
            
            streamSocket.on('connect', () => {
                console.log('Conectado al servidor de streaming');
            });
            
            // Escuchar cuando hay stream disponible
            streamSocket.on('stream-live', (data) => {
                console.log('Stream en vivo disponible:', data);
                document.getElementById('liveButtonContainer').style.display = 'block';
                
                // Mostrar notificación
                showStreamNotification('La transmisión del pleno está en vivo');
            });
            
            streamSocket.on('stream-ended', () => {
                console.log('Stream terminado');
                document.getElementById('liveButtonContainer').style.display = 'none';
                closeLiveStream();
            });
            
            // Actualizar contador de espectadores
            streamSocket.on('viewer-count', (data) => {
                document.getElementById('viewerCount').textContent = data.count;
            });
        }
        
        // Mostrar notificación de stream
        function showStreamNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'stream-notification';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-broadcast-tower text-danger me-3"></i>
                    <div>
                        <strong>Transmisión en Vivo</strong>
                        <div class="small text-muted">${message}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Toggle stream
        async function toggleLiveStream() {
            const container = document.getElementById('streamContainer');
            
            if (container.style.display === 'none' || container.style.display === '') {
                container.style.display = 'block';
                await connectToStream();
            } else {
                closeLiveStream();
            }
        }
        
        // Conectar al stream
        async function connectToStream() {
            try {
                // Intentar WebRTC primero para baja latencia
                if (typeof mediasoupClient !== 'undefined') {
                    await connectWebRTC();
                } else {
                    // Fallback a HLS
                    connectHLS();
                }
            } catch (error) {
                console.error('Error conectando al stream:', error);
                // Fallback a HLS si WebRTC falla
                connectHLS();
            }
        }
        
        // Conectar usando WebRTC (baja latencia)
        async function connectWebRTC() {
            try {
                // Obtener capacidades del router
                const response = await fetch('http://localhost:3001/api/streaming/capabilities');
                const routerRtpCapabilities = await response.json();
                
                // Crear device
                device = new mediasoupClient.Device();
                await device.load({ routerRtpCapabilities });
                
                // Notificar al servidor que queremos consumir
                streamSocket.emit('consume-stream', {
                    rtpCapabilities: device.rtpCapabilities,
                    diputadoId: user.id,
                    nombre: user.nombre_completo || user.nombre
                });
                
                // Esperar transport
                streamSocket.on('transport-created', async (params) => {
                    // Crear transport de recepción
                    transport = device.createRecvTransport(params);
                    
                    // Manejar conexión
                    transport.on('connect', ({ dtlsParameters }, callback) => {
                        streamSocket.emit('connect-transport', { dtlsParameters });
                        streamSocket.once('transport-connected', callback);
                    });
                    
                    // Solicitar consumir
                    streamSocket.emit('consume', { transportId: transport.id });
                });
                
                // Recibir consumer
                streamSocket.on('consumer-created', async (params) => {
                    // Crear consumer
                    consumer = await transport.consume({
                        id: params.id,
                        producerId: params.producerId,
                        kind: params.kind,
                        rtpParameters: params.rtpParameters
                    });
                    
                    // Mostrar video
                    const video = document.getElementById('remoteVideo');
                    const stream = new MediaStream();
                    stream.addTrack(consumer.track);
                    video.srcObject = stream;
                    
                    isStreamConnected = true;
                    streamMode = 'webrtc';
                    console.log('✅ Conectado via WebRTC (baja latencia)');
                });
                
                // Manejar no stream disponible
                streamSocket.on('no-stream-available', () => {
                    console.log('No hay stream disponible, intentando HLS...');
                    connectHLS();
                });
                
            } catch (error) {
                console.error('Error en WebRTC:', error);
                throw error;
            }
        }
        
        // Conectar usando HLS (fallback)
        function connectHLS() {
            const video = document.getElementById('remoteVideo');
            const videoSrc = 'http://localhost:8000/live/congreso/index.m3u8';
            
            if (Hls.isSupported()) {
                const hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90
                });
                
                hls.loadSource(videoSrc);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play().catch(e => console.log('Autoplay bloqueado:', e));
                    isStreamConnected = true;
                    streamMode = 'hls';
                    console.log('✅ Conectado via HLS');
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        console.error('Error fatal HLS:', data);
                        alert('No se pudo conectar al stream');
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // iOS Safari nativo
                video.src = videoSrc;
                video.addEventListener('loadedmetadata', () => {
                    video.play().catch(e => console.log('Autoplay bloqueado:', e));
                    isStreamConnected = true;
                    streamMode = 'hls';
                });
            } else {
                alert('Tu navegador no soporta streaming HLS');
            }
            
            // Notificar que está viendo
            if (streamSocket) {
                streamSocket.emit('viewer-joined', {
                    diputadoId: user.id,
                    nombre: user.nombre_completo || user.nombre
                });
            }
        }
        
        // Cerrar stream
        function closeLiveStream() {
            const container = document.getElementById('streamContainer');
            container.style.display = 'none';
            
            const video = document.getElementById('remoteVideo');
            video.pause();
            
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            if (consumer) {
                consumer.close();
                consumer = null;
            }
            
            if (transport) {
                transport.close();
                transport = null;
            }
            
            isStreamConnected = false;
            
            // Notificar desconexión
            if (streamSocket) {
                streamSocket.emit('viewer-left', {
                    diputadoId: user.id
                });
            }
        }
        
        // Picture in Picture
        async function togglePiP() {
            const video = document.getElementById('remoteVideo');
            
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else if (document.pictureInPictureEnabled) {
                    await video.requestPictureInPicture();
                } else {
                    alert('Picture-in-Picture no está soportado en este navegador');
                }
            } catch (error) {
                console.error('Error en PiP:', error);
            }
        }
        
        // Pantalla completa
        function toggleFullscreen() {
            const container = document.getElementById('streamContainer');
            
            if (!document.fullscreenElement) {
                container.classList.add('fullscreen');
                container.requestFullscreen().catch(err => {
                    console.error('Error en pantalla completa:', err);
                });
            } else {
                document.exitFullscreen();
                container.classList.remove('fullscreen');
            }
        }
        
        // Modo minimal
        function toggleMinimal() {
            const container = document.getElementById('streamContainer');
            container.classList.toggle('minimal');
        }
        
        // Cambiar calidad
        async function changeQuality(quality) {
            if (streamMode === 'webrtc' && consumer && streamSocket) {
                streamSocket.emit('change-quality', {
                    consumerId: consumer.id,
                    quality
                });
            }
            // Para HLS, la calidad se adapta automáticamente
        }
        
        // Inicializar conexión de streaming al cargar
        connectStreamingServer();
        
        // Inicializar al cargar
        loadSystemConfig();
        if (typeof setupRecordatorioListener === 'function') {
            setupRecordatorioListener();
        }
    </script>

    <!-- Modal de Recordatorios para Presidente -->
    <div class="modal fade" id="recordatoriosModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-bell"></i> Enviar Recordatorios de Votación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="iniciativaInfo" class="alert alert-light mb-3"></div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Diputados que no han votado: <span id="totalSinVoto" class="badge bg-danger">0</span></h6>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Diputado</th>
                                    <th>Partido</th>
                                    <th>Cargo</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="listaDiputadosSinVoto">
                                <tr><td colspan="4" class="text-center">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 193, 7, 0.5); }
            100% { transform: scale(1); }
        }
        
        .pulse-animation {
            animation: pulse 1s infinite;
        }
    </style>
    
    <!-- Modal para tablero simplificado -->
    <div class="modal fade" id="tableroModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-th"></i> Tablero de Votación Simplificado
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div id="tableroSimplificado">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Configuración Personal -->
    <div class="modal fade" id="modalConfiguracion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-cog"></i> Configuración Personal
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formConfiguracion">
                        <div class="row">
                            <div class="col-md-4 text-center mb-3">
                                <div class="position-relative">
                                    <img id="previewFoto" src="/images/diputados/default.png" alt="Foto" 
                                         class="img-thumbnail mb-2" style="width: 150px; height: 150px; object-fit: cover;">
                                    <div class="mt-2">
                                        <label for="inputFoto" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-camera"></i> Cambiar Foto
                                        </label>
                                        <input type="file" id="inputFoto" class="d-none" accept="image/*" onchange="previewImage(this)">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Nombre Completo</label>
                                    <input type="text" class="form-control" id="configNombre" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Usuario de Acceso</label>
                                    <input type="text" class="form-control" id="configUsuario" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nueva Contraseña</label>
                                    <input type="password" class="form-control" id="configPassword" 
                                           placeholder="Dejar vacío para mantener la actual">
                                    <small class="text-muted">Mínimo 6 caracteres</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Confirmar Contraseña</label>
                                    <input type="password" class="form-control" id="configPasswordConfirm" 
                                           placeholder="Repetir nueva contraseña">
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label text-muted">Partido <small>(no editable)</small></label>
                                    <input type="text" class="form-control" id="configPartido" readonly disabled
                                           style="background-color: #e9ecef; cursor: not-allowed; opacity: 0.7;">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label text-muted">Cargo <small>(no editable)</small></label>
                                    <input type="text" class="form-control" id="configCargo" readonly disabled
                                           style="background-color: #e9ecef; cursor: not-allowed; opacity: 0.7;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Nota:</strong> Solo puedes modificar tu nombre, usuario, contraseña y fotografía.
                            <br>El partido y cargo son asignados por el administrador del sistema.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarConfiguracion()">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Función para mostrar notificación de resultado
        function mostrarNotificacionResultado(data) {
            // Obtener los resultados de la última votación
            fetch('/api/diputado/ultima-votacion-resultado', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(resultado => {
                if (resultado && resultado.conteo) {
                    const notification = document.createElement('div');
                    notification.className = 'result-notification';
                    notification.innerHTML = `
                        <div class="notification-header">
                            <h5 class="mb-0">
                                <i class="fas fa-poll"></i> Votación Cerrada
                            </h5>
                            <button class="btn btn-sm btn-light" onclick="this.closest('.result-notification').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="notification-body">
                            <h6>${resultado.descripcion || 'Iniciativa votada'}</h6>
                            <div class="result-stats">
                                <div class="stat-item">
                                    <div class="stat-circle favor">${resultado.conteo.favor || 0}</div>
                                    <small>A Favor</small>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-circle contra">${resultado.conteo.contra || 0}</div>
                                    <small>En Contra</small>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-circle abstencion">${resultado.conteo.abstencion || 0}</div>
                                    <small>Abstención</small>
                                </div>
                            </div>
                            <div class="mt-3 text-center">
                                <strong>Resultado: </strong>
                                <span class="badge ${resultado.aprobada ? 'bg-success' : 'bg-danger'}">
                                    ${resultado.aprobada ? 'APROBADA' : 'RECHAZADA'}
                                </span>
                            </div>
                            <div class="countdown-bar">
                                <div class="countdown-progress"></div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Auto-cerrar después de 10 segundos
                    setTimeout(() => {
                        notification.remove();
                    }, 10000);
                }
            })
            .catch(error => console.error('Error obteniendo resultado:', error));
        }
        
        // Función para ver tablero simplificado
        function verTableroSimplificado() {
            toggleMenu();
            
            // Obtener estado actual del tablero
            fetch('/api/pantalla/estado')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('tableroSimplificado');
                    
                    if (data.estado === 'sin_actividad') {
                        container.innerHTML = `
                            <div class="text-center py-5">
                                <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                                <h5>Sin actividad de votación</h5>
                                <p class="text-muted">No hay votaciones activas en este momento</p>
                            </div>
                        `;
                    } else {
                        // Crear tabla simplificada
                        container.innerHTML = `
                            <div class="mb-3">
                                <h6>Iniciativa: ${data.iniciativa.descripcion || 'Sin descripción'}</h6>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-success">${data.conteo.favor}</h3>
                                            <p>A Favor</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-danger">${data.conteo.contra}</h3>
                                            <p>En Contra</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-warning">${data.conteo.abstencion}</h3>
                                            <p>Abstención</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <h6>Detalle de Votos:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Diputado</th>
                                                <th>Partido</th>
                                                <th>Voto</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.votos.map(v => `
                                                <tr>
                                                    <td>${v.nombre_completo}</td>
                                                    <td><small>${v.partido || 'N/A'}</small></td>
                                                    <td>
                                                        ${v.voto === 'favor' ? '<span class="badge bg-success">A Favor</span>' :
                                                          v.voto === 'contra' ? '<span class="badge bg-danger">En Contra</span>' :
                                                          v.voto === 'abstencion' ? '<span class="badge bg-warning">Abstención</span>' :
                                                          '<span class="badge bg-secondary">Sin voto</span>'}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Mostrar modal
                    const modal = new bootstrap.Modal(document.getElementById('tableroModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar el tablero');
                });
        }
        
        // Función para ver historial de votaciones
        function verHistorialVotaciones() {
            toggleMenu();
            window.location.href = '#historial';
            document.getElementById('historialTab').click();
        }
        
        // Función para ver estadísticas
        function verEstadisticas() {
            toggleMenu();
            alert('Función de estadísticas en desarrollo');
        }
        
        // Funciones para el Presidente de la Mesa Directiva
        async function verIniciativasCargadas() {
            toggleMenu();
            
            if (!isPresidente) {
                alert('Solo el Presidente de la Mesa Directiva puede acceder a esta función');
                return;
            }
            
            // Mostrar las iniciativas cargadas para la sesión actual
            try {
                const response = await fetch('/api/diputado/iniciativas-sesion', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al obtener iniciativas');
                }
                
                const data = await response.json();
                
                // Mostrar modal con las iniciativas
                mostrarModalIniciativas(data.iniciativas || []);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al obtener las iniciativas de la sesión');
            }
        }
        
        // Función para mostrar modal con iniciativas
        function mostrarModalIniciativas(iniciativas) {
            // Crear modal si no existe
            let modal = document.getElementById('modalIniciativasPresidente');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modalIniciativasPresidente';
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">Iniciativas de la Sesión</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="modalIniciativasBody">
                                <!-- Contenido dinámico -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Llenar contenido
            const bodyElement = document.getElementById('modalIniciativasBody');
            if (iniciativas.length === 0) {
                bodyElement.innerHTML = '<p class="text-center text-muted">No hay iniciativas cargadas para esta sesión</p>';
            } else {
                bodyElement.innerHTML = `
                    <div class="list-group">
                        ${iniciativas.map((init, index) => `
                            <div class="list-group-item">
                                <h6 class="mb-1">${index + 1}. ${init.titulo || init.descripcion}</h6>
                                <p class="mb-1 small">${init.descripcion || ''}</p>
                                <small class="text-muted">
                                    ${init.presentador ? `Presentador: ${init.presentador}` : ''}
                                    ${init.tipo_mayoria ? ` | Mayoría: ${init.tipo_mayoria}` : ''}
                                </small>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Mostrar modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // Mantener compatibilidad con llamadas anteriores
        async function verListaIniciativas() {
            verIniciativasCargadas();
        }
        
        // Función original que ya no se usa pero mantenemos por compatibilidad
        async function verListaIniciativasOriginal() {
            toggleMenu();
            
            if (!isPresidente) {
                alert('Solo el Presidente de la Mesa Directiva puede acceder a esta función');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('gestionIniciativasModal'));
            modal.show();
            
            // Cargar estado del quórum
            actualizarEstadoQuorum();
            
            try {
                const response = await fetch('/api/diputado/iniciativas-sesion', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    mostrarIniciativasPresidente(data.iniciativas || []);
                } else {
                    document.getElementById('listaIniciativasPresidente').innerHTML = 
                        '<p class="text-danger">Error al cargar iniciativas</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('listaIniciativasPresidente').innerHTML = 
                    '<p class="text-danger">Error de conexión</p>';
            }
        }
        
        // Función para actualizar el estado del quórum
        async function actualizarEstadoQuorum() {
            try {
                const response = await fetch('/api/diputado/estado-quorum', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Actualizar números
                    document.getElementById('quorumPresentes').textContent = data.presentes || 0;
                    document.getElementById('quorumRequerido').textContent = data.quorum_minimo || 0;
                    document.getElementById('quorumTotal').textContent = data.total_diputados || 0;
                    
                    // Calcular porcentaje
                    const porcentaje = data.total_diputados > 0 
                        ? Math.round((data.presentes / data.total_diputados) * 100) 
                        : 0;
                    
                    // Actualizar barra de progreso
                    const progressBar = document.getElementById('quorumProgressBar');
                    progressBar.style.width = `${porcentaje}%`;
                    progressBar.setAttribute('aria-valuenow', porcentaje);
                    document.getElementById('quorumProgressText').textContent = `${porcentaje}%`;
                    
                    // Determinar estado y color
                    const hayQuorum = data.presentes >= data.quorum_minimo;
                    const statusBadge = document.getElementById('quorumStatus');
                    
                    if (hayQuorum) {
                        progressBar.className = 'progress-bar bg-success';
                        statusBadge.innerHTML = '<span class="badge bg-success">✓ Quórum alcanzado</span>';
                    } else {
                        const faltantes = data.quorum_minimo - data.presentes;
                        progressBar.className = 'progress-bar bg-warning';
                        statusBadge.innerHTML = `<span class="badge bg-warning">⚠ Faltan ${faltantes} diputados</span>`;
                    }
                }
            } catch (error) {
                console.error('Error actualizando quórum:', error);
                document.getElementById('quorumStatus').innerHTML = 
                    '<span class="badge bg-danger">Error al obtener quórum</span>';
            }
        }
        
        // Variables para filtros y selección múltiple
        let iniciativasGlobales = [];
        let filtroActualPresidente = 'todas';
        let modoSeleccionMultiple = false;
        let iniciativasSeleccionadas = new Set();
        
        function mostrarIniciativasPresidente(iniciativas) {
            iniciativasGlobales = iniciativas;
            const container = document.getElementById('listaIniciativasPresidente');
            
            if (iniciativas.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No hay iniciativas en la sesión actual</p>';
                return;
            }
            
            // Aplicar filtro
            let iniciativasFiltradas = filtrarIniciativas(iniciativas, filtroActualPresidente);
            
            container.innerHTML = `
                <div class="list-group">
                    ${iniciativasFiltradas.map(init => {
                        // Truncar texto y preparar tooltip
                        const textoCompleto = init.descripcion || init.titulo || 'Sin descripción';
                        const textoTruncado = textoCompleto.length > 200 ? 
                            textoCompleto.substring(0, 200) + '...' : textoCompleto;
                        
                        // Estado de la iniciativa
                        let estadoBadge = '';
                        let colorItem = '';
                        if (init.cerrada && init.resultado) {
                            estadoBadge = '<span class="badge bg-success ms-2">✓ VOTADA</span>';
                            colorItem = 'border-success';
                        } else if (init.activa) {
                            estadoBadge = '<span class="badge bg-warning ms-2">EN VOTACIÓN</span>';
                            colorItem = 'border-warning';
                        } else {
                            estadoBadge = '<span class="badge bg-secondary ms-2">PENDIENTE</span>';
                            colorItem = '';
                        }
                        
                        return `
                        <div class="list-group-item ${colorItem}" data-id="${init.id}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    ${modoSeleccionMultiple ? `
                                        <div class="form-check d-inline-block me-2">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="check_${init.id}" 
                                                   onchange="toggleSeleccionIniciativa(${init.id})"
                                                   ${iniciativasSeleccionadas.has(init.id) ? 'checked' : ''}>
                                        </div>
                                    ` : ''}
                                    <h6 class="mb-1 d-inline-block" 
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="${textoCompleto.replace(/"/g, '&quot;')}">
                                        ${init.numero}. ${textoTruncado}
                                        ${estadoBadge}
                                    </h6>
                                    ${init.presentador ? `<small class="text-muted d-block">Por: ${init.presentador}</small>` : ''}
                                    ${init.partido ? `<small class="text-muted">Partido: ${init.partido}</small>` : ''}
                                    ${textoCompleto.length > 200 ? `
                                        <button class="btn btn-link btn-sm p-0 ms-2" onclick="verDetalleIniciativa(${init.id})">
                                            <i class="fas fa-eye"></i> Ver más
                                        </button>
                                    ` : ''}
                                </div>
                                <div>
                                    ${!init.activa && !init.cerrada ? `
                                        <button class="btn btn-sm btn-success" onclick="activarIniciativaPresidente(${init.id})" 
                                                title="Activar para votación">
                                            <i class="fas fa-play"></i> Activar
                                        </button>
                                    ` : ''}
                                    ${init.activa ? `
                                        <button class="btn btn-sm btn-danger" onclick="cerrarVotacionPresidente(${init.id})"
                                                title="Cerrar votación">
                                            <i class="fas fa-stop"></i> Cerrar
                                        </button>
                                    ` : ''}
                                    ${init.cerrada && init.resultado ? `
                                        <button class="btn btn-sm btn-info" onclick="verResultadoIniciativa(${init.id})"
                                                title="Ver resultado de votación">
                                            <i class="fas fa-chart-bar"></i> Resultado
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Inicializar tooltips de Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Función para filtrar iniciativas
        function filtrarIniciativas(iniciativas, filtro) {
            switch(filtro) {
                case 'votadas':
                    return iniciativas.filter(i => i.cerrada && i.resultado);
                case 'pendientes':
                    return iniciativas.filter(i => !i.activa && !i.cerrada);
                case 'activas':
                    return iniciativas.filter(i => i.activa);
                default:
                    return iniciativas;
            }
        }
        
        // Filtrar iniciativas del presidente
        function filtrarIniciativasPresidente(filtro) {
            filtroActualPresidente = filtro;
            
            // Actualizar botones activos
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.onclick.toString().includes(filtro)) {
                    btn.classList.add('active');
                }
            });
            
            mostrarIniciativasPresidente(iniciativasGlobales);
        }
        
        // Toggle selección múltiple
        function toggleSeleccionMultiple() {
            modoSeleccionMultiple = document.getElementById('seleccionMultiple').checked;
            document.getElementById('accionesMultiples').style.display = 
                modoSeleccionMultiple ? 'block' : 'none';
            
            if (!modoSeleccionMultiple) {
                iniciativasSeleccionadas.clear();
            }
            
            mostrarIniciativasPresidente(iniciativasGlobales);
        }
        
        // Toggle selección de iniciativa
        function toggleSeleccionIniciativa(id) {
            if (iniciativasSeleccionadas.has(id)) {
                iniciativasSeleccionadas.delete(id);
            } else {
                iniciativasSeleccionadas.add(id);
            }
            actualizarContadorSeleccionadas();
        }
        
        // Actualizar contador
        function actualizarContadorSeleccionadas() {
            document.getElementById('contadorSeleccionadas').textContent = 
                `${iniciativasSeleccionadas.size} seleccionadas`;
        }
        
        // Seleccionar todas
        function seleccionarTodas() {
            const checkboxes = document.querySelectorAll('#listaIniciativasPresidente input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                const id = parseInt(cb.id.replace('check_', ''));
                iniciativasSeleccionadas.add(id);
            });
            actualizarContadorSeleccionadas();
        }
        
        // Deseleccionar todas
        function deseleccionarTodas() {
            const checkboxes = document.querySelectorAll('#listaIniciativasPresidente input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            iniciativasSeleccionadas.clear();
            actualizarContadorSeleccionadas();
        }
        
        // Votar seleccionadas
        async function votarSeleccionadas() {
            if (iniciativasSeleccionadas.size === 0) {
                alert('No hay iniciativas seleccionadas');
                return;
            }
            
            if (!confirm(`¿Activar ${iniciativasSeleccionadas.size} iniciativas para votación simultánea?`)) {
                return;
            }
            
            // Aquí implementar la lógica para votar múltiples iniciativas
            alert('Función en desarrollo: Votación múltiple');
        }
        
        // Ver detalle de iniciativa en modal
        function verDetalleIniciativa(id) {
            const iniciativa = iniciativasGlobales.find(i => i.id === id);
            if (!iniciativa) return;
            
            const modal = new bootstrap.Modal(document.getElementById('modalDetalleIniciativa'));
            document.getElementById('detalleIniciativaTitulo').textContent = 
                `Iniciativa #${iniciativa.numero}`;
            document.getElementById('detalleIniciativaContenido').innerHTML = `
                <h5>${iniciativa.titulo || 'Sin título'}</h5>
                <p class="text-muted">${iniciativa.descripcion || 'Sin descripción'}</p>
                <hr>
                <p><strong>Presentador:</strong> ${iniciativa.presentador || 'No especificado'}</p>
                <p><strong>Partido:</strong> ${iniciativa.partido || 'No especificado'}</p>
                <p><strong>Tipo de Mayoría:</strong> ${iniciativa.tipo_mayoria || 'Simple'}</p>
                ${iniciativa.observaciones ? `<p><strong>Observaciones:</strong> ${iniciativa.observaciones}</p>` : ''}
            `;
            modal.show();
        }
        }
        
        async function activarIniciativaPresidente(id, force = false) {
            if (!force && !confirm('¿Activar esta iniciativa para votación?')) return;
            
            try {
                const response = await fetch(`/api/diputado/activar-iniciativa/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ force })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Mostrar mensaje específico si se cerró otra iniciativa
                    if (data.iniciativa_cerrada) {
                        alert(`Se cerró la iniciativa #${data.iniciativa_cerrada.numero} y se activó la #${data.iniciativa.numero}`);
                    } else {
                        alert('Iniciativa activada para votación');
                    }
                    
                    verListaIniciativas(); // Recargar lista
                    checkActiveInitiative(); // Actualizar panel principal
                    
                } else if (response.status === 409) {
                    // Hay otra iniciativa activa, preguntar confirmación
                    const data = await response.json();
                    
                    const confirmar = confirm(
                        `${data.mensaje}\n\n` +
                        `Iniciativa activa actual:\n` +
                        `#${data.iniciativa_activa.numero}: ${data.iniciativa_activa.titulo}\n\n` +
                        `¿Desea cerrarla y activar la nueva?`
                    );
                    
                    if (confirmar) {
                        // Llamar de nuevo con force=true
                        activarIniciativaPresidente(id, true);
                    }
                } else if (response.status === 412) {
                    // Quórum insuficiente
                    const data = await response.json();
                    
                    // Crear mensaje informativo detallado
                    let mensajeQuorum = `⚠️ ADVERTENCIA: QUÓRUM INSUFICIENTE\n\n`;
                    mensajeQuorum += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
                    mensajeQuorum += `Diputados presentes: ${data.presentes} de ${data.total_diputados}\n`;
                    mensajeQuorum += `Quórum requerido: ${data.quorum_requerido} diputados\n`;
                    mensajeQuorum += `Tipo de mayoría: ${data.tipo_mayoria.toUpperCase()}\n`;
                    mensajeQuorum += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n`;
                    mensajeQuorum += `${data.mensaje}\n\n`;
                    mensajeQuorum += `¿Desea forzar la activación sin quórum?\n`;
                    mensajeQuorum += `(Esta acción quedará registrada en el sistema)`;
                    
                    const confirmar = confirm(mensajeQuorum);
                    
                    if (confirmar) {
                        // Confirmar nuevamente por la importancia de la acción
                        const confirmarSegundo = confirm(
                            '⚠️ CONFIRMACIÓN FINAL\n\n' +
                            'Está a punto de activar una iniciativa SIN el quórum necesario.\n' +
                            'Esta acción es excepcional y quedará registrada.\n\n' +
                            '¿Está seguro de continuar?'
                        );
                        
                        if (confirmarSegundo) {
                            // Llamar de nuevo con force=true
                            activarIniciativaPresidente(id, true);
                        }
                    }
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al activar iniciativa');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al activar la iniciativa');
            }
        }
        
        async function cerrarVotacionPresidente(id) {
            if (!confirm('¿Cerrar la votación de esta iniciativa?')) return;
            
            try {
                const response = await fetch(`/api/diputado/cerrar-votacion/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Votación cerrada. Resultado: ${data.resultado}`);
                    verListaIniciativas(); // Recargar lista
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al cerrar votación');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cerrar la votación');
            }
        }
        
        function verDiputadosPresentes() {
            toggleMenu();
            if (!isPresidente) {
                alert('Solo el Presidente de la Mesa Directiva puede acceder a esta función');
                return;
            }
            alert('Función de quórum en desarrollo');
        }
        
        // Las funciones abrirConfiguracion, guardarConfiguracion y previewImage ya están definidas al inicio del archivo
        
        // Función duplicada eliminada - guardarConfiguracion ya está definida arriba
        /*
        async function guardarConfiguracion_OLD() {
            const nombre = document.getElementById('configNombre').value.trim();
            const usuario = document.getElementById('configUsuario').value.trim();
            const password = document.getElementById('configPassword').value;
            const passwordConfirm = document.getElementById('configPasswordConfirm').value;
            
            // Validaciones
            if (!nombre || !usuario) {
                alert('El nombre y usuario son obligatorios');
                return;
            }
            
            if (password && password !== passwordConfirm) {
                alert('Las contraseñas no coinciden');
                return;
            }
            
            if (password && password.length < 6) {
                alert('La contraseña debe tener al menos 6 caracteres');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('nombre', nombre);
                formData.append('usuario', usuario);
                
                if (password) {
                    formData.append('password', password);
                }
                
                // Agregar foto si se seleccionó una
                const inputFoto = document.getElementById('inputFoto');
                if (inputFoto.files && inputFoto.files[0]) {
                    formData.append('fotografia', inputFoto.files[0]);
                }
                
                const response = await fetch('/api/diputado/actualizar-perfil', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Configuración actualizada correctamente');
                    
                    // Actualizar datos locales del usuario
                    user.nombre = nombre;
                    user.usuario = usuario;
                    if (data.fotografia) {
                        user.fotografia = data.fotografia;
                    }
                    
                    // Actualizar header con el nuevo nombre
                    document.getElementById('deputyName').textContent = nombre;
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('modalConfiguracion')).hide();
                    
                    // Si cambió el usuario, sugerir relogin
                    if (usuario !== user.usuario) {
                        if (confirm('Has cambiado tu usuario. ¿Deseas cerrar sesión para ingresar con tu nuevo usuario?')) {
                            logout();
                        }
                    }
                } else {
                    alert(data.error || 'Error al actualizar la configuración');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar la configuración');
            }
        }
        */

        // Funciones de Servicios Legislativos
        let iniciativasExtraccion = [];
        
        function abrirServiciosLegislativos() {
            toggleMenu();
            
            if (!isPresidente && !isSecretario) {
                alert('Solo el Presidente o Secretario de la Mesa Directiva pueden acceder a esta función');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalServiciosLegislativos'));
            modal.show();
            
            // Cargar iniciativas existentes
            cargarIniciativasSesion();
        }
        
        // Cargar iniciativas de la sesión
        async function cargarIniciativasSesion() {
            try {
                const response = await fetch('/api/diputado/iniciativas-sesion', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    mostrarIniciativasSesion(data.iniciativas || []);
                }
            } catch (error) {
                console.error('Error cargando iniciativas:', error);
            }
        }
        
        // Mostrar iniciativas en la tabla
        function mostrarIniciativasSesion(iniciativas) {
            const container = document.getElementById('listaIniciativasSesion');
            
            if (iniciativas.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay iniciativas cargadas para esta sesión</p>';
                return;
            }
            
            let html = `
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Título</th>
                            <th>Presentador</th>
                            <th>Tipo Mayoría</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            iniciativas.forEach((ini, index) => {
                const estado = ini.activa ? 'En Votación' : (ini.cerrada ? 'Cerrada' : 'Pendiente');
                const badgeClass = ini.activa ? 'success' : (ini.cerrada ? 'secondary' : 'warning');
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${ini.titulo}</td>
                        <td>${ini.presentador || '-'}</td>
                        <td>${ini.tipo_mayoria}</td>
                        <td><span class="badge bg-${badgeClass}">${estado}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editarIniciativa(${ini.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="eliminarIniciativa(${ini.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Descargar plantilla Excel
        function descargarPlantillaExcel() {
            window.location.href = '/api/diputado/servicios-legislativos/plantilla-excel';
        }
        
        // Cargar Excel
        document.getElementById('formCargarExcel').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const archivo = document.getElementById('archivoExcel').files[0];
            formData.append('archivo', archivo);
            
            try {
                const response = await fetch('/api/diputado/servicios-legislativos/cargar-excel', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Se cargaron ${data.iniciativas.length} iniciativas correctamente`);
                    cargarIniciativasSesion();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error al cargar el archivo Excel');
                console.error(error);
            }
        });
        
        // Cargar PDF
        document.getElementById('formCargarPDF').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const archivo = document.getElementById('archivoPDF').files[0];
            formData.append('archivo', archivo);
            
            try {
                const response = await fetch('/api/diputado/servicios-legislativos/cargar-pdf', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    iniciativasExtraccion = data.iniciativas;
                    mostrarIniciativasExtraidas(data.iniciativas);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error al procesar el archivo PDF');
                console.error(error);
            }
        });
        
        // Mostrar iniciativas extraídas del PDF
        function mostrarIniciativasExtraidas(iniciativas) {
            const container = document.getElementById('listaExtraccion');
            let html = '<div class="list-group">';
            
            iniciativas.forEach((ini, index) => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6>${index + 1}. ${ini.titulo}</h6>
                                <p class="mb-1 text-muted small">${ini.descripcion || ''}</p>
                                <small>
                                    ${ini.presentador ? `Presentador: ${ini.presentador}` : ''}
                                    ${ini.partido ? ` | Partido: ${ini.partido}` : ''}
                                    | Mayoría: ${ini.tipo_mayoria}
                                </small>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="quitarIniciativaExtraccion(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            document.getElementById('resultadoExtraccion').style.display = 'block';
        }
        
        // Quitar iniciativa de la extracción
        function quitarIniciativaExtraccion(index) {
            iniciativasExtraccion.splice(index, 1);
            mostrarIniciativasExtraidas(iniciativasExtraccion);
            
            if (iniciativasExtraccion.length === 0) {
                document.getElementById('resultadoExtraccion').style.display = 'none';
            }
        }
        
        // Confirmar extracción del PDF
        async function confirmarExtraccion() {
            if (iniciativasExtraccion.length === 0) {
                alert('No hay iniciativas para cargar');
                return;
            }
            
            try {
                const response = await fetch('/api/diputado/servicios-legislativos/confirmar-extraccion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ iniciativas: iniciativasExtraccion })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Se cargaron ${data.count} iniciativas correctamente`);
                    document.getElementById('resultadoExtraccion').style.display = 'none';
                    document.getElementById('archivoPDF').value = '';
                    cargarIniciativasSesion();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error al confirmar las iniciativas');
                console.error(error);
            }
        }
        
        // Captura manual
        document.getElementById('formCapturaManual').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const iniciativa = {
                titulo: document.getElementById('manualTitulo').value,
                descripcion: document.getElementById('manualDescripcion').value,
                presentador: document.getElementById('manualPresentador').value,
                partido: document.getElementById('manualPartido').value,
                tipo_mayoria: document.getElementById('manualTipoMayoria').value,
                tipo_iniciativa: document.getElementById('manualTipoIniciativa').value
            };
            
            try {
                const response = await fetch('/api/diputado/servicios-legislativos/captura-manual', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(iniciativa)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Iniciativa guardada correctamente');
                    document.getElementById('formCapturaManual').reset();
                    cargarIniciativasSesion();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error al guardar la iniciativa');
                console.error(error);
            }
        });
        
        // Editar iniciativa
        async function editarIniciativa(id) {
            // Por ahora solo mostramos alerta
            alert('Función de edición en desarrollo');
        }
        
        // Eliminar iniciativa
        async function eliminarIniciativa(id) {
            if (!confirm('¿Está seguro de eliminar esta iniciativa?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/diputado/servicios-legislativos/iniciativa/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('Iniciativa eliminada correctamente');
                    cargarIniciativasSesion();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error al eliminar la iniciativa');
                console.error(error);
            }
        }
    </script>

    <!-- Modal de Pausa de Sesión -->
    <div class="modal fade" id="modalPausa" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-pause-circle"></i> Pausar Sesión Legislativa
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Seleccione el tiempo de pausa:</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-warning" onclick="pausarSesion(5)">
                            <i class="fas fa-clock"></i> 5 minutos
                        </button>
                        <button class="btn btn-outline-warning" onclick="pausarSesion(10)">
                            <i class="fas fa-clock"></i> 10 minutos
                        </button>
                        <button class="btn btn-outline-warning" onclick="pausarSesion(15)">
                            <i class="fas fa-clock"></i> 15 minutos
                        </button>
                        <button class="btn btn-outline-warning" onclick="pausarSesion(30)">
                            <i class="fas fa-clock"></i> 30 minutos
                        </button>
                        <button class="btn btn-outline-danger" onclick="pausarSesion(0)">
                            <i class="fas fa-infinity"></i> Tiempo indefinido
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timer de Pausa Flotante -->
    <div id="pausaTimer" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 9999; background: rgba(255, 193, 7, 0.95); padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h5 class="mb-2 text-dark">
            <i class="fas fa-pause-circle"></i> Sesión en Pausa
        </h5>
        <div id="timerDisplay" class="text-center">
            <h2 class="mb-0 text-dark" id="timerCount">00:00</h2>
            <small class="text-dark" id="timerMessage">Tiempo restante</small>
        </div>
    </div>

    <script>
        let pausaInterval = null;
        let tiempoRestante = 0;

        function mostrarModalPausa() {
            const modal = new bootstrap.Modal(document.getElementById('modalPausa'));
            modal.show();
        }

        async function pausarSesion(minutos) {
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('modalPausa')).hide();
            
            try {
                const response = await fetch('/api/diputado/pausar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ minutos })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Ocultar botón pausar, mostrar reanudar
                    document.getElementById('btnPausarSesion').style.display = 'none';
                    document.getElementById('btnReanudarSesion').style.display = 'block';
                    
                    // Iniciar timer visual
                    if (minutos > 0) {
                        iniciarTimer(minutos * 60);
                    } else {
                        mostrarPausaIndefinida();
                    }
                    
                    alert(`Sesión pausada por ${minutos > 0 ? minutos + ' minutos' : 'tiempo indefinido'}`);
                } else {
                    const error = await response.json();
                    alert(error.error || 'Error al pausar la sesión');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al pausar la sesión');
            }
        }

        async function reanudarSesion() {
            if (!confirm('¿Desea reanudar la sesión?')) return;
            
            try {
                const response = await fetch('/api/diputado/reanudar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    // Ocultar reanudar, mostrar pausar
                    document.getElementById('btnReanudarSesion').style.display = 'none';
                    document.getElementById('btnPausarSesion').style.display = 'block';
                    
                    // Detener timer
                    detenerTimer();
                    
                    alert('Sesión reanudada');
                } else {
                    const error = await response.json();
                    alert(error.error || 'Error al reanudar la sesión');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al reanudar la sesión');
            }
        }

        function iniciarTimer(segundos) {
            tiempoRestante = segundos;
            document.getElementById('pausaTimer').style.display = 'block';
            
            actualizarTimer();
            
            pausaInterval = setInterval(() => {
                tiempoRestante--;
                actualizarTimer();
                
                if (tiempoRestante <= 0) {
                    detenerTimer();
                    notificarFinPausa();
                }
            }, 1000);
        }

        function actualizarTimer() {
            const minutos = Math.floor(tiempoRestante / 60);
            const segundos = tiempoRestante % 60;
            document.getElementById('timerCount').textContent = 
                `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
        }

        function mostrarPausaIndefinida() {
            document.getElementById('pausaTimer').style.display = 'block';
            document.getElementById('timerCount').textContent = '∞';
            document.getElementById('timerMessage').textContent = 'Pausa indefinida';
        }

        function detenerTimer() {
            if (pausaInterval) {
                clearInterval(pausaInterval);
                pausaInterval = null;
            }
            document.getElementById('pausaTimer').style.display = 'none';
        }

        function notificarFinPausa() {
            // Notificación visual y sonora
            alert('⏰ El tiempo de pausa ha terminado. La sesión puede continuar.');
            
            // Reproducir sonido si es posible
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
            audio.play().catch(e => console.log('No se pudo reproducir sonido'));
            
            // Cambiar botones
            document.getElementById('btnReanudarSesion').style.display = 'none';
            document.getElementById('btnPausarSesion').style.display = 'block';
        }

        // Escuchar eventos de WebSocket para sincronización
        socket.on('sesion-pausada', (data) => {
            if (data.minutos > 0) {
                iniciarTimer(data.minutos * 60);
            } else {
                mostrarPausaIndefinida();
            }
        });

        socket.on('sesion-reanudada', () => {
            detenerTimer();
        });
    </script>

    <!-- Modal Servicios Legislativos -->
    <div class="modal fade" id="modalServiciosLegislativos" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-file-alt"></i> Servicios Legislativos - Orden del Día
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Tabs de navegación -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#tabExcel">
                                <i class="fas fa-file-excel"></i> Cargar Excel
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#tabPDF">
                                <i class="fas fa-file-pdf"></i> Cargar PDF
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#tabManual">
                                <i class="fas fa-keyboard"></i> Captura Manual
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#tabIniciativas">
                                <i class="fas fa-list"></i> Iniciativas Cargadas
                            </a>
                        </li>
                    </ul>

                    <!-- Contenido de tabs -->
                    <div class="tab-content">
                        <!-- Tab Excel -->
                        <div class="tab-pane fade show active" id="tabExcel">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Cargar desde archivo Excel</h6>
                                    <p class="text-muted">Sube un archivo Excel con las iniciativas de la sesión</p>
                                    
                                    <div class="mb-3">
                                        <button class="btn btn-info btn-sm" onclick="descargarPlantillaExcel()">
                                            <i class="fas fa-download"></i> Descargar Plantilla
                                        </button>
                                    </div>
                                    
                                    <form id="formCargarExcel">
                                        <div class="mb-3">
                                            <input type="file" class="form-control" id="archivoExcel" accept=".xlsx,.xls" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-upload"></i> Cargar Iniciativas
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Tab PDF -->
                        <div class="tab-pane fade" id="tabPDF">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Cargar desde archivo PDF</h6>
                                    <p class="text-muted">Sube un archivo PDF del orden del día para extraer automáticamente las iniciativas</p>
                                    
                                    <form id="formCargarPDF">
                                        <div class="mb-3">
                                            <input type="file" class="form-control" id="archivoPDF" accept=".pdf" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-upload"></i> Procesar PDF
                                        </button>
                                    </form>
                                    
                                    <div id="resultadoExtraccion" class="mt-3" style="display: none;">
                                        <h6>Iniciativas Extraídas</h6>
                                        <div id="listaExtraccion"></div>
                                        <button class="btn btn-success mt-3" onclick="confirmarExtraccion()">
                                            <i class="fas fa-check"></i> Confirmar y Cargar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Manual -->
                        <div class="tab-pane fade" id="tabManual">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Captura Manual de Iniciativa</h6>
                                    
                                    <form id="formCapturaManual">
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label>Título de la Iniciativa *</label>
                                                <input type="text" class="form-control" id="manualTitulo" required>
                                            </div>
                                            
                                            <div class="col-md-12 mb-3">
                                                <label>Descripción</label>
                                                <textarea class="form-control" id="manualDescripcion" rows="3"></textarea>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label>Presentador</label>
                                                <input type="text" class="form-control" id="manualPresentador">
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label>Partido/Fracción</label>
                                                <input type="text" class="form-control" id="manualPartido">
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label>Tipo de Mayoría *</label>
                                                <select class="form-control" id="manualTipoMayoria" required>
                                                    <option value="simple">Mayoría Simple</option>
                                                    <option value="absoluta">Mayoría Absoluta</option>
                                                    <option value="calificada">Mayoría Calificada (2/3)</option>
                                                    <option value="unanime">Unanimidad</option>
                                                </select>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label>Tipo de Iniciativa</label>
                                                <select class="form-control" id="manualTipoIniciativa">
                                                    <option value="ordinaria">Iniciativa Ordinaria</option>
                                                    <option value="decreto">Decreto</option>
                                                    <option value="punto_acuerdo">Punto de Acuerdo</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Guardar Iniciativa
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Iniciativas Cargadas -->
                        <div class="tab-pane fade" id="tabIniciativas">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Iniciativas de la Sesión</h6>
                                    <div id="listaIniciativasSesion" class="table-responsive">
                                        <!-- Se llenará dinámicamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/theme-switcher.js"></script>
</body>
</html>