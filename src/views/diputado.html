<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panel Diputado - Sistema de Votación</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/apple-theme.css">
    <link rel="stylesheet" href="/css/dark-theme.css">
    <link rel="stylesheet" href="/css/global-background.css">
    <script src="/js/theme-loader.js"></script>
    <style>
        body {
            background-color: var(--bg-primary);
            /* Prevenir zoom con pinch */
            touch-action: pan-x pan-y;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Permitir zoom solo en visualizador de PDF */
        .pdf-viewer, .pdf-container, iframe[src*="documentos-sesion"] {
            touch-action: auto !important;
            -webkit-user-select: text !important;
            user-select: text !important;
        }
        
        /* Fix z-index para navbar siempre al frente de todo */
        .navbar {
            background: var(--navbar-bg) !important;
            border-bottom: 1px solid var(--border-color);
            z-index: 9998 !important;
            position: sticky !important;
            top: 0;
        }
        
        /* El menú colapsado SIEMPRE al frente absoluto */
        .navbar-collapse {
            z-index: 99999 !important;
        }
        
        .navbar-collapse.collapsing,
        .navbar-collapse.show {
            z-index: 99999 !important;
            position: absolute !important;
            width: 100%;
            top: 56px !important; /* Altura del navbar */
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1a2332 0%, #263241 100%) !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8) !important;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Asegurar que todos los cards estén detrás */
        .card, .modal-backdrop {
            position: relative;
            z-index: 1 !important;
        }
        
        .container, .container-fluid {
            position: relative;
            z-index: 1 !important;
        }
        
        /* Header del diputado */
        .deputy-header {
            background: var(--bg-card);
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            padding: 25px;
            margin: 20px auto;
            max-width: 900px;
            border-left: 5px solid var(--color-primary);
            transition: all 0.3s;
        }
        
        .deputy-info {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
        }
        
        .deputy-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            font-weight: bold;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }
        
        .deputy-details {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .deputy-text-info {
            flex: 1;
        }
        
        .deputy-name {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .deputy-cargo {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }
        
        .deputy-commission {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .deputy-party {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .party-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            background-color: #6c757d;
        }
        
        .party-logo {
            height: 30px;
            max-width: 60px;
            object-fit: contain;
        }
        
        /* Contenedor de votación */
        .vote-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .vote-card {
            background: var(--bg-card);
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            padding: 30px;
            margin-top: 20px;
            position: relative;
        }
        
        /* Botones de votación mejorados */
        .vote-btn {
            width: 100%;
            height: 100px;
            position: relative;
            font-size: 26px;
            font-weight: bold;
            margin: 15px 0;
            border: 3px solid transparent;
            border-radius: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        /* Botones de asistencia */
        .attendance-btn {
            width: 100%;
            height: 100px;
            position: relative;
            font-size: 26px;
            font-weight: bold;
            margin: 15px 0;
            border: 3px solid transparent;
            border-radius: 15px;
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            color: white;
        }
        
        .attendance-btn.btn-presente {
            background: linear-gradient(135deg, #28A745 0%, #20c997 100%);
            border-color: #28A745;
        }
        
        .attendance-btn.btn-presente:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #20c997 0%, #28A745 100%);
        }
        
        .attendance-btn.btn-presente:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .attendance-btn.btn-ausente {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border-color: #6c757d;
        }
        
        .attendance-btn.btn-ausente:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(108, 117, 125, 0.4);
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
        }
        
        .attendance-btn.btn-ausente:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }
        
        .attendance-btn i {
            font-size: 35px;
        }
        
        .attendance-btn.selected {
            box-shadow: 0 0 0 5px rgba(0, 123, 255, 0.5);
            animation: pulse 1.5s infinite;
        }
        
        .vote-btn i {
            font-size: 32px;
        }
        
        .vote-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .vote-btn.selected {
            border-color: #333;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
            animation: selectedPulse 2s infinite;
        }
        
        @keyframes selectedPulse {
            0% { box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.8); }
            50% { box-shadow: 0 0 0 8px rgba(255, 255, 255, 0.4); }
            100% { box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.8); }
        }
        
        .btn-favor {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }
        
        .btn-favor:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
        }
        
        .btn-contra {
            background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
            color: white;
        }
        
        .btn-contra:hover {
            background: linear-gradient(135deg, #bd2130 0%, #a71d2a 100%);
        }
        
        .btn-abstencion {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            color: white;
        }
        
        .btn-abstencion:hover {
            background: linear-gradient(135deg, #545b62 0%, #383d42 100%);
        }
        
        /* Estado sin votación */
        .no-voting {
            text-align: center;
            padding: 80px 20px;
            color: #6c757d;
        }
        
        .no-voting i {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        /* Badge de votado */
        .voted-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .pulse-animation {
            animation: pulse 1s ease-in-out 3;
            border: 3px solid #ffc107 !important;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.5) !important;
        }
        
        /* Botón EN VIVO flotante */
        .live-button-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1050;
        }
        
        .btn-live {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-live:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.5);
        }
        
        .btn-live .live-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }
        
        /* Contenedor del stream */
        .stream-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 450px;
            max-width: 90vw;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1040;
            display: none;
            overflow: hidden;
        }
        
        .stream-header {
            background: linear-gradient(135deg, #212529, #343a40);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stream-header .live-badge {
            background: #dc3545;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stream-header .live-badge .live-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        
        .stream-video {
            width: 100%;
            height: auto;
            background: black;
        }
        
        .stream-controls {
            background: #f8f9fa;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        .stream-controls .btn-group-sm .btn {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .viewer-count {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #6c757d;
            font-size: 14px;
        }
        
        /* Modo pantalla completa */
        .stream-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            max-width: 100%;
            border-radius: 0;
            z-index: 9999;
        }
        
        .stream-container.fullscreen .stream-video {
            height: calc(100vh - 100px);
        }
        
        /* Responsive para móviles */
        @media (max-width: 767px) {
            .navbar-collapse {
                background-color: rgba(0, 0, 0, 0.1);
                padding: 1rem;
                margin-top: 1rem;
                border-radius: 8px;
            }
            
            .navbar-nav {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            .navbar-nav > span {
                margin-bottom: 0.5rem;
            }
            
            /* Fix para mesa directiva */
            .president-controls {
                position: relative;
                z-index: 1;
            }
            
            .navbar-toggler {
                z-index: 2000 !important;
                position: relative !important;
                pointer-events: auto !important;
                cursor: pointer !important;
                border: 1px solid rgba(255,255,255,0.5) !important;
                padding: 0.25rem 0.5rem !important;
                background-color: transparent !important;
                transition: all 0.3s ease !important;
            }
            
            .navbar-toggler:hover {
                background-color: rgba(255,255,255,0.1) !important;
                border-color: rgba(255,255,255,0.8) !important;
            }
            
            .navbar-toggler:focus {
                box-shadow: 0 0 0 0.25rem rgba(255,255,255,0.25) !important;
                outline: none !important;
            }
            
            #navbarContent {
                z-index: 9999 !important;
                background-color: inherit;
            }
            
            #navbarContent.show {
                display: block !important;
                z-index: 9999 !important;
            }
            
            /* Asegurar que el botón sea clickeable */
            .navbar-toggler-icon {
                pointer-events: none;
                display: inline-block;
                width: 1.5em;
                height: 1.5em;
                vertical-align: middle;
                background-repeat: no-repeat;
                background-position: center;
                background-size: 100%;
            }
            
            /* Fix específico para mesa directiva */
            .navbar.navbar-expand-lg .navbar-toggler {
                display: none !important;
            }
            
            @media (max-width: 991.98px) {
                .navbar.navbar-expand-lg .navbar-toggler {
                    display: inline-block !important;
                    z-index: 10002 !important;
                }
                
                .navbar-collapse {
                    position: absolute !important;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: linear-gradient(135deg, #1a2332 0%, #263241 100%) !important;
                    padding: 1rem;
                    box-shadow: 0 8px 16px rgba(0,0,0,0.5) !important;
                    border-bottom-left-radius: 10px;
                    border-bottom-right-radius: 10px;
                    z-index: 99999 !important;
                    backdrop-filter: blur(20px);
                    -webkit-backdrop-filter: blur(20px);
                }
                
                .navbar-collapse.show {
                    z-index: 99999 !important;
                    display: block !important;
                }
                
                #navbarContent {
                    z-index: 99999 !important;
                }
                
                /* Asegurar que el contenido del dropdown esté al frente */
                #navbarContent .navbar-nav {
                    z-index: 99999 !important;
                    position: relative;
                    background: transparent;
                }
                
                /* Todos los demás elementos deben estar detrás */
                .card, .deputy-header, .voting-panel {
                    max-z-index: 100 !important;
                }
            }
        }
        
        /* Responsive para tablets */
        @media (min-width: 768px) and (max-width: 1024px) {
            .vote-btn {
                height: 120px;
                font-size: 28px;
            }
            
            .vote-btn i {
                font-size: 36px;
            }
            
            .deputy-avatar {
                width: 90px;
                height: 90px;
                font-size: 32px;
            }
        }
        
        /* Timer de sesión */
        #sessionTimer {
            font-weight: bold;
            padding: 5px 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
        }
        
        /* Botón flotante discreto para PDF */
        .floating-pdf-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #dc3545);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        .floating-pdf-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.5);
        }
        
        .floating-pdf-btn.active {
            display: flex;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3); }
            50% { box-shadow: 0 4px 25px rgba(220, 53, 69, 0.6); }
            100% { box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3); }
        }
        
        .congress-logos {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-right: 10px;
        }
        
        .congress-logos img {
            height: 100px;
            object-fit: contain;
        }
        
        .secretary-menu {
            margin-top: 15px;
            width: 100%;
        }
        
        .secretary-menu .btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            font-size: 1em;
        }
        
        .secretary-menu .btn:hover {
            background: linear-gradient(135deg, #0056b3 0%, #003d82 100%);
        }
        
        .secretary-menu .dropdown-menu {
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 100%;
        }
        
        .secretary-menu .dropdown-item {
            color: #333;
            padding: 10px 20px;
        }
        
        .secretary-menu .dropdown-item:hover {
            background: #f0f0f0;
            color: #007bff;
        }
        
        .secretary-menu .dropdown-item i {
            margin-right: 8px;
            color: #007bff;
        }
        
        /* Notificación de resultado de votación */
        .result-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            max-width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideIn 0.5s ease-out;
            border-left: 5px solid #007bff;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .result-notification .notification-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-notification .notification-body {
            padding: 20px;
        }
        
        .result-notification .result-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        
        .result-notification .stat-item {
            text-align: center;
        }
        
        .result-notification .stat-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 20px;
            font-weight: bold;
            color: white;
        }
        
        .result-notification .stat-circle.favor { background: #28A745; }
        .result-notification .stat-circle.contra { background: #DC3545; }
        .result-notification .stat-circle.abstencion { background: #FFC107; }
        
        .result-notification .countdown-bar {
            height: 4px;
            background: #e0e0e0;
            position: relative;
            margin-top: 10px;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .result-notification .countdown-progress {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            animation: countdown 10s linear forwards;
        }
        
        @keyframes countdown {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        /* Menú hamburguesa */
        .menu-button {
            position: fixed !important;
            top: 80px !important;
            right: 20px !important;
            z-index: 999997 !important;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            border: none !important;
            color: white !important;
            width: 50px !important;
            height: 50px !important;
            border-radius: 50% !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s;
            pointer-events: auto !important;
        }
        
        .menu-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .menu-button:active {
            transform: scale(0.95);
        }
        
        .side-menu {
            position: fixed !important;
            top: 0 !important;
            right: -380px;
            width: 380px;
            height: 100% !important;
            background: var(--bg-card) !important;
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            box-shadow: var(--shadow-xl);
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999999 !important;
            overflow-y: auto;
            border-left: 1px solid var(--border-color);
            display: block !important;
        }
        
        .side-menu.show {
            right: 0 !important;
        }
        
        .side-menu-header {
            background: var(--bg-card);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .side-menu-header h5 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.4px;
            color: var(--text-primary);
            margin: 0;
        }
        
        .side-menu-content {
            padding: 16px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 16px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: var(--border-radius);
            margin-bottom: 4px;
            transition: all var(--transition-fast);
            cursor: pointer;
            background: transparent;
            border: none;
            width: 100%;
            text-align: left;
        }
        
        .menu-item:hover {
            background: var(--gray-100);
            transform: translateX(2px);
        }
        
        .menu-item i {
            font-size: 18px;
            width: 24px;
            text-align: center;
            color: var(--color-primary);
            opacity: 0.8;
        }
        
        .menu-item:hover i {
            opacity: 1;
        }
        
        .menu-item small {
            display: block;
            color: var(--text-tertiary);
            font-size: 12px;
            margin-top: 2px;
        }
        
        .menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 12px 0;
        }
        
        /* Overlay para el menú */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-base);
            z-index: 999998 !important;
            pointer-events: none;
        }
        
        .menu-overlay.show {
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }
        
        /* Botón de cierre del menú */
        .btn-close-menu {
            background: var(--gray-100);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-secondary);
        }
        
        .btn-close-menu:hover {
            background: var(--gray-200);
            transform: rotate(90deg);
        }
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: none;
        }
        
        .menu-overlay.active {
            display: block;
        }
        
    </style>
</head>
<body>
    <!-- Botón de menú hamburguesa -->
    <button class="menu-button" id="menuButton">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Overlay del menú -->
    <div class="menu-overlay" id="menuOverlay"></div>
    
    <!-- Menú lateral -->
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h5>Opciones</h5>
            <button class="btn-close-menu" onclick="toggleMenu()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="side-menu-content">
            <!-- Panel de Control del Presidente -->
            <div id="panelPresidente" style="display: none;">
                <h6 class="text-primary mb-3"><i class="fas fa-crown"></i> Panel de Control - Presidente</h6>
                <a href="#" class="menu-item" onclick="verIniciativasCargadas()">
                    <i class="fas fa-list"></i>
                    <div>
                        <div>Ver Iniciativas Cargadas</div>
                        <small class="text-muted">Consultar orden del día</small>
                    </div>
                </a>
                <!-- Removido enlace a Servicios Legislativos -->
                    <div>
                        <div>Servicios Legislativos</div>
                        <small class="text-muted">Cargar orden del día</small>
                    </div>
                </a>
                <a href="#" class="menu-item" onclick="verDiputadosPresentes()">
                    <i class="fas fa-users"></i>
                    <div>
                        <div>Diputados Presentes</div>
                        <small class="text-muted">Ver quórum actual</small>
                    </div>
                </a>
                <div class="menu-divider"></div>
            </div>
            
            <!-- Panel de Control del Secretario -->
            <div id="panelSecretario" style="display: none;">
                <h6 class="text-warning mb-3"><i class="fas fa-user-tie"></i> Panel de Control - Secretario</h6>
                <a href="#" class="menu-item" onclick="abrirPaseLista()">
                    <i class="fas fa-user-check"></i>
                    <div>
                        <div>Pase de Lista</div>
                        <small class="text-muted">Realizar toma de asistencia</small>
                    </div>
                </a>
                <div class="menu-divider"></div>
            </div>
            
            <!-- Botón de Auto-registro de Asistencia (oculto inicialmente) -->
            <button id="btnRegistrarAsistencia" class="menu-item" onclick="registrarMiAsistencia()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; display: none;">
                <i class="fas fa-user-check" style="color: white;"></i>
                <div>
                    <div style="font-weight: bold;">PRESENTE</div>
                    <small style="color: rgba(255,255,255,0.8);">Registrar mi asistencia</small>
                </div>
            </button>
            <div id="dividerAsistencia" class="menu-divider" style="display: none;"></div>
            
            <!-- Botón EN VIVO solo para mesa directiva - DESHABILITADO porque ya tenemos PWA -->
            <!-- <a href="#" class="menu-item" id="btnStreamingLive" onclick="abrirStreamingLive()" style="display: none; background: linear-gradient(135deg, #dc2626, #ef4444); color: white;">
                <i class="fas fa-video" style="color: white;"></i>
                <div>
                    <div style="font-weight: bold;">EN VIVO</div>
                    <small style="color: rgba(255,255,255,0.9);">Ver transmisión de la sesión</small>
                </div>
            </a> -->
            
            <a href="#" class="menu-item" onclick="verTableroSimplificado()">
                <i class="fas fa-th"></i>
                <div>
                    <div>Ver Tablero de Votación</div>
                    <small class="text-muted">Vista simplificada del tablero</small>
                </div>
            </a>
            <a href="#" class="menu-item" onclick="consultarOrdenDelDia()">
                <i class="fas fa-file-pdf"></i>
                <div>
                    <div>Orden del Día</div>
                    <small class="text-muted">Consultar documento de la sesión</small>
                </div>
            </a>
            <a href="#" class="menu-item" onclick="abrirConfiguracion()">
                <i class="fas fa-cog"></i>
                <div>
                    <div>Configuración</div>
                    <small class="text-muted">Mis datos personales</small>
                </div>
            </a>
        </div>
    </div>
    
    <nav class="navbar navbar-dark navbar-expand-lg" style="background: linear-gradient(135deg, #1a2332, #263241) !important; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0, 0, 0, 0.3); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-user"></i> Panel de Votación - Diputado
            </span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" 
                    aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <div class="navbar-nav ms-auto d-flex align-items-center">
                    <span class="text-white me-3">
                        <i class="fas fa-clock"></i> <span id="currentTime">00:00:00</span>
                    </span>
                    <span class="text-white me-3" id="sessionTimerContainer" style="display: none;">
                        <i class="fas fa-hourglass-half"></i> Sesión: <span id="sessionTimer">00:00:00</span>
                    </span>
                        <span class="text-white me-3" id="coordinatorInfo" style="display: none;">
                        <span style="font-size: 0.9em; opacity: 0.8;">Coordinador:</span>
                        <img id="coordinatorPartyLogo" src="" alt="" style="height: 20px; margin: 0 5px; display: none;">
                        <span id="coordinatorName" style="font-weight: 500;"></span>
                    </span>
                    <button id="btnConsultarSesionMenu" class="btn btn-outline-warning btn-sm me-2" style="display: none;" onclick="consultarDocumentoOriginal()">
                        <i class="fas fa-file-pdf"></i> Consultar Sesión
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Indicador de Estado de Asistencia -->
    <div id="asistenciaStatus" class="alert m-3" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i id="iconoAsistencia" class="fas fa-user-check"></i> 
                <strong>Estado de Asistencia:</strong> 
                <span id="estadoAsistenciaTexto">No registrado</span>
            </div>
            <div id="mensajeAsistencia" class="text-muted small">
                <!-- Mensaje dinámico según estado -->
            </div>
        </div>
    </div>

    <!-- Botón EN VIVO flotante - DESHABILITADO porque ya tenemos PWA -->
    <!-- <div class="live-button-container" id="liveButtonContainer" style="display: none;">
        <button class="btn-live" onclick="toggleLiveStream()">
            <span class="live-dot"></span>
            <span>EN VIVO</span>
        </button>
    </div> -->
    
    <!-- Botón flotante para consultar PDF -->
    <button class="floating-pdf-btn" id="floatingPdfBtn" onclick="consultarDocumentoOriginal()" title="Ver documento PDF de la sesión">
        <i class="fas fa-file-pdf fa-lg"></i>
    </button>

    <!-- Contenedor del Stream -->
    <div class="stream-container" id="streamContainer">
        <div class="stream-header">
            <div class="d-flex align-items-center gap-2">
                <span class="live-badge">
                    <span class="live-dot"></span>
                    EN VIVO
                </span>
                <span>Transmisión del Pleno</span>
            </div>
            <button class="btn-close btn-close-white" onclick="closeLiveStream()"></button>
        </div>
        <video id="remoteVideo" class="stream-video" autoplay playsinline muted controls></video>
        <div class="stream-controls">
            <div class="viewer-count">
                <i class="fas fa-eye"></i>
                <span id="viewerCount">0</span> viendo
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="togglePiP()" title="Picture in Picture">
                    <i class="fas fa-external-link-alt"></i>
                </button>
                <button class="btn btn-outline-secondary" onclick="toggleFullscreen()" title="Pantalla Completa">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="btn btn-outline-secondary" onclick="toggleMinimal()" title="Modo Minimal">
                    <i class="fas fa-compress"></i>
                </button>
            </div>
            <select class="form-select form-select-sm" style="width: auto;" onchange="changeQuality(this.value)">
                <option value="high">Alta (720p)</option>
                <option value="medium" selected>Media (480p)</option>
                <option value="low">Baja (360p)</option>
            </select>
        </div>
    </div>

    <div class="container vote-container">
        <!-- Header del diputado mejorado -->
        <div class="deputy-header" id="deputyHeader">
            <div class="deputy-info">
                <div class="deputy-avatar" id="deputyAvatar">
                    <!-- Se llenará dinámicamente -->
                </div>
                <div class="deputy-details">
                    <div class="deputy-text-info">
                        <div class="deputy-name" id="fullName"></div>
                        <div class="deputy-cargo" id="userCargo"></div>
                        <div class="deputy-commission" id="userCommission"></div>
                        <div class="deputy-party">
                            <span class="party-badge" id="partyBadge"></span>
                            <img class="party-logo" id="partyLogo" style="display: none;">
                            <span id="attendanceBadge" class="badge bg-secondary ms-2" style="display: none;">SIN REGISTRO</span>
                        </div>
                    </div>
                    <div class="congress-logos" id="congressLogos">
                        <!-- Se llenarán dinámicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Panel de control para presidente/vicepresidente -->
            <div class="president-controls" id="presidentControls" style="display: none;">
                <div class="card mt-3 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0"><i class="fas fa-gavel"></i> Control de Sesión</h6>
                    </div>
                    <div class="card-body">
                        <div id="sessionControlStatus" class="mb-3">
                            <!-- Se llenará dinámicamente -->
                        </div>
                        <!-- Cronómetro de pausa -->
                        <div id="pauseTimerContainer" class="alert alert-warning mb-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-pause-circle"></i> <strong>Sesión Pausada</strong>
                                </div>
                                <div class="text-end">
                                    <small>Tiempo en pausa:</small><br>
                                    <strong id="pauseTimer" class="fs-5">00:00:00</strong>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" id="btnIniciarSesion" onclick="iniciarSesion()" style="display: none;">
                                <i class="fas fa-play"></i> Iniciar Sesión Legislativa
                            </button>
                            <button class="btn btn-warning btn-lg" id="btnPausarSesion" onclick="pausarSesionSimple()" style="display: none;">
                                <i class="fas fa-pause"></i> Pausar Sesión
                            </button>
                            <button class="btn btn-info btn-lg" id="btnReanudarSesion" onclick="reanudarSesion()" style="display: none;">
                                <i class="fas fa-play-circle"></i> Reanudar Sesión
                            </button>
                            <button class="btn btn-danger btn-lg" id="btnClausurarSesion" onclick="clausurarSesion()" style="display: none;">
                                <i class="fas fa-stop"></i> Clausurar Sesión
                            </button>
                        </div>
                        <div id="sessionStats" class="mt-3" style="display: none;">
                            <!-- Estadísticas de sesión -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pestañas del Orden del Día (Solo consulta) -->
        <div class="orden-dia-tabs-container mt-3" id="ordenDiaTabs" style="display: none;">
            <style>
                .orden-dia-tabs-container {
                    background: var(--bg-card);
                    border-radius: 12px;
                    box-shadow: var(--shadow-md);
                    padding: 15px;
                    margin-bottom: 20px;
                }
                
                .nav-tabs-orden {
                    display: flex;
                    flex-wrap: nowrap;
                    overflow-x: auto;
                    gap: 5px;
                    border-bottom: 2px solid var(--border-color);
                    padding-bottom: 10px;
                    -webkit-overflow-scrolling: touch;
                }
                
                .nav-tabs-orden::-webkit-scrollbar {
                    height: 6px;
                }
                
                .nav-tabs-orden::-webkit-scrollbar-track {
                    background: var(--bg-secondary);
                    border-radius: 3px;
                }
                
                .nav-tabs-orden::-webkit-scrollbar-thumb {
                    background: var(--color-primary);
                    border-radius: 3px;
                }
                
                .tab-button-orden {
                    flex-shrink: 0;
                    padding: 8px 15px;
                    background: var(--bg-secondary);
                    border: 1px solid var(--border-color);
                    border-radius: 8px 8px 0 0;
                    color: var(--text-primary);
                    font-size: 0.9em;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.3s;
                    white-space: nowrap;
                }
                
                .tab-button-orden:hover {
                    background: var(--bg-hover);
                    transform: translateY(-2px);
                }
                
                .tab-button-orden.active {
                    background: var(--color-primary);
                    color: white;
                    border-color: var(--color-primary);
                }
                
                .tab-button-orden .badge {
                    margin-left: 5px;
                    font-size: 0.8em;
                }
                
                .tab-content-orden {
                    padding: 20px;
                    max-height: 400px;
                    overflow-y: auto;
                    background: var(--bg-secondary);
                    border-radius: 0 0 12px 12px;
                }
                
                .tab-pane-orden {
                    display: none;
                }
                
                .tab-pane-orden.active {
                    display: block;
                    animation: fadeIn 0.3s;
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                .iniciativa-item {
                    background: var(--bg-card);
                    border: 1px solid var(--border-color);
                    border-radius: 8px;
                    padding: 12px;
                    margin-bottom: 10px;
                    transition: all 0.3s;
                }
                
                .iniciativa-item:hover {
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    transform: translateX(5px);
                }
                
                .iniciativa-numero {
                    display: inline-block;
                    background: var(--color-primary);
                    color: white;
                    padding: 2px 8px;
                    border-radius: 4px;
                    font-weight: bold;
                    margin-right: 10px;
                    font-size: 0.9em;
                }
                
                .iniciativa-titulo {
                    font-weight: 500;
                    color: var(--text-primary);
                    margin-bottom: 5px;
                }
                
                .iniciativa-descripcion {
                    font-size: 0.85em;
                    color: var(--text-secondary);
                    line-height: 1.4;
                }
                
                .no-iniciativas {
                    text-align: center;
                    padding: 40px;
                    color: var(--text-secondary);
                }
                
                .categoria-header {
                    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
                    color: white;
                    padding: 10px 15px;
                    border-radius: 8px;
                    margin-bottom: 15px;
                    font-weight: 600;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                @media (max-width: 768px) {
                    .orden-dia-tabs-container {
                        padding: 10px;
                        margin: 10px -15px 20px -15px;
                        border-radius: 0;
                    }
                    
                    .tab-button-orden {
                        font-size: 0.85em;
                        padding: 6px 12px;
                    }
                    
                    .tab-content-orden {
                        padding: 15px;
                        max-height: 300px;
                    }
                }
            </style>
            
            <div class="nav-tabs-orden" id="ordenDiaTabsNav">
                <button class="tab-button-orden active" onclick="cambiarTabOrden('od')">
                    <i class="fas fa-list-ol"></i> OD
                    <span class="badge bg-secondary" id="badgeOD">0</span>
                </button>
                <button class="tab-button-orden" onclick="cambiarTabOrden('iniciativas')">
                    <i class="fas fa-file-alt"></i> INICIATIVAS
                    <span class="badge bg-info" id="badgeIniciativas">0</span>
                </button>
                <button class="tab-button-orden" onclick="cambiarTabOrden('primera')">
                    <i class="fas fa-book-reader"></i> PRIMERA LECTURA
                    <span class="badge bg-warning" id="badgePrimera">0</span>
                </button>
                <button class="tab-button-orden" onclick="cambiarTabOrden('segunda')">
                    <i class="fas fa-vote-yea"></i> SEGUNDA LECTURA
                    <span class="badge bg-success" id="badgeSegunda">0</span>
                </button>
                <button class="tab-button-orden" onclick="cambiarTabOrden('puntos')">
                    <i class="fas fa-handshake"></i> PUNTOS DE ACUERDO
                    <span class="badge bg-primary" id="badgePuntos">0</span>
                </button>
            </div>
            
            <div class="tab-content-orden">
                <!-- Tab OD (Orden del Día completo) -->
                <div class="tab-pane-orden active" id="tabOD">
                    <div class="categoria-header">
                        <span><i class="fas fa-list-ol"></i> Orden del Día Completo</span>
                        <span id="totalOD">0 elementos</span>
                    </div>
                    <div id="listaOD">
                        <div class="no-iniciativas">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p>No hay elementos del orden del día disponibles</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Iniciativas -->
                <div class="tab-pane-orden" id="tabIniciativas">
                    <div class="categoria-header">
                        <span><i class="fas fa-file-alt"></i> Iniciativas</span>
                        <span id="totalIniciativas">0 iniciativas</span>
                    </div>
                    <div id="listaIniciativas">
                        <div class="no-iniciativas">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p>No hay iniciativas disponibles</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Primera Lectura -->
                <div class="tab-pane-orden" id="tabPrimera">
                    <div class="categoria-header">
                        <span><i class="fas fa-book-reader"></i> Dictámenes de Primera Lectura</span>
                        <span id="totalPrimera">0 dictámenes</span>
                    </div>
                    <div id="listaPrimera">
                        <div class="no-iniciativas">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p>No hay dictámenes de primera lectura</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Segunda Lectura -->
                <div class="tab-pane-orden" id="tabSegunda">
                    <div class="categoria-header">
                        <span><i class="fas fa-vote-yea"></i> Dictámenes de Segunda Lectura</span>
                        <span id="totalSegunda">0 dictámenes</span>
                    </div>
                    <div id="listaSegunda">
                        <div class="no-iniciativas">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p>No hay dictámenes de segunda lectura</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Puntos de Acuerdo -->
                <div class="tab-pane-orden" id="tabPuntos">
                    <div class="categoria-header">
                        <span><i class="fas fa-handshake"></i> Puntos de Acuerdo</span>
                        <span id="totalPuntos">0 puntos</span>
                    </div>
                    <div id="listaPuntos">
                        <div class="no-iniciativas">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p>No hay puntos de acuerdo disponibles</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botón de Confirmar Asistencia -->
        <div class="vote-card" id="btnConfirmarAsistenciaContainer" style="display: none;">
            <h4 class="text-center mb-4">
                <i class="fas fa-clipboard-check"></i> Pase de Lista Activo
            </h4>
            <button class="btn btn-success attendance-btn btn-presente" id="btnConfirmarAsistencia" onclick="confirmarMiAsistencia()">
                <i class="fas fa-user-check"></i>
                <span>CONFIRMAR MI ASISTENCIA</span>
            </button>
            <div class="text-center mt-3 text-muted">
                <small>Presione el botón para confirmar que está presente en la sesión</small>
            </div>
        </div>
        
        <!-- Panel de votación -->
        <div class="vote-card" id="votingPanel" style="display: none;">
            <div class="text-center mb-4">
                <h2 class="text-primary">INICIATIVA EN VOTACIÓN</h2>
                <span class="badge bg-info" id="initiativeNumber" style="font-size: 1.1em;"></span>
            </div>
            
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h4 id="initiativeTitle" class="card-title flex-grow-1"></h4>
                        <button id="btnConsultarPDF" class="btn btn-outline-primary btn-sm" style="display: none;" onclick="consultarDocumentoOriginal()">
                            <i class="fas fa-file-pdf"></i> Consultar Sesión Impresa
                        </button>
                    </div>
                    <div id="initiativeDescriptionContainer">
                        <p id="initiativeDescription" class="card-text" style="max-height: 200px; overflow: hidden; position: relative; font-size: 1.3em; font-weight: bold; color: #2c3e50;"></p>
                        <button id="btnVerMasTexto" class="btn btn-link btn-sm" style="display: none;" onclick="toggleTextoCompleto()">
                            <i class="fas fa-chevron-down"></i> Ver más
                        </button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted d-block">
                            Tipo de Mayoría: <span class="badge bg-primary" id="majorityType"></span>
                        </small>
                        <div id="initiativeDetails"></div>
                    </div>
                </div>
            </div>
            
            <div id="votingButtons" class="text-center">
                <h5 class="mb-3">Emite tu voto:</h5>
                <div class="row">
                    <div class="col-md-4">
                        <button class="btn vote-btn btn-favor" onclick="vote('favor')" title="Presiona 1 para votar A Favor">
                            <i class="fas fa-check-circle"></i>
                            <span>A FAVOR</span>
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn vote-btn btn-contra" onclick="vote('contra')" title="Presiona 2 para votar En Contra">
                            <i class="fas fa-times-circle"></i>
                            <span>EN CONTRA</span>
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn vote-btn btn-abstencion" onclick="vote('abstencion')" title="Presiona 3 para Abstención">
                            <i class="fas fa-minus-circle"></i>
                            <span>ABSTENCIÓN</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="votedMessage" class="text-center mt-4" style="display: none;">
                <div class="alert alert-success">
                    <h4><i class="fas fa-check"></i> Voto Registrado</h4>
                    <p class="mb-0">Tu voto ha sido: <strong id="myVote"></strong></p>
                </div>
                <button class="btn btn-warning mt-3" onclick="changeVote()">
                    <i class="fas fa-edit"></i> Cambiar mi voto
                </button>
                <p class="text-muted mt-3">La votación sigue abierta. Puedes cambiar tu voto hasta que se cierre.</p>
            </div>
        </div>
        
        <!-- Panel removido - Los diputados NO pueden marcar su propia asistencia -->
        <!-- Solo los secretarios pueden marcar la asistencia desde su panel -->
        <!-- El estado de asistencia se muestra en la barra superior -->
        
        <!-- Mensaje sin votación -->
        <div class="vote-card no-voting" id="noVotingPanel">
            <div id="noVotingMessage">
                <i class="fas fa-clock fa-4x mb-3"></i>
                <h3>No hay iniciativa activa</h3>
                <p>Espera a que se active una iniciativa para votar</p>
                <div class="spinner-border text-primary mt-3" role="status">
                    <span class="visually-hidden">Esperando...</span>
                </div>
            </div>
        </div>
        
        <!-- Historial -->
        <div class="card mt-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-history"></i> Mi Historial de Votos</h5>
            </div>
            <div class="card-body">
                <div id="votingHistory" class="small">
                    <p class="text-muted text-center">Cargando historial...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Ver Detalle de Iniciativa -->
    <div class="modal fade" id="modalDetalleIniciativa" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="detalleIniciativaTitulo">Detalle de Iniciativa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detalleIniciativaContenido">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Gestión de Iniciativas (Solo Presidente) -->
    <div class="modal fade" id="gestionIniciativasModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-crown"></i> Gestión de Iniciativas - Presidente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Como Presidente de la Mesa Directiva, puedes activar iniciativas para votación.
                    </div>
                    
                    <!-- Indicador de Quórum -->
                    <div id="indicadorQuorum" class="mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="fas fa-users"></i> Estado del Quórum
                                </h6>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="h4 mb-0" id="quorumPresentes">0</div>
                                        <small class="text-muted">Presentes</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="h4 mb-0" id="quorumRequerido">0</div>
                                        <small class="text-muted">Requerido</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="h4 mb-0" id="quorumTotal">0</div>
                                        <small class="text-muted">Total</small>
                                    </div>
                                </div>
                                <div class="progress mt-3" style="height: 25px;">
                                    <div id="quorumProgressBar" class="progress-bar" role="progressbar" 
                                         style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        <span id="quorumProgressText">0%</span>
                                    </div>
                                </div>
                                <div id="quorumStatus" class="mt-2 text-center">
                                    <span class="badge bg-secondary">Calculando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FILTROS MEJORADOS -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary active" onclick="filtrarIniciativasPresidente('todas')">
                                            <i class="fas fa-list"></i> Todas
                                        </button>
                                        <button type="button" class="btn btn-outline-success" onclick="filtrarIniciativasPresidente('votadas')">
                                            <i class="fas fa-check-circle"></i> Votadas
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" onclick="filtrarIniciativasPresidente('pendientes')">
                                            <i class="fas fa-clock"></i> Pendientes
                                        </button>
                                        <button type="button" class="btn btn-outline-info" onclick="filtrarIniciativasPresidente('activas')">
                                            <i class="fas fa-play-circle"></i> En Votación
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="seleccionMultiple" onchange="toggleSeleccionMultiple()">
                                        <label class="form-check-label" for="seleccionMultiple">
                                            <i class="fas fa-check-double"></i> Selección Múltiple
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2" id="accionesMultiples" style="display: none;">
                                <div class="col-12">
                                    <button class="btn btn-sm btn-success" onclick="votarSeleccionadas()">
                                        <i class="fas fa-vote-yea"></i> Votar Seleccionadas
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="seleccionarTodas()">
                                        <i class="fas fa-check-square"></i> Seleccionar Todas
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="deseleccionarTodas()">
                                        <i class="fas fa-square"></i> Deseleccionar
                                    </button>
                                    <span class="ms-3 badge bg-primary" id="contadorSeleccionadas">0 seleccionadas</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="listaIniciativasPresidente" style="max-height: 400px; overflow-y: auto;">
                        <p class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando iniciativas...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://unpkg.com/mediasoup-client@3/lib/mediasoup-client.min.js"></script>
    <script>
        // ================ FUNCIONES GLOBALES DEL MENÚ (deben estar antes del HTML) ================
        // Nota: La función toggleMenu está definida más abajo después de inicializar los elementos del DOM
        
        // Inicializar menú al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando menú hamburguesa azul');
            
            // Verificar que los elementos existen
            const menuButton = document.getElementById('menuButton');
            const sideMenu = document.getElementById('sideMenu');
            const menuOverlay = document.getElementById('menuOverlay');
            
            console.log('Elementos encontrados:', {
                menuButton: !!menuButton,
                sideMenu: !!sideMenu,
                menuOverlay: !!menuOverlay
            });
            
            // Agregar evento al botón si existe
            if (menuButton) {
                menuButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Botón de menú clickeado');
                    try {
                        window.toggleMenu();
                    } catch (error) {
                        console.error('Error al ejecutar toggleMenu:', error);
                    }
                });
                console.log('Event listener agregado al botón del menú');
            } else {
                console.error('Botón de menú no encontrado!');
            }
            
            // Agregar evento al overlay para cerrar el menú
            if (menuOverlay) {
                menuOverlay.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Overlay clickeado, cerrando menú');
                    try {
                        window.toggleMenu();
                    } catch (error) {
                        console.error('Error al ejecutar toggleMenu desde overlay:', error);
                    }
                });
                console.log('Event listener agregado al overlay');
            }
            
            // Configurar visibilidad de paneles según el rol
            setTimeout(() => {
                if (typeof user !== 'undefined' && user) {
                    const cargo = user.cargo_mesa_directiva || '';
                    console.log('Configurando paneles según rol:', cargo || 'Sin cargo en mesa directiva');
                    
                    // Normalizar el cargo para comparación
                    const cargoLower = cargo.toLowerCase().trim();
                    
                    // Mostrar panel del presidente si corresponde
                    if (cargoLower === 'presidente' || cargoLower === 'presidente de la mesa directiva') {
                        const panelPresidente = document.getElementById('panelPresidente');
                        if (panelPresidente) {
                            panelPresidente.style.display = 'block';
                            console.log('Panel presidente visible');
                        }
                    }
                    
                    // Mostrar panel del secretario si corresponde
                    if (cargoLower === 'secretario1' || cargoLower === 'secretario2' || 
                        cargoLower.includes('secretario') && cargoLower !== '') {
                        const panelSecretario = document.getElementById('panelSecretario');
                        if (panelSecretario) {
                            panelSecretario.style.display = 'block';
                            console.log('Panel secretario visible');
                        }
                    }
                    
                    // Si no tiene cargo en mesa directiva, es diputado regular
                    if (!cargo || cargo === '') {
                        console.log('Diputado sin cargo en mesa directiva');
                    }
                }
            }, 500);
        });
        
        function verTableroSimplificado() {
            toggleMenu();
            window.location.href = '/tablero-diputado';
        }
        
        // Función de configuración - Definición completa desde el inicio
        window.abrirConfiguracion = function() {
            toggleMenu();
            
            // Verificar que el usuario esté cargado
            if (!user) {
                alert('Información del usuario no disponible. Por favor, recarga la página.');
                return;
            }
            
            // Verificar que el modal exista
            const modalElement = document.getElementById('modalConfiguracion');
            if (!modalElement) {
                console.error('Modal de configuración no encontrado');
                alert('El modal de configuración no está disponible. Por favor, recarga la página.');
                return;
            }
            
            // Verificar que los elementos del formulario existan
            const configNombre = document.getElementById('configNombre');
            const configUsuario = document.getElementById('configUsuario');
            const configPartido = document.getElementById('configPartido');
            const configCargo = document.getElementById('configCargo');
            const previewFoto = document.getElementById('previewFoto');
            const configPassword = document.getElementById('configPassword');
            const configPasswordConfirm = document.getElementById('configPasswordConfirm');
            
            if (!configNombre || !configUsuario) {
                console.error('Elementos del formulario no encontrados');
                alert('Los elementos del formulario no están disponibles. Por favor, recarga la página.');
                return;
            }
            
            // Cargar datos actuales del usuario
            configNombre.value = user.nombre || user.nombre_completo || '';
            configUsuario.value = user.username || user.usuario || '';
            if (configPartido) {
                configPartido.value = user.partido || '';
                configPartido.disabled = true;  // Asegurar que esté deshabilitado
                configPartido.readOnly = true;
            }
            if (configCargo) {
                configCargo.value = user.cargo_mesa_directiva || 'Diputado';
                configCargo.disabled = true;  // Asegurar que esté deshabilitado
                configCargo.readOnly = true;
            }
            
            // Cargar foto actual
            const fotoPath = user.fotografia || '/images/diputados/default.svg';
            if (previewFoto) previewFoto.src = fotoPath;
            
            // Limpiar campos de contraseña
            if (configPassword) configPassword.value = '';
            if (configPasswordConfirm) configPasswordConfirm.value = '';
            
            // Mostrar modal
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // Función para guardar configuración
        window.guardarConfiguracion = async function() {
            const nombre = document.getElementById('configNombre').value.trim();
            const usuario = document.getElementById('configUsuario').value.trim();
            const password = document.getElementById('configPassword').value;
            const passwordConfirm = document.getElementById('configPasswordConfirm').value;
            
            // Validaciones
            if (!nombre || !usuario) {
                alert('El nombre y usuario son obligatorios');
                return;
            }
            
            if (password && password !== passwordConfirm) {
                alert('Las contraseñas no coinciden');
                return;
            }
            
            if (password && password.length < 6) {
                alert('La contraseña debe tener al menos 6 caracteres');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('nombre', nombre);
                formData.append('usuario', usuario);
                
                if (password) {
                    formData.append('password', password);
                }
                
                // Agregar foto si se seleccionó una
                const inputFoto = document.getElementById('inputFoto');
                if (inputFoto && inputFoto.files && inputFoto.files[0]) {
                    formData.append('fotografia', inputFoto.files[0]);
                }
                
                const response = await fetch('/api/diputado/actualizar-perfil', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('Configuración actualizada correctamente');
                    
                    // Actualizar datos locales del usuario
                    user.nombre = nombre;
                    user.usuario = usuario;
                    if (data.fotografia) {
                        user.fotografia = data.fotografia;
                    }
                    
                    // Actualizar header con el nuevo nombre
                    const deputyNameElement = document.getElementById('deputyName');
                    if (deputyNameElement) {
                        deputyNameElement.textContent = nombre;
                    }
                    
                    // Guardar en localStorage
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('modalConfiguracion')).hide();
                    
                    // Si cambió el usuario, sugerir relogin
                    if (usuario !== (user.username || user.usuario)) {
                        if (confirm('Has cambiado tu usuario. ¿Deseas cerrar sesión para ingresar con tu nuevo usuario?')) {
                            logout();
                        }
                    }
                    
                    // Si cambió la contraseña, informar al usuario
                    if (password) {
                        alert('Contraseña actualizada correctamente. Por seguridad, recomendamos cerrar sesión e ingresar con tu nueva contraseña.');
                    }
                } else if (data.error) {
                    alert(data.error);
                } else {
                    alert('Error al actualizar la configuración');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar la configuración');
            }
        }
        
        // Preview de imagen para configuración
        window.previewImage = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewElement = document.getElementById('previewFoto');
                    if (previewElement) {
                        previewElement.src = e.target.result;
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // ================ INICIALIZACIÓN DE VARIABLES ================
        
        const socket = io();
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');
        let currentInitiative = null;
        let hasVoted = false;
        let partidosData = {};
        
        // Verificar si es presidente o secretario
        const isPresidente = user && user.cargo_mesa_directiva === 'Presidente de la Mesa Directiva';
        const isSecretario = user && (user.cargo_mesa_directiva === 'Secretario de la Mesa Directiva' || 
                                      user.cargo_mesa_directiva === 'secretario1' || 
                                      user.cargo_mesa_directiva === 'secretario2');
        const isVicepresidente = user && user.cargo_mesa_directiva === 'Vicepresidente';
        let sessionStartTime = null;
        let sessionTimerInterval = null;
        let pauseStartTime = null;
        let pauseTimerInterval = null;
        let sessionPaused = false;
        
        // Identificar usuario al conectarse
        if (user) {
            socket.emit('identificar-usuario', {
                nombre: user.nombre_completo || user.username,
                rol: 'Diputado',
                cargo: user.cargo_mesa_directiva || user.cargo_legislativo || ''
            });
        }
        
        if (!token || !user || user.role !== 'diputado') {
            window.location.href = '/';
        }
        
        // Función de logout (debe estar antes de ser usada)
        function logout() {
            if (sessionTimerInterval) clearInterval(sessionTimerInterval);
            localStorage.clear();
            window.location.href = '/';
        }
        
        // No mostrar el nombre del usuario aquí, se mostrará el coordinador después
        
        // Esperar a que el DOM esté listo y cargar información del usuario
        setTimeout(() => {
            loadUserInfo();
            // Mostrar panel del presidente si corresponde
            if (isPresidente) {
                document.getElementById('panelPresidente').style.display = 'block';
            }
            // Asegurar que la función de configuración esté disponible
            if (typeof window.abrirConfiguracion === 'function') {
                console.log('Función abrirConfiguracion cargada correctamente');
            }
        }, 100);
        
        // También cargar información de partidos (en paralelo)
        loadPartidos().catch(error => {
            console.error('Error cargando partidos:', error);
        });
        
        // Cargar iniciativa activa y historial al iniciar
        checkActiveInitiative();
        loadHistory();
        
        // Iniciar cronómetro de sesión
        startSessionTimer();
        
        // Función para toggle del menú (debe estar disponible globalmente)
        window.toggleMenu = function() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            if (menu && overlay) {
                menu.classList.toggle('show');
                overlay.classList.toggle('show');
                console.log('Menú toggle ejecutado - Estado:', menu.classList.contains('show') ? 'abierto' : 'cerrado');
            } else {
                console.error('Elementos del menú no encontrados', {
                    menu: !!menu,
                    overlay: !!overlay
                });
            }
        }
        
        // Agregar atajos de teclado para votación rápida
        document.addEventListener('keydown', function(event) {
            // Solo funcionar si hay una iniciativa activa y no se está escribiendo en un input
            if (!currentInitiative || hasVoted) return;
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;
            
            // Verificar que el panel de votación esté visible
            if (document.getElementById('votingPanel').style.display !== 'block') return;
            
            // Verificar que los botones de votación estén visibles (no haya votado ya)
            if (document.getElementById('votingButtons').style.display !== 'block') return;
            
            switch(event.key) {
                case '1':
                    event.preventDefault();
                    // Resaltar visualmente el botón antes de votar
                    const btnFavor = document.querySelector('.btn-favor.vote-btn');
                    if (btnFavor && !btnFavor.disabled) {
                        btnFavor.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            btnFavor.style.transform = '';
                            vote('favor');
                        }, 200);
                    }
                    break;
                    
                case '2':
                    event.preventDefault();
                    // Resaltar visualmente el botón antes de votar
                    const btnContra = document.querySelector('.btn-contra.vote-btn');
                    if (btnContra && !btnContra.disabled) {
                        btnContra.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            btnContra.style.transform = '';
                            vote('contra');
                        }, 200);
                    }
                    break;
                    
                case '3':
                    event.preventDefault();
                    // Resaltar visualmente el botón antes de votar
                    const btnAbstencion = document.querySelector('.btn-abstencion.vote-btn');
                    if (btnAbstencion && !btnAbstencion.disabled) {
                        btnAbstencion.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            btnAbstencion.style.transform = '';
                            vote('abstencion');
                        }, 200);
                    }
                    break;
            }
        });
        
        // Función para obtener las iniciales del nombre
        function getInitials(name) {
            if (!name) return '';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return parts[0][0] + parts[parts.length - 1][0];
            }
            return name[0];
        }
        
        // Función para obtener el color del partido
        function getPartyColor(party) {
            const colors = {
                'MORENA': '#8B1B1B',
                'PAN': '#1B4788',
                'PRI': '#CD1C22',
                'PT': '#E31E24',
                'PVEM': '#00A550',
                'MC': '#FF6B00',
                'NUEVA ALIANZA': '#00B8B2',
                'INDEPENDIENTE': '#6c757d'
            };
            return colors[party] || '#6c757d';
        }
        
        // Cargar información de partidos
        async function loadPartidos() {
            try {
                const response = await fetch('/api/pantalla/partidos');
                if (response.ok) {
                    const partidos = await response.json();
                    // Crear mapa de partidos por siglas
                    partidos.forEach(partido => {
                        partidosData[partido.siglas] = partido;
                    });
                }
            } catch (error) {
                console.error('Error cargando partidos:', error);
            }
        }
        
        // Verificar iniciativa activa
        async function checkActiveInitiative() {
            try {
                const response = await fetch('/api/diputado/iniciativa-activa', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.iniciativa) {
                    currentInitiative = data.iniciativa;
                    hasVoted = data.yaVoto;
                    showVotingPanel(data.iniciativa, data.yaVoto, data.miVoto);
                } else {
                    showNoVoting();
                }
            } catch (error) {
                console.error('Error:', error);
                showNoVoting();
            }
        }
        
        // Mostrar panel de votación
        function showVotingPanel(initiative, alreadyVoted, myVote) {
            // Verificar si el diputado pasó lista antes de permitir votar
            if (!yaConfirmeAsistencia) {
                // Mostrar advertencia de que debe pasar lista
                document.getElementById('noVotingPanel').style.display = 'block';
                document.getElementById('votingPanel').style.display = 'none';
                
                // Cambiar el mensaje del panel
                document.getElementById('noVotingMessage').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <h3>No puede votar</h3>
                        <p class="lead">Debe confirmar su asistencia primero</p>
                        <p>Por favor confirme su asistencia usando el botón verde antes de poder votar</p>
                        <button class="btn btn-warning mt-3" onclick="location.reload()">
                            <i class="fas fa-sync"></i> Actualizar
                        </button>
                    </div>
                `;
                
                // Mostrar notificación
                showNotification('⚠️ Debe pasar lista primero', 'warning');
                showNotification('No puede votar sin confirmar su asistencia', 'error');
                return;
            }
            
            document.getElementById('noVotingPanel').style.display = 'none';
            document.getElementById('votingPanel').style.display = 'block';
            
            const numeroFormato = initiative.numero_orden_dia ? 
                `${initiative.numero}/${initiative.numero_orden_dia}` : 
                initiative.numero;
            document.getElementById('initiativeNumber').textContent = numeroFormato;
            
            // Solo mostrar el texto una vez - usar descripción o título
            const textoIniciativa = initiative.descripcion || initiative.titulo || 'Sin descripción';
            
            // Ocultar el título grande ya que el texto viene en la descripción
            document.getElementById('initiativeTitle').style.display = 'none';
            
            // Manejar texto largo con botón "Ver más"
            const descElement = document.getElementById('initiativeDescription');
            const btnVerMas = document.getElementById('btnVerMasTexto');
            
            descElement.textContent = textoIniciativa;
            descElement.setAttribute('data-texto-completo', textoIniciativa);
            
            // Si el texto es muy largo, mostrar botón "Ver más"
            if (textoIniciativa.length > 300) {
                descElement.style.maxHeight = '200px';
                descElement.style.overflow = 'hidden';
                btnVerMas.style.display = 'inline-block';
                btnVerMas.innerHTML = '<i class="fas fa-chevron-down"></i> Ver más';
                descElement.setAttribute('data-expandido', 'false');
            } else {
                descElement.style.maxHeight = 'none';
                descElement.style.overflow = 'visible';
                btnVerMas.style.display = 'none';
            }
            
            document.getElementById('majorityType').textContent = getMajorityLabel(initiative.tipo_mayoria);
            
            // Mostrar detalles de la iniciativa de forma simple
            document.getElementById('initiativeDetails').innerHTML = `
                ${initiative.presentador ? `<small class="text-muted d-block mt-1">Propuesta por: ${initiative.presentador}</small>` : ''}
            `;
            
            if (alreadyVoted) {
                document.getElementById('votingButtons').style.display = 'none';
                document.getElementById('votedMessage').style.display = 'block';
                document.getElementById('myVote').textContent = getVoteLabel(myVote);
                // Deshabilitar botones si ya votó
                document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = true);
            } else {
                document.getElementById('votingButtons').style.display = 'block';
                document.getElementById('votedMessage').style.display = 'none';
                // Habilitar botones si no ha votado
                document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = false);
            }
        }
        
        // Mostrar mensaje sin votación
        function showNoVoting() {
            const votingPanel = document.getElementById('votingPanel');
            const noVotingPanel = document.getElementById('noVotingPanel');
            
            if (votingPanel) {
                votingPanel.style.display = 'none';
            }
            
            // El panel de asistencia ya no existe en esta versión
            // Se removió la línea: document.getElementById('attendancePanel').style.display = 'none';
            
            if (noVotingPanel) {
                noVotingPanel.style.display = 'block';
            }
        }
        
        // Cambiar voto
        function changeVote() {
            // Mostrar botones de votación nuevamente
            document.getElementById('votingButtons').style.display = 'block';
            document.getElementById('votedMessage').style.display = 'none';
            document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = false);
            hasVoted = false;
        }
        
        // ================ FUNCIONES DE PASE DE LISTA ================
        
        let hasMarkedAttendance = false;
        let myAttendanceStatus = null;
        
        // Funciones de panel de asistencia removidas
        // Los diputados solo pueden ver su estado, no modificarlo
        
        // Función para mostrar botón gris de presente temporalmente
        function mostrarBotonPresente() {
            const containerAsistencia = document.getElementById('btnConfirmarAsistenciaContainer');
            if (containerAsistencia) {
                containerAsistencia.innerHTML = `
                    <h4 class="text-center mb-4">
                        <i class="fas fa-check-circle text-success"></i> Asistencia Registrada
                    </h4>
                    <button class="btn btn-secondary attendance-btn disabled" disabled>
                        <i class="fas fa-check"></i>
                        <span>PRESENTE</span>
                    </button>
                    <div class="text-center mt-3 text-success">
                        <small>Su asistencia ya fue confirmada</small>
                    </div>
                `;
                containerAsistencia.style.display = 'block';
                
                // Ocultar después de 5 segundos
                setTimeout(() => {
                    containerAsistencia.style.display = 'none';
                }, 5000);
            }
        }
        
        // Función para confirmar mi propia asistencia
        async function confirmarMiAsistencia() {
            try {
                const response = await fetch('/api/pase-lista/confirmar-asistencia', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Marcar que ya confirmé asistencia
                    yaConfirmeAsistencia = true;
                    
                    // Ocultar el botón de confirmar asistencia
                    const containerAsistencia = document.getElementById('btnConfirmarAsistenciaContainer');
                    if (containerAsistencia) {
                        containerAsistencia.style.display = 'none';
                    }
                    
                    // Mostrar botón gris de presente temporalmente
                    mostrarBotonPresente();
                    
                    // Obtener el género del usuario basado en su nombre o cargo
                    const nombreCompleto = user.nombre || '';
                    const cargo = user.cargo || '';
                    
                    // Detectar género por terminación del nombre o cargo
                    let genero = 'neutro';
                    
                    // Lista de nombres femeninos comunes o terminaciones
                    const terminacionesFemeninas = ['a', 'ela', 'ina', 'ana', 'ena', 'ona', 'ara', 'ira'];
                    const nombresFemeninos = ['carmen', 'pilar', 'dolores', 'mercedes', 'angeles', 'luz', 'mar', 'sol', 'cruz'];
                    
                    const nombreLower = nombreCompleto.toLowerCase();
                    const primerNombre = nombreLower.split(' ')[0];
                    
                    // Verificar si el cargo indica género
                    if (cargo.toLowerCase().includes('diputada')) {
                        genero = 'femenino';
                    } else if (cargo.toLowerCase().includes('diputado')) {
                        genero = 'masculino';
                    } 
                    // Si no hay cargo claro, verificar por nombre
                    else if (nombresFemeninos.some(n => primerNombre.includes(n))) {
                        genero = 'femenino';
                    } else if (terminacionesFemeninas.some(term => primerNombre.endsWith(term))) {
                        genero = 'femenino';
                    } else if (primerNombre.endsWith('o') || primerNombre.endsWith('os') || 
                              primerNombre.endsWith('el') || primerNombre.endsWith('or')) {
                        genero = 'masculino';
                    }
                    
                    // Construir mensaje personalizado
                    let mensajeExito = '';
                    if (genero === 'femenino') {
                        mensajeExito = '✅ Gracias Diputada, su asistencia ha quedado registrada';
                    } else if (genero === 'masculino') {
                        mensajeExito = '✅ Gracias Diputado, su asistencia ha quedado registrada';
                    } else {
                        mensajeExito = '✅ Gracias, su asistencia ha quedado registrada';
                    }
                    
                    // Mostrar notificación de éxito personalizada
                    mostrarNotificacionPersonalizada(mensajeExito, 'success');
                    
                    // Actualizar el indicador de asistencia
                    updateAttendanceStatus('presente');
                } else {
                    const error = await response.json();
                    mostrarNotificacionPersonalizada('❌ Error al confirmar asistencia', 'error');
                    if (error.error) {
                        mostrarNotificacionPersonalizada(error.error, 'warning');
                    }
                }
            } catch (error) {
                console.error('Error confirmando asistencia:', error);
                mostrarNotificacionPersonalizada('❌ Error de conexión al confirmar asistencia', 'error');
            }
        }
        
        // Función mejorada para mostrar notificaciones
        function mostrarNotificacionPersonalizada(mensaje, tipo) {
            // Evitar mostrar "undefined"
            if (!mensaje || mensaje === 'undefined' || mensaje === 'null') {
                console.error('Intento de mostrar notificación vacía');
                return;
            }
            
            const claseAlerta = tipo === 'success' ? 'alert-success' : 
                               tipo === 'error' ? 'alert-danger' : 
                               tipo === 'warning' ? 'alert-warning' : 'alert-info';
            
            const icono = tipo === 'success' ? 'fa-check-circle' : 
                         tipo === 'error' ? 'fa-times-circle' : 
                         tipo === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            // Crear elemento de notificación
            const notification = document.createElement('div');
            notification.className = `alert ${claseAlerta} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 80px; right: 20px; z-index: 10000; min-width: 350px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas ${icono} fa-lg me-3"></i>
                    <div class="flex-grow-1">
                        <strong>${mensaje}</strong>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Agregar al body
            document.body.appendChild(notification);
            
            // Auto eliminar después de 5 segundos
            setTimeout(() => {
                notification.remove();
            }, 5000);
            
            // También intentar usar showNotification si existe y es diferente
            if (typeof showNotification === 'function' && showNotification !== mostrarNotificacionPersonalizada) {
                // Evitar pasar undefined
                if (mensaje && mensaje !== 'undefined') {
                    showNotification(mensaje, tipo);
                }
            }
        }
        
        // Verificar mi asistencia actual
        async function checkMyAttendance() {
            try {
                const response = await fetch('/api/pase-lista/mi-asistencia', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.asistencia === 'presente') {
                        hasMarkedAttendance = true;
                        myAttendanceStatus = data.asistencia;
                        yaConfirmeAsistencia = true;
                        
                        // Actualizar indicador visual de asistencia
                        mostrarEstadoAsistencia(data.asistencia);
                        showAttendanceRegistered(data.asistencia);
                        
                        // No mostrar el botón verde si ya confirmó
                        const containerAsistencia = document.getElementById('btnConfirmarAsistenciaContainer');
                        if (containerAsistencia) {
                            containerAsistencia.style.display = 'none';
                        }
                    } else {
                        yaConfirmeAsistencia = false;
                    }
                }
            } catch (error) {
                console.error('Error verificando asistencia:', error);
            }
        }
        
        // Funciones removidas - Los diputados no pueden marcar su propia asistencia
        // Solo los secretarios marcan la asistencia desde su panel
        
        // Variable para almacenar información de la sesión actual
        let sesionActualInfo = null;
        
        // Función para consultar el documento PDF original
        function consultarDocumentoOriginal() {
            if (sesionActualInfo && sesionActualInfo.archivo_pdf) {
                // Abrir el PDF en una nueva ventana
                window.open(`/documentos-sesion/${sesionActualInfo.archivo_pdf}`, '_blank');
            } else {
                alert('No hay documento PDF disponible para esta sesión');
            }
        }
        
        // Función para consultar la orden del día desde el menú
        async function consultarOrdenDelDia() {
            toggleMenu(); // Cerrar el menú
            
            try {
                // Obtener información de la sesión actual usando la ruta correcta para diputados
                const response = await fetch('/api/diputado/sesion-actual', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.sesion) {
                        // Intentar obtener el PDF del orden del día
                        try {
                            const pdfResponse = await fetch(`/api/operador/sesiones/${data.sesion.id}/orden-dia-pdf`, {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (pdfResponse.ok) {
                                const blob = await pdfResponse.blob();
                                const pdfURL = URL.createObjectURL(blob);
                                
                                // Crear modal para mostrar el PDF
                                mostrarModalPDFOrdenDelDia(pdfURL, data.sesion.nombre || 'Orden del Día');
                            } else {
                                // Si no hay PDF pero hay iniciativas, mostrarlas
                                if (data.iniciativas && data.iniciativas.length > 0) {
                                    mostrarModalIniciativas(data.iniciativas);
                                } else {
                                    alert('No hay documento PDF disponible para esta sesión');
                                }
                            }
                        } catch (error) {
                            console.error('Error obteniendo PDF:', error);
                            // Si falla obtener el PDF, mostrar iniciativas si existen
                            if (data.iniciativas && data.iniciativas.length > 0) {
                                mostrarModalIniciativas(data.iniciativas);
                            } else {
                                alert('Error al obtener el documento PDF');
                            }
                        }
                    } else {
                        alert('No hay sesión activa en este momento');
                    }
                } else if (response.status === 404) {
                    alert('No hay sesión activa en este momento');
                } else {
                    alert('Error al obtener información de la sesión');
                }
            } catch (error) {
                console.error('Error consultando orden del día:', error);
                alert('Error al consultar la orden del día');
            }
        }
        
        // Función para mostrar el PDF del orden del día en un modal
        function mostrarModalPDFOrdenDelDia(pdfURL, titulo) {
            // Crear modal si no existe
            let modal = document.getElementById('modalPDFOrdenDia');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modalPDFOrdenDia';
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-xl" style="max-width: 90%; height: 90vh;">
                        <div class="modal-content" style="height: 100%;">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-file-pdf"></i> 
                                    <span id="modalPDFTituloOrden">${titulo}</span>
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="cerrarModalPDFOrdenDelDia()"></button>
                            </div>
                            <div class="modal-body p-0" style="height: calc(100% - 60px);">
                                <iframe id="modalPDFFrameOrden" src="" style="width: 100%; height: 100%; border: none;"></iframe>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                // Actualizar título si el modal ya existe
                document.getElementById('modalPDFTituloOrden').textContent = titulo;
            }
            
            // Establecer la URL del PDF
            document.getElementById('modalPDFFrameOrden').src = pdfURL;
            
            // Mostrar modal
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
        }
        
        // Función para cerrar el modal del PDF del orden del día
        function cerrarModalPDFOrdenDelDia() {
            const modal = document.getElementById('modalPDFOrdenDia');
            if (modal) {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // Limpiar iframe
                const frame = document.getElementById('modalPDFFrameOrden');
                if (frame && frame.src) {
                    if (frame.src.startsWith('blob:')) {
                        URL.revokeObjectURL(frame.src);
                    }
                    frame.src = '';
                }
            }
        }
        
        // ================ FUNCIONES DE PESTAÑAS ORDEN DEL DÍA ================
        
        // Función para cambiar entre pestañas del orden del día
        function cambiarTabOrden(tab) {
            // Remover clase active de todos los botones y paneles
            document.querySelectorAll('.tab-button-orden').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-pane-orden').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // Activar el botón y panel correspondiente
            const button = document.querySelector(`.tab-button-orden[onclick="cambiarTabOrden('${tab}')"]`);
            if (button) button.classList.add('active');
            
            const tabMap = {
                'od': 'tabOD',
                'iniciativas': 'tabIniciativas',
                'primera': 'tabPrimera',
                'segunda': 'tabSegunda',
                'puntos': 'tabPuntos'
            };
            
            const pane = document.getElementById(tabMap[tab]);
            if (pane) pane.classList.add('active');
        }
        
        // Función para cargar las iniciativas del orden del día
        async function cargarOrdenDelDia() {
            try {
                const response = await fetch('/api/diputado/sesion-actual', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    console.log('No hay sesión activa');
                    document.getElementById('ordenDiaTabs').style.display = 'none';
                    return;
                }
                
                const data = await response.json();
                
                if (data.sesion && data.iniciativas && data.iniciativas.length > 0) {
                    // Mostrar las pestañas
                    document.getElementById('ordenDiaTabs').style.display = 'block';
                    
                    // Categorizar las iniciativas
                    const categorias = {
                        od: [],
                        iniciativas: [],
                        primera: [],
                        segunda: [],
                        puntos: []
                    };
                    
                    // Procesar todas las iniciativas
                    data.iniciativas.forEach((item, index) => {
                        // Determinar categoría
                        let categoria = 'od'; // Por defecto todo va a OD
                        
                        const titulo = (item.titulo || item.descripcion || '').toLowerCase();
                        const tipo = (item.tipo || '').toLowerCase();
                        const tipoDocumento = (item.tipo_documento || '').toLowerCase();
                        
                        // Clasificar por tipo
                        if (titulo.includes('iniciativa') || tipo.includes('iniciativa') || tipoDocumento === 'iniciativa') {
                            categoria = 'iniciativas';
                        } else if (titulo.includes('primera lectura') || tipo.includes('primera') || tipoDocumento.includes('primera')) {
                            categoria = 'primera';
                        } else if (titulo.includes('segunda lectura') || tipo.includes('segunda') || tipoDocumento.includes('segunda')) {
                            categoria = 'segunda';
                        } else if (titulo.includes('punto') && titulo.includes('acuerdo') || tipo.includes('punto') || tipoDocumento.includes('punto')) {
                            categoria = 'puntos';
                        }
                        
                        // Crear el elemento con numeración
                        const elemento = {
                            ...item,
                            numeroOrden: index + 1,
                            categoria: categoria
                        };
                        
                        // Agregar a OD (todo va aquí)
                        categorias.od.push(elemento);
                        
                        // También agregar a su categoría específica
                        if (categoria !== 'od') {
                            categorias[categoria].push(elemento);
                        }
                    });
                    
                    // Renderizar cada categoría
                    renderizarCategoria('od', categorias.od);
                    renderizarCategoria('iniciativas', categorias.iniciativas);
                    renderizarCategoria('primera', categorias.primera);
                    renderizarCategoria('segunda', categorias.segunda);
                    renderizarCategoria('puntos', categorias.puntos);
                    
                    // Actualizar badges con conteos
                    document.getElementById('badgeOD').textContent = categorias.od.length;
                    document.getElementById('badgeIniciativas').textContent = categorias.iniciativas.length;
                    document.getElementById('badgePrimera').textContent = categorias.primera.length;
                    document.getElementById('badgeSegunda').textContent = categorias.segunda.length;
                    document.getElementById('badgePuntos').textContent = categorias.puntos.length;
                    
                    // Actualizar totales
                    document.getElementById('totalOD').textContent = `${categorias.od.length} elementos`;
                    document.getElementById('totalIniciativas').textContent = `${categorias.iniciativas.length} iniciativas`;
                    document.getElementById('totalPrimera').textContent = `${categorias.primera.length} dictámenes`;
                    document.getElementById('totalSegunda').textContent = `${categorias.segunda.length} dictámenes`;
                    document.getElementById('totalPuntos').textContent = `${categorias.puntos.length} puntos`;
                } else {
                    document.getElementById('ordenDiaTabs').style.display = 'none';
                }
            } catch (error) {
                console.error('Error cargando orden del día:', error);
                document.getElementById('ordenDiaTabs').style.display = 'none';
            }
        }
        
        // Función para renderizar una categoría
        function renderizarCategoria(tipo, items) {
            const contenedores = {
                'od': 'listaOD',
                'iniciativas': 'listaIniciativas',
                'primera': 'listaPrimera',
                'segunda': 'listaSegunda',
                'puntos': 'listaPuntos'
            };
            
            const contenedor = document.getElementById(contenedores[tipo]);
            if (!contenedor) return;
            
            if (items.length === 0) {
                contenedor.innerHTML = `
                    <div class="no-iniciativas">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p>No hay elementos disponibles</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            items.forEach((item) => {
                const numero = item.numero || item.numeroOrden || '';
                const titulo = item.titulo || 'Sin título';
                const descripcion = item.descripcion || '';
                const presentador = item.presentador || '';
                const partido = item.partido_presentador || '';
                
                html += `
                    <div class="iniciativa-item">
                        <div class="d-flex align-items-start">
                            ${numero ? `<span class="iniciativa-numero">${numero}</span>` : ''}
                            <div class="flex-grow-1">
                                <div class="iniciativa-titulo">${titulo}</div>
                                ${descripcion && descripcion !== titulo ? `
                                    <div class="iniciativa-descripcion">${descripcion.substring(0, 200)}${descripcion.length > 200 ? '...' : ''}</div>
                                ` : ''}
                                ${presentador ? `
                                    <small class="text-muted">
                                        <i class="fas fa-user"></i> ${presentador} 
                                        ${partido ? `(${partido})` : ''}
                                    </small>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        // Escuchar eventos del socket para actualizar el orden del día
        socket.on('iniciativas-cargadas', () => {
            console.log('Iniciativas cargadas, actualizando pestañas...');
            cargarOrdenDelDia();
        });
        
        socket.on('sesion-iniciada', () => {
            console.log('Sesión iniciada, cargando orden del día...');
            cargarOrdenDelDia();
        });
        
        socket.on('iniciativa-agregada', () => {
            console.log('Nueva iniciativa agregada, actualizando...');
            cargarOrdenDelDia();
        });
        
        socket.on('iniciativas-actualizadas', () => {
            console.log('Iniciativas actualizadas, recargando...');
            cargarOrdenDelDia();
        });
        
        // Cargar orden del día al iniciar
        if (user && token) {
            setTimeout(() => {
                cargarOrdenDelDia();
            }, 1000);
        }
        
        // Prevenir zoom con pinch en toda la aplicación excepto PDFs
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
        });
        
        // Prevenir doble tap para zoom (excepto en elementos de navegación)
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            // No prevenir en elementos de navegación
            if (event.target.closest('.navbar-toggler') || 
                event.target.closest('.navbar-collapse') ||
                event.target.closest('.btn')) {
                return;
            }
            
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Prevenir zoom con ctrl + scroll
        document.addEventListener('wheel', function(event) {
            if (event.ctrlKey) {
                event.preventDefault();
            }
        }, { passive: false });
        
        // Función para expandir/contraer texto de descripción
        function toggleTextoCompleto() {
            const descElement = document.getElementById('initiativeDescription');
            const btnVerMas = document.getElementById('btnVerMasTexto');
            const expandido = descElement.getAttribute('data-expandido') === 'true';
            
            if (expandido) {
                // Contraer
                descElement.style.maxHeight = '200px';
                descElement.style.overflow = 'hidden';
                btnVerMas.innerHTML = '<i class="fas fa-chevron-down"></i> Ver más';
                descElement.setAttribute('data-expandido', 'false');
            } else {
                // Expandir
                descElement.style.maxHeight = 'none';
                descElement.style.overflow = 'visible';
                btnVerMas.innerHTML = '<i class="fas fa-chevron-up"></i> Ver menos';
                descElement.setAttribute('data-expandido', 'true');
            }
        }
        
        // Función para actualizar el estado de asistencia (para compatibilidad)
        function updateAttendanceStatus(estado) {
            console.log('Actualizando estado de asistencia a:', estado);
            // Actualizar algún indicador visual si existe
            const badgeAsistencia = document.getElementById('attendanceBadge');
            if (badgeAsistencia) {
                badgeAsistencia.style.display = 'inline-block'; // Mostrar el badge
                if (estado === 'presente') {
                    badgeAsistencia.className = 'badge bg-success ms-2';
                    badgeAsistencia.innerHTML = '<i class="fas fa-check-circle"></i> PRESENTE';
                } else if (estado === 'ausente') {
                    badgeAsistencia.className = 'badge bg-danger ms-2';
                    badgeAsistencia.innerHTML = '<i class="fas fa-times-circle"></i> AUSENTE';
                } else if (estado === 'justificado') {
                    badgeAsistencia.className = 'badge bg-warning text-dark ms-2';
                    badgeAsistencia.innerHTML = '<i class="fas fa-exclamation-circle"></i> JUSTIFICADO';
                } else if (estado === '') {
                    // Si el estado está vacío, ocultar el badge
                    badgeAsistencia.style.display = 'none';
                } else {
                    badgeAsistencia.className = 'badge bg-secondary ms-2';
                    badgeAsistencia.innerHTML = '<i class="fas fa-question-circle"></i> SIN REGISTRO';
                }
            }
            
            // También llamar a mostrarEstadoAsistencia si es necesario
            if (typeof mostrarEstadoAsistencia === 'function') {
                mostrarEstadoAsistencia(estado);
            }
        }
        
        // Función para mostrar estado de asistencia
        function mostrarEstadoAsistencia(estado) {
            const statusDiv = document.getElementById('asistenciaStatus');
            const icono = document.getElementById('iconoAsistencia');
            const texto = document.getElementById('estadoAsistenciaTexto');
            const mensaje = document.getElementById('mensajeAsistencia');
            
            if (!statusDiv) return;
            
            statusDiv.style.display = 'block';
            
            switch(estado) {
                case 'presente':
                    statusDiv.className = 'alert alert-success m-3';
                    icono.className = 'fas fa-check-circle text-success';
                    texto.textContent = 'PRESENTE';
                    mensaje.innerHTML = '<i class="fas fa-vote-yea"></i> Puede participar en las votaciones';
                    break;
                    
                case 'ausente':
                    statusDiv.className = 'alert alert-danger m-3';
                    icono.className = 'fas fa-user-times text-danger';
                    texto.textContent = 'AUSENTE';
                    mensaje.innerHTML = '<i class="fas fa-ban"></i> No puede votar (marcado como ausente)';
                    break;
                    
                case 'permiso':
                    statusDiv.className = 'alert alert-info m-3';
                    icono.className = 'fas fa-user-clock text-info';
                    texto.textContent = 'CON PERMISO';
                    mensaje.innerHTML = '<i class="fas fa-info-circle"></i> Ausente con justificación';
                    break;
                    
                default:
                    statusDiv.className = 'alert alert-warning m-3';
                    icono.className = 'fas fa-exclamation-triangle text-warning';
                    texto.textContent = 'NO REGISTRADO';
                    mensaje.innerHTML = '<i class="fas fa-exclamation"></i> Esperando pase de lista';
            }
        }
        
        // Emitir voto
        async function vote(voto) {
            if (!currentInitiative) return;
            
            // Si ya votó, no permitir votar de nuevo (a menos que haya cambiado de opinión)
            if (hasVoted && document.getElementById('votedMessage').style.display === 'block') {
                return;
            }
            
            // Deshabilitar botones
            document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = true);
            
            try {
                const response = await fetch('/api/diputado/votar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        iniciativa_id: currentInitiative.id,
                        voto: voto
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    hasVoted = true;
                    document.getElementById('votingButtons').style.display = 'none';
                    document.getElementById('votedMessage').style.display = 'block';
                    document.getElementById('myVote').textContent = getVoteLabel(voto);
                    
                    // Recargar historial
                    setTimeout(loadHistory, 1000);
                } else {
                    // Verificar si es error de asistencia
                    if (data.estado_asistencia) {
                        mostrarEstadoAsistencia(data.estado_asistencia);
                        alert(`⚠️ ${data.error}\n\n${data.mensaje}`);
                    } else {
                        alert(data.error);
                    }
                    document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = false);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al registrar tu voto');
                document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = false);
            }
        }
        
        // Variables de paginación
        let currentHistoryPage = 1;
        const itemsPerPage = 5;
        let totalHistoryItems = 0;
        let allHistoryData = [];

        // Cargar historial con paginación
        async function loadHistory(page = 1) {
            try {
                const response = await fetch('/api/diputado/mi-historial', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                const container = document.getElementById('votingHistory');
                
                if (data.votos.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">No has emitido votos aún</p>';
                    return;
                }
                
                // Guardar todos los datos y calcular paginación
                allHistoryData = data.votos;
                totalHistoryItems = allHistoryData.length;
                currentHistoryPage = page;
                
                const totalPages = Math.ceil(totalHistoryItems / itemsPerPage);
                const startIndex = (currentHistoryPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, totalHistoryItems);
                const currentPageData = allHistoryData.slice(startIndex, endIndex);
                
                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Iniciativa</th>
                                    <th>Mi Voto</th>
                                    <th>Resultado</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentPageData.map(v => `
                                    <tr>
                                        <td>${v.numero}</td>
                                        <td>${v.titulo}</td>
                                        <td>
                                            <span class="badge bg-${getVoteColor(v.voto)}">
                                                ${getVoteLabel(v.voto)}
                                            </span>
                                        </td>
                                        <td>
                                            ${v.resultado ? `
                                                <span class="badge bg-${v.resultado === 'aprobada' ? 'success' : 'danger'}">
                                                    ${v.resultado.toUpperCase()}
                                                </span>
                                            ` : '<span class="text-muted">Pendiente</span>'}
                                        </td>
                                        <td>${new Date(v.fecha_voto).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${totalPages > 1 ? `
                        <nav aria-label="Paginación del historial">
                            <ul class="pagination pagination-sm justify-content-center">
                                <li class="page-item ${currentHistoryPage === 1 ? 'disabled' : ''}">
                                    <a class="page-link" href="#" onclick="loadHistory(${currentHistoryPage - 1}); return false;">
                                        <i class="fas fa-chevron-left"></i> Anterior
                                    </a>
                                </li>
                                
                                ${Array.from({length: totalPages}, (_, i) => i + 1).map(pageNum => `
                                    <li class="page-item ${pageNum === currentHistoryPage ? 'active' : ''}">
                                        <a class="page-link" href="#" onclick="loadHistory(${pageNum}); return false;">
                                            ${pageNum}
                                        </a>
                                    </li>
                                `).join('')}
                                
                                <li class="page-item ${currentHistoryPage === totalPages ? 'disabled' : ''}">
                                    <a class="page-link" href="#" onclick="loadHistory(${currentHistoryPage + 1}); return false;">
                                        Siguiente <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                        
                        <div class="text-center text-muted small">
                            Mostrando ${startIndex + 1}-${endIndex} de ${totalHistoryItems} votos
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Utilidades
        function getMajorityLabel(tipo) {
            const labels = {
                'simple': 'Mayoría Simple',
                'absoluta': 'Mayoría Absoluta',
                'calificada': 'Mayoría Calificada (2/3)',
                'unanime': 'Unanimidad'
            };
            return labels[tipo] || 'Mayoría Simple';
        }
        
        function getVoteLabel(voto) {
            const labels = {
                'favor': 'A FAVOR',
                'contra': 'EN CONTRA',
                'abstencion': 'ABSTENCIÓN'
            };
            return labels[voto] || voto;
        }
        
        function getVoteColor(voto) {
            const colors = {
                'favor': 'success',
                'contra': 'danger',
                'abstencion': 'secondary'
            };
            return colors[voto] || 'secondary';
        }
        
        // Eventos de socket
        socket.on('iniciativa-activa', (iniciativa) => {
            currentInitiative = iniciativa;
            hasVoted = false;
            
            // Guardar información de la sesión incluyendo el PDF
            sesionActualInfo = {
                archivo_pdf: iniciativa.archivo_pdf
            };
            
            // Mostrar/ocultar botón de consultar PDF en la tarjeta
            const btnPDF = document.getElementById('btnConsultarPDF');
            if (btnPDF) {
                btnPDF.style.display = iniciativa.archivo_pdf ? 'block' : 'none';
            }
            
            // Mostrar/ocultar botón en el menú
            const btnPDFMenu = document.getElementById('btnConsultarSesionMenu');
            if (btnPDFMenu) {
                btnPDFMenu.style.display = iniciativa.archivo_pdf ? 'inline-block' : 'none';
            }
            
            // Mostrar/ocultar botón flotante
            const floatingBtn = document.getElementById('floatingPdfBtn');
            if (floatingBtn) {
                if (iniciativa.archivo_pdf) {
                    floatingBtn.classList.add('active');
                } else {
                    floatingBtn.classList.remove('active');
                }
            }
            
            // Re-habilitar botones cuando se activa una nueva iniciativa
            document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = false);
            showVotingPanel(iniciativa, false, null);
        });
        
        // Escuchar recordatorios de voto
        socket.on(`recordatorio-voto-${user.id}`, (data) => {
            console.log('Recordatorio recibido:', data);
            
            // Mostrar notificación no invasiva
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
            notificationDiv.style.zIndex = '9999';
            notificationDiv.style.maxWidth = '350px';
            notificationDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-bell fa-2x me-3 text-warning"></i>
                    <div>
                        <strong>Recordatorio</strong><br>
                        ${data.mensaje}
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notificationDiv);
            
            // Hacer parpadear el panel de votación
            if (currentInitiative && !hasVoted) {
                const votingPanel = document.getElementById('votingPanel');
                votingPanel.classList.add('pulse-animation');
                setTimeout(() => {
                    votingPanel.classList.remove('pulse-animation');
                }, 3000);
            }
            
            // Auto-cerrar después de 10 segundos
            setTimeout(() => {
                if (notificationDiv.parentNode) {
                    notificationDiv.remove();
                }
            }, 10000);
        });
        
        // Escuchar cambios de habilitación
        socket.on(`estado-habilitacion-${user.id}`, (data) => {
            console.log('Estado de habilitación cambiado:', data);
            
            if (!data.habilitado) {
                // Si fue deshabilitado, mostrar mensaje y bloquear votación
                alert(data.mensaje);
                
                // Deshabilitar botones de voto
                document.querySelectorAll('.vote-btn').forEach(btn => {
                    btn.disabled = true;
                });
                
                // Mostrar mensaje en el panel
                const votingPanel = document.getElementById('votingPanel');
                if (votingPanel) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger mt-3';
                    alertDiv.innerHTML = `
                        <i class="fas fa-ban"></i> 
                        ${data.mensaje}. Contacte al Secretario Legislativo.
                    `;
                    votingPanel.insertBefore(alertDiv, votingPanel.firstChild);
                }
                
                // Recargar página después de 3 segundos
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                // Si fue habilitado, recargar la página
                alert(data.mensaje);
                window.location.reload();
            }
        });
        
        socket.on('votacion-cerrada', (data) => {
            // Mostrar notificación de resultados
            mostrarNotificacionResultado(data);
            showNoVoting();
            loadHistory();
        });
        
        socket.on('votacion-completa', () => {
            if (hasVoted) {
                const msg = document.getElementById('votedMessage').querySelector('p.text-muted');
                if (msg) {
                    msg.innerHTML = '<i class="fas fa-check-circle text-success"></i> ¡Todos han votado! La votación se cerrará pronto.';
                }
            }
        });
        
        // Eventos de sesión
        // Notificación específica para el presidente cuando el secretario clausura
        socket.on('notificacion-presidente', (data) => {
            if (user.cargo_mesa_directiva === 'presidente') {
                if (data.tipo === 'sesion_clausurada_por_secretario') {
                    alert(`⚠️ NOTIFICACIÓN:\n\n${data.mensaje}\n\nEstadísticas de la sesión:\n- Iniciativas votadas: ${data.estadisticas.total_iniciativas}\n- Aprobadas: ${data.estadisticas.aprobadas}\n- Rechazadas: ${data.estadisticas.rechazadas}`);
                }
            }
        });
        
        // Escuchar notificación del operador para mesa directiva
        socket.on('sesion-lista-para-iniciar', (data) => {
            if (user.cargo_mesa_directiva === 'presidente' || 
                user.cargo_mesa_directiva === 'secretario1' || 
                user.cargo_mesa_directiva === 'secretario2') {
                
                // Crear notificación visual (ajustada 30px más abajo para no chocar con menú)
                const notification = document.createElement('div');
                notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
                notification.style.cssText = 'top: 130px; right: 20px; z-index: 9999; max-width: 400px;';
                notification.innerHTML = `
                    <h5 class="alert-heading">
                        <i class="fas fa-bell"></i> Sesión Lista para Iniciar
                    </h5>
                    <div class="menu-divider"></div>
                    <p><strong>Operador:</strong> ${data.operador}</p>
                    <p><strong>Sesión:</strong> ${data.sesion}</p>
                    <p><strong>Iniciativas cargadas:</strong> ${data.totalIniciativas}</p>
                    <div class="menu-divider"></div>
                    <p class="mb-0">Ya puede iniciar la sesión legislativa</p>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(notification);
                
                // Habilitar botón de iniciar sesión si es presidente
                if (user.cargo_mesa_directiva === 'presidente') {
                    // Solo mostrar botón si la sesión no ha sido iniciada aún
                    checkSessionStatus();
                }
                
                // Auto-cerrar después de 30 segundos
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 30000);
            }
        });
        
        socket.on('sesion-iniciada', (data) => {
            console.log('Sesión iniciada:', data);
            if (user.cargo_mesa_directiva) {
                alert(`Sesión iniciada por ${data.iniciada_por}: ${data.nombre}`);
                checkSessionStatus();
                startSessionTimer();
            }
        });
        
        socket.on('sesion-clausurada', (data) => {
            console.log('Sesión clausurada:', data);
            alert(`Sesión clausurada por ${data.clausurada_por}\n\nEstadísticas finales:\n- Total iniciativas: ${data.estadisticas.total_iniciativas}\n- Aprobadas: ${data.estadisticas.aprobadas}\n- Rechazadas: ${data.estadisticas.rechazadas}`);
            
            // Detener cronómetro
            sessionStartTime = null;
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
                sessionTimerInterval = null;
            }
            document.getElementById('sessionTimer').textContent = '00:00:00';
            
            // Actualizar estado
            if (user.cargo_mesa_directiva === 'presidente' || user.cargo_mesa_directiva === 'vicepresidente') {
                checkSessionStatus();
            }
            
            // Ocultar panel de votación
            showNoVoting();
        });
        
        // Variable para rastrear si ya confirmé asistencia
        let yaConfirmeAsistencia = false;
        
        // Sincronización del pase de lista entre secretarios
        socket.on('pase-lista-activado', async (data) => {
            console.log('Pase de lista activado:', data);
            
            // Primero verificar mi estado actual de asistencia
            await checkMyAttendance();
            
            // Solo mostrar el botón si NO he confirmado asistencia todavía
            if (!yaConfirmeAsistencia) {
                const containerAsistencia = document.getElementById('btnConfirmarAsistenciaContainer');
                if (containerAsistencia) {
                    containerAsistencia.style.display = 'block';
                    const btnAsistencia = document.getElementById('btnConfirmarAsistencia');
                    if (btnAsistencia) {
                        btnAsistencia.classList.add('pulse-animation');
                    }
                }
                
                // Notificación para diputados que no han pasado lista
                showNotification('📋 Pase de lista activado', 'success');
                showNotification('Todo listo para marcar tu asistencia, da click en el botón verde', 'info');
            } else {
                // Si ya pasé lista, mostrar un botón gris temporalmente
                mostrarBotonPresente();
                console.log('Ya confirmé asistencia previamente, no muestro botón verde');
            }
        });
        
        // Escuchar cuando se confirma una asistencia (para actualizar en tiempo real)
        socket.on('asistencia-confirmada', (data) => {
            console.log('Asistencia confirmada:', data);
            // Si es mi propia asistencia, ocultar el botón
            if (data.diputado_id === user.id) {
                const containerAsistencia = document.getElementById('btnConfirmarAsistenciaContainer');
                if (containerAsistencia) {
                    containerAsistencia.style.display = 'none';
                }
                updateAttendanceStatus('presente');
            }
        });
        
        // Escuchar cuando se reinicia el pase de lista
        socket.on('pase-lista-reiniciado', (data) => {
            console.log('Pase de lista reiniciado:', data);
            
            // Resetear la variable de asistencia confirmada
            yaConfirmeAsistencia = false;
            
            // Mostrar notificación
            showNotification('🔄 ' + data.mensaje, 'warning');
            
            // Limpiar estado de asistencia
            updateAttendanceStatus('');
            
            // Restaurar el botón original para cuando se reactive
            const containerAsistencia = document.getElementById('btnConfirmarAsistenciaContainer');
            if (containerAsistencia) {
                containerAsistencia.innerHTML = `
                    <h4 class="text-center mb-4">
                        <i class="fas fa-clipboard-check"></i> Pase de Lista Activo
                    </h4>
                    <button class="btn btn-success attendance-btn btn-presente" id="btnConfirmarAsistencia" onclick="confirmarMiAsistencia()">
                        <i class="fas fa-user-check"></i>
                        <span>CONFIRMAR MI ASISTENCIA</span>
                    </button>
                    <div class="text-center mt-3 text-muted">
                        <small>Presione el botón para confirmar que está presente en la sesión</small>
                    </div>
                `;
                containerAsistencia.style.display = 'none';
            }
        });
        
        // Escuchar cuando se reactiva el pase de lista después de reabrir
        socket.on('pase-lista-reabierto', (data) => {
            console.log('Pase de lista reabierto:', data);
            showNotification('📋 Pase de lista reabierto para ajustes', 'info');
            
            // NO resetear yaConfirmeAsistencia aquí
            // Solo verificar si ya confirmé asistencia
            checkMyAttendance();
        });
        
        // Escuchar cuando el secretario actualice mi asistencia
        socket.on('asistencia-actualizada', (data) => {
            if (data.usuario_id === user.id) {
                console.log('Mi asistencia fue actualizada:', data.estado);
                mostrarEstadoAsistencia(data.estado);
                
                // Mostrar notificación según el estado
                const mensaje = data.estado === 'presente' ? 
                    '✅ Has sido marcado como PRESENTE' :
                    data.estado === 'ausente' ?
                    '❌ Has sido marcado como AUSENTE' :
                    'ℹ️ Has sido marcado con PERMISO';
                    
                showNotification(mensaje, 
                    data.estado === 'presente' ? 'success' : 
                    data.estado === 'ausente' ? 'danger' : 'info');
            }
        });
        
        socket.on('pase-lista-desactivado', (data) => {
            console.log('Pase de lista finalizado:', data);
            showNotification('Pase de lista finalizado', 'info');
        });
        
        // Verificar periódicamente
        setInterval(checkActiveInitiative, 10000);
        
        // Cargar información del usuario
        async function loadUserInfo() {
            console.log('Iniciando carga de información del diputado...');
            try {
                const response = await fetch('/api/diputado/mi-informacion', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    console.error('Error en respuesta:', response.status);
                    // Mostrar información básica del localStorage
                    document.getElementById('fullName').textContent = user.nombre_completo || user.nombre || 'Diputado';
                    document.getElementById('userCargo').textContent = 'Diputado';
                    document.getElementById('userCommission').textContent = 'Sin comisión asignada';
                    document.getElementById('partyBadge').textContent = 'Sin partido';
                    return;
                }
                
                const data = await response.json();
                console.log('Datos del diputado cargados:', data);
                
                // Actualizar el objeto user con la información completa
                user.cargo_mesa_directiva = data.cargo_mesa_directiva;
                user.partido = data.partido;
                user.comision = data.comision;
                user.nombre = data.nombre;
                user.nombre_completo = data.nombre_completo;
                user.fotografia = data.fotografia;
                user.cargo_legislativo = data.cargo_legislativo;
                // Mantener el username original si no viene en la respuesta
                if (data.username) user.username = data.username;
                if (data.usuario) user.usuario = data.usuario;
                localStorage.setItem('user', JSON.stringify(user));
                
                // Verificar si es secretario después de cargar la información
                checkIfSecretary();
                
                // Mostrar información del coordinador en el navbar
                updateCoordinatorInfo(data);
                
                // Actualizar información en la interfaz (con verificación de elementos)
                const fullNameEl = document.getElementById('fullName');
                const userCargoEl = document.getElementById('userCargo');
                const userCommissionEl = document.getElementById('userCommission');
                
                if (fullNameEl) fullNameEl.textContent = data.nombre_completo || data.nombre || 'Diputado';
                if (userCargoEl) {
                    // Mostrar cargo oficial para Isaac Pimentel (Presidente de la Mesa Directiva)
                    if (data.nombre_completo === 'Isaac Pimentel Mejía' && data.cargo_mesa_directiva === 'presidente') {
                        userCargoEl.textContent = 'Presidente de la Mesa Directiva del H. Congreso del Estado de Morelos';
                    } else {
                        userCargoEl.textContent = data.cargo_legislativo || data.cargo_mesa_directiva || 'Diputado';
                    }
                }
                if (userCommissionEl) userCommissionEl.textContent = data.comision || 'Sin comisión asignada';
                
                // Obtener datos del partido
                const partidoInfo = partidosData[data.partido] || null;
                const partyColor = partidoInfo ? partidoInfo.color_primario : '#6c757d';
                
                // Actualizar badge del partido
                const partyBadge = document.getElementById('partyBadge');
                if (partyBadge) {
                    partyBadge.textContent = data.partido || 'Independiente';
                    partyBadge.style.backgroundColor = partyColor;
                }
                
                // Mostrar logo del partido si existe
                if (partidoInfo && partidoInfo.logo_url) {
                    const partyLogo = document.getElementById('partyLogo');
                    if (partyLogo) {
                        partyLogo.src = partidoInfo.logo_url;
                        partyLogo.style.display = 'inline-block';
                    }
                }
                
                // Actualizar avatar con foto o iniciales
                const deputyAvatar = document.getElementById('deputyAvatar');
                if (deputyAvatar) {
                    if (data.foto_url) {
                        deputyAvatar.style.backgroundImage = `url(${data.foto_url})`;
                        deputyAvatar.innerHTML = '';
                    } else if (data.nombre_completo) {
                        const iniciales = data.nombre_completo.split(' ').map(n => n[0]).slice(0, 2).join('');
                        deputyAvatar.textContent = iniciales;
                        deputyAvatar.style.backgroundColor = partyColor;
                    } else {
                        deputyAvatar.textContent = 'D';
                        deputyAvatar.style.backgroundColor = '#6c757d';
                    }
                }
                
                // Aplicar colores del partido
                applyPartyColors(partyColor);
                
                // Código anterior del placeholder
                const photoContainer = document.getElementById('userPhotoContainer');
                if (photoContainer) {
                    if (data.foto_url) {
                        photoContainer.innerHTML = `<img src="${data.foto_url}" class="user-photo" alt="Foto">`;
                    } else {
                            photoContainer.innerHTML = `
                            <div class="user-photo-placeholder">
                                <i class="fas fa-user"></i>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error cargando información del usuario:', error);
                // Mostrar información básica en caso de error
                const fullNameEl = document.getElementById('fullName');
                const userCargoEl = document.getElementById('userCargo');
                const userCommissionEl = document.getElementById('userCommission');
                const partyBadge = document.getElementById('partyBadge');
                const deputyAvatar = document.getElementById('deputyAvatar');
                
                if (fullNameEl) fullNameEl.textContent = user.nombre_completo || user.nombre || 'Diputado';
                if (userCargoEl) userCargoEl.textContent = 'Diputado';
                if (userCommissionEl) userCommissionEl.textContent = 'Sin información disponible';
                if (partyBadge) {
                    partyBadge.textContent = 'Sin partido';
                    partyBadge.style.backgroundColor = '#6c757d';
                }
                if (deputyAvatar) {
                    deputyAvatar.textContent = 'D';
                    deputyAvatar.style.backgroundColor = '#6c757d';
                }
            }
        }
        
        // Reloj en tiempo real (para todos)
        function updateClock() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;
        }
        
        // Iniciar reloj
        setInterval(updateClock, 1000);
        updateClock();
        
        // Fix para el menú hamburguesa - Solución definitiva
        function initializeHamburgerMenu() {
            const navbarToggler = document.querySelector('.navbar-toggler');
            const navbarCollapse = document.querySelector('#navbarContent');
            
            if (!navbarToggler || !navbarCollapse) {
                console.log('Elementos del navbar no encontrados, reintentando...');
                setTimeout(initializeHamburgerMenu, 100);
                return;
            }
            
            console.log('Inicializando menú hamburguesa...');
            
            // Remover cualquier instancia previa de Bootstrap Collapse
            try {
                const existingCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                if (existingCollapse) {
                    existingCollapse.dispose();
                }
            } catch (e) {
                // Ignorar si no existe
            }
            
            // Remover todos los event listeners previos clonando el botón
            const newToggler = navbarToggler.cloneNode(true);
            navbarToggler.parentNode.replaceChild(newToggler, navbarToggler);
            
            // Método híbrido que funciona tanto con Bootstrap como sin él
            newToggler.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Intentar usar Bootstrap primero
                try {
                    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(navbarCollapse);
                    bsCollapse.toggle();
                    console.log('Menú toggled con Bootstrap');
                } catch (error) {
                    // Fallback manual si Bootstrap falla
                    const isShowing = navbarCollapse.classList.contains('show');
                    
                    if (isShowing) {
                        navbarCollapse.classList.remove('show');
                        navbarCollapse.style.display = 'none';
                        newToggler.setAttribute('aria-expanded', 'false');
                    } else {
                        navbarCollapse.classList.add('show');
                        navbarCollapse.style.display = 'block';
                        newToggler.setAttribute('aria-expanded', 'true');
                    }
                    
                    console.log('Menú toggled manualmente - está:', !isShowing ? 'abierto' : 'cerrado');
                }
            });
            
            // Asegurar que el botón es clickeable
            newToggler.style.pointerEvents = 'auto';
            newToggler.style.cursor = 'pointer';
            newToggler.style.zIndex = '10000';
            
            // Asegurar que el menú colapsado también tenga z-index alto
            navbarCollapse.style.zIndex = '99999';
            
            console.log('✓ Menú hamburguesa inicializado correctamente');
            
            // Debug
            if (user && user.cargo_mesa_directiva) {
                console.log('Usuario mesa directiva:', user.cargo_mesa_directiva);
            }
        }
        
        // Fix para los tabs del modal de Servicios Legislativos
        function initializeModalTabs() {
            const modal = document.getElementById('modalServiciosLegislativos');
            if (!modal) return;
            
            console.log('Inicializando tabs del modal...');
            
            // Función para manejar los tabs
            function setupTabs() {
                const tabLinks = modal.querySelectorAll('.nav-tabs .nav-link');
                const tabPanes = modal.querySelectorAll('.tab-content .tab-pane');
                
                if (tabLinks.length === 0) {
                    console.log('No se encontraron tabs');
                    return;
                }
                
                // Remover event listeners previos y agregar nuevos
                tabLinks.forEach(link => {
                    // Clonar para limpiar listeners
                    const newLink = link.cloneNode(true);
                    link.parentNode.replaceChild(newLink, link);
                    
                    newLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Remover active de todos
                        tabLinks.forEach(l => {
                            l.classList.remove('active');
                            l.setAttribute('aria-selected', 'false');
                        });
                        tabPanes.forEach(p => {
                            p.classList.remove('show', 'active', 'fade');
                        });
                        
                        // Activar el clickeado
                        this.classList.add('active');
                        this.setAttribute('aria-selected', 'true');
                        
                        const targetId = this.getAttribute('href');
                        if (targetId && targetId.startsWith('#')) {
                            const targetPane = document.querySelector(targetId);
                            if (targetPane) {
                                // Agregar clases en orden correcto
                                targetPane.classList.add('fade');
                                setTimeout(() => {
                                    targetPane.classList.add('show', 'active');
                                }, 10);
                            }
                        }
                        
                        console.log('Tab activado:', targetId);
                    });
                });
                
                console.log('✓ Tabs inicializados correctamente');
            }
            
            // Inicializar cuando el modal se muestra
            modal.addEventListener('shown.bs.modal', setupTabs);
            
            // También inicializar si el modal ya está visible
            if (modal.classList.contains('show')) {
                setupTabs();
            }
        }
        
        // Esperar a que Bootstrap esté completamente cargado
        if (typeof bootstrap !== 'undefined') {
            setTimeout(() => {
                initializeHamburgerMenu();
                initializeModalTabs();
            }, 100);
        } else {
            // Si Bootstrap no está listo, esperar
            window.addEventListener('load', function() {
                setTimeout(() => {
                    initializeHamburgerMenu();
                    initializeModalTabs();
                }, 500);
            });
        }
        
        // Cronómetro de sesión (solo para mesa directiva, secretarios y superadmin)
        // Variables ya declaradas arriba, no duplicar
        
        function shouldShowSessionTimer() {
            return user.cargo_mesa_directiva || 
                   user.role === 'secretario' || 
                   user.role === 'superadmin';
        }
        
        async function startSessionTimer() {
            // Solo mostrar cronómetro a usuarios autorizados
            if (!shouldShowSessionTimer()) return;
            
            try {
                const response = await fetch('/api/diputado/tiempo-sesion', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.sesionActiva && data.inicioSesion) {
                    sessionStartTime = new Date(data.inicioSesion);
                    document.getElementById('sessionTimerContainer').style.display = 'inline-block';
                    
                    // Actualizar cada segundo
                    if (sessionTimerInterval) clearInterval(sessionTimerInterval);
                    sessionTimerInterval = setInterval(updateTimer, 1000);
                    updateTimer();
                }
            } catch (error) {
                console.error('Error obteniendo tiempo de sesión:', error);
            }
        }
        
        function updateTimer() {
            if (!sessionStartTime) return;
            
            const now = new Date();
            const elapsed = Math.floor((now - sessionStartTime) / 1000);
            
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('sessionTimer').textContent = timeString;
        }
        
        // Aplicar colores del partido dinámicamente
        function applyPartyColors(partyColor) {
            const style = document.createElement('style');
            style.innerHTML = `
                .deputy-header {
                    border-left-color: ${partyColor} !important;
                }
                .deputy-avatar {
                    border-color: ${partyColor} !important;
                }
                .vote-btn:hover {
                    box-shadow: 0 10px 25px ${partyColor}33 !important;
                }
                .party-badge {
                    background-color: ${partyColor} !important;
                }
            `;
            document.head.appendChild(style);
        }
        
        // Cargar configuración del sistema
        async function loadSystemConfig() {
            try {
                const response = await fetch('/api/configuracion/public');
                if (response.ok) {
                    const config = await response.json();
                    const logosDiv = document.getElementById('congressLogos');
                    
                    if (config.logo_congreso) {
                        logosDiv.innerHTML += `<img src="${config.logo_congreso}" alt="Logo Principal">`;
                    }
                    if (config.logo_secundario) {
                        logosDiv.innerHTML += `<img src="${config.logo_secundario}" alt="Logo Secundario">`;
                    }
                }
            } catch (error) {
                console.error('Error cargando configuración:', error);
            }
        }
        
        // Verificar cargo en mesa directiva
        function updateCoordinatorInfo(data) {
            // Obtener el nombre del coordinador desde la base de datos
            let coordinatorName = data.nombre_coordinador || '';
            let partyLogo = '';
            
            if (data.partido && coordinatorName) {
                
                // Configurar logo del partido
                const partyLogos = {
                    'MORENA': '/images/partidos/morena.svg',
                    'PAN': '/images/partidos/pan.svg',
                    'PRI': '/images/partidos/pri.svg',
                    'PT': '/images/partidos/pt.svg',
                    'PVEM': '/images/partidos/pvem.svg',
                    'MC': '/images/partidos/mc.svg',
                    'PRD': '/images/partidos/prd.svg',
                    'PNA': '/images/partidos/pna.svg',
                    'NUEVA ALIANZA': '/images/partidos/nueva-alianza.svg'
                };
                
                partyLogo = partyLogos[data.partido] || '';
                
                // Actualizar el navbar
                const coordinatorInfo = document.getElementById('coordinatorInfo');
                const coordinatorNameElement = document.getElementById('coordinatorName');
                const coordinatorPartyLogo = document.getElementById('coordinatorPartyLogo');
                
                if (coordinatorInfo && coordinatorNameElement) {
                    coordinatorNameElement.textContent = coordinatorName;
                    coordinatorInfo.style.display = 'inline-block';
                    
                    if (partyLogo && coordinatorPartyLogo) {
                        coordinatorPartyLogo.src = partyLogo;
                        coordinatorPartyLogo.alt = data.partido;
                        coordinatorPartyLogo.style.display = 'inline-block';
                    }
                }
            }
        }
        
        function checkIfSecretary() {
            const cargo = user.cargo_mesa_directiva || '';
            console.log('Verificando cargo mesa directiva:', cargo || 'Sin cargo');
            console.log('Usuario completo:', user);
            
            // Normalizar el cargo para comparación
            const cargoLower = cargo.toLowerCase().trim();
            
            // Mostrar menú de secretario en el panel lateral
            if (cargoLower === 'secretario1' || cargoLower === 'secretario2' || 
                (cargoLower.includes('secretario') && cargoLower !== '')) {
                console.log('Es secretario, mostrando panel en menú lateral');
                const panelSecretario = document.getElementById('panelSecretario');
                if (panelSecretario) {
                    panelSecretario.style.display = 'block';
                }
            }
            
            // Verificar estado del pase de lista para TODOS los diputados
            // Comentado temporalmente - la ruta /api/pase-lista/estado no existe
            // verificarEstadoPaseLista();
            
            // Mostrar panel de control de presidente/vicepresidente
            if (cargoLower === 'presidente' || cargoLower === 'presidente de la mesa directiva') {
                console.log('Es presidente, mostrando panel de control');
                const presidentControls = document.getElementById('presidentControls');
                const panelPresidente = document.getElementById('panelPresidente');
                
                if (presidentControls) {
                    presidentControls.style.display = 'block';
                }
                if (panelPresidente) {
                    panelPresidente.style.display = 'block';
                }
                checkSessionStatus();
            } else if (cargoLower === 'vicepresidente') {
                console.log('Es vicepresidente, verificando autorización');
                verificarAutorizacionVicepresidente();
            } else if (!cargo || cargo === '') {
                console.log('Diputado sin cargo en mesa directiva - paneles especiales no mostrados');
            }
        }
        
        // Función para abrir streaming en vivo - DESHABILITADA porque ya tenemos PWA
        // function abrirStreamingLive() {
        //     toggleMenu();
        //     
        //     // Usar la página personalizada con fondo parallax y PWA
        //     const currentHost = window.location.protocol + '//' + window.location.host;
        //     window.open(currentHost + '/streaming-live', '_blank');
        //     
        //     // Opción alternativa: Abrir directamente LiveLAN de vMix (sin interfaz personalizada)
        //     // window.open('http://192.168.150.71:8088/livelan', '_blank', 'width=1280,height=720,toolbar=no,menubar=no,location=no');
        // }
        
        // Verificar autorización del vicepresidente
        async function verificarAutorizacionVicepresidente() {
            try {
                const response = await fetch('/api/diputado/vicepresidente-autorizado', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.autorizado) {
                        console.log('Vicepresidente autorizado para funciones de presidente');
                        document.getElementById('presidentControls').style.display = 'block';
                        checkSessionStatus();
                    } else {
                        console.log('Vicepresidente no autorizado');
                        document.getElementById('presidentControls').style.display = 'none';
                    }
                } else {
                    // Si el endpoint no existe o hay error, mostrar controles por defecto para vicepresidente
                    console.log('Verificación de autorización no disponible, mostrando controles');
                    document.getElementById('presidentControls').style.display = 'block';
                    checkSessionStatus();
                }
            } catch (error) {
                console.error('Error verificando autorización:', error);
                // En caso de error, mostrar controles por defecto para vicepresidente
                document.getElementById('presidentControls').style.display = 'block';
                checkSessionStatus();
            }
        }
        
        // Listener para cambios de autorización en tiempo real
        socket.on('autorizacion-vicepresidente-cambiada', (data) => {
            if (user.cargo_mesa_directiva === 'vicepresidente') {
                if (data.autorizado) {
                    alert(`Has sido autorizado por ${data.autorizado_por} para usar funciones del Presidente`);
                    document.getElementById('presidentControls').style.display = 'block';
                    checkSessionStatus();
                } else {
                    alert('Tu autorización para usar funciones del Presidente ha sido revocada');
                    document.getElementById('presidentControls').style.display = 'none';
                }
            }
        });
        
        // Verificar estado de la sesión para presidente/vicepresidente
        async function checkSessionStatus() {
            try {
                const response = await fetch('/api/diputado/sesion-actual', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                updateSessionControls(data);
            } catch (error) {
                console.error('Error obteniendo estado de sesión:', error);
            }
        }
        
        function updateSessionControls(data) {
            const statusDiv = document.getElementById('sessionControlStatus');
            const btnIniciar = document.getElementById('btnIniciarSesion');
            const btnPausar = document.getElementById('btnPausarSesion');
            const btnReanudar = document.getElementById('btnReanudarSesion');
            const btnClausurar = document.getElementById('btnClausurarSesion');
            const statsDiv = document.getElementById('sessionStats');
            const pauseTimerContainer = document.getElementById('pauseTimerContainer');
            
            // Primero ocultar todos los botones
            btnIniciar.style.display = 'none';
            btnPausar.style.display = 'none';
            btnReanudar.style.display = 'none';
            btnClausurar.style.display = 'none';
            
            if (data.sesion_activa) {
                // Verificar si la sesión está iniciada o solo preparada
                const sesionIniciada = data.sesion.fecha_inicio && data.sesion.fecha_inicio !== null;
                const sesionClausurada = data.sesion.fecha_clausura && data.sesion.fecha_clausura !== null;
                
                statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Sesión:</strong> ${data.sesion.nombre} | 
                                <strong>Estado:</strong> ${sesionClausurada ? 'Clausurada' : sesionIniciada ? 'Iniciada' : 'Preparada'} 
                                ${sesionIniciada && !sesionClausurada ? ` | <strong>Inicio:</strong> ${new Date(data.sesion.fecha_inicio).toLocaleString('es-MX', {hour: '2-digit', minute: '2-digit'})}` : ''}
                            </div>
                            ${data.sesion.pausada ? '<span class="badge bg-warning">PAUSADA</span>' : ''}
                        </div>
                        ${data.mensaje_iniciativas ? `<div class="alert alert-warning mt-2 mb-0"><i class="fas fa-exclamation-triangle"></i> ${data.mensaje_iniciativas}</div>` : ''}
                    </div>
                `;
                
                // Si la sesión NO está iniciada pero está activa (preparada)
                if (!sesionIniciada && !sesionClausurada && data.puede_iniciar) {
                    btnIniciar.style.display = 'block';
                }
                // Si la sesión ESTÁ iniciada pero NO clausurada
                else if (sesionIniciada && !sesionClausurada) {
                    console.log('Sesión iniciada - configurando botones de control');
                    // Mostrar botones de pausa/reanudar según estado
                    if (data.puede_pausar) {
                        if (data.sesion.pausada) {
                            btnPausar.style.display = 'none';
                            btnReanudar.style.display = 'block';
                            // Mostrar y activar cronómetro de pausa
                            pauseTimerContainer.style.display = 'block';
                            if (!pauseTimerInterval) {
                                startPauseTimer();
                            }
                        } else {
                            btnPausar.style.display = 'block';
                            btnPausar.innerHTML = '<i class="fas fa-pause"></i> Pausar Sesión';
                            btnPausar.className = 'btn btn-warning btn-lg';
                            btnReanudar.style.display = 'none';
                            // Ocultar cronómetro de pausa
                            pauseTimerContainer.style.display = 'none';
                            stopPauseTimer();
                        }
                    }
                    // Mostrar botón de clausurar solo si puede
                    if (data.puede_clausurar) {
                        btnClausurar.style.display = 'block';
                    }
                }
                
                // Mostrar botón de recordatorios si es presidente o vicepresidente autorizado
                const btnRecordatorios = document.getElementById('btnRecordatorios');
                if (btnRecordatorios) {
                    btnRecordatorios.style.display = (isPresidente || (user.cargo_mesa_directiva === 'vicepresidente' && data.puede_clausurar)) ? 'block' : 'none';
                }
                
                if (data.estadisticas) {
                    statsDiv.style.display = 'block';
                    statsDiv.innerHTML = `
                        <div class="row text-center">
                            <div class="col-4">
                                <h5>${data.estadisticas.total_iniciativas}</h5>
                                <small>Iniciativas</small>
                            </div>
                            <div class="col-4">
                                <h5>${data.estadisticas.votaciones_cerradas}</h5>
                                <small>Cerradas</small>
                            </div>
                            <div class="col-4">
                                <h5>${data.estadisticas.votaciones_activas}</h5>
                                <small>Activas</small>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Mensaje según si hay iniciativas cargadas o no
                let mensaje = '';
                if (data.mensaje_iniciativas) {
                    mensaje = `
                        <div class="alert alert-warning">
                            <strong>No hay sesión activa</strong><br>
                            <small class="text-danger">${data.mensaje_iniciativas}</small>
                        </div>
                    `;
                } else {
                    mensaje = `
                        <div class="alert alert-warning">
                            <strong>No hay sesión activa</strong><br>
                            <small>Puedes iniciar una nueva sesión legislativa</small>
                        </div>
                    `;
                }
                
                statusDiv.innerHTML = mensaje;
                
                // Mostrar botón solo si puede iniciar Y hay iniciativas
                btnIniciar.style.display = data.puede_iniciar ? 'block' : 'none';
                btnIniciar.disabled = !data.iniciativas_cargadas;
                
                // Actualizar texto del botón si está deshabilitado
                if (!data.iniciativas_cargadas && data.puede_iniciar) {
                    btnIniciar.title = 'El operador debe cargar las iniciativas primero';
                    btnIniciar.classList.add('btn-secondary');
                    btnIniciar.classList.remove('btn-success');
                } else if (data.puede_iniciar) {
                    btnIniciar.title = 'Iniciar nueva sesión legislativa';
                    btnIniciar.classList.add('btn-success');
                    btnIniciar.classList.remove('btn-secondary');
                }
                
                btnClausurar.style.display = 'none';
                statsDiv.style.display = 'none';
            }
        }
        
        // Funciones del cronómetro de pausa
        function startPauseTimer() {
            pauseStartTime = Date.now();
            if (pauseTimerInterval) clearInterval(pauseTimerInterval);
            pauseTimerInterval = setInterval(updatePauseTimer, 1000);
            updatePauseTimer();
        }
        
        function stopPauseTimer() {
            if (pauseTimerInterval) {
                clearInterval(pauseTimerInterval);
                pauseTimerInterval = null;
            }
            pauseStartTime = null;
            document.getElementById('pauseTimer').textContent = '00:00:00';
        }
        
        function updatePauseTimer() {
            if (!pauseStartTime) return;
            
            const elapsed = Date.now() - pauseStartTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('pauseTimer').textContent = timeString;
        }
        
        // Pausar sesión simple (sin modal)
        async function pausarSesionSimple() {
            if (!confirm('¿Deseas pausar la sesión?')) return;
            
            try {
                const response = await fetch('/api/diputado/pausar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ minutos: 0 }) // Sin tiempo límite
                });
                
                if (response.ok) {
                    sessionPaused = true;
                    // Pausar el cronómetro principal
                    if (sessionTimerInterval) {
                        clearInterval(sessionTimerInterval);
                    }
                    // Iniciar cronómetro de pausa
                    startPauseTimer();
                    checkSessionStatus();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al pausar sesión');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al pausar sesión');
            }
        }
        
        // Reanudar sesión
        async function reanudarSesion() {
            try {
                const response = await fetch('/api/diputado/reanudar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    sessionPaused = false;
                    // Detener cronómetro de pausa
                    stopPauseTimer();
                    // Ocultar contenedor de pausa
                    const pauseContainer = document.getElementById('pauseTimerContainer');
                    if (pauseContainer) {
                        pauseContainer.style.display = 'none';
                    }
                    // Reanudar cronómetro principal
                    startSessionTimer();
                    checkSessionStatus();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al reanudar sesión');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al reanudar sesión');
            }
        }
        
        // Iniciar sesión
        async function iniciarSesion() {
            if (!confirm('¿Deseas iniciar una nueva sesión legislativa?')) return;
            
            try {
                const response = await fetch('/api/diputado/iniciar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Sesión iniciada correctamente');
                    // Forzar actualización inmediata y después de un pequeño retraso
                    checkSessionStatus();
                    setTimeout(() => {
                        checkSessionStatus();
                        startSessionTimer(); // Reiniciar cronómetro
                    }, 500);
                } else {
                    // Mostrar mensaje más específico si es por falta de iniciativas
                    if (data.requiere_iniciativas) {
                        alert('❌ No se puede iniciar la sesión\n\n' + data.mensaje);
                    } else {
                        alert(data.error || 'Error al iniciar sesión');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al iniciar sesión');
            }
        }
        
        // Clausurar sesión
        async function clausurarSesion() {
            if (!confirm('¿Estás seguro de clausurar la sesión? Esto cerrará todas las votaciones activas.')) return;
            
            try {
                const response = await fetch('/api/diputado/clausurar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Sesión clausurada correctamente.\n\nEstadísticas:\n- Iniciativas: ${data.estadisticas.total_iniciativas}\n- Aprobadas: ${data.estadisticas.aprobadas}\n- Rechazadas: ${data.estadisticas.rechazadas}`);
                    checkSessionStatus();
                    sessionStartTime = null; // Detener cronómetro
                    if (sessionTimerInterval) {
                        clearInterval(sessionTimerInterval);
                        sessionTimerInterval = null;
                    }
                    document.getElementById('sessionTimer').textContent = '00:00:00';
                } else {
                    alert(data.error || 'Error al clausurar sesión');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al clausurar sesión');
            }
        }
        
        // Función para ir directamente al pase de lista (para Diputados-Secretarios)
        function abrirPaseLista() {
            // Redirigir directamente a la página de pase de lista
            window.location.href = '/pase-lista';
        }
        
        // Activar pase de lista (función legacy - mantener por compatibilidad)
        async function activarPaseLista() {
            if (!confirm('¿Activar el pase de lista?\n\nEsto mostrará la pantalla de asistencia pública.')) return;
            
            try {
                const response = await fetch('/api/pase-lista/activar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Emitir evento para actualizar pantalla pública
                    socket.emit('pase-lista-activado', {
                        activo: true,
                        sesion_id: data.sesion_id
                    });
                    
                    // Mostrar notificación
                    showNotification('✅ Pase de lista activado', 'success');
                    showNotification('La pantalla de asistencia está ahora visible', 'info');
                    
                    // Abrir ventana de control en nueva pestaña
                    window.open('/pase-lista', '_blank');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error activando pase de lista:', error);
                alert('Error al activar el pase de lista');
            }
        }
        
        // Ver estado de asistencia
        function verEstadoAsistencia() {
            window.open('/pantalla-asistencia', '_blank');
        }
        
        // Verificar estado del pase de lista al cargar
        async function verificarEstadoPaseLista() {
            try {
                const response = await fetch('/api/pase-lista/estado', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Estado del pase de lista:', data);
                    
                    if (data.activo) {
                        // Mostrar panel de pase de lista si está activo
                        showAttendancePanel();
                        
                        // Si el pase de lista ya está activo, actualizar botón para secretarios
                        const btnActivar = document.querySelector('#panelSecretario .menu-item[onclick*="activarPaseLista"]');
                        if (btnActivar) {
                            btnActivar.innerHTML = `
                                <i class="fas fa-check-circle text-success"></i>
                                <div>
                                    <div>Pase de Lista Activo</div>
                                    <small class="text-muted">Ya está habilitado</small>
                                </div>
                            `;
                            btnActivar.style.pointerEvents = 'none';
                            btnActivar.style.opacity = '0.6';
                        }
                    }
                }
            } catch (error) {
                console.error('Error verificando estado del pase de lista:', error);
            }
        }
        
        // Ir a pase de lista
        function goToAttendance() {
            window.location.href = '/pase-lista';
        }
        
        // Regresar a votación
        function backToVoting() {
            window.location.href = '/diputado';
        }
        
        
        // Funciones de recordatorios para presidente
        async function mostrarDiputadosSinVoto() {
            try {
                const response = await fetch('/api/diputado/diputados-sin-voto', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (!data.iniciativa) {
                    alert('No hay votación activa');
                    return;
                }
                
                // Mostrar info de iniciativa
                const numeroFormato = data.iniciativa.numero_orden_dia ? 
                    `${data.iniciativa.numero}/${data.iniciativa.numero_orden_dia}` : 
                    data.iniciativa.numero;
                document.getElementById('iniciativaInfo').innerHTML = `
                    <strong>Iniciativa ${numeroFormato}:</strong> ${data.iniciativa.titulo || data.iniciativa.descripcion || 'Sin descripción'}
                `;
                
                // Actualizar contador
                document.getElementById('totalSinVoto').textContent = data.total_sin_voto;
                
                // Mostrar lista de diputados
                const tbody = document.getElementById('listaDiputadosSinVoto');
                if (data.diputados_sin_voto.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-success">Todos los diputados han votado</td></tr>';
                } else {
                    tbody.innerHTML = data.diputados_sin_voto.map(dip => `
                        <tr>
                            <td>${dip.nombre_completo}</td>
                            <td><span class="badge bg-secondary">${dip.partido}</span></td>
                            <td>${dip.cargo_mesa_directiva || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="enviarRecordatorio(${dip.id}, ${data.iniciativa.id}, '${dip.nombre_completo}')">
                                    <i class="fas fa-bell"></i> Recordar
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
                
                // Guardar ID de iniciativa para uso posterior
                window.currentIniciativaId = data.iniciativa.id;
                
                recordatoriosModal.show();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar diputados sin voto');
            }
        }
        
        // Enviar recordatorio individual
        async function enviarRecordatorio(diputadoId, iniciativaId, nombreDiputado) {
            if (!confirm(`¿Enviar recordatorio a ${nombreDiputado}?`)) return;
            
            try {
                const response = await fetch('/api/diputado/enviar-recordatorio', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        diputado_id: diputadoId,
                        iniciativa_id: iniciativaId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(data.mensaje);
                    // Actualizar lista
                    mostrarDiputadosSinVoto();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al enviar recordatorio');
            }
        }

        // Configurar listener para recordatorios de voto
        function setupRecordatorioListener() {
            // Escuchar recordatorios específicos para este usuario
            socket.on(`recordatorio-voto-${user.id}`, (data) => {
                mostrarNotificacionRecordatorio(data);
            });
        }
        
        // Mostrar notificación no invasiva de recordatorio
        function mostrarNotificacionRecordatorio(data) {
            // Crear elemento de notificación si no existe
            let notifContainer = document.getElementById('notificacionRecordatorio');
            if (!notifContainer) {
                notifContainer = document.createElement('div');
                notifContainer.id = 'notificacionRecordatorio';
                notifContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                    max-width: 400px;
                `;
                document.body.appendChild(notifContainer);
            }
            
            // Crear notificación
            const notifId = 'notif-' + Date.now();
            const notifHtml = `
                <div id="${notifId}" class="alert alert-warning alert-dismissible fade show" role="alert">
                    <strong><i class="fas fa-bell"></i> Recordatorio de Votación</strong><br>
                    <small>De: ${data.cargo_enviador}</small><br>
                    <hr class="my-2">
                    ${data.mensaje}<br>
                    <button type="button" class="btn-close" onclick="document.getElementById('${notifId}').remove()"></button>
                </div>
            `;
            
            notifContainer.insertAdjacentHTML('beforeend', notifHtml);
            
            // Auto-remover después de 10 segundos
            setTimeout(() => {
                const notif = document.getElementById(notifId);
                if (notif) {
                    notif.classList.add('fade');
                    setTimeout(() => notif.remove(), 500);
                }
            }, 10000);
            
            // Si el diputado puede votar, resaltar el botón de voto
            if (!isPresidente && !isSecretario && currentInitiative) {
                const voteButtons = document.querySelectorAll('.vote-btn');
                voteButtons.forEach(btn => {
                    btn.classList.add('pulse-animation');
                    setTimeout(() => btn.classList.remove('pulse-animation'), 3000);
                });
            }
        }
        
        // Modal de recordatorios (solo para presidente)
        const recordatoriosModal = isPresidente ? new bootstrap.Modal(document.getElementById('recordatoriosModal')) : null;
        
        // Variables para streaming
        let streamSocket = null;
        let device = null;
        let transport = null;
        let consumer = null;
        let isStreamConnected = false;
        let streamMode = 'webrtc'; // 'webrtc' o 'hls'
        
        // Conectar al servidor de streaming
        function connectStreamingServer() {
            streamSocket = io('http://localhost:3333', {
                transports: ['websocket'],
                reconnection: true
            });
            
            streamSocket.on('connect', () => {
                console.log('Conectado al servidor de streaming');
            });
            
            // Escuchar cuando hay stream disponible
            streamSocket.on('stream-live', (data) => {
                console.log('Stream en vivo disponible:', data);
                document.getElementById('liveButtonContainer').style.display = 'block';
                
                // Mostrar notificación
                showStreamNotification('La transmisión del pleno está en vivo');
            });
            
            streamSocket.on('stream-ended', () => {
                console.log('Stream terminado');
                document.getElementById('liveButtonContainer').style.display = 'none';
                closeLiveStream();
            });
            
            // Actualizar contador de espectadores
            streamSocket.on('viewer-count', (data) => {
                document.getElementById('viewerCount').textContent = data.count;
            });
        }
        
        // Mostrar notificación de stream
        function showStreamNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'stream-notification';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-broadcast-tower text-danger me-3"></i>
                    <div>
                        <strong>Transmisión en Vivo</strong>
                        <div class="small text-muted">${message}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Toggle stream
        async function toggleLiveStream() {
            const container = document.getElementById('streamContainer');
            
            if (container.style.display === 'none' || container.style.display === '') {
                container.style.display = 'block';
                await connectToStream();
            } else {
                closeLiveStream();
            }
        }
        
        // Conectar al stream
        async function connectToStream() {
            try {
                // Intentar WebRTC primero para baja latencia
                if (typeof mediasoupClient !== 'undefined') {
                    await connectWebRTC();
                } else {
                    // Fallback a HLS
                    connectHLS();
                }
            } catch (error) {
                console.error('Error conectando al stream:', error);
                // Fallback a HLS si WebRTC falla
                connectHLS();
            }
        }
        
        // Conectar usando WebRTC (baja latencia)
        async function connectWebRTC() {
            try {
                // Obtener capacidades del router
                const response = await fetch('http://localhost:3333/api/streaming/capabilities');
                const routerRtpCapabilities = await response.json();
                
                // Crear device
                device = new mediasoupClient.Device();
                await device.load({ routerRtpCapabilities });
                
                // Notificar al servidor que queremos consumir
                streamSocket.emit('consume-stream', {
                    rtpCapabilities: device.rtpCapabilities,
                    diputadoId: user.id,
                    nombre: user.nombre_completo || user.nombre
                });
                
                // Esperar transport
                streamSocket.on('transport-created', async (params) => {
                    // Crear transport de recepción
                    transport = device.createRecvTransport(params);
                    
                    // Manejar conexión
                    transport.on('connect', ({ dtlsParameters }, callback) => {
                        streamSocket.emit('connect-transport', { dtlsParameters });
                        streamSocket.once('transport-connected', callback);
                    });
                    
                    // Solicitar consumir
                    streamSocket.emit('consume', { transportId: transport.id });
                });
                
                // Recibir consumer
                streamSocket.on('consumer-created', async (params) => {
                    // Crear consumer
                    consumer = await transport.consume({
                        id: params.id,
                        producerId: params.producerId,
                        kind: params.kind,
                        rtpParameters: params.rtpParameters
                    });
                    
                    // Mostrar video
                    const video = document.getElementById('remoteVideo');
                    const stream = new MediaStream();
                    stream.addTrack(consumer.track);
                    video.srcObject = stream;
                    
                    isStreamConnected = true;
                    streamMode = 'webrtc';
                    console.log('✅ Conectado via WebRTC (baja latencia)');
                });
                
                // Manejar no stream disponible
                streamSocket.on('no-stream-available', () => {
                    console.log('No hay stream disponible, intentando HLS...');
                    connectHLS();
                });
                
            } catch (error) {
                console.error('Error en WebRTC:', error);
                throw error;
            }
        }
        
        // Conectar usando HLS (fallback)
        function connectHLS() {
            const video = document.getElementById('remoteVideo');
            const videoSrc = 'http://localhost:8000/live/congreso/index.m3u8';
            
            if (Hls.isSupported()) {
                const hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90
                });
                
                hls.loadSource(videoSrc);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play().catch(e => console.log('Autoplay bloqueado:', e));
                    isStreamConnected = true;
                    streamMode = 'hls';
                    console.log('✅ Conectado via HLS');
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        console.error('Error fatal HLS:', data);
                        alert('No se pudo conectar al stream');
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // iOS Safari nativo
                video.src = videoSrc;
                video.addEventListener('loadedmetadata', () => {
                    video.play().catch(e => console.log('Autoplay bloqueado:', e));
                    isStreamConnected = true;
                    streamMode = 'hls';
                });
            } else {
                alert('Tu navegador no soporta streaming HLS');
            }
            
            // Notificar que está viendo
            if (streamSocket) {
                streamSocket.emit('viewer-joined', {
                    diputadoId: user.id,
                    nombre: user.nombre_completo || user.nombre
                });
            }
        }
        
        // Cerrar stream
        function closeLiveStream() {
            const container = document.getElementById('streamContainer');
            container.style.display = 'none';
            
            const video = document.getElementById('remoteVideo');
            video.pause();
            
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            if (consumer) {
                consumer.close();
                consumer = null;
            }
            
            if (transport) {
                transport.close();
                transport = null;
            }
            
            isStreamConnected = false;
            
            // Notificar desconexión
            if (streamSocket) {
                streamSocket.emit('viewer-left', {
                    diputadoId: user.id
                });
            }
        }
        
        // Picture in Picture
        async function togglePiP() {
            const video = document.getElementById('remoteVideo');
            
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else if (document.pictureInPictureEnabled) {
                    await video.requestPictureInPicture();
                } else {
                    alert('Picture-in-Picture no está soportado en este navegador');
                }
            } catch (error) {
                console.error('Error en PiP:', error);
            }
        }
        
        // Pantalla completa
        function toggleFullscreen() {
            const container = document.getElementById('streamContainer');
            
            if (!document.fullscreenElement) {
                container.classList.add('fullscreen');
                container.requestFullscreen().catch(err => {
                    console.error('Error en pantalla completa:', err);
                });
            } else {
                document.exitFullscreen();
                container.classList.remove('fullscreen');
            }
        }
        
        // Modo minimal
        function toggleMinimal() {
            const container = document.getElementById('streamContainer');
            container.classList.toggle('minimal');
        }
        
        // Cambiar calidad
        async function changeQuality(quality) {
            if (streamMode === 'webrtc' && consumer && streamSocket) {
                streamSocket.emit('change-quality', {
                    consumerId: consumer.id,
                    quality
                });
            }
            // Para HLS, la calidad se adapta automáticamente
        }
        
        // Inicializar conexión de streaming al cargar
        connectStreamingServer();
        
        // Inicializar al cargar
        loadSystemConfig();
        if (typeof setupRecordatorioListener === 'function') {
            setupRecordatorioListener();
        }
    </script>

    <!-- Modal de Recordatorios para Presidente -->
    <div class="modal fade" id="recordatoriosModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-bell"></i> Enviar Recordatorios de Votación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="iniciativaInfo" class="alert alert-light mb-3"></div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Diputados que no han votado: <span id="totalSinVoto" class="badge bg-danger">0</span></h6>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Diputado</th>
                                    <th>Partido</th>
                                    <th>Cargo</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="listaDiputadosSinVoto">
                                <tr><td colspan="4" class="text-center">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 193, 7, 0.5); }
            100% { transform: scale(1); }
        }
        
        .pulse-animation {
            animation: pulse 1s infinite;
        }
    </style>
    
    <!-- Modal para tablero simplificado -->
    <div class="modal fade" id="tableroModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-th"></i> Tablero de Votación Simplificado
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div id="tableroSimplificado">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Configuración Personal -->
    <div class="modal fade modal-apple" id="modalConfiguracion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content modal-content-apple">
                <div class="modal-header modal-header-apple">
                    <h5 class="modal-title modal-title-apple">
                        <i class="fas fa-cog"></i> Configuración Personal
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body modal-body-apple">
                    <form id="formConfiguracion">
                        <div class="row">
                            <div class="col-md-4 text-center mb-3">
                                <div class="position-relative">
                                    <img id="previewFoto" src="/images/diputados/default.svg" alt="Foto" 
                                         class="img-thumbnail mb-2" style="width: 150px; height: 150px; object-fit: cover;">
                                    <div class="mt-2">
                                        <label for="inputFoto" class="btn btn-apple btn-sm">
                                            <i class="fas fa-camera"></i> Cambiar Foto
                                        </label>
                                        <input type="file" id="inputFoto" class="d-none" accept="image/*" onchange="previewImage(this)">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label form-label-apple">Nombre Completo</label>
                                    <input type="text" class="form-control form-control-apple" id="configNombre" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label form-label-apple">Usuario de Acceso</label>
                                    <input type="text" class="form-control form-control-apple" id="configUsuario" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label form-label-apple">Nueva Contraseña</label>
                                    <input type="password" class="form-control form-control-apple" id="configPassword" 
                                           placeholder="Dejar vacío para mantener la actual">
                                    <small class="text-muted">Mínimo 6 caracteres</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label form-label-apple">Confirmar Contraseña</label>
                                    <input type="password" class="form-control form-control-apple" id="configPasswordConfirm" 
                                           placeholder="Repetir nueva contraseña">
                                </div>
                            </div>
                        </div>
                        
                        <div class="menu-divider"></div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label form-label-apple text-muted">Partido <small>(no editable)</small></label>
                                    <input type="text" class="form-control form-control-apple" id="configPartido" readonly disabled>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label form-label-apple text-muted">Cargo <small>(no editable)</small></label>
                                    <input type="text" class="form-control form-control-apple" id="configCargo" readonly disabled>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Nota:</strong> Solo puedes modificar tu nombre, usuario, contraseña y fotografía.
                            <br>El partido y cargo son asignados por el administrador del sistema.
                        </div>
                    </form>
                </div>
                <div class="modal-footer modal-footer-apple">
                    <button type="button" class="btn btn-apple-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-apple" onclick="guardarConfiguracion()">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Función para mostrar notificación de resultado
        function mostrarNotificacionResultado(data) {
            // Obtener los resultados de la última votación
            fetch('/api/diputado/ultima-votacion-resultado', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(resultado => {
                if (resultado && resultado.conteo) {
                    const notification = document.createElement('div');
                    notification.className = 'result-notification';
                    notification.innerHTML = `
                        <div class="notification-header">
                            <h5 class="mb-0">
                                <i class="fas fa-poll"></i> Votación Cerrada
                            </h5>
                            <button class="btn btn-sm btn-light" onclick="this.closest('.result-notification').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="notification-body">
                            <h6>${resultado.descripcion || 'Iniciativa votada'}</h6>
                            <div class="result-stats">
                                <div class="stat-item">
                                    <div class="stat-circle favor">${resultado.conteo.favor || 0}</div>
                                    <small>A Favor</small>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-circle contra">${resultado.conteo.contra || 0}</div>
                                    <small>En Contra</small>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-circle abstencion">${resultado.conteo.abstencion || 0}</div>
                                    <small>Abstención</small>
                                </div>
                            </div>
                            <div class="mt-3 text-center">
                                <strong>Resultado: </strong>
                                <span class="badge ${resultado.aprobada ? 'bg-success' : 'bg-danger'}">
                                    ${resultado.aprobada ? 'APROBADA' : 'RECHAZADA'}
                                </span>
                            </div>
                            <div class="countdown-bar">
                                <div class="countdown-progress"></div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Auto-cerrar después de 10 segundos
                    setTimeout(() => {
                        notification.remove();
                    }, 10000);
                }
            })
            .catch(error => console.error('Error obteniendo resultado:', error));
        }
        
        // Función para ver tablero simplificado
        function verTableroSimplificado() {
            toggleMenu();
            
            // Obtener estado actual del tablero
            fetch('/api/pantalla/estado')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('tableroSimplificado');
                    
                    if (data.estado === 'sin_actividad') {
                        container.innerHTML = `
                            <div class="text-center py-5">
                                <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                                <h5>Sin actividad de votación</h5>
                                <p class="text-muted">No hay votaciones activas en este momento</p>
                            </div>
                        `;
                    } else {
                        // Crear tabla simplificada
                        container.innerHTML = `
                            <div class="mb-3">
                                <h6>Iniciativa: ${data.iniciativa.descripcion || 'Sin descripción'}</h6>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-success">${data.conteo.favor}</h3>
                                            <p>A Favor</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-danger">${data.conteo.contra}</h3>
                                            <p>En Contra</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-warning">${data.conteo.abstencion}</h3>
                                            <p>Abstención</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <h6>Detalle de Votos:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Diputado</th>
                                                <th>Partido</th>
                                                <th>Voto</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.votos.map(v => `
                                                <tr>
                                                    <td>${v.nombre_completo}</td>
                                                    <td><small>${v.partido || 'N/A'}</small></td>
                                                    <td>
                                                        ${v.voto === 'favor' ? '<span class="badge bg-success">A Favor</span>' :
                                                          v.voto === 'contra' ? '<span class="badge bg-danger">En Contra</span>' :
                                                          v.voto === 'abstencion' ? '<span class="badge bg-warning">Abstención</span>' :
                                                          '<span class="badge bg-secondary">Sin voto</span>'}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Mostrar modal
                    const modal = new bootstrap.Modal(document.getElementById('tableroModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar el tablero');
                });
        }
        
        // Función para ver historial de votaciones
        function verHistorialVotaciones() {
            toggleMenu();
            window.location.href = '#historial';
            document.getElementById('historialTab').click();
        }
        
        // Función para ver estadísticas
        function verEstadisticas() {
            toggleMenu();
            alert('Función de estadísticas en desarrollo');
        }
        
        // Funciones para el Presidente de la Mesa Directiva
        async function verIniciativasCargadas() {
            toggleMenu();
            
            if (!isPresidente) {
                alert('Solo el Presidente de la Mesa Directiva puede acceder a esta función');
                return;
            }
            
            // Mostrar las iniciativas cargadas para la sesión actual
            try {
                const response = await fetch('/api/diputado/iniciativas-sesion', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al obtener iniciativas');
                }
                
                const data = await response.json();
                
                // Mostrar modal con las iniciativas
                mostrarModalIniciativas(data.iniciativas || []);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al obtener las iniciativas de la sesión');
            }
        }
        
        // Función para mostrar modal con iniciativas
        function mostrarModalIniciativas(iniciativas) {
            // Crear modal si no existe
            let modal = document.getElementById('modalIniciativasPresidente');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modalIniciativasPresidente';
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">Iniciativas de la Sesión</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="modalIniciativasBody">
                                <!-- Contenido dinámico -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Llenar contenido
            const bodyElement = document.getElementById('modalIniciativasBody');
            if (iniciativas.length === 0) {
                bodyElement.innerHTML = '<p class="text-center text-muted">No hay iniciativas cargadas para esta sesión</p>';
            } else {
                bodyElement.innerHTML = `
                    <div class="list-group">
                        ${iniciativas.map((init, index) => `
                            <div class="list-group-item">
                                <h6 class="mb-1">${index + 1}. ${init.titulo || init.descripcion}</h6>
                                <p class="mb-1 small">${init.descripcion || ''}</p>
                                <small class="text-muted">
                                    ${init.presentador ? `Presentador: ${init.presentador}` : ''}
                                    ${init.tipo_mayoria ? ` | Mayoría: ${init.tipo_mayoria}` : ''}
                                </small>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Mostrar modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // Mantener compatibilidad con llamadas anteriores
        async function verListaIniciativas() {
            verIniciativasCargadas();
        }
        
        // Función original que ya no se usa pero mantenemos por compatibilidad
        async function verListaIniciativasOriginal() {
            toggleMenu();
            
            if (!isPresidente) {
                alert('Solo el Presidente de la Mesa Directiva puede acceder a esta función');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('gestionIniciativasModal'));
            modal.show();
            
            // Cargar estado del quórum
            actualizarEstadoQuorum();
            
            try {
                const response = await fetch('/api/diputado/iniciativas-sesion', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    mostrarIniciativasPresidente(data.iniciativas || []);
                } else {
                    document.getElementById('listaIniciativasPresidente').innerHTML = 
                        '<p class="text-danger">Error al cargar iniciativas</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('listaIniciativasPresidente').innerHTML = 
                    '<p class="text-danger">Error de conexión</p>';
            }
        }
        
        // Función para actualizar el estado del quórum
        async function actualizarEstadoQuorum() {
            try {
                const response = await fetch('/api/diputado/estado-quorum', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Actualizar números
                    document.getElementById('quorumPresentes').textContent = data.presentes || 0;
                    document.getElementById('quorumRequerido').textContent = data.quorum_minimo || 0;
                    document.getElementById('quorumTotal').textContent = data.total_diputados || 0;
                    
                    // Calcular porcentaje
                    const porcentaje = data.total_diputados > 0 
                        ? Math.round((data.presentes / data.total_diputados) * 100) 
                        : 0;
                    
                    // Actualizar barra de progreso
                    const progressBar = document.getElementById('quorumProgressBar');
                    progressBar.style.width = `${porcentaje}%`;
                    progressBar.setAttribute('aria-valuenow', porcentaje);
                    document.getElementById('quorumProgressText').textContent = `${porcentaje}%`;
                    
                    // Determinar estado y color
                    const hayQuorum = data.presentes >= data.quorum_minimo;
                    const statusBadge = document.getElementById('quorumStatus');
                    
                    if (hayQuorum) {
                        progressBar.className = 'progress-bar bg-success';
                        statusBadge.innerHTML = '<span class="badge bg-success">✓ Quórum alcanzado</span>';
                    } else {
                        const faltantes = data.quorum_minimo - data.presentes;
                        progressBar.className = 'progress-bar bg-warning';
                        statusBadge.innerHTML = `<span class="badge bg-warning">⚠ Faltan ${faltantes} diputados</span>`;
                    }
                }
            } catch (error) {
                console.error('Error actualizando quórum:', error);
                document.getElementById('quorumStatus').innerHTML = 
                    '<span class="badge bg-danger">Error al obtener quórum</span>';
            }
        }
        
        // Variables para filtros y selección múltiple
        let iniciativasGlobales = [];
        let filtroActualPresidente = 'todas';
        let modoSeleccionMultiple = false;
        let iniciativasSeleccionadas = new Set();
        
        function mostrarIniciativasPresidente(iniciativas) {
            iniciativasGlobales = iniciativas;
            const container = document.getElementById('listaIniciativasPresidente');
            
            if (iniciativas.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No hay iniciativas en la sesión actual</p>';
                return;
            }
            
            // Aplicar filtro
            let iniciativasFiltradas = filtrarIniciativas(iniciativas, filtroActualPresidente);
            
            container.innerHTML = `
                <div class="list-group">
                    ${iniciativasFiltradas.map(init => {
                        // Truncar texto y preparar tooltip
                        const textoCompleto = init.descripcion || init.titulo || 'Sin descripción';
                        const textoTruncado = textoCompleto.length > 200 ? 
                            textoCompleto.substring(0, 200) + '...' : textoCompleto;
                        
                        // Estado de la iniciativa
                        let estadoBadge = '';
                        let colorItem = '';
                        if (init.cerrada && init.resultado) {
                            estadoBadge = '<span class="badge bg-success ms-2">✓ VOTADA</span>';
                            colorItem = 'border-success';
                        } else if (init.activa) {
                            estadoBadge = '<span class="badge bg-warning ms-2">EN VOTACIÓN</span>';
                            colorItem = 'border-warning';
                        } else {
                            estadoBadge = '<span class="badge bg-secondary ms-2">PENDIENTE</span>';
                            colorItem = '';
                        }
                        
                        return `
                        <div class="list-group-item ${colorItem}" data-id="${init.id}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    ${modoSeleccionMultiple ? `
                                        <div class="form-check d-inline-block me-2">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="check_${init.id}" 
                                                   onchange="toggleSeleccionIniciativa(${init.id})"
                                                   ${iniciativasSeleccionadas.has(init.id) ? 'checked' : ''}>
                                        </div>
                                    ` : ''}
                                    <h6 class="mb-1 d-inline-block" 
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="${textoCompleto.replace(/"/g, '&quot;')}">
                                        ${init.numero}. ${textoTruncado}
                                        ${estadoBadge}
                                    </h6>
                                    ${init.presentador ? `<small class="text-muted d-block">Por: ${init.presentador}</small>` : ''}
                                    ${init.partido ? `<small class="text-muted">Partido: ${init.partido}</small>` : ''}
                                    ${textoCompleto.length > 200 ? `
                                        <button class="btn btn-link btn-sm p-0 ms-2" onclick="verDetalleIniciativa(${init.id})">
                                            <i class="fas fa-eye"></i> Ver más
                                        </button>
                                    ` : ''}
                                </div>
                                <div>
                                    ${!init.activa && !init.cerrada ? `
                                        <button class="btn btn-sm btn-success" onclick="activarIniciativaPresidente(${init.id})" 
                                                title="Activar para votación">
                                            <i class="fas fa-play"></i> Activar
                                        </button>
                                    ` : ''}
                                    ${init.activa ? `
                                        <button class="btn btn-sm btn-danger" onclick="cerrarVotacionPresidente(${init.id})"
                                                title="Cerrar votación">
                                            <i class="fas fa-stop"></i> Cerrar
                                        </button>
                                    ` : ''}
                                    ${init.cerrada && init.resultado ? `
                                        <button class="btn btn-sm btn-info" onclick="verResultadoIniciativa(${init.id})"
                                                title="Ver resultado de votación">
                                            <i class="fas fa-chart-bar"></i> Resultado
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Inicializar tooltips de Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Función para filtrar iniciativas
        function filtrarIniciativas(iniciativas, filtro) {
            switch(filtro) {
                case 'votadas':
                    return iniciativas.filter(i => i.cerrada && i.resultado);
                case 'pendientes':
                    return iniciativas.filter(i => !i.activa && !i.cerrada);
                case 'activas':
                    return iniciativas.filter(i => i.activa);
                default:
                    return iniciativas;
            }
        }
        
        // Filtrar iniciativas del presidente
        function filtrarIniciativasPresidente(filtro) {
            filtroActualPresidente = filtro;
            
            // Actualizar botones activos
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.onclick.toString().includes(filtro)) {
                    btn.classList.add('active');
                }
            });
            
            mostrarIniciativasPresidente(iniciativasGlobales);
        }
        
        // Toggle selección múltiple
        function toggleSeleccionMultiple() {
            modoSeleccionMultiple = document.getElementById('seleccionMultiple').checked;
            document.getElementById('accionesMultiples').style.display = 
                modoSeleccionMultiple ? 'block' : 'none';
            
            if (!modoSeleccionMultiple) {
                iniciativasSeleccionadas.clear();
            }
            
            mostrarIniciativasPresidente(iniciativasGlobales);
        }
        
        // Toggle selección de iniciativa
        function toggleSeleccionIniciativa(id) {
            if (iniciativasSeleccionadas.has(id)) {
                iniciativasSeleccionadas.delete(id);
            } else {
                iniciativasSeleccionadas.add(id);
            }
            actualizarContadorSeleccionadas();
        }
        
        // Actualizar contador
        function actualizarContadorSeleccionadas() {
            document.getElementById('contadorSeleccionadas').textContent = 
                `${iniciativasSeleccionadas.size} seleccionadas`;
        }
        
        // Seleccionar todas
        function seleccionarTodas() {
            const checkboxes = document.querySelectorAll('#listaIniciativasPresidente input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                const id = parseInt(cb.id.replace('check_', ''));
                iniciativasSeleccionadas.add(id);
            });
            actualizarContadorSeleccionadas();
        }
        
        // Deseleccionar todas
        function deseleccionarTodas() {
            const checkboxes = document.querySelectorAll('#listaIniciativasPresidente input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            iniciativasSeleccionadas.clear();
            actualizarContadorSeleccionadas();
        }
        
        // Votar seleccionadas
        async function votarSeleccionadas() {
            if (iniciativasSeleccionadas.size === 0) {
                alert('No hay iniciativas seleccionadas');
                return;
            }
            
            if (!confirm(`¿Activar ${iniciativasSeleccionadas.size} iniciativas para votación simultánea?`)) {
                return;
            }
            
            // Aquí implementar la lógica para votar múltiples iniciativas
            alert('Función en desarrollo: Votación múltiple');
        }
        
        // Ver detalle de iniciativa en modal
        function verDetalleIniciativa(id) {
            const iniciativa = iniciativasGlobales.find(i => i.id === id);
            if (!iniciativa) return;
            
            const modal = new bootstrap.Modal(document.getElementById('modalDetalleIniciativa'));
            document.getElementById('detalleIniciativaTitulo').textContent = 
                `Iniciativa #${iniciativa.numero}`;
            document.getElementById('detalleIniciativaContenido').innerHTML = `
                <h5>${iniciativa.titulo || 'Sin título'}</h5>
                <p class="text-muted">${iniciativa.descripcion || 'Sin descripción'}</p>
                <div class="menu-divider"></div>
                <p><strong>Presentador:</strong> ${iniciativa.presentador || 'No especificado'}</p>
                <p><strong>Partido:</strong> ${iniciativa.partido || 'No especificado'}</p>
                <p><strong>Tipo de Mayoría:</strong> ${iniciativa.tipo_mayoria || 'Simple'}</p>
                ${iniciativa.observaciones ? `<p><strong>Observaciones:</strong> ${iniciativa.observaciones}</p>` : ''}
            `;
            modal.show();
        }
        
        async function activarIniciativaPresidente(id, force = false) {
            if (!force && !confirm('¿Activar esta iniciativa para votación?')) return;
            
            try {
                const response = await fetch(`/api/diputado/activar-iniciativa/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ force })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Mostrar mensaje específico si se cerró otra iniciativa
                    if (data.iniciativa_cerrada) {
                        alert(`Se cerró la iniciativa #${data.iniciativa_cerrada.numero} y se activó la #${data.iniciativa.numero}`);
                    } else {
                        alert('Iniciativa activada para votación');
                    }
                    
                    verListaIniciativas(); // Recargar lista
                    checkActiveInitiative(); // Actualizar panel principal
                    
                } else if (response.status === 409) {
                    // Hay otra iniciativa activa, preguntar confirmación
                    const data = await response.json();
                    
                    const confirmar = confirm(
                        `${data.mensaje}\n\n` +
                        `Iniciativa activa actual:\n` +
                        `#${data.iniciativa_activa.numero}: ${data.iniciativa_activa.titulo}\n\n` +
                        `¿Desea cerrarla y activar la nueva?`
                    );
                    
                    if (confirmar) {
                        // Llamar de nuevo con force=true
                        activarIniciativaPresidente(id, true);
                    }
                } else if (response.status === 412) {
                    // Quórum insuficiente
                    const data = await response.json();
                    
                    // Crear mensaje informativo detallado
                    let mensajeQuorum = `⚠️ ADVERTENCIA: QUÓRUM INSUFICIENTE\n\n`;
                    mensajeQuorum += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
                    mensajeQuorum += `Diputados presentes: ${data.presentes} de ${data.total_diputados}\n`;
                    mensajeQuorum += `Quórum requerido: ${data.quorum_requerido} diputados\n`;
                    mensajeQuorum += `Tipo de mayoría: ${data.tipo_mayoria.toUpperCase()}\n`;
                    mensajeQuorum += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n`;
                    mensajeQuorum += `${data.mensaje}\n\n`;
                    mensajeQuorum += `¿Desea forzar la activación sin quórum?\n`;
                    mensajeQuorum += `(Esta acción quedará registrada en el sistema)`;
                    
                    const confirmar = confirm(mensajeQuorum);
                    
                    if (confirmar) {
                        // Confirmar nuevamente por la importancia de la acción
                        const confirmarSegundo = confirm(
                            '⚠️ CONFIRMACIÓN FINAL\n\n' +
                            'Está a punto de activar una iniciativa SIN el quórum necesario.\n' +
                            'Esta acción es excepcional y quedará registrada.\n\n' +
                            '¿Está seguro de continuar?'
                        );
                        
                        if (confirmarSegundo) {
                            // Llamar de nuevo con force=true
                            activarIniciativaPresidente(id, true);
                        }
                    }
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al activar iniciativa');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al activar la iniciativa');
            }
        }
        
        async function cerrarVotacionPresidente(id) {
            if (!confirm('¿Cerrar la votación de esta iniciativa?')) return;
            
            try {
                const response = await fetch(`/api/diputado/cerrar-votacion/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Votación cerrada. Resultado: ${data.resultado}`);
                    verListaIniciativas(); // Recargar lista
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al cerrar votación');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cerrar la votación');
            }
        }
        
        function verDiputadosPresentes() {
            toggleMenu();
            if (!isPresidente) {
                alert('Solo el Presidente de la Mesa Directiva puede acceder a esta función');
                return;
            }
            alert('Función de quórum en desarrollo');
        }
        
        // Las funciones abrirConfiguracion, guardarConfiguracion y previewImage ya están definidas al inicio del archivo
        
        // Función duplicada eliminada - guardarConfiguracion ya está definida arriba
        /*
        async function guardarConfiguracion_OLD() {
            const nombre = document.getElementById('configNombre').value.trim();
            const usuario = document.getElementById('configUsuario').value.trim();
            const password = document.getElementById('configPassword').value;
            const passwordConfirm = document.getElementById('configPasswordConfirm').value;
            
            // Validaciones
            if (!nombre || !usuario) {
                alert('El nombre y usuario son obligatorios');
                return;
            }
            
            if (password && password !== passwordConfirm) {
                alert('Las contraseñas no coinciden');
                return;
            }
            
            if (password && password.length < 6) {
                alert('La contraseña debe tener al menos 6 caracteres');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('nombre', nombre);
                formData.append('usuario', usuario);
                
                if (password) {
                    formData.append('password', password);
                }
                
                // Agregar foto si se seleccionó una
                const inputFoto = document.getElementById('inputFoto');
                if (inputFoto.files && inputFoto.files[0]) {
                    formData.append('fotografia', inputFoto.files[0]);
                }
                
                const response = await fetch('/api/diputado/actualizar-perfil', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Configuración actualizada correctamente');
                    
                    // Actualizar datos locales del usuario
                    user.nombre = nombre;
                    user.usuario = usuario;
                    if (data.fotografia) {
                        user.fotografia = data.fotografia;
                    }
                    
                    // Actualizar header con el nuevo nombre
                    document.getElementById('deputyName').textContent = nombre;
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('modalConfiguracion')).hide();
                    
                    // Si cambió el usuario, sugerir relogin
                    if (usuario !== user.usuario) {
                        if (confirm('Has cambiado tu usuario. ¿Deseas cerrar sesión para ingresar con tu nuevo usuario?')) {
                            logout();
                        }
                    }
                } else {
                    alert(data.error || 'Error al actualizar la configuración');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar la configuración');
            }
        }
        */

        // Funciones de Servicios Legislativos
        let iniciativasExtraccion = [];
        
        function abrirServiciosLegislativos() {
            toggleMenu();
            
            if (!isPresidente && !isSecretario) {
                alert('Solo el Presidente o Secretario de la Mesa Directiva pueden acceder a esta función');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalServiciosLegislativos'));
            modal.show();
            
            // Cargar iniciativas existentes
            cargarIniciativasSesion();
        }
        
        // Cargar iniciativas de la sesión
        async function cargarIniciativasSesion() {
            try {
                const response = await fetch('/api/diputado/iniciativas-sesion', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    mostrarIniciativasSesion(data.iniciativas || []);
                }
            } catch (error) {
                console.error('Error cargando iniciativas:', error);
            }
        }
        
        // Mostrar iniciativas en la tabla
        function mostrarIniciativasSesion(iniciativas) {
            const container = document.getElementById('listaIniciativasSesion');
            
            if (iniciativas.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay iniciativas cargadas para esta sesión</p>';
                return;
            }
            
            let html = `
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Título</th>
                            <th>Presentador</th>
                            <th>Tipo Mayoría</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            iniciativas.forEach((ini, index) => {
                const estado = ini.activa ? 'En Votación' : (ini.cerrada ? 'Cerrada' : 'Pendiente');
                const badgeClass = ini.activa ? 'success' : (ini.cerrada ? 'secondary' : 'warning');
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${ini.titulo}</td>
                        <td>${ini.presentador || '-'}</td>
                        <td>${ini.tipo_mayoria}</td>
                        <td><span class="badge bg-${badgeClass}">${estado}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editarIniciativa(${ini.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="eliminarIniciativa(${ini.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Descargar plantilla Excel
        function descargarPlantillaExcel() {
            window.location.href = '/api/diputado/servicios-legislativos/plantilla-excel';
        }
        
        // Cargar Excel - Verificar que el elemento existe
        const formCargarExcel = document.getElementById('formCargarExcel');
        if (formCargarExcel) {
            formCargarExcel.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData();
                const archivoInput = document.getElementById('archivoExcel');
                if (!archivoInput || !archivoInput.files[0]) {
                    alert('Por favor selecciona un archivo Excel');
                    return;
                }
                
                const archivo = archivoInput.files[0];
                formData.append('archivo', archivo);
                
                try {
                    const response = await fetch('/api/diputado/servicios-legislativos/cargar-excel', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        alert(`Se cargaron ${data.iniciativas.length} iniciativas correctamente`);
                        if (typeof cargarIniciativasSesion === 'function') {
                            cargarIniciativasSesion();
                        }
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (error) {
                    alert('Error al cargar el archivo Excel');
                    console.error(error);
                }
            });
        } else {
            console.log('Formulario de carga Excel no disponible');
        }
        
        // Cargar PDF - Verificar que el elemento existe
        const formCargarPDF = document.getElementById('formCargarPDF');
        if (formCargarPDF) {
            formCargarPDF.addEventListener('submit', async (e) => {
                e.preventDefault();
            
            const formData = new FormData();
            const archivo = document.getElementById('archivoPDF').files[0];
            formData.append('archivo', archivo);
            
            try {
                const response = await fetch('/api/diputado/servicios-legislativos/cargar-pdf', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    iniciativasExtraccion = data.iniciativas;
                    mostrarIniciativasExtraidas(data.iniciativas);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error al procesar el archivo PDF');
                console.error(error);
            }
            });
        } else {
            console.log('Formulario de carga PDF no disponible');
        }
        
        // Mostrar iniciativas extraídas del PDF
        function mostrarIniciativasExtraidas(iniciativas) {
            const container = document.getElementById('listaExtraccion');
            let html = '<div class="list-group">';
            
            iniciativas.forEach((ini, index) => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6>${index + 1}. ${ini.titulo}</h6>
                                <p class="mb-1 text-muted small">${ini.descripcion || ''}</p>
                                <small>
                                    ${ini.presentador ? `Presentador: ${ini.presentador}` : ''}
                                    ${ini.partido ? ` | Partido: ${ini.partido}` : ''}
                                    | Mayoría: ${ini.tipo_mayoria}
                                </small>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="quitarIniciativaExtraccion(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            document.getElementById('resultadoExtraccion').style.display = 'block';
        }
        
        // Quitar iniciativa de la extracción
        function quitarIniciativaExtraccion(index) {
            iniciativasExtraccion.splice(index, 1);
            mostrarIniciativasExtraidas(iniciativasExtraccion);
            
            if (iniciativasExtraccion.length === 0) {
                document.getElementById('resultadoExtraccion').style.display = 'none';
            }
        }
        
        // Confirmar extracción del PDF
        async function confirmarExtraccion() {
            if (iniciativasExtraccion.length === 0) {
                alert('No hay iniciativas para cargar');
                return;
            }
            
            try {
                const response = await fetch('/api/diputado/servicios-legislativos/confirmar-extraccion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ iniciativas: iniciativasExtraccion })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Se cargaron ${data.count} iniciativas correctamente`);
                    document.getElementById('resultadoExtraccion').style.display = 'none';
                    document.getElementById('archivoPDF').value = '';
                    cargarIniciativasSesion();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error al confirmar las iniciativas');
                console.error(error);
            }
        }
        
        // Captura manual - Verificar que el elemento existe
        const formCapturaManual = document.getElementById('formCapturaManual');
        if (formCapturaManual) {
            formCapturaManual.addEventListener('submit', async (e) => {
                e.preventDefault();
            
            const iniciativa = {
                titulo: document.getElementById('manualTitulo').value,
                descripcion: document.getElementById('manualDescripcion').value,
                presentador: document.getElementById('manualPresentador').value,
                partido: document.getElementById('manualPartido').value,
                tipo_mayoria: document.getElementById('manualTipoMayoria').value,
                tipo_iniciativa: document.getElementById('manualTipoIniciativa').value
            };
            
            try {
                const response = await fetch('/api/diputado/servicios-legislativos/captura-manual', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(iniciativa)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Iniciativa guardada correctamente');
                    document.getElementById('formCapturaManual').reset();
                    cargarIniciativasSesion();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error al guardar la iniciativa');
                console.error(error);
            }
            });
        } else {
            console.log('Formulario de captura manual no disponible');
        }
        
        // Editar iniciativa
        async function editarIniciativa(id) {
            // Por ahora solo mostramos alerta
            alert('Función de edición en desarrollo');
        }
        
        // Eliminar iniciativa
        async function eliminarIniciativa(id) {
            if (!confirm('¿Está seguro de eliminar esta iniciativa?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/diputado/servicios-legislativos/iniciativa/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('Iniciativa eliminada correctamente');
                    cargarIniciativasSesion();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error al eliminar la iniciativa');
                console.error(error);
            }
        }
    </script>

    <!-- Modal de Pausa de Sesión -->
    <div class="modal fade" id="modalPausa" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-pause-circle"></i> Pausar Sesión Legislativa
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Seleccione el tiempo de pausa:</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-warning" onclick="pausarSesion(5)">
                            <i class="fas fa-clock"></i> 5 minutos
                        </button>
                        <button class="btn btn-outline-warning" onclick="pausarSesion(10)">
                            <i class="fas fa-clock"></i> 10 minutos
                        </button>
                        <button class="btn btn-outline-warning" onclick="pausarSesion(15)">
                            <i class="fas fa-clock"></i> 15 minutos
                        </button>
                        <button class="btn btn-outline-warning" onclick="pausarSesion(30)">
                            <i class="fas fa-clock"></i> 30 minutos
                        </button>
                        <button class="btn btn-outline-danger" onclick="pausarSesion(0)">
                            <i class="fas fa-infinity"></i> Tiempo indefinido
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timer de Pausa Flotante -->
    <div id="pausaTimer" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 9999; background: rgba(255, 193, 7, 0.95); padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h5 class="mb-2 text-dark">
            <i class="fas fa-pause-circle"></i> Sesión en Pausa
        </h5>
        <div id="timerDisplay" class="text-center">
            <h2 class="mb-0 text-dark" id="timerCount">00:00</h2>
            <small class="text-dark" id="timerMessage">Tiempo restante</small>
        </div>
    </div>

    <script>
        let pausaInterval = null;
        let tiempoRestante = 0;

        function mostrarModalPausa() {
            const modal = new bootstrap.Modal(document.getElementById('modalPausa'));
            modal.show();
        }

        async function pausarSesion(minutos) {
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('modalPausa')).hide();
            
            try {
                const response = await fetch('/api/diputado/pausar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ minutos })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Ocultar botón pausar, mostrar reanudar
                    document.getElementById('btnPausarSesion').style.display = 'none';
                    document.getElementById('btnReanudarSesion').style.display = 'block';
                    
                    // Iniciar timer visual
                    if (minutos > 0) {
                        iniciarTimer(minutos * 60);
                    } else {
                        mostrarPausaIndefinida();
                    }
                    
                    alert(`Sesión pausada por ${minutos > 0 ? minutos + ' minutos' : 'tiempo indefinido'}`);
                } else {
                    const error = await response.json();
                    alert(error.error || 'Error al pausar la sesión');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al pausar la sesión');
            }
        }

        async function reanudarSesion() {
            if (!confirm('¿Desea reanudar la sesión?')) return;
            
            try {
                const response = await fetch('/api/diputado/reanudar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    // Ocultar reanudar, mostrar pausar
                    document.getElementById('btnReanudarSesion').style.display = 'none';
                    document.getElementById('btnPausarSesion').style.display = 'block';
                    
                    // Detener timer
                    detenerTimer();
                    
                    alert('Sesión reanudada');
                } else {
                    const error = await response.json();
                    alert(error.error || 'Error al reanudar la sesión');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al reanudar la sesión');
            }
        }

        function iniciarTimer(segundos) {
            tiempoRestante = segundos;
            document.getElementById('pausaTimer').style.display = 'block';
            
            actualizarTimer();
            
            pausaInterval = setInterval(() => {
                tiempoRestante--;
                actualizarTimer();
                
                if (tiempoRestante <= 0) {
                    detenerTimer();
                    notificarFinPausa();
                }
            }, 1000);
        }

        function actualizarTimer() {
            const minutos = Math.floor(tiempoRestante / 60);
            const segundos = tiempoRestante % 60;
            document.getElementById('timerCount').textContent = 
                `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
        }

        function mostrarPausaIndefinida() {
            document.getElementById('pausaTimer').style.display = 'block';
            document.getElementById('timerCount').textContent = '∞';
            document.getElementById('timerMessage').textContent = 'Pausa indefinida';
        }

        function detenerTimer() {
            if (pausaInterval) {
                clearInterval(pausaInterval);
                pausaInterval = null;
            }
            document.getElementById('pausaTimer').style.display = 'none';
        }

        function notificarFinPausa() {
            // Notificación visual y sonora
            alert('⏰ El tiempo de pausa ha terminado. La sesión puede continuar.');
            
            // Reproducir sonido si es posible
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
            audio.play().catch(e => console.log('No se pudo reproducir sonido'));
            
            // Cambiar botones
            document.getElementById('btnReanudarSesion').style.display = 'none';
            document.getElementById('btnPausarSesion').style.display = 'block';
        }

        // Escuchar eventos de WebSocket para sincronización
        socket.on('sesion-pausada', (data) => {
            // Detener el cronómetro de sesión principal
            sessionPaused = true;
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
                sessionTimerInterval = null;
            }
            
            // Iniciar cronómetro de pausa si es presidente/vicepresidente
            if (user && (user.cargo_mesa_directiva === 'presidente' || 
                        user.cargo_mesa_directiva === 'vicepresidente' ||
                        user.cargo_mesa_directiva === 'Presidente de la Mesa Directiva')) {
                startPauseTimer();
            }
            
            // Mostrar modal de pausa para otros usuarios
            if (data.minutos > 0) {
                iniciarTimer(data.minutos * 60);
            } else {
                mostrarPausaIndefinida();
            }
            
            // Actualizar estado de controles
            checkSessionStatus();
        });

        socket.on('sesion-reanudada', () => {
            detenerTimer();
            // También detener el cronómetro de pausa del panel presidente
            sessionPaused = false;
            stopPauseTimer();
            const pauseContainer = document.getElementById('pauseTimerContainer');
            if (pauseContainer) {
                pauseContainer.style.display = 'none';
            }
            
            // Reanudar el cronómetro de sesión principal
            if (shouldShowSessionTimer()) {
                startSessionTimer();
            }
            
            // Actualizar estado de la sesión
            checkSessionStatus();
        });
        
        // ============= FUNCIONES DE AUTO-REGISTRO DE ASISTENCIA =============
        let paseListaConfirmado = false;
        
        async function registrarMiAsistencia() {
            try {
                // Cerrar el menú
                toggleMenu();
                
                // Determinar si es llegada tardía
                const esLlegadaTardia = paseListaConfirmado;
                
                // Verificar si hay una sesión activa
                const response = await fetch('/api/pase-lista/auto-registro', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        diputado_id: user.id,
                        asistencia: 'presente',
                        llegada_tardia: esLlegadaTardia
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Mostrar mensaje de éxito
                    showNotification('success', 'Asistencia Registrada', 'Tu asistencia ha sido marcada como PRESENTE');
                    
                    // Actualizar el botón para mostrar que ya está registrado
                    const btnRegistrar = document.getElementById('btnRegistrarAsistencia');
                    if (btnRegistrar) {
                        btnRegistrar.style.background = 'linear-gradient(135deg, #6c757d, #5a6268)';
                        btnRegistrar.style.pointerEvents = 'none';
                        btnRegistrar.innerHTML = `
                            <i class="fas fa-check-circle" style="color: white;"></i>
                            <div>
                                <div style="font-weight: bold;">REGISTRADO</div>
                                <small style="color: rgba(255,255,255,0.8);">Asistencia confirmada</small>
                            </div>
                        `;
                    }
                    
                    // Emitir evento por socket para actualizar pantallas
                    socket.emit('auto-registro-asistencia', {
                        diputado_id: user.id,
                        nombre: user.nombre_completo,
                        asistencia: 'presente'
                    });
                    
                } else {
                    showNotification('error', 'Error', data.message || 'No se pudo registrar la asistencia');
                }
            } catch (error) {
                console.error('Error registrando asistencia:', error);
                showNotification('error', 'Error', 'Error al conectar con el servidor');
            }
        }
        
        // Función auxiliar para mostrar notificaciones
        function showNotification(type, title, message) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas ${icon} me-2"></i>
                    <div>
                        <strong>${title}</strong><br>
                        <small>${message}</small>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Escuchar cuando se reinicia el pase de lista
        socket.on('pase-lista-reiniciado', (data) => {
            console.log('Pase de lista reiniciado:', data);
            
            if (data.tipo_reinicio === 'duro') {
                // Reinicio DURO: ocultar botón y mostrar advertencia
                const btnRegistrar = document.getElementById('btnRegistrarAsistencia');
                const divider = document.getElementById('dividerAsistencia');
                if (btnRegistrar) {
                    btnRegistrar.style.display = 'none';
                    // Restaurar estado original del botón
                    btnRegistrar.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    btnRegistrar.style.pointerEvents = 'auto';
                    btnRegistrar.disabled = false;
                    btnRegistrar.innerHTML = `
                        <i class="fas fa-user-check" style="color: white;"></i>
                        <div>
                            <div style="font-weight: bold;">PRESENTE</div>
                            <small style="color: rgba(255,255,255,0.8);">Registrar mi asistencia</small>
                        </div>
                    `;
                }
                if (divider) {
                    divider.style.display = 'none';
                }
                
                // Mostrar notificación de pérdida de votación
                if (data.votacion_deshabilitada) {
                    showNotification('warning', 'Reinicio Total', 'Se ha deshabilitado su derecho a votar. Requiere validación manual.');
                }
            } else if (data.tipo_reinicio === 'suave') {
                // Reinicio SUAVE: solo notificar si era ausente
                showNotification('info', 'Reinicio Parcial', 'Se ha reiniciado el pase de lista para ausentes');
            }
        });
        
        // Escuchar cuando se habilita la auto-asistencia
        socket.on('auto-asistencia-habilitada', (data) => {
            console.log('Auto-asistencia habilitada:', data);
            
            // Determinar si mostrar el botón según las reglas
            let mostrarBoton = false;
            
            if (data.tipo_usuario === 'secretario_legislativo') {
                // Si lo habilitó el secretario legislativo, mostrar a todos los diputados
                mostrarBoton = true;
            } else if (data.tipo_usuario === 'secretario1' || data.tipo_usuario === 'secretario2') {
                // Si lo habilitó un diputado secretario
                if (user.cargo_mesa_directiva === 'secretario1' || user.cargo_mesa_directiva === 'secretario2') {
                    // Mostrar solo al otro secretario (no al que lo habilitó)
                    if (data.iniciado_por !== user.id) {
                        mostrarBoton = true;
                    }
                } else {
                    // Mostrar a todos los demás diputados
                    mostrarBoton = true;
                }
            }
            
            if (mostrarBoton) {
                // Verificar si ya confirmé asistencia
                if (yaConfirmeAsistencia) {
                    console.log('Ya confirmé asistencia, ignorando auto-asistencia');
                    return;
                }
                
                // Usar el botón frontal grande en lugar del botón del menú
                const containerAsistencia = document.getElementById('btnConfirmarAsistenciaContainer');
                if (containerAsistencia) {
                    containerAsistencia.style.display = 'block';
                    
                    // Actualizar el título para indicar que es auto-asistencia
                    const titulo = containerAsistencia.querySelector('h4');
                    if (titulo) {
                        titulo.innerHTML = '<i class="fas fa-clipboard-check"></i> Auto-Asistencia Habilitada';
                    }
                    
                    // Agregar animación para llamar la atención
                    const btnAsistencia = document.getElementById('btnConfirmarAsistencia');
                    if (btnAsistencia) {
                        btnAsistencia.classList.add('pulse-animation');
                    }
                }
                
                // OCULTAR el botón del menú hamburguesa (no lo necesitamos)
                const btnRegistrar = document.getElementById('btnRegistrarAsistencia');
                const divider = document.getElementById('dividerAsistencia');
                if (btnRegistrar) {
                    btnRegistrar.style.display = 'none';
                }
                if (divider) {
                    divider.style.display = 'none';
                }
                
                // Mostrar notificación
                mostrarNotificacionPersonalizada('📋 Auto-Asistencia Habilitada - Puedes registrar tu asistencia ahora', 'info');
            }
        });
        
        // Escuchar cuando se confirma el pase de lista
        socket.on('pase-lista-confirmado', async (data) => {
            console.log('Pase de lista confirmado:', data);
            paseListaConfirmado = true;
            
            // Verificar si el usuario actual ya marcó asistencia
            try {
                const response = await fetch('/api/pase-lista/mi-asistencia', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const miAsistencia = await response.json();
                    
                    // Si no ha marcado asistencia, mostrar el botón frontal para llegada tardía
                    if (!miAsistencia.asistencia || miAsistencia.asistencia === 'ausente') {
                        // Usar el botón frontal grande
                        const containerAsistencia = document.getElementById('btnConfirmarAsistenciaContainer');
                        if (containerAsistencia) {
                            containerAsistencia.style.display = 'block';
                            
                            // Actualizar el título para indicar llegada tardía
                            const titulo = containerAsistencia.querySelector('h4');
                            if (titulo) {
                                titulo.innerHTML = '<i class="fas fa-clock text-warning"></i> Llegada Tardía';
                            }
                            
                            // Cambiar el estilo del botón para indicar tardanza
                            const btnAsistencia = document.getElementById('btnConfirmarAsistencia');
                            if (btnAsistencia) {
                                btnAsistencia.className = 'btn btn-warning attendance-btn btn-presente';
                                btnAsistencia.innerHTML = `
                                    <i class="fas fa-clock"></i>
                                    <span>MARCAR LLEGADA TARDÍA</span>
                                `;
                                btnAsistencia.classList.add('pulse-animation');
                            }
                            
                            // Actualizar el mensaje informativo
                            const mensaje = containerAsistencia.querySelector('.text-muted small');
                            if (mensaje) {
                                mensaje.textContent = 'Registra tu asistencia tardía a la sesión';
                            }
                        }
                        
                        // Ocultar el botón del menú hamburguesa
                        const btnRegistrar = document.getElementById('btnRegistrarAsistencia');
                        const divider = document.getElementById('dividerAsistencia');
                        if (btnRegistrar) {
                            btnRegistrar.style.display = 'none';
                        }
                        if (divider) {
                            divider.style.display = 'none';
                        }
                    } else if (miAsistencia.asistencia === 'justificado') {
                        // Si la inasistencia está justificada, NO mostrar botones
                        // Solo actualizar el badge de estado
                        updateAttendanceStatus('justificado');
                        
                        // Ocultar ambos botones (frontal y menú)
                        const containerAsistencia = document.getElementById('btnConfirmarAsistenciaContainer');
                        if (containerAsistencia) {
                            containerAsistencia.style.display = 'none';
                        }
                        
                        const btnRegistrar = document.getElementById('btnRegistrarAsistencia');
                        const divider = document.getElementById('dividerAsistencia');
                        if (btnRegistrar) {
                            btnRegistrar.style.display = 'none';
                        }
                        if (divider) {
                            divider.style.display = 'none';
                        }
                        
                        // Mostrar notificación informativa
                        const motivo = miAsistencia.justificacion_motivo || 'Justificada por secretario';
                        mostrarNotificacionPersonalizada(`ℹ️ Inasistencia justificada: ${motivo}`, 'info');
                    }
                }
            } catch (error) {
                console.error('Error verificando mi asistencia:', error);
            }
        });
        
        // Escuchar notificaciones de llegadas tardías
        socket.on('notificar-llegada-tardia', (data) => {
            console.log('Notificación de llegada tardía:', data);
            
            // Determinar si mostrar notificación según quién inició
            let mostrarNotificacion = false;
            
            if (data.tipo_iniciador === 'secretario_legislativo') {
                // Si inició el secretario legislativo, solo él recibe notificación
                if (user.role === 'secretario') {
                    mostrarNotificacion = true;
                }
            } else if (data.tipo_iniciador === 'secretario1' || data.tipo_iniciador === 'secretario2') {
                // Si inició un secretario diputado, solo ese secretario recibe notificación
                if (user.id === data.iniciador_id) {
                    mostrarNotificacion = true;
                }
            }
            
            if (mostrarNotificacion) {
                // Crear notificación especial para llegada tardía
                const notification = document.createElement('div');
                notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
                notification.style.cssText = 'top: 80px; right: 20px; z-index: 10000; min-width: 350px; border-left: 5px solid #ff9800;';
                notification.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock fa-2x me-3" style="color: #ff9800;"></i>
                        <div>
                            <strong>Llegada Tardía</strong><br>
                            <small>${data.diputado} ha marcado asistencia con retardo</small><br>
                            <small class="text-muted">Hora: ${data.hora}</small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(notification);
                
                // Auto-ocultar después de 8 segundos
                setTimeout(() => notification.remove(), 8000);
            }
        });
        
        // Escuchar notificaciones finales cuando se confirma el pase de lista
        socket.on('notificar-secretarios-asistencia-final', (data) => {
            // Solo mostrar a secretarios de mesa directiva
            if (user.cargo_mesa_directiva === 'secretario1' || user.cargo_mesa_directiva === 'secretario2') {
                mostrarPopupAsistenciaSecretarios(data);
            }
        });
        
        // Función para mostrar popup a los secretarios
        function mostrarPopupAsistenciaSecretarios(data) {
            // Crear el modal si no existe
            let modal = document.getElementById('modalAsistenciaSecretarios');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'modalAsistenciaSecretarios';
                modal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-user-check"></i> Registro de Asistencia
                                </h5>
                            </div>
                            <div class="modal-body text-center">
                                <p class="mb-3">Diputado presidente, le informo que hay una asistencia de:</p>
                                <div class="display-1 text-success fw-bold" id="numeroAsistentes">0</div>
                                <p class="fs-4 text-muted">Diputados</p>
                            </div>
                            <div class="modal-footer justify-content-center">
                                <button type="button" class="btn btn-primary btn-lg" onclick="volverPanelVotacion()">
                                    <i class="fas fa-arrow-left"></i> Regresar al Panel de Votación
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Actualizar el número
            document.getElementById('numeroAsistentes').textContent = data.totalPresentes || 0;
            
            // Mostrar el modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // Función para volver al panel de votación
        function volverPanelVotacion() {
            const modal = document.getElementById('modalAsistenciaSecretarios');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            }
        }
    </script>

    <!-- Modal Servicios Legislativos -->
    <div class="modal fade" id="modalServiciosLegislativos" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-file-alt"></i> Servicios Legislativos - Orden del Día
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Tabs de navegación -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#tabExcel">
                                <i class="fas fa-file-excel"></i> Cargar Excel
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#tabPDF">
                                <i class="fas fa-file-pdf"></i> Cargar PDF
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#tabManual">
                                <i class="fas fa-keyboard"></i> Captura Manual
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#tabIniciativas">
                                <i class="fas fa-list"></i> Iniciativas Cargadas
                            </a>
                        </li>
                    </ul>

                    <!-- Contenido de tabs -->
                    <div class="tab-content">
                        <!-- Tab Excel -->
                        <div class="tab-pane fade show active" id="tabExcel">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Cargar desde archivo Excel</h6>
                                    <p class="text-muted">Sube un archivo Excel con las iniciativas de la sesión</p>
                                    
                                    <div class="mb-3">
                                        <button class="btn btn-info btn-sm" onclick="descargarPlantillaExcel()">
                                            <i class="fas fa-download"></i> Descargar Plantilla
                                        </button>
                                    </div>
                                    
                                    <form id="formCargarExcel">
                                        <div class="mb-3">
                                            <input type="file" class="form-control" id="archivoExcel" accept=".xlsx,.xls" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-upload"></i> Cargar Iniciativas
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Tab PDF -->
                        <div class="tab-pane fade" id="tabPDF">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Cargar desde archivo PDF</h6>
                                    <p class="text-muted">Sube un archivo PDF del orden del día para extraer automáticamente las iniciativas</p>
                                    
                                    <form id="formCargarPDF">
                                        <div class="mb-3">
                                            <input type="file" class="form-control" id="archivoPDF" accept=".pdf" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-upload"></i> Procesar PDF
                                        </button>
                                    </form>
                                    
                                    <div id="resultadoExtraccion" class="mt-3" style="display: none;">
                                        <h6>Iniciativas Extraídas</h6>
                                        <div id="listaExtraccion"></div>
                                        <button class="btn btn-success mt-3" onclick="confirmarExtraccion()">
                                            <i class="fas fa-check"></i> Confirmar y Cargar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Manual -->
                        <div class="tab-pane fade" id="tabManual">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Captura Manual de Iniciativa</h6>
                                    
                                    <form id="formCapturaManual">
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label>Título de la Iniciativa *</label>
                                                <input type="text" class="form-control" id="manualTitulo" required>
                                            </div>
                                            
                                            <div class="col-md-12 mb-3">
                                                <label>Descripción</label>
                                                <textarea class="form-control" id="manualDescripcion" rows="3"></textarea>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label>Presentador</label>
                                                <input type="text" class="form-control" id="manualPresentador">
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label>Partido/Fracción</label>
                                                <input type="text" class="form-control" id="manualPartido">
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label>Tipo de Mayoría *</label>
                                                <select class="form-control" id="manualTipoMayoria" required>
                                                    <option value="simple">Mayoría Simple</option>
                                                    <option value="absoluta">Mayoría Absoluta</option>
                                                    <option value="calificada">Mayoría Calificada (2/3)</option>
                                                    <option value="unanime">Unanimidad</option>
                                                </select>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label>Tipo de Iniciativa</label>
                                                <select class="form-control" id="manualTipoIniciativa">
                                                    <option value="ordinaria">Iniciativa Ordinaria</option>
                                                    <option value="decreto">Decreto</option>
                                                    <option value="punto_acuerdo">Punto de Acuerdo</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Guardar Iniciativa
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Iniciativas Cargadas -->
                        <div class="tab-pane fade" id="tabIniciativas">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Iniciativas de la Sesión</h6>
                                    <div id="listaIniciativasSesion" class="table-responsive">
                                        <!-- Se llenará dinámicamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/theme-switcher.js"></script>
</body>
</html>