<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Operador - Sistema de Votación</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/global-theme.css">
    <style>
        /* Colores neutros */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .navbar { 
            background: var(--navbar-bg) !important;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        .card-header {
            background: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border-bottom: 1px solid var(--border-color);
        }
        .bg-purple {
            background-color: #9b59b6 !important;
        }
        
        /* Fix para dropdown de pantalla pública */
        .dropdown-menu {
            z-index: 9999 !important;
            position: absolute !important;
        }
        
        .dropdown {
            position: relative !important;
        }
        
        /* Asegurar que el dropdown de pantalla esté siempre visible */
        #screenDropdown .dropdown-menu {
            z-index: 10000 !important;
        }
        
        .initiative-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .initiative-card:hover { transform: translateY(-5px); }
        .initiative-card.active {
            border: 2px solid var(--color-primary);
            background: var(--bg-hover);
        }
        
        /* Estilos mejorados para iniciativas extraordinarias */
        .initiative-card.extraordinary {
            background: linear-gradient(135deg, #fff8e1 0%, #fffdf7 100%);
            border: 2px solid #ffa000 !important;
            box-shadow: 0 0 10px rgba(255, 160, 0, 0.2);
            position: relative;
        }
        
        .initiative-card.extraordinary::before {
            content: "⚠";
            position: absolute;
            top: -10px;
            right: 15px;
            background: #ff9800;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .initiative-card.extraordinary.active {
            background: linear-gradient(135deg, #fff3cd 0%, #f8fff9 100%);
            border-color: #ff6b00 !important;
            box-shadow: 0 0 15px rgba(255, 107, 0, 0.3);
        }
        
        .badge-extraordinary {
            background: linear-gradient(135deg, #ff9800 0%, #ff6b00 100%);
            color: white;
            font-weight: bold;
            animation: pulse 2s infinite;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <img src="/uploads/logo-congreso.png" alt="Logo" style="height: 40px; margin-right: 15px;" 
                     onerror="this.style.display='none'">
                <span class="navbar-brand mb-0 h1">
                    <i class="fas fa-user-cog"></i> Panel Operador - Congreso del Estado de Morelos
                </span>
                <img src="/uploads/logo-secundario.png" alt="Logo Sec" style="height: 35px; margin-left: 15px;" 
                     onerror="this.style.display='none'">
            </div>
            <div class="d-flex align-items-center">
                <span class="text-white me-3" id="userName"></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
    </nav>

    <!-- Panel de estadísticas de sesiones -->
    <div class="container-fluid mt-3">
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center p-2">
                        <h6 class="text-muted mb-1 small">Última Sesión</h6>
                        <p class="mb-0 small fw-bold" id="ultimaSesion">Cargando...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-warning bg-opacity-10">
                    <div class="card-body text-center p-2">
                        <h6 class="text-muted mb-1 small">Próxima Programada</h6>
                        <p class="mb-0 small fw-bold" id="proximaSesion">Sin programar</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info bg-opacity-10">
                    <div class="card-body text-center p-2">
                        <h6 class="text-muted mb-1 small">Docs Precargados</h6>
                        <p class="mb-0 small fw-bold" id="documentosPendientes">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container-fluid">
        <!-- Panel de Sesiones Precargadas por Servicios Legislativos -->
        <div id="sesionesPrecargadasAlert" class="alert alert-info mb-3" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-bell"></i> <strong>Hay sesiones precargadas disponibles</strong>
                    <span id="numSesionesPrecargadas"></span>
                </div>
                <button class="btn btn-sm btn-primary" onclick="verSesionesPrecargadas()">
                    <i class="fas fa-eye"></i> Ver Sesiones
                </button>
            </div>
        </div>
        
        <div class="row">
            <!-- Panel de carga de PDF -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-file-pdf"></i> Cargar Orden del Día</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label for="pdfFile" class="form-label">Seleccionar archivo (PDF o Word)</label>
                                <input type="file" class="form-control" id="pdfFile" accept=".pdf,.doc,.docx" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tipo de carga:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tipoCarga" id="cargaInmediata" value="inmediata" checked>
                                    <label class="form-check-label" for="cargaInmediata">
                                        <i class="fas fa-play-circle text-success"></i> Ejecutar inmediatamente
                                        <small class="text-muted d-block">El presidente podrá iniciar la sesión de inmediato</small>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tipoCarga" id="cargaProgramada" value="programada">
                                    <label class="form-check-label" for="cargaProgramada">
                                        <i class="fas fa-calendar-check text-info"></i> Programar para después
                                        <small class="text-muted d-block">Guardar para una sesión futura con fecha específica</small>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tipoCarga" id="cargaIndefinida" value="indefinida">
                                    <label class="form-check-label" for="cargaIndefinida">
                                        <i class="fas fa-clock text-warning"></i> Fecha indefinida
                                        <small class="text-muted d-block">Guardar para cuando se decida realizar la sesión</small>
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3" id="fechaProgramada" style="display: none;">
                                <label for="fechaSesion" class="form-label">Fecha y hora programada:</label>
                                <input type="datetime-local" class="form-control" id="fechaSesion">
                                <small class="text-muted">La sesión se activará automáticamente en esta fecha</small>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-upload"></i> Cargar y Procesar
                            </button>
                            <button type="button" class="btn btn-info w-100 mt-2" onclick="verHistorial()">
                                <i class="fas fa-history"></i> Historial de Sesiones
                            </button>
                        </form>
                        
                        <div id="uploadStatus" class="mt-3"></div>
                    </div>
                </div>
                
                <!-- Estado de sesión -->
                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Estado de Sesión</h6>
                    </div>
                    <div class="card-body">
                        <div id="sessionStatus">
                            <p class="text-muted">Sin sesión activa</p>
                        </div>
                    </div>
                </div>
                
                <!-- Pantalla de votación -->
                <div class="card mt-3">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0"><i class="fas fa-tv"></i> Pantalla Pública</h6>
                    </div>
                    <div class="card-body">
                        <div class="dropdown w-100" id="screenDropdown">
                            <button class="btn btn-dark w-100 dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="true">
                                <i class="fas fa-desktop"></i> Seleccionar Pantalla
                            </button>
                            <ul class="dropdown-menu w-100" data-bs-popper="static">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="abrirPantalla('votacion')">
                                        <i class="fas fa-vote-yea"></i> Pantalla de Votación
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="abrirPantalla('asistencia')">
                                        <i class="fas fa-clipboard-check"></i> Pantalla de Asistencia
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="mostrarOpcionesOBS('votacion')">
                                        <i class="fas fa-video"></i> OBS - Votación
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="mostrarOpcionesOBS('asistencia')">
                                        <i class="fas fa-video"></i> OBS - Asistencia
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Selecciona qué pantalla mostrar al público
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Lista de iniciativas -->
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list"></i> Iniciativas Cargadas</h5>
                            <div class="btn-group" role="group">
                                <button class="btn btn-warning btn-sm" onclick="mostrarModalExtraordinarias()" title="Agregar iniciativas extraordinarias">
                                    <i class="fas fa-plus-circle"></i> Extraordinarias
                                </button>
                                <button class="btn btn-info btn-sm" onclick="guardarSesion()" title="Guardar sesión para uso posterior">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="limpiarSesion()" title="Eliminar todas las iniciativas de la sesión">
                                    <i class="fas fa-trash"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="initiativesList">
                            <p class="text-muted text-center">No hay iniciativas cargadas</p>
                        </div>
                        <!-- Botón para notificar a mesa directiva -->
                        <div id="notificarMesaContainer" class="mt-3" style="display: none;">
                            <div class="d-grid">
                                <button class="btn btn-success btn-lg" onclick="notificarMesaDirectiva()">
                                    <i class="fas fa-bell"></i> Notificar Mesa Directiva - Sesión Lista
                                </button>
                                <small class="text-muted text-center mt-2">
                                    Notifica al presidente y secretarios que las iniciativas están listas
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel de Exportación -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-download"></i> Exportar Resultados</h5>
                    </div>
                    <div class="card-body">
                        <div id="exportPanel">
                            <p class="small text-muted mb-3">Exporta los resultados de la sesión actual en diferentes formatos</p>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" onclick="exportarResultados('excel')" id="btnExportExcel" disabled>
                                    <i class="fas fa-file-excel"></i> Exportar a Excel
                                </button>
                                <button class="btn btn-danger" onclick="exportarResultados('pdf')" id="btnExportPDF" disabled>
                                    <i class="fas fa-file-pdf"></i> Exportar a PDF
                                </button>
                                <button class="btn btn-primary" onclick="exportarResultados('word')" id="btnExportWord" disabled>
                                    <i class="fas fa-file-word"></i> Exportar a Word
                                </button>
                            </div>
                            
                            <hr>
                            
                            <div class="small">
                                <h6>El reporte incluye:</h6>
                                <ul class="small ps-3">
                                    <li>Información de la sesión</li>
                                    <li>Duración total</li>
                                    <li>Asistencia y quórum</li>
                                    <li>Resultados por iniciativa</li>
                                    <li>Detalle de votos</li>
                                </ul>
                            </div>
                            
                            <div id="exportStatus" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sesiones Pendientes -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning bg-opacity-25 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-clock"></i> Sesiones Pendientes / Indefinidas</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadSesionesPendientes()">
                            <i class="fas fa-sync"></i> Actualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="sesionesPendientesList">
                            <p class="text-muted text-center">Cargando sesiones pendientes...</p>
                        </div>
                        <!-- Controles de paginación -->
                        <div id="paginacionSesiones" class="d-flex justify-content-between align-items-center mt-3" style="display: none;">
                            <div>
                                <span class="text-muted">Mostrando <span id="showingRange">0-0</span> de <span id="totalSesiones">0</span> sesiones</span>
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="paginationControls">
                                    <!-- Se llena dinámicamente -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Consulta Sesiones Previas -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-file-pdf"></i> Consulta Sesiones Previas</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadSesionesConDocumentos()">
                            <i class="fas fa-sync"></i> Actualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="sesionesDocumentosList">
                            <p class="text-muted text-center">Cargando sesiones con documentos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar iniciativas de sesión -->
    <div class="modal fade" id="editarIniciativasModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Editar Iniciativas de Sesión</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Puedes editar las iniciativas de esta sesión antes de activarla.
                    </div>
                    
                    <h6 class="mb-3">Sesión: <span id="sesionNombreEdit"></span></h6>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="25%">Título</th>
                                    <th width="45%">Descripción</th>
                                    <th width="15%">Tipo de Mayoría</th>
                                    <th width="10%">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="iniciativasEditList">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-success" onclick="agregarNuevaIniciativa()">
                            <i class="fas fa-plus"></i> Agregar Nueva Iniciativa
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarCambiosIniciativas()">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para configuración OBS -->
    <div class="modal fade" id="obsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-video"></i> Configuración OBS/Streaming</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Usa estos enlaces para agregar la pantalla como Browser Source en OBS
                    </div>
                    
                    <h6>Modos Predefinidos:</h6>
                    <div class="list-group mb-3" id="obsPresetModes">
                        <!-- Se llenará dinámicamente según el tipo de pantalla -->
                    </div>
                    
                    <h6>Configuración Personalizada:</h6>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Resolución</label>
                            <select class="form-select" id="obsResolution">
                                <option value="">Automática</option>
                                <option value="1920x1080">1920x1080 (Full HD)</option>
                                <option value="1280x720">1280x720 (HD)</option>
                                <option value="774x518">774x518 (Compacto)</option>
                                <option value="custom">Personalizada</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Ancho</label>
                            <input type="number" class="form-control" id="obsWidth" placeholder="1920" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Alto</label>
                            <input type="number" class="form-control" id="obsHeight" placeholder="1080" disabled>
                        </div>
                    </div>
                    
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="obsHeader" checked>
                        <label class="form-check-label" for="obsHeader">Mostrar encabezado</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="obsSidebar" checked>
                        <label class="form-check-label" for="obsSidebar">Mostrar panel lateral</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="obsTransparent">
                        <label class="form-check-label" for="obsTransparent">Fondo transparente</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="obsMinimal">
                        <label class="form-check-label" for="obsMinimal">Modo minimalista</label>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">URL Personalizada:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="obsCustomURL" readonly>
                            <button class="btn btn-primary" onclick="copiarCustomURL()">Copiar</button>
                        </div>
                    </div>
                    
                    <div class="alert alert-secondary mt-3">
                        <strong>Configuración recomendada en OBS:</strong>
                        <ul class="mb-0">
                            <li>Tipo de fuente: Browser Source</li>
                            <li>FPS: 60</li>
                            <li>CSS personalizado: Dejar vacío</li>
                            <li>Shutdown source when not visible: Desactivado</li>
                            <li>Refresh browser when scene becomes active: Activado</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="abrirPantallaOBS()">Abrir Vista Previa</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para editar iniciativa -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Iniciativa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label class="form-label">Número</label>
                            <input type="number" class="form-control" id="editNumero" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción de la Iniciativa</label>
                            <textarea class="form-control" id="editDescripcion" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Presentada por</label>
                            <input type="text" class="form-control" id="editPresentador" placeholder="Nombre del diputado">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Partido</label>
                            <input type="text" class="form-control" id="editPartidoPresentador" placeholder="Siglas del partido">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Mayoría</label>
                            <select class="form-select" id="editTipoMayoria" disabled>
                                <option value="simple">Mayoría Simple</option>
                                <option value="absoluta">Mayoría Absoluta</option>
                                <option value="calificada">Mayoría Calificada (2/3)</option>
                                <option value="unanime">Unanimidad</option>
                            </select>
                            <small class="text-muted">Solo el secretario puede editar el tipo de mayoría</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">Guardar cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Sesiones Precargadas -->
    <div class="modal fade" id="sesionesPrecargadasModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-folder-open"></i> Sesiones Precargadas por Servicios Legislativos</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Sesiones Disponibles</h6>
                            <div class="list-group" id="listaSesionesPrecargadas">
                                <!-- Se carga dinámicamente -->
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div id="detalleSesionPrecargada">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-arrow-left fa-3x"></i>
                                    <p class="mt-3">Seleccione una sesión para ver los detalles</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Iniciativas Extraordinarias -->
    <div class="modal fade" id="extraordinariasModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Agregar Iniciativas Extraordinarias</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="extraordinariasTab">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#manualTab">
                                <i class="fas fa-keyboard"></i> Captura Manual
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pdfTab">
                                <i class="fas fa-file-pdf"></i> Desde PDF
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content">
                        <!-- Tab de Captura Manual -->
                        <div class="tab-pane fade show active" id="manualTab">
                            <form id="extraordinariaManualForm">
                                <div class="mb-3">
                                    <label class="form-label">Número de Iniciativa</label>
                                    <select class="form-select" id="extNumero" required>
                                        <option value="">Seleccionar posición...</option>
                                    </select>
                                    <small class="text-muted">La iniciativa extraordinaria se insertará en esta posición y recorrerá las demás</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Descripción de la Iniciativa</label>
                                    <textarea class="form-control" id="extDescripcion" rows="3" required></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Presentada por</label>
                                            <select class="form-select" id="extPresentador" onchange="actualizarPartidoAutomatico()">
                                                <option value="">Seleccionar diputado...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Partido</label>
                                            <select class="form-select" id="extPartido">
                                                <option value="">Seleccionar...</option>
                                                <option value="MORENA">MORENA</option>
                                                <option value="PAN">PAN</option>
                                                <option value="PRI">PRI</option>
                                                <option value="PT">PT</option>
                                                <option value="PVEM">PVEM</option>
                                                <option value="MC">MC</option>
                                                <option value="PRD">PRD</option>
                                                <option value="PNA">PNA</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tipo de Mayoría</label>
                                    <select class="form-select" id="extTipoMayoria" required>
                                        <option value="simple">Mayoría Simple</option>
                                        <option value="absoluta">Mayoría Absoluta</option>
                                        <option value="calificada">Mayoría Calificada (2/3)</option>
                                        <option value="unanime">Unanimidad</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-warning" onclick="agregarExtraordinaria()">
                                    <i class="fas fa-plus"></i> Agregar a la lista
                                </button>
                            </form>
                            
                            <!-- Lista de iniciativas agregadas -->
                            <div class="mt-3">
                                <h6>Iniciativas Extraordinarias Agregadas:</h6>
                                <div id="listaExtraordinarias" class="list-group">
                                    <p class="text-muted">No hay iniciativas extraordinarias agregadas</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab de PDF -->
                        <div class="tab-pane fade" id="pdfTab">
                            <form id="extraordinariaPdfForm">
                                <div class="mb-3">
                                    <label class="form-label">Archivo PDF con Iniciativas Extraordinarias</label>
                                    <input type="file" class="form-control" id="extPdfFile" accept=".pdf" required>
                                    <small class="text-muted">El PDF debe contener solo las iniciativas extraordinarias</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Rango de números (opcional)</label>
                                    <div class="row">
                                        <div class="col">
                                            <input type="number" class="form-control" id="extNumeroInicio" placeholder="Desde">
                                        </div>
                                        <div class="col">
                                            <input type="number" class="form-control" id="extNumeroFin" placeholder="Hasta">
                                        </div>
                                    </div>
                                    <small class="text-muted">Si no se especifica, se asignarán números automáticamente</small>
                                </div>
                                <button type="submit" class="btn btn-warning w-100">
                                    <i class="fas fa-file-import"></i> Importar desde PDF
                                </button>
                            </form>
                            
                            <div id="pdfExtraordinariasStatus" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="guardarTodasExtraordinarias()">
                        <i class="fas fa-save"></i> Guardar todas las extraordinarias
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');
        
        // Identificar usuario al conectarse
        if (user) {
            socket.emit('identificar-usuario', {
                nombre: user.nombre_completo || user.username,
                rol: 'Operador'
            });
        }
        
        // Variable para rastrear el tipo de pantalla actual (definida al inicio)
        let currentScreenType = 'votacion';
        
        // Función para mostrar notificaciones
        function showNotification(message, type = 'info') {
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'warning' ? 'alert-warning' : 
                             type === 'danger' ? 'alert-danger' : 'alert-info';
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-cerrar después de 3 segundos
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 150);
            }, 3000);
        }
        
        // Variable para almacenar información de la sesión actual
        let sessionData = null;
        
        if (!token || !user || user.role !== 'operador') {
            window.location.href = '/';
        }
        
        document.getElementById('userName').textContent = user.nombre;
        
        // Cargar sesión activa y estadísticas al iniciar
        loadActiveSession();
        loadEstadisticasSesiones();
        loadSesionesPendientes();
        loadSesionesConDocumentos();
        verificarSesionesPrecargadas();
        
        // Escuchar notificaciones de nuevas sesiones precargadas
        socket.on('nueva-sesion-precargada', (data) => {
            console.log('Nueva sesión precargada recibida:', data);
            
            // Mostrar notificación toast o alerta
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-info alert-dismissible fade show position-fixed top-0 end-0 m-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <strong>¡Nueva sesión disponible!</strong><br>
                ${data.mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-cerrar después de 5 segundos
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
            
            // Actualizar contador de sesiones precargadas
            verificarSesionesPrecargadas();
        });
        
        // Escuchar cuando el presidente inicia sesión
        socket.on('sesion-iniciada', (data) => {
            console.log('El presidente ha iniciado sesión:', data);
            
            // Mostrar alerta urgente
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '400px';
            alertDiv.innerHTML = `
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> ¡Atención!</h5>
                <p><strong>${data.mensaje}</strong></p>
                ${data.aviso_operador ? '<p class="mb-0">Por favor, cargue las iniciativas lo antes posible.</p>' : ''}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Actualizar estado de sesión
            loadActiveSession();
        });
        
        // Manejar tipo de carga
        document.getElementById('cargaInmediata').addEventListener('change', function() {
            document.getElementById('fechaProgramada').style.display = 'none';
        });
        
        document.getElementById('cargaProgramada').addEventListener('change', function() {
            document.getElementById('fechaProgramada').style.display = 'block';
            // Establecer fecha mínima como ahora
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('fechaSesion').min = now.toISOString().slice(0, 16);
            document.getElementById('fechaSesion').required = true;
        });
        
        document.getElementById('cargaIndefinida').addEventListener('change', function() {
            document.getElementById('fechaProgramada').style.display = 'none';
            document.getElementById('fechaSesion').required = false;
        });
        
        // Manejar carga de PDF
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor selecciona un archivo PDF');
                return;
            }
            
            const formData = new FormData();
            formData.append('pdf', file);
            
            // Agregar tipo de carga
            const tipoCarga = document.querySelector('input[name="tipoCarga"]:checked').value;
            formData.append('tipoCarga', tipoCarga);
            
            if (tipoCarga === 'programada') {
                const fechaProgramada = document.getElementById('fechaSesion').value;
                if (!fechaProgramada) {
                    alert('Por favor selecciona una fecha para la sesión programada');
                    return;
                }
                formData.append('fechaProgramada', fechaProgramada);
            } else if (tipoCarga === 'indefinida') {
                // Para sesión indefinida, no enviamos fecha
                formData.append('indefinida', 'true');
            }
            
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="alert alert-info">Procesando PDF...</div>';
            
            try {
                const response = await fetch('/api/operador/upload-pdf', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let mensaje = '';
                    if (tipoCarga === 'inmediata') {
                        mensaje = 'Las iniciativas están listas para que el presidente inicie la sesión';
                    } else if (tipoCarga === 'programada') {
                        mensaje = `Sesión programada para ${new Date(document.getElementById('fechaSesion').value).toLocaleString('es-MX')}`;
                    } else if (tipoCarga === 'indefinida') {
                        mensaje = 'Sesión guardada con fecha indefinida. Se podrá activar cuando se decida';
                    }
                    
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            ✅ PDF procesado correctamente<br>
                            ${data.iniciativas} iniciativas extraídas<br>
                            <small class="text-muted">${mensaje}</small>
                        </div>
                    `;
                    fileInput.value = '';
                    loadActiveSession();
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = '<div class="alert alert-danger">Error al procesar el PDF</div>';
            }
        });
        
        // Cargar sesión activa
        async function loadActiveSession() {
            try {
                const response = await fetch('/api/operador/sesion-activa', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.sesion) {
                    document.getElementById('sessionStatus').innerHTML = `
                        <strong>Sesión:</strong> ${data.sesion.nombre}<br>
                        <strong>Fecha:</strong> ${new Date(data.sesion.fecha).toLocaleDateString()}<br>
                        <strong>Iniciativas:</strong> ${data.iniciativas.length}
                    `;
                    
                    displayInitiatives(data.iniciativas);
                } else {
                    document.getElementById('sessionStatus').innerHTML = 
                        '<p class="text-muted">Sin sesión activa</p>';
                    document.getElementById('initiativesList').innerHTML = 
                        '<p class="text-muted text-center">No hay iniciativas cargadas</p>';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Mostrar iniciativas
        function displayInitiatives(initiatives) {
            // Mostrar/ocultar botón de notificar si hay iniciativas
            const notificarContainer = document.getElementById('notificarMesaContainer');
            if (notificarContainer) {
                notificarContainer.style.display = initiatives.length > 0 ? 'block' : 'none';
            }
            const container = document.getElementById('initiativesList');
            
            if (initiatives.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No hay iniciativas</p>';
                return;
            }
            
            // Agregar controles de selección múltiple
            let headerHtml = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllInitiatives" onchange="toggleSelectAll()">
                        <label class="form-check-label" for="selectAllInitiatives">
                            Seleccionar todas
                        </label>
                    </div>
                    <button class="btn btn-danger btn-sm" id="deleteSelectedBtn" style="display: none;" onclick="deleteSelectedInitiatives()">
                        <i class="fas fa-trash"></i> Eliminar seleccionadas (<span id="selectedCount">0</span>)
                    </button>
                </div>
            `;
            
            const initiativesHtml = initiatives.map(init => {
                // Determinar si requiere votación
                const requiereVotacion = init.requiere_votacion || 
                    (init.tipo_votacion && !init.tipo_votacion.toLowerCase().includes('comisión'));
                
                // Clase para resaltar si requiere votación
                const borderClass = requiereVotacion ? 'border-success border-3' : '';
                
                return `
                <div class="card mb-2 initiative-card ${init.activa ? 'active' : ''} ${init.tipo_iniciativa === 'extraordinaria' ? 'extraordinary' : ''} ${borderClass}" 
                     data-id="${init.id}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="d-flex align-items-start">
                                ${!init.activa && !init.cerrada ? `
                                    <div class="form-check me-3">
                                        <input class="form-check-input initiative-checkbox" type="checkbox" 
                                               value="${init.id}" onchange="updateSelectedCount()">
                                    </div>
                                ` : '<div style="width: 40px;"></div>'}
                                <div>
                                    <h6 class="mb-1">
                                        ${requiereVotacion ? '<i class="fas fa-vote-yea text-success me-2" title="Requiere votación"></i>' : ''}
                                        ${init.numero_orden_dia ? `${init.numero}/${init.numero_orden_dia}` : init.numero}. ${init.titulo || init.descripcion || 'Sin descripción'}
                                        ${init.tipo_iniciativa === 'extraordinaria' ? '<span class="badge badge-extraordinary ms-2">⚡ EXTRAORDINARIA</span>' : ''}
                                    </h6>
                                    ${init.presentador ? `
                                        <div class="small mb-1">
                                            <i class="fas fa-user"></i> 
                                            <strong>Presentada por:</strong> ${init.presentador}
                                            ${init.partido_presentador ? `<span class="badge bg-info ms-1">${init.partido_presentador}</span>` : ''}
                                        </div>
                                    ` : ''}
                                    <span class="badge bg-secondary">${init.tipo_mayoria || 'Simple'}</span>
                                    ${init.activa ? '<span class="badge bg-success ms-1">ACTIVA</span>' : ''}
                                    ${init.cerrada ? '<span class="badge bg-dark ms-1">CERRADA</span>' : ''}
                                </div>
                            </div>
                            <div class="btn-group">
                                ${!init.activa && !init.cerrada ? `
                                    <button class="btn btn-sm btn-success" 
                                            onclick="activateInitiative(${init.id})"
                                            title="Activar iniciativa">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning" 
                                            onclick="editInitiative(${init.id})"
                                            title="Editar iniciativa">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" 
                                            onclick="deleteInitiative(${init.id})"
                                            title="Eliminar iniciativa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                                ${init.activa ? `
                                    <button class="btn btn-sm btn-danger" 
                                            onclick="closeVoting(${init.id})"
                                            title="Cerrar votación">
                                        <i class="fas fa-stop"></i> Cerrar
                                    </button>
                                ` : ''}
                                ${init.cerrada && !init.resultado ? `
                                    <button class="btn btn-sm btn-warning" 
                                            onclick="reopenVoting(${init.id})"
                                            title="Reabrir votación">
                                        <i class="fas fa-undo"></i> Reabrir
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        ${init.cerrada ? `
                            <div class="mt-2">
                                <small class="text-muted">
                                    Resultado: <strong class="${init.resultado === 'aprobada' ? 'text-success' : 'text-danger'}">
                                        ${init.resultado ? init.resultado.toUpperCase() : 'PENDIENTE'}
                                    </strong> | 
                                    A favor: ${init.votos_favor} | 
                                    En contra: ${init.votos_contra} | 
                                    Abstención: ${init.votos_abstencion}
                                </small>
                                ${!init.resultado ? '<br><small class="text-warning"><i class="fas fa-info-circle"></i> Votación cerrada temporalmente - puede reabrirse</small>' : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            }).join('');
            
            // Combinar header y contenido
            container.innerHTML = headerHtml + initiativesHtml;
        }
        
        // Funciones para selección múltiple
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllInitiatives');
            const checkboxes = document.querySelectorAll('.initiative-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const checked = document.querySelectorAll('.initiative-checkbox:checked');
            const count = checked.length;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('deleteSelectedBtn').style.display = count > 0 ? 'block' : 'none';
        }
        
        // Eliminar iniciativas seleccionadas
        async function deleteSelectedInitiatives() {
            const checked = document.querySelectorAll('.initiative-checkbox:checked');
            const ids = Array.from(checked).map(cb => cb.value);
            
            if (ids.length === 0) return;
            
            if (!confirm(`¿Eliminar ${ids.length} iniciativa(s) seleccionada(s)?\n\nEsta acción no se puede deshacer.`)) {
                return;
            }
            
            let eliminadas = 0;
            let errores = 0;
            
            for (const id of ids) {
                try {
                    const response = await fetch(`/api/operador/iniciativa/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        eliminadas++;
                    } else {
                        errores++;
                    }
                } catch (error) {
                    console.error('Error eliminando iniciativa:', error);
                    errores++;
                }
            }
            
            // Mostrar resultado
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${errores === 0 ? 'alert-success' : 'alert-warning'} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <strong>${eliminadas > 0 ? '✅' : '⚠️'} Operación completada</strong><br>
                ${eliminadas} iniciativa(s) eliminada(s)${errores > 0 ? `<br>${errores} error(es) al eliminar` : ''}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 5000);
            
            // Recargar lista
            loadActiveSession();
        }
        
        // Activar iniciativa
        async function activateInitiative(id) {
            if (!confirm('¿Activar esta iniciativa para votación?')) return;
            
            try {
                const response = await fetch(`/api/operador/activar-iniciativa/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    loadActiveSession();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al activar iniciativa');
            }
        }
        
        // Cerrar votación
        async function closeVoting(id) {
            if (!confirm('¿Cerrar la votación de esta iniciativa?')) return;
            
            try {
                const response = await fetch(`/api/operador/cerrar-votacion/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Votación cerrada. Resultado: ${data.resultado.toUpperCase()}`);
                    loadActiveSession();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cerrar votación');
            }
        }
        
        // Reabrir votación
        async function reopenVoting(id) {
            if (!confirm('¿Reabrir la votación de esta iniciativa? Los votos existentes se mantendrán.')) return;
            
            try {
                const response = await fetch(`/api/operador/reabrir-votacion/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Votación reabierta exitosamente');
                    loadActiveSession();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al reabrir votación');
            }
        }
        
        // Escuchar eventos de socket
        socket.on('iniciativa-activa', () => {
            loadActiveSession();
        });
        
        socket.on('votacion-cerrada', () => {
            loadActiveSession();
        });
        
        socket.on('iniciativa-actualizada', () => {
            loadActiveSession();
        });
        
        // Evento de inicio de sesión
        socket.on('sesion-iniciada', (data) => {
            console.log('Sesión iniciada:', data);
            
            // Mostrar notificación mejorada
            const notification = `
                <div class="alert alert-success alert-dismissible fade show position-fixed shadow-lg" style="top: 20px; right: 20px; z-index: 9999; min-width: 350px;">
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    <h5 class="alert-heading"><i class="fas fa-play-circle"></i> ¡Sesión Iniciada!</h5>
                    <hr>
                    <p class="mb-2"><strong>Nombre:</strong> ${data.nombre}</p>
                    <p class="mb-2"><strong>Iniciada por:</strong> ${data.iniciada_por}</p>
                    <p class="mb-0"><small class="text-muted">Hora: ${new Date(data.fecha).toLocaleTimeString('es-MX')}</small></p>
                </div>
            `;
            
            // Agregar notificación al DOM
            const container = document.createElement('div');
            container.innerHTML = notification;
            document.body.appendChild(container.firstElementChild);
            
            // Auto-remover después de 10 segundos
            setTimeout(() => {
                const alert = document.querySelector('.alert.alert-success');
                if (alert) alert.remove();
            }, 10000);
            
            // Recargar la sesión activa
            loadActiveSession();
        });
        
        // Evento de clausura de sesión
        socket.on('sesion-clausurada', (data) => {
            console.log('Sesión clausurada:', data);
            
            // Mostrar notificación mejorada
            const notification = `
                <div class="alert alert-warning alert-dismissible fade show position-fixed shadow-lg" style="top: 20px; right: 20px; z-index: 9999; min-width: 350px;">
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    <h5 class="alert-heading"><i class="fas fa-stop-circle"></i> ¡Sesión Clausurada!</h5>
                    <hr>
                    <p class="mb-2"><strong>Clausurada por:</strong> ${data.clausurada_por}</p>
                    <strong>Estadísticas finales:</strong><br>
                    - Iniciativas: ${data.estadisticas.total_iniciativas}<br>
                    - Aprobadas: ${data.estadisticas.aprobadas}<br>
                    - Rechazadas: ${data.estadisticas.rechazadas}<br>
                    <hr>
                    <button class="btn btn-primary btn-sm w-100" onclick="descargarReporteSesion(${data.sesion_id})">
                        <i class="fas fa-file-pdf"></i> Descargar Reporte PDF
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', notification);
            
            // Recargar sesión
            loadActiveSession();
        });
        
        // Función para descargar reporte de sesión
        async function descargarReporteSesion(sesionId) {
            try {
                const response = await fetch(`/api/operador/reporte-sesion/${sesionId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `reporte_sesion_${sesionId}_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    alert('Error al generar el reporte');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al descargar el reporte');
            }
        }
        
        // Modal de edición
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        
        // Editar iniciativa
        async function editInitiative(id) {
            try {
                const response = await fetch(`/api/operador/iniciativa/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('editId').value = data.id;
                    document.getElementById('editNumero').value = data.numero;
                    document.getElementById('editDescripcion').value = data.descripcion || data.titulo || '';
                    document.getElementById('editPresentador').value = data.presentador || '';
                    document.getElementById('editPartidoPresentador').value = data.partido_presentador || '';
                    document.getElementById('editTipoMayoria').value = data.tipo_mayoria || 'simple';
                    
                    editModal.show();
                } else {
                    alert('Error al cargar la iniciativa');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar la iniciativa');
            }
        }
        
        // Guardar edición
        async function saveEdit() {
            const id = document.getElementById('editId').value;
            const data = {
                numero: parseInt(document.getElementById('editNumero').value),
                descripcion: document.getElementById('editDescripcion').value,
                presentador: document.getElementById('editPresentador').value,
                partido_presentador: document.getElementById('editPartidoPresentador').value
                // tipo_mayoria no se envía porque el operador no puede editarlo
            };
            
            try {
                const response = await fetch(`/api/operador/iniciativa/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    editModal.hide();
                    loadActiveSession();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Error al guardar los cambios');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar los cambios');
            }
        }
        
        // Eliminar iniciativa
        async function deleteInitiative(id) {
            if (!confirm('¿Estás seguro de eliminar esta iniciativa? Esta acción no se puede deshacer.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/operador/iniciativa/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    loadActiveSession();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al eliminar la iniciativa');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar la iniciativa');
            }
        }
        
        // Cargar estadísticas de sesiones
        async function loadEstadisticasSesiones() {
            try {
                const response = await fetch('/api/operador/estadisticas-sesiones', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Última sesión
                    if (data.ultimaSesion) {
                        const fecha = new Date(data.ultimaSesion.fecha_clausura || data.ultimaSesion.fecha);
                        document.getElementById('ultimaSesion').textContent = fecha.toLocaleDateString('es-MX') + ' ' + fecha.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});
                    } else {
                        document.getElementById('ultimaSesion').textContent = 'Sin sesiones previas';
                    }
                    
                    // Próxima sesión programada
                    if (data.proximaSesion) {
                        const fecha = new Date(data.proximaSesion.fecha_programada);
                        document.getElementById('proximaSesion').textContent = fecha.toLocaleDateString('es-MX') + ' ' + fecha.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});
                    } else {
                        document.getElementById('proximaSesion').textContent = 'Sin programar';
                    }
                    
                    // Documentos pendientes
                    document.getElementById('documentosPendientes').textContent = data.documentosPendientes || 0;
                }
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }
        
        // Ver historial de sesiones
        function verHistorial() {
            window.open('/historial-sesiones', '_blank');
        }
        
        // Cargar sesiones con documentos PDF
        async function loadSesionesConDocumentos() {
            try {
                const response = await fetch('/api/operador/sesiones-con-documentos', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('sesionesDocumentosList');
                    
                    if (!data.sesiones || data.sesiones.length === 0) {
                        container.innerHTML = '<p class="text-muted text-center">No hay sesiones con documentos disponibles</p>';
                        return;
                    }
                    
                    let html = '<div class="table-responsive"><table class="table table-sm table-hover">';
                    html += `
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Sesión</th>
                                <th>Estado</th>
                                <th>Iniciativas</th>
                                <th>Resultados</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    
                    data.sesiones.forEach(sesion => {
                        const fecha = new Date(sesion.fecha).toLocaleDateString('es-MX');
                        const estadoBadge = sesion.estado === 'clausurada' ? 
                            '<span class="badge bg-secondary">Clausurada</span>' :
                            '<span class="badge bg-info">Activa</span>';
                        
                        html += `
                            <tr>
                                <td>${fecha}</td>
                                <td>
                                    <strong>${sesion.nombre}</strong><br>
                                    <small class="text-muted">${sesion.codigo_sesion}</small>
                                </td>
                                <td>${estadoBadge}</td>
                                <td class="text-center">${sesion.total_iniciativas || 0}</td>
                                <td>
                                    <small>
                                        <span class="text-success">✓ ${sesion.aprobadas || 0}</span> | 
                                        <span class="text-danger">✗ ${sesion.rechazadas || 0}</span>
                                    </small>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="consultarDocumentoPDF('${sesion.archivo_pdf}')">
                                        <i class="fas fa-file-pdf"></i> Ver PDF
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error cargando sesiones con documentos:', error);
                document.getElementById('sesionesDocumentosList').innerHTML = 
                    '<p class="text-danger text-center">Error al cargar sesiones con documentos</p>';
            }
        }
        
        // Función para consultar documento PDF
        function consultarDocumentoPDF(archivo) {
            if (archivo) {
                window.open(`/documentos-sesion/${archivo}`, '_blank');
            } else {
                alert('No hay documento PDF disponible');
            }
        }
        
        // Función para notificar a la mesa directiva
        async function notificarMesaDirectiva() {
            try {
                const response = await fetch('/api/operador/notificar-mesa-directiva', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Mostrar notificación de éxito
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <strong>✅ Notificación enviada</strong><br>
                        Se notificó al presidente y secretarios que hay ${data.totalIniciativas} iniciativas listas.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    // Deshabilitar el botón temporalmente
                    const btn = event.target;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-check"></i> Notificación Enviada';
                    
                    setTimeout(() => {
                        alertDiv.remove();
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-bell"></i> Notificar Mesa Directiva - Sesión Lista';
                    }, 5000);
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'No se pudo enviar la notificación'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al enviar la notificación');
            }
        }
        
        // Variables para paginación
        let sesionesPendientesData = [];
        let paginaActualSesiones = 1;
        const sesionesPerPage = 5;
        
        // Cargar sesiones pendientes
        async function loadSesionesPendientes() {
            try {
                const response = await fetch('/api/operador/sesiones-pendientes', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    sesionesPendientesData = data.sesiones || [];
                    paginaActualSesiones = 1;
                    renderSesionesPendientesPaginadas();
                }
            } catch (error) {
                console.error('Error cargando sesiones pendientes:', error);
                document.getElementById('sesionesPendientesList').innerHTML = 
                    '<p class="text-danger text-center">Error al cargar sesiones pendientes</p>';
            }
        }
        
        // Renderizar sesiones pendientes con paginación
        function renderSesionesPendientesPaginadas() {
            const container = document.getElementById('sesionesPendientesList');
            const paginacionDiv = document.getElementById('paginacionSesiones');
            
            if (!sesionesPendientesData || sesionesPendientesData.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No hay sesiones pendientes</p>';
                paginacionDiv.style.display = 'none';
                return;
            }
            
            // Calcular páginas
            const totalPages = Math.ceil(sesionesPendientesData.length / sesionesPerPage);
            const startIndex = (paginaActualSesiones - 1) * sesionesPerPage;
            const endIndex = Math.min(startIndex + sesionesPerPage, sesionesPendientesData.length);
            const sesionesPagina = sesionesPendientesData.slice(startIndex, endIndex);
            
            // Actualizar rango mostrado
            document.getElementById('showingRange').textContent = `${startIndex + 1}-${endIndex}`;
            document.getElementById('totalSesiones').textContent = sesionesPendientesData.length;
            
            // Renderizar sesiones de la página actual
            container.innerHTML = sesionesPagina.map(sesion => {
                let tipoLabel = '';
                let borderColor = '';
                let descripcion = '';
                
                if (sesion.estado === 'indefinida') {
                    tipoLabel = '<span class="badge bg-secondary"><i class="fas fa-question-circle"></i> Fecha Indefinida</span>';
                    borderColor = 'secondary';
                    descripcion = '<br><small class="text-warning"><i class="fas fa-info-circle"></i> Sin fecha definida - Puede activarse cuando se requiera</small>';
                } else if (sesion.estado === 'programada') {
                    const fechaProg = new Date(sesion.fecha_programada);
                    tipoLabel = `<span class="badge bg-info"><i class="fas fa-calendar"></i> Programada: ${fechaProg.toLocaleString('es-MX')}</span>`;
                    borderColor = 'info';
                    descripcion = `<br><small class="text-info"><i class="fas fa-clock"></i> Se activará automáticamente el ${fechaProg.toLocaleDateString('es-MX')}</small>`;
                } else {
                    tipoLabel = '<span class="badge bg-warning"><i class="fas fa-check"></i> Preparada</span>';
                    borderColor = 'warning';
                    descripcion = '<br><small class="text-success"><i class="fas fa-check-circle"></i> Lista para activar</small>';
                }
                
                const fechaCreacion = new Date(sesion.fecha).toLocaleDateString('es-MX');
                const nombreEscapado = sesion.nombre.replace(/'/g, "\\'");
                
                // Badge del creador
                const creadorBadge = sesion.creado_por_nombre ? 
                    `<span class="badge ${sesion.creado_por_role === 'servicios_legislativos' ? 'bg-purple' : 'bg-dark'}">
                        <i class="fas fa-user"></i> ${sesion.creado_por_role === 'servicios_legislativos' ? 'Servicios' : 'Operador'}
                    </span>` : '';
                
                // Badge de origen
                const origenBadge = sesion.origen_tabla === 'sesion_precargada' ? 
                    '<span class="badge bg-info ms-1"><i class="fas fa-database"></i> Precargada</span>' : '';
                
                return `
                    <div class="card mb-2 border-start border-4 border-${borderColor}">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${sesion.nombre} ${creadorBadge} ${origenBadge}</h6>
                                    <div class="mb-2">
                                        ${tipoLabel}
                                        <span class="badge bg-light text-dark"><i class="fas fa-file-alt"></i> ${sesion.total_iniciativas || 0} iniciativas</span>
                                    </div>
                                    <small class="text-muted">Código: <code>${sesion.codigo_sesion || 'SES-' + sesion.id}</code></small><br>
                                    <small class="text-muted">Creada: ${fechaCreacion} ${sesion.creado_por_nombre ? `por ${sesion.creado_por_nombre}` : ''}</small>
                                    ${descripcion}
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-info" 
                                            onclick="editarIniciativasSesion(${sesion.id}, '${nombreEscapado}', '${sesion.origen_tabla}')"
                                            title="Ver y editar las iniciativas de esta sesión">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-success" 
                                            onclick="activarSesionPendiente(${sesion.id}, '${nombreEscapado}', '${sesion.origen_tabla}')"
                                            title="Activar esta sesión para que el presidente pueda iniciarla">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" 
                                            onclick="eliminarSesionPendiente(${sesion.id}, '${nombreEscapado}', '${sesion.origen_tabla}')"
                                            title="Eliminar esta sesión">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Renderizar controles de paginación
            renderPaginacionSesiones(totalPages);
            paginacionDiv.style.display = sesionesPendientesData.length > sesionesPerPage ? 'flex' : 'none';
        }
        
        // Renderizar controles de paginación
        function renderPaginacionSesiones(totalPages) {
            const paginationControls = document.getElementById('paginationControls');
            let html = '';
            
            // Botón anterior
            html += `
                <li class="page-item ${paginaActualSesiones === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="cambiarPaginaSesiones(${paginaActualSesiones - 1}); return false;">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= paginaActualSesiones - 1 && i <= paginaActualSesiones + 1)) {
                    html += `
                        <li class="page-item ${i === paginaActualSesiones ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="cambiarPaginaSesiones(${i}); return false;">${i}</a>
                        </li>
                    `;
                } else if (i === paginaActualSesiones - 2 || i === paginaActualSesiones + 2) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            // Botón siguiente
            html += `
                <li class="page-item ${paginaActualSesiones === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="cambiarPaginaSesiones(${paginaActualSesiones + 1}); return false;">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
            
            paginationControls.innerHTML = html;
        }
        
        // Cambiar página
        function cambiarPaginaSesiones(pagina) {
            const totalPages = Math.ceil(sesionesPendientesData.length / sesionesPerPage);
            if (pagina < 1 || pagina > totalPages) return;
            paginaActualSesiones = pagina;
            renderSesionesPendientesPaginadas();
        }
        
        // Eliminar sesión pendiente
        async function eliminarSesionPendiente(sesionId, nombre) {
            if (!confirm(`¿Eliminar la sesión "${nombre}"?\n\nEsta acción eliminará permanentemente la sesión y todas sus iniciativas.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/operador/sesion/${sesionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    // Mostrar mensaje de éxito
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <strong>✅ Sesión eliminada</strong><br>
                        La sesión "${nombre}" ha sido eliminada correctamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    setTimeout(() => alertDiv.remove(), 5000);
                    
                    // Recargar lista
                    loadSesionesPendientes();
                } else {
                    const data = await response.json();
                    alert('Error al eliminar la sesión: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar la sesión');
            }
        }
        
        // Activar sesión pendiente
        async function activarSesionPendiente(sesionId, nombre, origenTabla = 'sesion') {
            if (!confirm(`¿Activar la sesión "${nombre}"?\n\nEsto desactivará cualquier otra sesión activa y permitirá al presidente iniciar esta sesión inmediatamente.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/operador/activar-sesion-pendiente/${sesionId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ origen_tabla: origenTabla })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('✅ Sesión activada correctamente\n\nEl presidente ya puede iniciar la sesión desde su panel de control.');
                    // Recargar todas las secciones
                    loadSesionesPendientes();
                    loadActiveSession();
                    loadEstadisticasSesiones();
                } else {
                    alert('❌ ' + (data.error || 'Error al activar la sesión'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('❌ Error al activar la sesión');
            }
        }
        
        // Variables para edición de iniciativas
        let sesionEditandoId = null;
        let sesionEditandoOrigen = 'sesion';
        let iniciativasEditando = [];
        
        // Editar iniciativas de sesión
        async function editarIniciativasSesion(sesionId, nombreSesion, origenTabla = 'sesion') {
            sesionEditandoId = sesionId;
            sesionEditandoOrigen = origenTabla; // Guardar el origen
            document.getElementById('sesionNombreEdit').textContent = nombreSesion;
            
            try {
                const endpoint = origenTabla === 'sesion_precargada' 
                    ? `/api/operador/sesion-precargada/${sesionId}/iniciativas`
                    : `/api/operador/sesion/${sesionId}/iniciativas`;
                    
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    iniciativasEditando = data.iniciativas || [];
                    renderIniciativasEdit();
                    
                    const modal = new bootstrap.Modal(document.getElementById('editarIniciativasModal'));
                    modal.show();
                } else {
                    alert('Error al cargar las iniciativas');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar las iniciativas');
            }
        }
        
        // Renderizar iniciativas para edición
        function renderIniciativasEdit() {
            const tbody = document.getElementById('iniciativasEditList');
            
            if (iniciativasEditando.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay iniciativas en esta sesión</td></tr>';
                return;
            }
            
            tbody.innerHTML = iniciativasEditando.map((iniciativa, index) => `
                <tr>
                    <td>${iniciativa.numero || index + 1}</td>
                    <td>
                        <input type="text" class="form-control form-control-sm" 
                               value="${iniciativa.titulo || ''}" 
                               onchange="actualizarIniciativa(${index}, 'titulo', this.value)">
                    </td>
                    <td>
                        <textarea class="form-control form-control-sm" rows="2"
                                  onchange="actualizarIniciativa(${index}, 'descripcion', this.value)">${iniciativa.descripcion || ''}</textarea>
                    </td>
                    <td>
                        <select class="form-select form-select-sm" 
                                onchange="actualizarIniciativa(${index}, 'tipo_mayoria', this.value)">
                            <option value="simple" ${iniciativa.tipo_mayoria === 'simple' ? 'selected' : ''}>Simple</option>
                            <option value="absoluta" ${iniciativa.tipo_mayoria === 'absoluta' ? 'selected' : ''}>Absoluta</option>
                            <option value="calificada" ${iniciativa.tipo_mayoria === 'calificada' ? 'selected' : ''}>Calificada</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="eliminarIniciativa(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Actualizar iniciativa
        function actualizarIniciativa(index, campo, valor) {
            iniciativasEditando[index][campo] = valor;
        }
        
        // Eliminar iniciativa
        function eliminarIniciativa(index) {
            if (confirm('¿Eliminar esta iniciativa?')) {
                iniciativasEditando.splice(index, 1);
                renderIniciativasEdit();
            }
        }
        
        // Agregar nueva iniciativa
        function agregarNuevaIniciativa() {
            const nuevaIniciativa = {
                numero: iniciativasEditando.length + 1,
                titulo: '',
                descripcion: '',
                tipo_mayoria: 'simple'
            };
            iniciativasEditando.push(nuevaIniciativa);
            renderIniciativasEdit();
        }
        
        // Guardar cambios en las iniciativas
        async function guardarCambiosIniciativas() {
            if (!sesionEditandoId) return;
            
            try {
                const endpoint = sesionEditandoOrigen === 'sesion_precargada' 
                    ? `/api/operador/sesion-precargada/${sesionEditandoId}/iniciativas`
                    : `/api/operador/sesion/${sesionEditandoId}/iniciativas`;
                    
                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ iniciativas: iniciativasEditando })
                });
                
                if (response.ok) {
                    alert('✅ Iniciativas actualizadas correctamente');
                    bootstrap.Modal.getInstance(document.getElementById('editarIniciativasModal')).hide();
                    loadSesionesPendientes();
                } else {
                    const data = await response.json();
                    alert('❌ ' + (data.error || 'Error al guardar los cambios'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('❌ Error al guardar los cambios');
            }
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }
        
        // Función para exportar resultados
        async function exportarResultados(formato) {
            const sesionActiva = sessionData?.id;
            
            if (!sesionActiva) {
                alert('No hay sesión activa para exportar');
                return;
            }
            
            // Mostrar estado de descarga
            const statusDiv = document.getElementById('exportStatus');
            statusDiv.innerHTML = `<div class="alert alert-info p-2">
                <i class="fas fa-spinner fa-spin"></i> Generando ${formato.toUpperCase()}...
            </div>`;
            
            try {
                const response = await fetch(`/api/exportar/${formato}/${sesionActiva}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al generar el archivo');
                }
                
                // Obtener el blob del archivo
                const blob = await response.blob();
                
                // Crear URL temporal para descarga
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // Nombre del archivo basado en formato y fecha
                const fecha = new Date().toISOString().split('T')[0];
                const extension = formato === 'excel' ? 'xlsx' : formato === 'word' ? 'docx' : 'pdf';
                a.download = `sesion_${sessionData.codigo_sesion}_${fecha}.${extension}`;
                
                // Descargar archivo
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Limpiar URL temporal
                window.URL.revokeObjectURL(url);
                
                // Mostrar éxito
                statusDiv.innerHTML = `<div class="alert alert-success p-2">
                    <i class="fas fa-check"></i> ${formato.toUpperCase()} descargado
                </div>`;
                
                // Limpiar mensaje después de 3 segundos
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
                
            } catch (error) {
                console.error('Error exportando:', error);
                statusDiv.innerHTML = `<div class="alert alert-danger p-2">
                    <i class="fas fa-times"></i> Error al generar ${formato.toUpperCase()}
                </div>`;
            }
        }
        
        // Abrir pantalla según tipo
        function abrirPantalla(tipo) {
            const width = 774;
            const height = 518;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            // Opciones para ventana tipo popup minimalista
            const windowFeatures = [
                `width=${width}`,
                `height=${height}`,
                `left=${left}`,
                `top=${top}`,
                'resizable=yes',
                'scrollbars=no',
                'toolbar=no',
                'menubar=no',
                'location=no',  // Intenta ocultar barra de dirección (limitado por navegador)
                'directories=no',
                'status=no',
                'titlebar=yes',
                'popup=yes'     // Modo popup para aspecto más limpio
            ].join(',');
            
            let url = '/pantalla';
            let windowName = 'PantallaPublica';
            
            if (tipo === 'asistencia') {
                url = '/pantalla-asistencia';
                windowName = 'PantallaAsistencia';
            }
            
            const ventana = window.open(url, windowName, windowFeatures);
            
            // Intentar modo pantalla completa automáticamente (requiere interacción del usuario)
            if (ventana) {
                ventana.focus();
                // Sugerir pantalla completa después de cargar
                setTimeout(() => {
                    if (ventana && !ventana.closed) {
                        ventana.postMessage({ action: 'suggestFullscreen' }, '*');
                    }
                }, 1000);
            }
            
            event.preventDefault();
        }
        
        // Función para actualizar URL personalizada basada en opciones (definida primero)
        function actualizarURLPersonalizada() {
            const params = [];
            const resolution = document.getElementById('obsResolution').value;
            
            if (resolution === 'custom') {
                const width = document.getElementById('obsWidth').value;
                const height = document.getElementById('obsHeight').value;
                if (width) params.push(`width=${width}`);
                if (height) params.push(`height=${height}`);
            } else if (resolution) {
                const [width, height] = resolution.split('x');
                params.push(`width=${width}`, `height=${height}`);
            }
            
            if (!document.getElementById('obsHeader').checked) params.push('header=false');
            if (!document.getElementById('obsSidebar').checked) params.push('sidebar=false');
            if (document.getElementById('obsTransparent').checked) params.push('transparent=true');
            if (document.getElementById('obsMinimal').checked) params.push('minimal=true');
            
            const baseURL = window.location.origin + (currentScreenType === 'asistencia' ? '/pantalla-asistencia' : '/pantalla');
            const fullURL = params.length > 0 ? `${baseURL}?${params.join('&')}` : baseURL;
            document.getElementById('obsCustomURL').value = fullURL;
        }
        
        // Función para mostrar opciones OBS
        function mostrarOpcionesOBS(tipo) {
            currentScreenType = tipo || 'votacion';
            const modal = new bootstrap.Modal(document.getElementById('obsModal'));
            
            // Actualizar el título del modal según el tipo
            const modalTitle = document.querySelector('#obsModal .modal-title');
            if (modalTitle) {
                modalTitle.innerHTML = `<i class="fas fa-video"></i> Configuración OBS/Streaming - ${tipo === 'asistencia' ? 'Asistencia' : 'Votación'}`;
            }
            
            // Actualizar los modos predefinidos según el tipo
            actualizarModosOBS(tipo);
            actualizarURLPersonalizada();
            modal.show();
            event.preventDefault();
        }
        
        // Función para actualizar los modos predefinidos de OBS
        function actualizarModosOBS(tipo) {
            const container = document.getElementById('obsPresetModes');
            let modos = [];
            
            if (tipo === 'asistencia') {
                modos = [
                    { url: '/pantalla-asistencia', titulo: 'Modo Normal', desc: 'Vista completa de asistencia' },
                    { url: '/pantalla-asistencia?obs=true&transparent=true', titulo: 'Fondo Transparente', desc: 'Para superponer sobre otros elementos' },
                    { url: '/pantalla-asistencia?chromakey=true', titulo: 'Chromakey (Verde)', desc: 'Fondo verde para eliminación por color' },
                    { url: '/pantalla-asistencia?minimal=true', titulo: 'Modo Minimalista', desc: 'Vista simplificada de asistencia' },
                    { url: '/pantalla-asistencia?header=false', titulo: 'Sin Encabezado', desc: 'Oculta el título y encabezado' }
                ];
            } else {
                modos = [
                    { url: '/pantalla', titulo: 'Modo Normal', desc: 'Vista completa con todos los elementos' },
                    { url: '/pantalla?obs=true&transparent=true', titulo: 'Fondo Transparente', desc: 'Para superponer sobre otros elementos' },
                    { url: '/pantalla?chromakey=true', titulo: 'Chromakey (Verde)', desc: 'Fondo verde para eliminación por color' },
                    { url: '/pantalla?voting-only=true', titulo: 'Solo Votación', desc: 'Muestra únicamente la tabla de votación' },
                    { url: '/pantalla?results-only=true', titulo: 'Solo Resultados', desc: 'Panel de resumen únicamente' }
                ];
            }
            
            container.innerHTML = modos.map(modo => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${modo.titulo}</strong>
                            <small class="d-block text-muted">${modo.desc}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="copiarURL('${modo.url}'); return false;">
                            <i class="fas fa-copy"></i> Copiar URL
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Copiar URL al portapapeles
        function copiarURL(path) {
            // Si el path contiene 'asistencia', usar la ruta correcta
            if (path.includes('asistencia') && !path.includes('pantalla-asistencia')) {
                path = path.replace('/pantalla', '/pantalla-asistencia');
            }
            const url = window.location.origin + path;
            
            // Usar la API del portapapeles con manejo de errores
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('✅ URL copiada al portapapeles', 'success');
                }).catch(err => {
                    console.error('Error al copiar:', err);
                    // Fallback al método tradicional
                    copiarConFallback(url);
                });
            } else {
                // Fallback para navegadores sin soporte de clipboard API
                copiarConFallback(url);
            }
            
            if (event) event.preventDefault();
            return false;
        }
        
        // Fallback para copiar al portapapeles
        function copiarConFallback(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification('✅ URL copiada al portapapeles', 'success');
            } catch (err) {
                console.error('Error al copiar:', err);
                prompt('Copia esta URL manualmente:', text);
            }
            document.body.removeChild(textArea);
        }
        
        function copiarCustomURL() {
            const url = document.getElementById('obsCustomURL').value;
            if (!url) {
                showNotification('⚠️ No hay URL para copiar', 'warning');
                return;
            }
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('✅ URL personalizada copiada', 'success');
                }).catch(err => {
                    console.error('Error al copiar:', err);
                    copiarConFallback(url);
                });
            } else {
                copiarConFallback(url);
            }
        }
        
        // Abrir vista previa OBS
        function abrirPantallaOBS() {
            const url = document.getElementById('obsCustomURL').value;
            window.open(url, '_blank');
        }
        
        // Actualizar URL personalizada cuando cambian las opciones
        function actualizarURLPersonalizada() {
            if (!currentScreenType) return;
            
            const baseURL = currentScreenType === 'asistencia' ? '/pantalla-asistencia' : '/pantalla';
            const params = [];
            
            // Obtener configuración
            const resolution = document.getElementById('obsResolution')?.value;
            const width = document.getElementById('obsWidth')?.value;
            const height = document.getElementById('obsHeight')?.value;
            const header = document.getElementById('obsHeader')?.checked;
            const sidebar = document.getElementById('obsSidebar')?.checked;
            const transparent = document.getElementById('obsTransparent')?.checked;
            const minimal = document.getElementById('obsMinimal')?.checked;
            
            // Agregar parámetros según configuración
            if (resolution && resolution !== '' && resolution !== 'custom') {
                const [w, h] = resolution.split('x');
                params.push(`width=${w}`);
                params.push(`height=${h}`);
            } else if (resolution === 'custom' && width && height) {
                params.push(`width=${width}`);
                params.push(`height=${height}`);
            }
            
            if (!header) params.push('header=false');
            if (!sidebar) params.push('sidebar=false');
            if (transparent) params.push('transparent=true');
            if (minimal) params.push('minimal=true');
            params.push('obs=true');
            
            const url = `${window.location.origin}${baseURL}${params.length > 0 ? '?' + params.join('&') : ''}`;
            const customURLInput = document.getElementById('obsCustomURL');
            if (customURLInput) {
                customURLInput.value = url;
            }
        }
        
        // Event listeners para actualización de URL
        document.addEventListener('DOMContentLoaded', () => {
            // Listeners para actualización automática de URL
            ['obsResolution', 'obsWidth', 'obsHeight', 'obsHeader', 'obsSidebar', 'obsTransparent', 'obsMinimal'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', actualizarURLPersonalizada);
                    if (id === 'obsWidth' || id === 'obsHeight') {
                        element.addEventListener('input', actualizarURLPersonalizada);
                    }
                }
            });
            
            // Habilitar campos de resolución personalizada
            const resolutionSelect = document.getElementById('obsResolution');
            if (resolutionSelect) {
                resolutionSelect.addEventListener('change', function() {
                    const isCustom = this.value === 'custom';
                    document.getElementById('obsWidth').disabled = !isCustom;
                    document.getElementById('obsHeight').disabled = !isCustom;
                    actualizarURLPersonalizada();
                });
            }
        });
        
        // Event listeners para actualización de URL
        // Función para cargar estado de sesión y habilitar exportación
        async function cargarEstadoSesion() {
            try {
                const response = await fetch('/api/operador/sesion-actual', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.sesion) {
                        sessionData = data.sesion;
                        
                        // Habilitar botones de exportación
                        document.getElementById('btnExportExcel').disabled = false;
                        document.getElementById('btnExportPDF').disabled = false;
                        document.getElementById('btnExportWord').disabled = false;
                        
                        // Actualizar contadores del dashboard
                        document.getElementById('votacionesActivas').textContent = data.votaciones_activas || 0;
                        document.getElementById('votacionesCompletadas').textContent = data.votaciones_completadas || 0;
                        document.getElementById('documentosPendientes').textContent = data.documentos_pendientes || 0;
                    } else {
                        // Deshabilitar botones si no hay sesión
                        document.getElementById('btnExportExcel').disabled = true;
                        document.getElementById('btnExportPDF').disabled = true;
                        document.getElementById('btnExportWord').disabled = true;
                    }
                }
            } catch (error) {
                console.error('Error cargando estado de sesión:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar estado inicial
            cargarEstadoSesion();
            
            // Actualizar cada 30 segundos
            setInterval(cargarEstadoSesion, 30000);
            const resolutionSelect = document.getElementById('obsResolution');
            if (resolutionSelect) {
                resolutionSelect.addEventListener('change', (e) => {
                    const isCustom = e.target.value === 'custom';
                    document.getElementById('obsWidth').disabled = !isCustom;
                    document.getElementById('obsHeight').disabled = !isCustom;
                    actualizarURLPersonalizada();
                });
            }
            
            ['obsWidth', 'obsHeight', 'obsHeader', 'obsSidebar', 'obsTransparent', 'obsMinimal'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', actualizarURLPersonalizada);
                    element.addEventListener('input', actualizarURLPersonalizada);
                }
            });
        });
        
        // FUNCIONES PARA INICIATIVAS EXTRAORDINARIAS
        let iniciativasExtraordinariasTemp = [];
        
        function mostrarModalExtraordinarias() {
            cargarListaDiputadosParaExtraordinarias();
            cargarNumerosDisponibles();
            const modal = new bootstrap.Modal(document.getElementById('extraordinariasModal'));
            modal.show();
        }
        
        function cargarListaDiputadosParaExtraordinarias() {
            fetch('/api/diputados')
                .then(response => response.json())
                .then(diputados => {
                    const select = document.getElementById('extPresentador');
                    select.innerHTML = '<option value="">Seleccionar diputado...</option>';
                    
                    diputados.forEach(dip => {
                        const option = document.createElement('option');
                        option.value = dip.nombre;
                        option.textContent = dip.nombre;
                        option.dataset.partido = dip.partido;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error cargando diputados:', error));
        }
        
        function cargarNumerosDisponibles() {
            fetch('/api/iniciativas')
                .then(response => response.json())
                .then(iniciativas => {
                    const select = document.getElementById('extNumero');
                    select.innerHTML = '<option value="">Seleccionar posición...</option>';
                    
                    // Agregar opciones del 1 al total de iniciativas + 5
                    const maxNum = iniciativas.length + 5;
                    for (let i = 1; i <= maxNum; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Posición ${i}`;
                        select.appendChild(option);
                    }
                })
                .catch(error => console.error('Error cargando números disponibles:', error));
        }
        
        function actualizarPartidoAutomatico() {
            const select = document.getElementById('extPresentador');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.partido) {
                document.getElementById('extPartido').value = selectedOption.dataset.partido;
            }
        }
        
        function agregarExtraordinaria() {
            const iniciativa = {
                numero: document.getElementById('extNumero').value,
                descripcion: document.getElementById('extDescripcion').value,
                presentador: document.getElementById('extPresentador').value,
                partido_presentador: document.getElementById('extPartido').value,
                tipo_mayoria: document.getElementById('extTipoMayoria').value,
                tipo_iniciativa: 'extraordinaria'
            };
            
            if (!iniciativa.numero || !iniciativa.descripcion) {
                alert('Por favor complete los campos obligatorios');
                return;
            }
            
            iniciativasExtraordinariasTemp.push(iniciativa);
            actualizarListaExtraordinarias();
            
            // Limpiar formulario
            document.getElementById('extNumero').value = '';
            document.getElementById('extDescripcion').value = '';
            document.getElementById('extPresentador').value = '';
            document.getElementById('extPartido').value = '';
            document.getElementById('extTipoMayoria').value = 'simple';
        }
        
        // Guardar sesión actual
        async function guardarSesion() {
            try {
                const response = await fetch('/api/operador/sesion-activa', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (!data.sesion) {
                    alert('No hay sesión activa para guardar');
                    return;
                }
                
                if (!data.iniciativas || data.iniciativas.length === 0) {
                    alert('No hay iniciativas para guardar');
                    return;
                }
                
                const nombreSesion = prompt('Ingrese un nombre para guardar esta sesión:', 
                    `${data.sesion.nombre} - Respaldo ${new Date().toLocaleDateString('es-MX')}`);
                
                if (!nombreSesion) return;
                
                // Guardar como sesión precargada
                const saveResponse = await fetch('/api/operador/guardar-sesion-respaldo', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sesion_id: data.sesion.id,
                        nombre: nombreSesion,
                        descripcion: `Respaldo de ${data.sesion.nombre} con ${data.iniciativas.length} iniciativas`
                    })
                });
                
                if (saveResponse.ok) {
                    const result = await saveResponse.json();
                    
                    // Mostrar mensaje de éxito
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <strong>✅ Sesión guardada</strong><br>
                        "${nombreSesion}" guardada con ${data.iniciativas.length} iniciativas.
                        <br><small>Puede recuperarla desde "Sesiones Pendientes"</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    setTimeout(() => alertDiv.remove(), 7000);
                    
                    // Actualizar lista de sesiones pendientes
                    loadSesionesPendientes();
                } else {
                    const error = await saveResponse.json();
                    alert('Error al guardar la sesión: ' + (error.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar la sesión');
            }
        }
        
        // Limpiar/Eliminar todas las iniciativas de la sesión actual
        async function limpiarSesion() {
            try {
                const response = await fetch('/api/operador/sesion-activa', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (!data.sesion) {
                    alert('No hay sesión activa');
                    return;
                }
                
                if (!data.iniciativas || data.iniciativas.length === 0) {
                    alert('No hay iniciativas para eliminar');
                    return;
                }
                
                // Verificar si hay votaciones activas o cerradas
                const votacionesActivas = data.iniciativas.filter(i => i.activa || i.cerrada);
                if (votacionesActivas.length > 0) {
                    alert('No se puede limpiar la sesión porque hay votaciones activas o cerradas.\n\n' +
                          'Por favor, finalice todas las votaciones primero.');
                    return;
                }
                
                const confirmMessage = `¿Está seguro de eliminar TODAS las iniciativas de la sesión actual?\n\n` +
                                      `Sesión: ${data.sesion.nombre}\n` +
                                      `Iniciativas a eliminar: ${data.iniciativas.length}\n\n` +
                                      `Esta acción NO se puede deshacer.`;
                
                if (!confirm(confirmMessage)) return;
                
                // Segunda confirmación para mayor seguridad
                if (!confirm('¿Está COMPLETAMENTE SEGURO? Se eliminarán todas las iniciativas.')) return;
                
                // Eliminar todas las iniciativas de la sesión
                const deleteResponse = await fetch(`/api/operador/limpiar-sesion/${data.sesion.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (deleteResponse.ok) {
                    const result = await deleteResponse.json();
                    
                    // Mostrar mensaje de éxito
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 end-0 m-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <strong>🗑️ Sesión limpiada</strong><br>
                        Se eliminaron ${result.eliminadas} iniciativas de la sesión.
                        <br><small>La sesión está lista para cargar nuevas iniciativas</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    setTimeout(() => alertDiv.remove(), 5000);
                    
                    // Recargar la sesión activa
                    loadActiveSession();
                } else {
                    const error = await deleteResponse.json();
                    alert('Error al limpiar la sesión: ' + (error.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al limpiar la sesión');
            }
        }
        
        // El formulario ya no necesita un event listener porque usamos onclick en el botón
        
        // Manejar formulario de PDF
        document.getElementById('extraordinariaPdfForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('extPdfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor selecciona un archivo PDF');
                return;
            }
            
            const formData = new FormData();
            formData.append('pdf', file);
            formData.append('tipo_iniciativa', 'extraordinaria');
            
            const numeroInicio = document.getElementById('extNumeroInicio').value;
            const numeroFin = document.getElementById('extNumeroFin').value;
            
            if (numeroInicio) formData.append('numero_inicio', numeroInicio);
            if (numeroFin) formData.append('numero_fin', numeroFin);
            
            const statusDiv = document.getElementById('pdfExtraordinariasStatus');
            statusDiv.innerHTML = '<div class="alert alert-info">Procesando PDF...</div>';
            
            try {
                const response = await fetch('/api/operador/procesar-pdf-extraordinarias', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            ✅ PDF procesado: ${data.iniciativas.length} iniciativas extraordinarias extraídas
                        </div>
                    `;
                    
                    // Agregar a la lista temporal
                    data.iniciativas.forEach(init => {
                        init.tipo_iniciativa = 'extraordinaria';
                        iniciativasExtraordinariasTemp.push(init);
                    });
                    
                    actualizarListaExtraordinarias();
                    fileInput.value = '';
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = '<div class="alert alert-danger">Error al procesar el PDF</div>';
            }
        });
        
        // Actualizar lista de iniciativas extraordinarias
        function actualizarListaExtraordinarias() {
            const lista = document.getElementById('listaExtraordinarias');
            
            if (iniciativasExtraordinariasTemp.length === 0) {
                lista.innerHTML = '<p class="text-muted">No hay iniciativas extraordinarias agregadas</p>';
                return;
            }
            
            lista.innerHTML = iniciativasExtraordinariasTemp.map((init, index) => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${init.numero}. ${init.titulo}</strong>
                            <small class="text-muted d-block">
                                ${init.presentador || 'Sin presentador'} 
                                ${init.partido_presentador ? `(${init.partido_presentador})` : ''}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="eliminarExtraordinariaTemporal(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Eliminar iniciativa extraordinaria temporal
        function eliminarExtraordinariaTemporal(index) {
            iniciativasExtraordinariasTemp.splice(index, 1);
            actualizarListaExtraordinarias();
        }
        
        // Guardar todas las iniciativas extraordinarias
        async function guardarTodasExtraordinarias() {
            if (iniciativasExtraordinariasTemp.length === 0) {
                alert('No hay iniciativas extraordinarias para guardar');
                return;
            }
            
            try {
                const response = await fetch('/api/operador/guardar-extraordinarias', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        iniciativas: iniciativasExtraordinariasTemp
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`✅ ${data.guardadas} iniciativas extraordinarias guardadas exitosamente`);
                    
                    // Limpiar lista temporal
                    iniciativasExtraordinariasTemp = [];
                    actualizarListaExtraordinarias();
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('extraordinariasModal')).hide();
                    
                    // Recargar lista de iniciativas
                    loadActiveSession();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar las iniciativas extraordinarias');
            }
        }
        
        // Verificar si hay sesiones precargadas
        async function verificarSesionesPrecargadas() {
            try {
                const response = await fetch('/api/operador/sesiones-precargadas/disponibles', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.sesiones && data.sesiones.length > 0) {
                    document.getElementById('sesionesPrecargadasAlert').style.display = 'block';
                    document.getElementById('countSesionesPrecargadas').textContent = data.sesiones.length;
                } else {
                    document.getElementById('sesionesPrecargadasAlert').style.display = 'none';
                }
            } catch (error) {
                console.error('Error verificando sesiones precargadas:', error);
            }
        }
        
        // Ver sesiones precargadas
        async function verSesionesPrecargadas() {
            try {
                const response = await fetch('/api/operador/sesiones-precargadas/disponibles', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.sesiones && data.sesiones.length > 0) {
                    mostrarModalSesionesPrecargadas(data.sesiones);
                } else {
                    alert('No hay sesiones precargadas disponibles');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar sesiones precargadas');
            }
        }
        
        // Mostrar modal con sesiones precargadas
        function mostrarModalSesionesPrecargadas(sesiones) {
            const modalBody = document.getElementById('listaSesionesPrecargadas');
            
            modalBody.innerHTML = sesiones.map(sesion => `
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">${sesion.nombre_sesion}</h6>
                                <small class="text-muted">
                                    ${new Date(sesion.fecha_sesion).toLocaleDateString('es-MX')} | 
                                    ${sesion.iniciativas_count} iniciativas
                                </small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-info" onclick="verDetalleSesionPrecargada(${sesion.id})">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="usarSesionPrecargada(${sesion.id})">
                                    <i class="fas fa-check"></i> Usar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" id="detalleSesion${sesion.id}" style="display:none;">
                        <!-- Aquí se cargarán los detalles -->
                    </div>
                </div>
            `).join('');
            
            const modal = new bootstrap.Modal(document.getElementById('sesionesPrecargadasModal'));
            modal.show();
        }
        
        // Ver detalle de sesión precargada
        async function verDetalleSesionPrecargada(sesionId) {
            const detalleDiv = document.getElementById(`detalleSesion${sesionId}`);
            
            if (detalleDiv.style.display === 'block') {
                detalleDiv.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/operador/sesiones-precargadas/${sesionId}/iniciativas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const iniciativas = await response.json();
                
                detalleDiv.innerHTML = `
                    <h6>Iniciativas:</h6>
                    <div class="list-group">
                        ${iniciativas.map(init => `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>${init.numero}. ${init.titulo}</strong>
                                        <p class="mb-1 small">${init.descripcion || 'Sin descripción'}</p>
                                        ${init.presentador ? `
                                            <small class="text-muted">
                                                Presentador: ${init.presentador} 
                                                ${init.partido_presentador ? `(${init.partido_presentador})` : ''}
                                            </small>
                                        ` : ''}
                                    </div>
                                    <span class="badge bg-secondary">${init.tipo_mayoria || 'Simple'}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                detalleDiv.style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar detalles de la sesión');
            }
        }
        
        // Usar sesión precargada
        async function usarSesionPrecargada(sesionId) {
            if (!confirm('¿Desea cargar esta sesión precargada? Esto reemplazará cualquier sesión activa actual.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/operador/cargar-sesion-precargada/${sesionId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('✅ Sesión cargada exitosamente');
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('sesionesPrecargadasModal')).hide();
                    
                    // Recargar sesión activa
                    loadActiveSession();
                    
                    // Ocultar alerta de sesiones precargadas
                    document.getElementById('sesionesPrecargadasAlert').style.display = 'none';
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar la sesión precargada');
            }
        }
        
        // Verificar sesiones precargadas al cargar la página
        verificarSesionesPrecargadas();
    </script>
    
    <!-- Modal de Validación de PDF -->
    <div class="modal fade" id="modalValidacion" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle"></i> Validación de Iniciativas
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Estadísticas -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="card bg-info text-white" style="cursor: pointer;" onclick="filtrarIniciativas('todas')">
                                <div class="card-body p-2 text-center">
                                    <h6>Total Iniciativas</h6>
                                    <h3 id="totalIniciativas">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white" style="cursor: pointer;" onclick="filtrarIniciativas('votacion')">
                                <div class="card-body p-2 text-center">
                                    <h6>Requieren Votación</h6>
                                    <h3 id="requierenVotacion">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white" style="cursor: pointer;" onclick="filtrarIniciativas('comisiones')">
                                <div class="card-body p-2 text-center">
                                    <h6>A Comisiones</h6>
                                    <h3 id="aComisiones">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-secondary text-white" style="cursor: pointer;" onclick="filtrarIniciativas('otros')">
                                <div class="card-body p-2 text-center">
                                    <h6>Otros</h6>
                                    <h3 id="otros">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtro activo -->
                    <div id="filtroActivo" class="alert alert-info mb-2" style="display: none;">
                        <i class="fas fa-filter"></i> Filtro activo: <strong id="textoFiltro">Todas</strong>
                        <button class="btn btn-sm btn-light float-end" onclick="filtrarIniciativas('todas')">
                            <i class="fas fa-times"></i> Limpiar filtro
                        </button>
                    </div>
                    
                    <!-- Tipo de Carga -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tipo de Carga:</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoCargaValidacion" id="cargaInmediataVal" value="inmediata" checked>
                            <label class="form-check-label" for="cargaInmediataVal">
                                <i class="fas fa-play"></i> Sesión Inmediata
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoCargaValidacion" id="cargaProgramadaVal" value="programada">
                            <label class="form-check-label" for="cargaProgramadaVal">
                                <i class="fas fa-calendar"></i> Sesión Programada
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoCargaValidacion" id="cargaIndefinidaVal" value="indefinida">
                            <label class="form-check-label" for="cargaIndefinidaVal">
                                <i class="fas fa-question"></i> Fecha Indefinida
                            </label>
                        </div>
                        
                        <div id="fechaProgramadaVal" style="display: none;" class="mt-2">
                            <label for="fechaSesionVal" class="form-label">Fecha y Hora de la Sesión:</label>
                            <input type="datetime-local" class="form-control" id="fechaSesionVal">
                        </div>
                    </div>
                    
                    <!-- Controles de selección -->
                    <div class="mb-2 d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-sm btn-outline-success" onclick="seleccionarTodasVotables()">
                                <i class="fas fa-check-square"></i> Seleccionar Votables
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="seleccionarTodas()">
                                <i class="fas fa-check-double"></i> Seleccionar Todas
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="deseleccionarTodas()">
                                <i class="fas fa-times"></i> Quitar Selección
                            </button>
                        </div>
                        <div>
                            <span class="badge bg-primary">
                                <span id="contadorSeleccionadas">0</span> seleccionadas
                            </span>
                        </div>
                    </div>
                    
                    <!-- Tabla de Iniciativas -->
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover table-sm">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" title="Seleccionar todas">
                                    </th>
                                    <th width="80">Núm.</th>
                                    <th width="80">Orden</th>
                                    <th>Título</th>
                                    <th width="150">Presentador</th>
                                    <th width="100">Partido</th>
                                    <th width="100">Mayoría</th>
                                    <th width="80">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaValidacion">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cancelarValidacion()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" onclick="mostrarVistaPrevia()">
                        <i class="fas fa-eye"></i> Vista Previa
                    </button>
                    <button type="button" class="btn btn-primary" id="btnGuardarValidacion">
                        <i class="fas fa-save"></i> Confirmar y Cargar Iniciativas
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Edición de Iniciativa -->
    <div class="modal fade" id="modalEditarIniciativa" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Iniciativa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarIniciativa">
                        <input type="hidden" id="editNumeroSistema">
                        
                        <div class="mb-3">
                            <label class="form-label">Número Orden del Día:</label>
                            <input type="number" class="form-control" id="editNumeroOrden" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Título:</label>
                            <textarea class="form-control" id="editTitulo" rows="2" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Descripción:</label>
                            <textarea class="form-control" id="editDescripcion" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Presentador:</label>
                            <input type="text" class="form-control" id="editPresentador">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Partido:</label>
                            <input type="text" class="form-control" id="editPartido">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Tipo de Mayoría:</label>
                            <select class="form-select" id="editTipoMayoria">
                                <option value="simple">Simple</option>
                                <option value="calificada">Calificada</option>
                                <option value="especial">Especial</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarEdicionIniciativa()">Guardar</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Variables para validación
        let sessionIdActual = null;
        let iniciativasValidacion = [];
        let iniciativasOriginales = []; // Copia para restaurar
        let filtroActual = 'todas';
        
        // Función para filtrar iniciativas
        function filtrarIniciativas(tipo) {
            filtroActual = tipo;
            const filtroDiv = document.getElementById('filtroActivo');
            const tbody = document.getElementById('tablaValidacion');
            
            let iniciativasFiltradas = [...iniciativasValidacion];
            let textoFiltro = 'Todas';
            
            switch(tipo) {
                case 'votacion':
                    iniciativasFiltradas = iniciativasValidacion.filter(i => i.requiere_votacion);
                    textoFiltro = 'Requieren Votación';
                    break;
                case 'comisiones':
                    iniciativasFiltradas = iniciativasValidacion.filter(i => 
                        i.tipo_votacion && i.tipo_votacion.toLowerCase().includes('comisión'));
                    textoFiltro = 'A Comisiones';
                    break;
                case 'otros':
                    iniciativasFiltradas = iniciativasValidacion.filter(i => 
                        !i.requiere_votacion && 
                        (!i.tipo_votacion || !i.tipo_votacion.toLowerCase().includes('comisión')));
                    textoFiltro = 'Otros';
                    break;
                case 'todas':
                default:
                    filtroDiv.style.display = 'none';
                    break;
            }
            
            if (tipo !== 'todas') {
                filtroDiv.style.display = 'block';
                document.getElementById('textoFiltro').textContent = textoFiltro;
            }
            
            renderizarTablaValidacion(iniciativasFiltradas);
        }
        
        // Función para renderizar tabla
        function renderizarTablaValidacion(iniciativas) {
            const tbody = document.getElementById('tablaValidacion');
            tbody.innerHTML = '';
            
            iniciativas.forEach((init) => {
                const index = iniciativasValidacion.indexOf(init);
                const tr = document.createElement('tr');
                
                // Determinar si requiere votación
                const requiereVotacion = init.requiere_votacion || false;
                
                // Estilo de fila para iniciativas que requieren votación
                if (requiereVotacion) {
                    tr.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
                }
                
                // Verificar si está seleccionada
                const isSelected = init.seleccionada || false;
                
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" 
                               class="form-check-input iniciativa-checkbox" 
                               data-index="${index}"
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleIniciativaSeleccion(${index})">
                    </td>
                    <td>
                        ${requiereVotacion ? '<i class="fas fa-vote-yea text-success me-1" title="Requiere votación"></i>' : ''}
                        <strong>${init.numero_sistema}</strong>
                    </td>
                    <td>${init.numero_orden_dia || '-'}</td>
                    <td>${init.titulo || 'Sin título'}</td>
                    <td>${init.presentador || '-'}</td>
                    <td>${init.partido || '-'}</td>
                    <td>
                        <span class="badge bg-${init.tipo_mayoria === 'calificada' ? 'warning' : 'secondary'}">
                            ${init.tipo_mayoria || 'simple'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" 
                                    onclick="editarIniciativaValidacion(${index})"
                                    title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" 
                                    onclick="eliminarIniciativaValidacion(${index})"
                                    title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            if (iniciativas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            No hay iniciativas ${filtroActual !== 'todas' ? 'en este filtro' : ''}
                        </td>
                    </tr>
                `;
            }
            
            actualizarContadorSeleccionadas();
        }
        
        // Función para eliminar iniciativa en validación
        function eliminarIniciativaValidacion(index) {
            if (!confirm('¿Eliminar esta iniciativa? No se importará a la sesión.')) return;
            
            // Eliminar de la lista
            iniciativasValidacion.splice(index, 1);
            
            // Actualizar estadísticas
            actualizarEstadisticasValidacion();
            
            // Re-renderizar tabla con filtro actual
            if (filtroActual !== 'todas') {
                filtrarIniciativas(filtroActual);
            } else {
                renderizarTablaValidacion(iniciativasValidacion);
            }
        }
        
        // Función para actualizar estadísticas
        function actualizarEstadisticasValidacion() {
            document.getElementById('totalIniciativas').textContent = iniciativasValidacion.length;
            
            const requierenVot = iniciativasValidacion.filter(i => i.requiere_votacion).length;
            document.getElementById('requierenVotacion').textContent = requierenVot;
            
            const aComision = iniciativasValidacion.filter(i => 
                i.tipo_votacion && i.tipo_votacion.toLowerCase().includes('comisión')).length;
            document.getElementById('aComisiones').textContent = aComision;
            
            document.getElementById('otros').textContent = 
                iniciativasValidacion.length - requierenVot - aComision;
        }
        
        // Funciones de selección de iniciativas
        function toggleIniciativaSeleccion(index) {
            iniciativasValidacion[index].seleccionada = !iniciativasValidacion[index].seleccionada;
            actualizarContadorSeleccionadas();
        }
        
        function actualizarContadorSeleccionadas() {
            const seleccionadas = iniciativasValidacion.filter(i => i.seleccionada).length;
            document.getElementById('contadorSeleccionadas').textContent = seleccionadas;
            
            // Actualizar estado del checkbox principal
            const totalCheckboxes = document.querySelectorAll('.iniciativa-checkbox').length;
            const checkedCheckboxes = document.querySelectorAll('.iniciativa-checkbox:checked').length;
            document.getElementById('selectAllCheckbox').checked = totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes;
            document.getElementById('selectAllCheckbox').indeterminate = checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes;
        }
        
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            iniciativasValidacion.forEach(init => {
                init.seleccionada = selectAll;
            });
            renderizarTablaValidacion(iniciativasValidacion);
        }
        
        function seleccionarTodasVotables() {
            iniciativasValidacion.forEach(init => {
                if (init.requiere_votacion) {
                    init.seleccionada = true;
                }
            });
            renderizarTablaValidacion(iniciativasValidacion);
        }
        
        function seleccionarTodas() {
            iniciativasValidacion.forEach(init => {
                init.seleccionada = true;
            });
            renderizarTablaValidacion(iniciativasValidacion);
        }
        
        function deseleccionarTodas() {
            iniciativasValidacion.forEach(init => {
                init.seleccionada = false;
            });
            renderizarTablaValidacion(iniciativasValidacion);
        }
        
        // Modificar la función de guardar para usar solo las seleccionadas
        async function guardarIniciativasSeleccionadas() {
            const iniciativasSeleccionadas = iniciativasValidacion.filter(i => i.seleccionada);
            
            if (iniciativasSeleccionadas.length === 0) {
                alert('Por favor selecciona al menos una iniciativa para importar');
                return;
            }
            
            // Marcar las iniciativas votables para que se muestren con el icono verde
            iniciativasSeleccionadas.forEach(init => {
                if (init.requiere_votacion) {
                    init.es_votable = true;
                }
            });
            
            // Aquí continúa el código de guardado con solo las iniciativas seleccionadas
            console.log('Iniciativas a importar:', iniciativasSeleccionadas);
            
            // El resto del código de guardado...
        }
        
        // Configurar eventos de tipo de carga en modal de validación
        document.getElementById('cargaProgramadaVal').addEventListener('change', function() {
            document.getElementById('fechaProgramadaVal').style.display = this.checked ? 'block' : 'none';
            if (this.checked) {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('fechaSesionVal').min = now.toISOString().slice(0, 16);
                document.getElementById('fechaSesionVal').required = true;
            }
        });
        
        document.getElementById('cargaInmediataVal').addEventListener('change', function() {
            document.getElementById('fechaProgramadaVal').style.display = 'none';
        });
        
        document.getElementById('cargaIndefinidaVal').addEventListener('change', function() {
            document.getElementById('fechaProgramadaVal').style.display = 'none';
        });
        
        // Función para mostrar modal de validación
        async function mostrarValidacionPDF(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/validacion/preview-pdf', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    sessionIdActual = data.sessionId;
                    iniciativasValidacion = data.iniciativas;
                    iniciativasOriginales = [...data.iniciativas]; // Guardar copia
                    filtroActual = 'todas'; // Resetear filtro
                    
                    // Actualizar estadísticas
                    actualizarEstadisticasValidacion();
                    
                    // Renderizar tabla
                    renderizarTablaValidacion(iniciativasValidacion);
                    
                    // Limpiar filtro activo
                    document.getElementById('filtroActivo').style.display = 'none';
                    
                    // Mostrar modal
                    const modal = new bootstrap.Modal(document.getElementById('modalValidacion'));
                    modal.show();
                } else {
                    alert('Error al procesar el PDF: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al procesar el PDF');
            }
        }
        
        // Función para editar iniciativa
        function editarIniciativaValidacion(index) {
            const init = iniciativasValidacion[index];
            
            document.getElementById('editNumeroSistema').value = init.numero_sistema;
            document.getElementById('editNumeroOrden').value = init.numero_orden_dia;
            document.getElementById('editTitulo').value = init.titulo;
            document.getElementById('editDescripcion').value = init.descripcion;
            document.getElementById('editPresentador').value = init.presentador;
            document.getElementById('editPartido').value = init.partido;
            document.getElementById('editTipoMayoria').value = init.tipo_mayoria;
            
            const modalEdit = new bootstrap.Modal(document.getElementById('modalEditarIniciativa'));
            modalEdit.show();
        }
        
        // Función para guardar edición
        async function guardarEdicionIniciativa() {
            const numeroSistema = document.getElementById('editNumeroSistema').value;
            
            const datosActualizados = {
                numero_orden_dia: parseInt(document.getElementById('editNumeroOrden').value),
                titulo: document.getElementById('editTitulo').value,
                descripcion: document.getElementById('editDescripcion').value,
                presentador: document.getElementById('editPresentador').value,
                partido: document.getElementById('editPartido').value,
                tipo_mayoria: document.getElementById('editTipoMayoria').value
            };
            
            try {
                const response = await fetch(`/api/validacion/preview-pdf/${sessionIdActual}/iniciativa/${numeroSistema}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(datosActualizados)
                });
                
                if (response.ok) {
                    // Actualizar array local
                    const index = iniciativasValidacion.findIndex(i => i.numero_sistema == numeroSistema);
                    if (index !== -1) {
                        iniciativasValidacion[index] = { ...iniciativasValidacion[index], ...datosActualizados };
                        
                        // Actualizar estadísticas
                        actualizarEstadisticasValidacion();
                        
                        // Re-renderizar tabla con filtro actual
                        if (filtroActual !== 'todas') {
                            filtrarIniciativas(filtroActual);
                        } else {
                            renderizarTablaValidacion(iniciativasValidacion);
                        }
                    }
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('modalEditarIniciativa')).hide();
                } else {
                    alert('Error al actualizar la iniciativa');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar la iniciativa');
            }
        }
        
        // Cancelar validación sin guardar
        function cancelarValidacion() {
            if (confirm('¿Estas seguro de cancelar? Se perderán todos los cambios no guardados.')) {
                // Limpiar todo y cerrar modal
                iniciativasValidacion = [];
                sessionIdActual = null;
                bootstrap.Modal.getInstance(document.getElementById('modalValidacion')).hide();
            }
        }
        
        // Mostrar vista previa antes de confirmar
        function mostrarVistaPrevia() {
            alert(`Vista Previa:\n\nTotal de iniciativas: ${iniciativasValidacion.length}\nIniciativas para votación: ${iniciativasValidacion.filter(i => i.requiere_votacion).length}\n\n¿Proceder con la carga?`);
        }
        
        // Guardar iniciativas validadas CON CONFIRMACIÓN
        document.getElementById('btnGuardarValidacion').addEventListener('click', async function() {
            // CONFIRMACIÓN EXPLÍCITA
            if (!confirm(`¿Confirmar la carga de ${iniciativasValidacion.length} iniciativas?\n\nEsta acción NO se puede deshacer.`)) {
                return;
            }
            
            const tipoCarga = document.querySelector('input[name="tipoCargaValidacion"]:checked').value;
            let fechaProgramada = null;
            
            if (tipoCarga === 'programada') {
                fechaProgramada = document.getElementById('fechaSesionVal').value;
                if (!fechaProgramada) {
                    alert('Por favor selecciona una fecha para la sesión programada');
                    return;
                }
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            try {
                const response = await fetch(`/api/validacion/validar-sesion/${sessionIdActual}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        tipoCarga: tipoCarga,
                        fechaProgramada: fechaProgramada
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('modalValidacion')).hide();
                    
                    // Mostrar mensaje de éxito
                    const statusDiv = document.getElementById('uploadStatus');
                    let mensaje = '';
                    if (tipoCarga === 'inmediata') {
                        mensaje = 'Las iniciativas están listas para que el presidente inicie la sesión';
                    } else if (tipoCarga === 'programada') {
                        mensaje = `Sesión programada para ${new Date(fechaProgramada).toLocaleString('es-MX')}`;
                    } else if (tipoCarga === 'indefinida') {
                        mensaje = 'Sesión guardada con fecha indefinida. Se podrá activar cuando se decida';
                    }
                    
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            ✅ Sesión validada y guardada correctamente<br>
                            ${data.iniciativas_guardadas} iniciativas guardadas<br>
                            <small class="text-muted">${mensaje}</small>
                        </div>
                    `;
                    
                    // Limpiar formulario
                    document.getElementById('pdfFile').value = '';
                    
                    // Solo recargar si es carga inmediata
                    if (tipoCarga === 'inmediata') {
                        loadActiveSession();
                    } else {
                        // Para carga programada o indefinida, solo actualizar sesiones pendientes
                        cargarSesionesPendientes();
                    }
                } else {
                    alert('Error al guardar la sesión: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar la sesión');
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-save"></i> Guardar Iniciativas Validadas';
            }
        });
        
        // Modificar el evento de carga de PDF para usar validación
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor selecciona un archivo PDF');
                return;
            }
            
            // Mostrar modal de validación en lugar de cargar directamente
            mostrarValidacionPDF(file);
        });
    </script>
    
    <script src="/js/theme-switcher.js"></script>
</body>
</html>