<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Operador - Sistema de Votaci√≥n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/apple-theme.css">
    <link rel="stylesheet" href="/css/dark-theme.css">
    <link rel="stylesheet" href="/css/global-background.css">
    <script src="/js/theme-loader.js"></script>
    <style>
        /* Colores neutros */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* Estilos personalizados para los botones del modal de validaci√≥n */
        #btnGuardarValidacion {
            cursor: pointer !important;
            user-select: none !important;
        }
        
        #btnGuardarValidacion:active {
            transform: scale(0.95) !important;
        }
        .navbar { 
            background: var(--navbar-bg) !important;
            border-bottom: 1px solid var(--border-color);
        }
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        .card-header {
            background: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border-bottom: 1px solid var(--border-color);
        }
        .bg-purple {
            background-color: #9b59b6 !important;
        }
        
        /* Fix para dropdown de pantalla p√∫blica - Simplificado */
        #screenDropdown .dropdown-menu {
            z-index: 9999 !important;
            background-color: var(--bg-card, white) !important;
            border: 1px solid var(--border-color, #dee2e6) !important;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3) !important;
        }
        
        .dropdown-menu .dropdown-item {
            color: var(--text-primary, #212529) !important;
        }
        
        .dropdown-menu .dropdown-item:hover {
            background-color: var(--bg-hover, #f8f9fa) !important;
        }
        
        .initiative-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .initiative-card:hover { transform: translateY(-5px); }
        .initiative-card.active {
            border: 2px solid var(--color-primary);
            background: var(--bg-hover);
        }
        
        /* Estilos mejorados para iniciativas extraordinarias */
        .initiative-card.extraordinary {
            background: linear-gradient(135deg, #fff8e1 0%, #fffdf7 100%);
            border: 2px solid #ffa000 !important;
            box-shadow: 0 0 10px rgba(255, 160, 0, 0.2);
            position: relative;
        }
        
        .initiative-card.extraordinary::before {
            content: "‚ö†";
            position: absolute;
            top: -10px;
            right: 15px;
            background: #ff9800;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .initiative-card.extraordinary.active {
            background: linear-gradient(135deg, #fff3cd 0%, #f8fff9 100%);
            border-color: #ff6b00 !important;
            box-shadow: 0 0 15px rgba(255, 107, 0, 0.3);
        }
        
        .badge-extraordinary {
            background: linear-gradient(135deg, #ff9800 0%, #ff6b00 100%);
            color: white;
            font-weight: bold;
            animation: pulse 2s infinite;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
        }
        
        /* Badges de partidos con colores oficiales */
        .badge-partido {
            color: white !important;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .badge-morena { background-color: #8B1B1B !important; }
        .badge-pan { background-color: #1B4788 !important; }
        .badge-pri { background-color: #CD1C22 !important; }
        .badge-pt { background-color: #E31E24 !important; }
        .badge-pvem { background-color: #00A550 !important; }
        .badge-mc { background-color: #FF6B00 !important; }
        .badge-nueva-alianza { background-color: #00B8B2 !important; }
        .badge-nueva-alianza-morelos { background-color: #00B8B2 !important; }
        
        /* Reducir tama√±o de iconos en botones de iniciativas */
        .initiative-card .btn-group .btn {
            padding: 4px 8px;
            font-size: 0.8rem;
        }
        
        .initiative-card .btn-group .btn i {
            font-size: 0.8rem;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Estilos para pesta√±as din√°micas */
        .nav-tabs .nav-link {
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link:hover {
            background-color: var(--bg-hover);
            border-color: var(--border-color);
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--bg-card);
            border-color: var(--border-color) var(--border-color) var(--bg-card);
            color: var(--color-primary);
            font-weight: 600;
        }
        
        /* Badges en pesta√±as con colores espec√≠ficos */
        .nav-tabs .badge-warning {
            background-color: #ff9800 !important;
            animation: pulse 2s infinite;
        }
        
        .nav-tabs .badge-danger {
            background-color: #dc3545 !important;
        }
        
        .nav-tabs .badge-info {
            background-color: #17a2b8 !important;
        }
        
        .nav-tabs .badge-success {
            background-color: #28a745 !important;
        }
        
        /* Contenedor de pesta√±as */
        .tab-content {
            background-color: var(--bg-card);
            padding: 15px;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark" style="background: linear-gradient(135deg, #1a2332, #263241) !important; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0, 0, 0, 0.3); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-user-cog"></i> Panel Operador - Sistema de Votaci√≥n
            </span>
            <div class="d-flex align-items-center">
                <span class="text-white me-3">
                    <i class="fas fa-clock"></i> <span id="currentTime">00:00:00</span>
                </span>
                <span class="text-white me-3" id="sessionTimerContainer" style="display: none;">
                    <i class="fas fa-hourglass-half"></i> Sesi√≥n: <span id="sessionTimer">00:00:00</span>
                </span>
                <span class="text-white me-3" id="userName"></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
    </nav>

    <!-- Panel de estad√≠sticas de sesiones -->
    <div class="container-fluid mt-3">
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center p-2">
                        <h6 class="text-muted mb-1 small">√öltima Sesi√≥n</h6>
                        <p class="mb-0 small fw-bold" id="ultimaSesion">Cargando...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-warning bg-opacity-10">
                    <div class="card-body text-center p-2">
                        <h6 class="text-muted mb-1 small">Pr√≥xima Programada</h6>
                        <p class="mb-0 small fw-bold" id="proximaSesion">Sin programar</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info bg-opacity-10">
                    <div class="card-body text-center p-2">
                        <h6 class="text-muted mb-1 small">Docs Precargados</h6>
                        <p class="mb-0 small fw-bold" id="documentosPendientes">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container-fluid">
        <!-- Panel de Sesiones Precargadas por Servicios Legislativos -->
        <div id="sesionesPrecargadasAlert" class="alert alert-info mb-3" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-bell"></i> <strong>Hay sesiones precargadas disponibles</strong>
                    <span id="numSesionesPrecargadas"></span>
                </div>
                <button class="btn btn-sm btn-primary" onclick="verSesionesPrecargadas()">
                    <i class="fas fa-eye"></i> Ver Sesiones
                </button>
            </div>
        </div>
        
        <div class="row">
            <!-- Panel de carga de PDF -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-file-pdf"></i> Cargar Orden del D√≠a</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label for="pdfFile" class="form-label">Seleccionar archivo (PDF o Word)</label>
                                <input type="file" class="form-control" id="pdfFile" accept=".pdf,.doc,.docx" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tipo de carga:</label>
                                <div class="form-check" id="tipoCargaGroup">
                                    <input class="form-check-input" type="radio" name="tipoCarga" id="cargaInmediata" value="inmediata" checked>
                                    <label class="form-check-label" for="cargaInmediata">
                                        <i class="fas fa-play-circle text-success"></i> Ejecutar inmediatamente
                                        <small class="text-muted d-block">El presidente podr√° iniciar la sesi√≥n de inmediato</small>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tipoCarga" id="cargaProgramada" value="programada">
                                    <label class="form-check-label" for="cargaProgramada">
                                        <i class="fas fa-calendar-check text-info"></i> Programar para despu√©s
                                        <small class="text-muted d-block">Guardar para una sesi√≥n futura con fecha espec√≠fica</small>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tipoCarga" id="cargaIndefinida" value="indefinida">
                                    <label class="form-check-label" for="cargaIndefinida">
                                        <i class="fas fa-clock text-warning"></i> Fecha indefinida
                                        <small class="text-muted d-block">Guardar para cuando se decida realizar la sesi√≥n</small>
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3" id="fechaProgramada" style="display: none;">
                                <label for="fechaSesion" class="form-label">Fecha y hora programada:</label>
                                <input type="datetime-local" class="form-control" id="fechaSesion">
                                <small class="text-muted">La sesi√≥n se activar√° autom√°ticamente en esta fecha</small>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-upload"></i> Cargar y Procesar
                            </button>
                            <button type="button" class="btn btn-info w-100 mt-2" onclick="verHistorial()">
                                <i class="fas fa-history"></i> Historial de Sesiones
                            </button>
                        </form>
                        
                        <div id="uploadStatus" class="mt-3"></div>
                    </div>
                </div>
                
                <!-- Estado de sesi√≥n -->
                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Estado de Sesi√≥n</h6>
                    </div>
                    <div class="card-body">
                        <div id="sessionStatus">
                            <p class="text-muted">Sin sesi√≥n activa</p>
                        </div>
                    </div>
                </div>
                
                <!-- Pantalla de votaci√≥n -->
                <div class="card mt-3">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0"><i class="fas fa-tv"></i> Pantalla P√∫blica</h6>
                    </div>
                    <div class="card-body" style="min-height: 280px; position: relative; overflow: visible;">
                        <div class="dropdown w-100" id="screenDropdown" style="position: static;">
                            <button class="btn btn-dark w-100 dropdown-toggle" type="button" 
                                    data-bs-toggle="dropdown" 
                                    data-bs-auto-close="false"
                                    data-bs-boundary="window"
                                    data-bs-strategy="absolute">
                                <i class="fas fa-desktop"></i> Seleccionar Pantalla
                            </button>
                            <ul class="dropdown-menu w-100" style="position: absolute; z-index: 9999;">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="abrirPantalla('votacion')">
                                        <i class="fas fa-vote-yea"></i> Pantalla de Votaci√≥n
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="abrirPantalla('asistencia')">
                                        <i class="fas fa-clipboard-check"></i> Pantalla de Asistencia
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="mostrarOpcionesOBS('votacion')">
                                        <i class="fas fa-video"></i> OBS - Votaci√≥n
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="mostrarOpcionesOBS('asistencia')">
                                        <i class="fas fa-video"></i> OBS - Asistencia
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Selecciona qu√© pantalla mostrar al p√∫blico
                        </small>
                        
                        <!-- Espacio adicional para que el dropdown no se corte -->
                        <div style="height: 150px;"></div>
                    </div>
                </div>
                
                <!-- Exportar Resultados -->
                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-download"></i> Exportar Resultados</h6>
                    </div>
                    <div class="card-body">
                        <div id="exportPanel">
                            <!-- Selector de sesi√≥n a exportar -->
                            <div class="mb-3">
                                <label for="sesionExportar" class="form-label small">Selecciona la sesi√≥n a exportar:</label>
                                <select class="form-select form-select-sm" id="sesionExportar" onchange="actualizarEstadoExportacion()">
                                    <option value="">-- Selecciona una sesi√≥n finalizada --</option>
                                </select>
                            </div>
                            
                            <div class="alert alert-warning small p-2" id="alertaExportacion" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i> Solo puedes exportar sesiones finalizadas
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-success btn-sm" onclick="exportarSesionSeleccionada('excel')" id="btnExportExcel" disabled>
                                    <i class="fas fa-file-excel"></i> Exportar a Excel
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="exportarSesionSeleccionada('pdf')" id="btnExportPDF" disabled>
                                    <i class="fas fa-file-pdf"></i> Exportar a PDF
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="exportarSesionSeleccionada('word')" id="btnExportWord" disabled>
                                    <i class="fas fa-file-word"></i> Exportar a Word
                                </button>
                            </div>
                            
                            <div id="exportStatus" class="mt-2"></div>
                            
                            <details class="mt-3">
                                <summary class="small text-muted" style="cursor: pointer;">Ver contenido del reporte</summary>
                                <ul class="small ps-3 mt-2 text-muted">
                                    <li>Informaci√≥n completa de la sesi√≥n</li>
                                    <li>Duraci√≥n total y horarios</li>
                                    <li>Control de asistencia y qu√≥rum</li>
                                    <li>Resultados de todas las votaciones</li>
                                    <li>Detalle de votos por diputado</li>
                                </ul>
                            </details>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lista de iniciativas -->
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list"></i> Iniciativas y Dict√°menes</h5>
                            <div class="btn-group" role="group">
                                <button class="btn btn-warning btn-sm" onclick="mostrarModalExtraordinarias()" title="Agregar iniciativas extraordinarias">
                                    <i class="fas fa-plus-circle"></i> Agregar
                                </button>
                                <button class="btn btn-info btn-sm" onclick="guardarSesion()" title="Guardar sesi√≥n para uso posterior">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="limpiarSesion()" title="Eliminar todas las iniciativas de la sesi√≥n">
                                    <i class="fas fa-trash"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Pesta√±as din√°micas para categor√≠as de iniciativas -->
                        <ul class="nav nav-tabs mb-3" id="initiativesTabs" role="tablist" style="display: none;">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="todas-tab" data-bs-toggle="tab" 
                                        data-bs-target="#todas" type="button" role="tab">
                                    <i class="fas fa-list"></i> Todas
                                    <span class="badge bg-secondary ms-1" id="countTodas">0</span>
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Contenido de las pesta√±as -->
                        <div class="tab-content" id="initiativesTabContent">
                            <div class="tab-pane fade show active" id="todas" role="tabpanel">
                                <div id="initiativesList">
                                    <p class="text-muted text-center">No hay iniciativas cargadas</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bot√≥n para notificar a mesa directiva -->
                        <div id="notificarMesaContainer" class="mt-3" style="display: none;">
                            <div class="d-grid">
                                <button class="btn btn-success btn-lg" onclick="notificarMesaDirectiva(event)">
                                    <i class="fas fa-bell"></i> Notificar Mesa Directiva - Sesi√≥n Lista
                                </button>
                                <small class="text-muted text-center mt-2">
                                    Notifica al presidente y secretarios que las iniciativas est√°n listas
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Sesiones Pendientes -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning bg-opacity-25 d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="fas fa-clock"></i> Sesiones Pendientes / Indefinidas</h5>
                            <small class="text-muted">
                                <span class="badge bg-primary"><i class="fas fa-building"></i></span> = Cargadas por Servicios Legislativos |
                                <span class="badge bg-dark"><i class="fas fa-user"></i></span> = Cargadas por Operador
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadSesionesPendientes()">
                            <i class="fas fa-sync"></i> Actualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="sesionesPendientesList">
                            <p class="text-muted text-center">Cargando sesiones pendientes...</p>
                        </div>
                        <!-- Controles de paginaci√≥n -->
                        <div id="paginacionSesiones" class="d-flex justify-content-between align-items-center mt-3" style="display: none;">
                            <div>
                                <span class="text-muted">Mostrando <span id="showingRange">0-0</span> de <span id="totalSesiones">0</span> sesiones</span>
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="paginationControls">
                                    <!-- Se llena din√°micamente -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Consulta Sesiones Previas -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-file-pdf"></i> Consulta Sesiones Previas</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadSesionesConDocumentos()">
                            <i class="fas fa-sync"></i> Actualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="sesionesDocumentosList">
                            <p class="text-muted text-center">Cargando sesiones con documentos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar iniciativas de sesi√≥n -->
    <div class="modal fade" id="editarIniciativasModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Editar Iniciativas de Sesi√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Puedes editar las iniciativas de esta sesi√≥n antes de activarla.
                    </div>
                    
                    <h6 class="mb-3">Sesi√≥n: <span id="sesionNombreEdit"></span></h6>
                    
                    <!-- Contadores por tipo -->
                    <div class="mb-3">
                        <span class="badge bg-warning me-2">
                            <i class="fas fa-gavel"></i> Dict√°menes: <span id="editBadgeDictamenes">0</span>
                        </span>
                        <span class="badge bg-info me-2">
                            <i class="fas fa-file-alt"></i> Iniciativas: <span id="editBadgeIniciativas">0</span>
                        </span>
                        <span class="badge bg-success">
                            <i class="fas fa-handshake"></i> Puntos de Acuerdo: <span id="editBadgePuntos">0</span>
                        </span>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th width="15%"># / Tipo</th>
                                    <th width="65%">Descripci√≥n</th>
                                    <th width="10%">Mayor√≠a</th>
                                    <th width="10%">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="iniciativasEditList">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-success" onclick="agregarNuevaIniciativa()">
                            <i class="fas fa-plus"></i> Agregar Nueva Iniciativa
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarCambiosIniciativas()">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para configuraci√≥n OBS -->
    <div class="modal fade" id="obsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-video"></i> Configuraci√≥n OBS/Streaming</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Usa estos enlaces para agregar la pantalla como Browser Source en OBS
                    </div>
                    
                    <h6>Modos Predefinidos:</h6>
                    <div class="list-group mb-3" id="obsPresetModes">
                        <!-- Se llenar√° din√°micamente seg√∫n el tipo de pantalla -->
                    </div>
                    
                    <h6>Configuraci√≥n Personalizada:</h6>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <label for="obsResolution" class="form-label">Resoluci√≥n</label>
                            <select class="form-select" id="obsResolution">
                                <option value="">Autom√°tica</option>
                                <option value="1920x1080">1920x1080 (Full HD)</option>
                                <option value="1280x720">1280x720 (HD)</option>
                                <option value="774x518">774x518 (Compacto)</option>
                                <option value="custom">Personalizada</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="obsWidth" class="form-label">Ancho</label>
                            <input type="number" class="form-control" id="obsWidth" placeholder="1920" disabled>
                        </div>
                        <div class="col-md-3">
                            <label for="obsHeight" class="form-label">Alto</label>
                            <input type="number" class="form-control" id="obsHeight" placeholder="1080" disabled>
                        </div>
                    </div>
                    
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="obsHeader" checked>
                        <label class="form-check-label" for="obsHeader">Mostrar encabezado</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="obsSidebar" checked>
                        <label class="form-check-label" for="obsSidebar">Mostrar panel lateral</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="obsTransparent">
                        <label class="form-check-label" for="obsTransparent">Fondo transparente</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="obsMinimal">
                        <label class="form-check-label" for="obsMinimal">Modo minimalista</label>
                    </div>
                    
                    <div class="mt-3">
                        <label for="obsCustomURL" class="form-label">URL Personalizada:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="obsCustomURL" readonly>
                            <button class="btn btn-primary" onclick="copiarCustomURL()">Copiar</button>
                        </div>
                    </div>
                    
                    <div class="alert alert-secondary mt-3">
                        <strong>Configuraci√≥n recomendada en OBS:</strong>
                        <ul class="mb-0">
                            <li>Tipo de fuente: Browser Source</li>
                            <li>FPS: 60</li>
                            <li>CSS personalizado: Dejar vac√≠o</li>
                            <li>Shutdown source when not visible: Desactivado</li>
                            <li>Refresh browser when scene becomes active: Activado</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="abrirPantallaOBS()">Abrir Vista Previa</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para editar iniciativa -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Iniciativa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label for="editNumero" class="form-label">N√∫mero</label>
                            <input type="number" class="form-control" id="editNumero" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDescripcion" class="form-label">Descripci√≥n de la Iniciativa</label>
                            <textarea class="form-control" id="editDescripcion" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editPresentador" class="form-label">Presentada por</label>
                            <input type="text" class="form-control" id="editPresentador" placeholder="Nombre del diputado">
                        </div>
                        <div class="mb-3">
                            <label for="editPartidoPresentador" class="form-label">Partido</label>
                            <input type="text" class="form-control" id="editPartidoPresentador" placeholder="Siglas del partido">
                        </div>
                        <div class="mb-3">
                            <label for="editTipoMayoria" class="form-label">Tipo de Mayor√≠a</label>
                            <select class="form-select" id="editTipoMayoria">
                                <option value="simple">Mayor√≠a Simple</option>
                                <option value="absoluta">Mayor√≠a Absoluta</option>
                                <option value="calificada">Mayor√≠a Calificada (2/3)</option>
                                <option value="unanime">Unanimidad</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">Guardar cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Sesiones Precargadas -->
    <div class="modal fade" id="sesionesPrecargadasModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-folder-open"></i> Sesiones Precargadas por Servicios Legislativos</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Sesiones Disponibles</h6>
                            <div class="list-group" id="listaSesionesPrecargadas">
                                <!-- Se carga din√°micamente -->
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div id="detalleSesionPrecargada">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-arrow-left fa-3x"></i>
                                    <p class="mt-3">Seleccione una sesi√≥n para ver los detalles</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Iniciativas Extraordinarias -->
    <div class="modal fade" id="extraordinariasModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Agregar Iniciativas Extraordinarias</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="extraordinariasTab">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#manualTab">
                                <i class="fas fa-keyboard"></i> Captura Manual
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pdfTab">
                                <i class="fas fa-file-pdf"></i> Desde PDF
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content">
                        <!-- Tab de Captura Manual -->
                        <div class="tab-pane fade show active" id="manualTab">
                            <form id="extraordinariaManualForm">
                                <div class="mb-3">
                                    <label for="extNumero" class="form-label">N√∫mero de Iniciativa</label>
                                    <select class="form-select" id="extNumero" required>
                                        <option value="">Seleccionar posici√≥n...</option>
                                    </select>
                                    <small class="text-muted">La iniciativa extraordinaria se insertar√° en esta posici√≥n y recorrer√° las dem√°s</small>
                                </div>
                                <div class="mb-3">
                                    <label for="extDescripcion" class="form-label">Descripci√≥n de la Iniciativa</label>
                                    <textarea class="form-control" id="extDescripcion" rows="3" required></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="extPresentador" class="form-label">Presentada por</label>
                                            <select class="form-select" id="extPresentador" onchange="actualizarPartidoAutomatico()">
                                                <option value="">Seleccionar diputado...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="extPartido" class="form-label">Partido</label>
                                            <select class="form-select" id="extPartido">
                                                <option value="">Seleccionar...</option>
                                                <option value="MORENA">MORENA</option>
                                                <option value="PAN">PAN</option>
                                                <option value="PRI">PRI</option>
                                                <option value="PT">PT</option>
                                                <option value="PVEM">PVEM</option>
                                                <option value="MC">MC</option>
                                                <option value="PRD">PRD</option>
                                                <option value="PNA">PNA</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="extTipoMayoria" class="form-label">Tipo de Mayor√≠a</label>
                                    <select class="form-select" id="extTipoMayoria" required>
                                        <option value="simple">Mayor√≠a Simple</option>
                                        <option value="absoluta">Mayor√≠a Absoluta</option>
                                        <option value="calificada">Mayor√≠a Calificada (2/3)</option>
                                        <option value="unanime">Unanimidad</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-warning" onclick="agregarExtraordinaria()">
                                    <i class="fas fa-plus"></i> Agregar a la lista
                                </button>
                            </form>
                            
                            <!-- Lista de iniciativas agregadas -->
                            <div class="mt-3">
                                <h6>Iniciativas Extraordinarias Agregadas:</h6>
                                <div id="listaExtraordinarias" class="list-group">
                                    <p class="text-muted">No hay iniciativas extraordinarias agregadas</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab de PDF -->
                        <div class="tab-pane fade" id="pdfTab">
                            <div class="mb-3">
                                <label for="pdfExtraordinarias" class="form-label">Archivo PDF con Iniciativas Extraordinarias</label>
                                <input type="file" class="form-control" id="pdfExtraordinarias" accept=".pdf">
                                <small class="text-muted">El PDF debe contener las iniciativas extraordinarias en formato estructurado</small>
                            </div>
                            <button type="button" class="btn btn-warning" onclick="procesarPDFExtraordinarias()">
                                <i class="fas fa-file-import"></i> Procesar PDF
                            </button>
                            <div id="pdfExtraordinariasStatus" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="guardarTodasExtraordinarias()">
                        <i class="fas fa-save"></i> Guardar todas las extraordinarias
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');
        
        // Identificar usuario al conectarse
        if (user) {
            socket.emit('identificar-usuario', {
                nombre: user.nombre_completo || user.username,
                rol: 'Operador'
            });
        }
        
        // Escuchar notificaciones de Servicios Legislativos
        socket.on('nueva-sesion-servicios', (data) => {
            console.log('üì¢ Nueva sesi√≥n cargada desde Servicios Legislativos:', data);
            
            // Mostrar notificaci√≥n visual
            const alertHtml = `
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <strong><i class="fas fa-bell"></i> Nueva Sesi√≥n Disponible</strong><br>
                    ${data.mensaje}<br>
                    <small>
                        <strong>C√≥digo:</strong> ${data.codigoUnico}<br>
                        <strong>Usuario:</strong> ${data.usuario}<br>
                        <strong>Iniciativas:</strong> ${data.iniciativasCount}
                    </small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Agregar la alerta al principio del contenedor principal
            const container = document.querySelector('.container-fluid');
            if (container) {
                const alertDiv = document.createElement('div');
                alertDiv.innerHTML = alertHtml;
                container.insertBefore(alertDiv.firstChild, container.firstChild);
                
                // Auto-cerrar despu√©s de 10 segundos
                setTimeout(() => {
                    alertDiv.firstChild?.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 500);
                }, 10000);
            }
            
            // Reproducir sonido de notificaci√≥n
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCTGH0fPTgjMGHm7A7+OZURE');
            audio.volume = 0.3;
            audio.play().catch(() => {});
            
            // Actualizar la lista de sesiones pendientes
            loadSesionesPendientes();
            verificarSesionesPrecargadas();
        });
        
        // Variable para rastrear el tipo de pantalla actual (definida al inicio)
        let currentScreenType = 'votacion';
        
        // Variables para el cron√≥metro
        let sessionStartTime = null;
        let timerInterval = null;
        
        // Funci√≥n para actualizar el reloj
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-MX', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
            setTimeout(updateClock, 1000);
        }
        
        // Funci√≥n para el cron√≥metro de sesi√≥n
        function startSessionTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            if (sessionStartTime) {
                document.getElementById('sessionTimerContainer').style.display = 'inline-block';
                
                timerInterval = setInterval(() => {
                    const elapsed = Date.now() - sessionStartTime;
                    const hours = Math.floor(elapsed / 3600000);
                    const minutes = Math.floor((elapsed % 3600000) / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    
                    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    document.getElementById('sessionTimer').textContent = timeString;
                }, 1000);
            }
        }
        
        // Iniciar reloj al cargar la p√°gina
        updateClock();
        
        // Funci√≥n para mostrar notificaciones
        function showNotification(message, type = 'info') {
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'warning' ? 'alert-warning' : 
                             type === 'danger' ? 'alert-danger' : 'alert-info';
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-cerrar despu√©s de 3 segundos
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 150);
            }, 3000);
        }
        
        // Variable para almacenar informaci√≥n de la sesi√≥n actual
        let sessionData = null;
        
        // Variables globales para el sistema de validaci√≥n de PDF
        let sessionIdActual = null;
        let iniciativasValidacion = [];
        let iniciativasOriginales = []; // Copia para restaurar
        let filtroActual = 'todas';
        
        if (!token || !user || user.role !== 'operador') {
            window.location.href = '/';
        }
        
        document.getElementById('userName').textContent = user.nombre;
        
        // Cargar sesi√≥n activa y estad√≠sticas al iniciar
        loadActiveSession();
        loadEstadisticasSesiones();
        loadSesionesPendientes();
        loadSesionesConDocumentos();
        verificarSesionesPrecargadas();
        cargarSesionesFinalizadas();
        
        // Escuchar notificaciones de nuevas sesiones precargadas
        socket.on('nueva-sesion-precargada', (data) => {
            console.log('Nueva sesi√≥n precargada recibida:', data);
            
            // Mostrar notificaci√≥n toast o alerta
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-info alert-dismissible fade show position-fixed top-0 end-0 m-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <strong>¬°Nueva sesi√≥n disponible!</strong><br>
                ${data.mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-cerrar despu√©s de 5 segundos
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
            
            // Actualizar contador de sesiones precargadas
            verificarSesionesPrecargadas();
        });
        
        // Escuchar cuando el presidente inicia sesi√≥n
        socket.on('sesion-iniciada', (data) => {
            console.log('El presidente ha iniciado sesi√≥n:', data);
            
            // Mostrar alerta urgente
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '400px';
            alertDiv.innerHTML = `
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> ¬°Atenci√≥n!</h5>
                <p><strong>${data.mensaje || 'El Presidente de la Mesa Directiva acaba de iniciar la sesi√≥n'}</strong></p>
                <p class="mb-0">Atento con las iniciativas y dict√°menes.</p>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Actualizar estado de sesi√≥n
            loadActiveSession();
        });
        
        // Manejar tipo de carga
        document.getElementById('cargaInmediata').addEventListener('change', function() {
            document.getElementById('fechaProgramada').style.display = 'none';
        });
        
        document.getElementById('cargaProgramada').addEventListener('change', function() {
            document.getElementById('fechaProgramada').style.display = 'block';
            // Establecer fecha m√≠nima como ahora
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('fechaSesion').min = now.toISOString().slice(0, 16);
            document.getElementById('fechaSesion').required = true;
        });
        
        document.getElementById('cargaIndefinida').addEventListener('change', function() {
            document.getElementById('fechaProgramada').style.display = 'none';
            document.getElementById('fechaSesion').required = false;
        });
        
        // Manejar carga de PDF - Mostrar modal de validaci√≥n
        const uploadForm = document.getElementById('uploadForm');
        if (uploadForm) {
            console.log('Formulario de carga encontrado, agregando listener');
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Formulario enviado - evento submit capturado');
                
                const fileInput = document.getElementById('pdfFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Por favor selecciona un archivo PDF');
                    return;
                }
                
                console.log('Archivo seleccionado:', file.name, 'Tama√±o:', file.size);
                // Mostrar modal de validaci√≥n para revisar antes de importar
                try {
                    console.log('Llamando a mostrarValidacionPDF...');
                    await mostrarValidacionPDF(file);
                } catch (error) {
                    console.error('Error al mostrar validaci√≥n:', error);
                    alert('Error al procesar el archivo: ' + error.message);
                }
            });
        } else {
            console.error('No se encontr√≥ el formulario uploadForm');
        }
        
        // Funci√≥n para actualizar estad√≠sticas de validaci√≥n
        function actualizarEstadisticasValidacion() {
            const totalIniciativasEl = document.getElementById('totalIniciativas');
            if (totalIniciativasEl) {
                totalIniciativasEl.textContent = iniciativasValidacion.length;
            }
            
            // Actualizar contador total
            const contadorTotalEl = document.getElementById('contadorTotal');
            if (contadorTotalEl) {
                contadorTotalEl.textContent = iniciativasValidacion.length;
            }
            
            // Contar recomendadas para votaci√≥n
            const recomendadas = iniciativasValidacion.filter(i => 
                i.recomendado_para_votacion || i.requiere_votacion).length;
            const numRecomendadasEl = document.getElementById('numRecomendadas');
            const contadorRecomendadasEl = document.getElementById('contadorRecomendadas');
            if (numRecomendadasEl && contadorRecomendadasEl) {
                numRecomendadasEl.textContent = recomendadas;
                contadorRecomendadasEl.style.display = recomendadas > 0 ? 'inline-block' : 'none';
            }
            
            const requierenVot = iniciativasValidacion.filter(i => i.requiere_votacion).length;
            const requierenVotacionEl = document.getElementById('requierenVotacion');
            if (requierenVotacionEl) {
                requierenVotacionEl.textContent = requierenVot;
            }
            
            const aComision = iniciativasValidacion.filter(i => 
                i.tipo_votacion && i.tipo_votacion.toLowerCase().includes('comisi√≥n')).length;
            const aComisionesEl = document.getElementById('aComisiones');
            if (aComisionesEl) {
                aComisionesEl.textContent = aComision;
            }
            
            const otrosEl = document.getElementById('otros');
            if (otrosEl) {
                otrosEl.textContent = iniciativasValidacion.length - requierenVot - aComision;
            }
        }
        
        // Funci√≥n para actualizar contador de seleccionadas
        function actualizarContadorSeleccionadas() {
            const seleccionadas = iniciativasValidacion.filter(i => i.seleccionada).length;
            const contadorEl = document.getElementById('contadorSeleccionadas');
            if (contadorEl) {
                contadorEl.textContent = seleccionadas;
            }
            
            // Actualizar estado del checkbox principal
            const totalCheckboxes = document.querySelectorAll('.iniciativa-checkbox').length;
            const checkedCheckboxes = document.querySelectorAll('.iniciativa-checkbox:checked').length;
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes;
                selectAllCheckbox.indeterminate = checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes;
            }
        }
        
        // Funci√≥n para renderizar tabla de validaci√≥n
        function renderizarTablaValidacion(iniciativas) {
            const tbody = document.getElementById('tablaValidacion');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            iniciativas.forEach((init) => {
                const index = iniciativasValidacion.indexOf(init);
                const tr = document.createElement('tr');
                
                // Determinar si requiere votaci√≥n y si es recomendada
                const requiereVotacion = init.requiere_votacion || false;
                const esRecomendada = init.recomendado_para_votacion || false;
                
                // Estilo de fila seg√∫n el estado
                if (esRecomendada) {
                    // Verde claro para recomendadas
                    tr.style.backgroundColor = 'rgba(40, 167, 69, 0.15)';
                    tr.style.borderLeft = '3px solid #28a745';
                } else if (requiereVotacion) {
                    // Verde muy claro para las que requieren votaci√≥n
                    tr.style.backgroundColor = 'rgba(40, 167, 69, 0.08)';
                } else if (init.categoria === 'iniciativas') {
                    // Azul claro para iniciativas (turno a comisiones)
                    tr.style.backgroundColor = 'rgba(0, 123, 255, 0.05)';
                } else if (init.categoria === 'otras') {
                    // Gris claro para otras
                    tr.style.backgroundColor = 'rgba(108, 117, 125, 0.05)';
                }
                
                // Verificar si est√° seleccionada
                const isSelected = init.seleccionada || false;
                
                // Preparar el contenido para mostrar - usar el campo que tenga m√°s contenido
                const descripcion = init.descripcion || init.titulo || init.contenido || 'Sin descripci√≥n';
                console.log(`Iniciativa ${init.numero_sistema}: desc=${init.descripcion?.length || 0} chars, titulo=${init.titulo?.length || 0} chars`);
                const descripcionCorta = descripcion.length > 150 ? 
                    descripcion.substring(0, 150) + '...' : descripcion;
                
                // Determinar el tipo de elemento
                const tipoElemento = init.tipo_documento || init.tipo_votacion || 'General';
                
                // Determinar la categor√≠a
                const categoriaElemento = init.categoria || 'otras';
                const categoriaBadge = {
                    'dictamenes': 'bg-success',
                    'primera_lectura': 'bg-info',
                    'segunda_lectura': 'bg-warning',
                    'urgente': 'bg-danger',
                    'puntos_acuerdo': 'bg-purple',
                    'iniciativas': 'bg-primary',
                    'procedimiento': 'bg-dark',
                    'otras': 'bg-secondary'
                }[categoriaElemento] || 'bg-secondary';
                
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" 
                               class="form-check-input iniciativa-checkbox" 
                               data-index="${index}"
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleIniciativaSeleccion(${index})">
                    </td>
                    <td>
                        ${esRecomendada ? '<i class="fas fa-robot text-warning me-1" title="Recomendada por el sistema"></i>' : ''}
                        ${requiereVotacion ? '<i class="fas fa-vote-yea text-success me-1" title="Requiere votaci√≥n"></i>' : ''}
                        <small>${init.numero_sistema || index + 1}</small>
                    </td>
                    <td><small>${init.numero_orden_dia || init.numero_original || '-'}</small></td>
                    <td title="${descripcion.replace(/"/g, '&quot;')}">
                        <small>${descripcionCorta}</small>
                    </td>
                    <td>
                        <small>${tipoElemento}</small>
                    </td>
                    <td>
                        <span class="badge ${categoriaBadge}">
                            ${categoriaElemento}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${init.tipo_mayoria === 'calificada' ? 'warning' : 'secondary'}">
                            ${init.tipo_mayoria || 'simple'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" 
                                    onclick="editarIniciativaValidacion(${index})"
                                    title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" 
                                    onclick="eliminarIniciativaValidacion(${index})"
                                    title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            if (iniciativas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            No hay iniciativas ${filtroActual !== 'todas' ? 'en este filtro' : ''}
                        </td>
                    </tr>
                `;
            }
            
            actualizarContadorSeleccionadas();
        }
        
        // Funci√≥n para filtrar iniciativas
        function filtrarIniciativas(tipo) {
            filtroActual = tipo;
            const filtroDiv = document.getElementById('filtroActivo');
            
            let iniciativasFiltradas = [...iniciativasValidacion];
            let textoFiltro = 'Todas';
            
            switch(tipo) {
                case 'votacion':
                    iniciativasFiltradas = iniciativasValidacion.filter(i => i.requiere_votacion);
                    textoFiltro = 'Requieren Votaci√≥n';
                    break;
                case 'comisiones':
                    iniciativasFiltradas = iniciativasValidacion.filter(i => 
                        i.tipo_votacion && i.tipo_votacion.toLowerCase().includes('comisi√≥n'));
                    textoFiltro = 'A Comisiones';
                    break;
                case 'otros':
                    iniciativasFiltradas = iniciativasValidacion.filter(i => 
                        !i.requiere_votacion && 
                        (!i.tipo_votacion || !i.tipo_votacion.toLowerCase().includes('comisi√≥n')));
                    textoFiltro = 'Otros';
                    break;
                case 'todas':
                default:
                    if (filtroDiv) filtroDiv.style.display = 'none';
                    break;
            }
            
            if (tipo !== 'todas' && filtroDiv) {
                filtroDiv.style.display = 'block';
                const textoFiltroEl = document.getElementById('textoFiltro');
                if (textoFiltroEl) textoFiltroEl.textContent = textoFiltro;
            }
            
            renderizarTablaValidacion(iniciativasFiltradas);
        }
        
        // Funci√≥n para eliminar iniciativa en validaci√≥n
        function eliminarIniciativaValidacion(index) {
            if (!confirm('¬øEliminar esta iniciativa? No se importar√° a la sesi√≥n.')) return;
            
            // Eliminar de la lista
            iniciativasValidacion.splice(index, 1);
            
            // Actualizar estad√≠sticas
            actualizarEstadisticasValidacion();
            
            // Re-renderizar tabla con filtro actual
            if (filtroActual !== 'todas') {
                filtrarIniciativas(filtroActual);
            } else {
                renderizarTablaValidacion(iniciativasValidacion);
            }
        }
        
        // Funci√≥n para editar iniciativa
        function editarIniciativaValidacion(index) {
            const init = iniciativasValidacion[index];
            
            const editNumeroSistema = document.getElementById('editNumeroSistema');
            const editNumeroOrden = document.getElementById('editNumeroOrden');
            const editDescripcion = document.getElementById('editDescripcionModal');
            const editPresentador = document.getElementById('editPresentador');
            const editPartido = document.getElementById('editPartido');
            const editTipoMayoria = document.getElementById('editTipoMayoria');
            const editRequiereVotacion = document.getElementById('editRequiereVotacion');
            const editIndexHidden = document.getElementById('editIndexHidden');
            
            if (editNumeroSistema) editNumeroSistema.value = init.numero_sistema;
            if (editNumeroOrden) editNumeroOrden.value = init.numero_orden_dia || '';
            if (editDescripcion) editDescripcion.value = init.descripcion || '';
            if (editPresentador) editPresentador.value = init.presentador || '';
            if (editPartido) editPartido.value = init.partido || '';
            if (editTipoMayoria) editTipoMayoria.value = init.tipo_mayoria || 'simple';
            if (editRequiereVotacion) editRequiereVotacion.checked = init.requiere_votacion || false;
            if (editIndexHidden) editIndexHidden.value = index;
            
            const modalEl = document.getElementById('modalEditarIniciativa');
            if (modalEl) {
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            }
        }
        
        // Mostrar vista previa antes de confirmar
        function mostrarVistaPrevia() {
            const iniciativasSeleccionadas = iniciativasValidacion.filter(i => i.seleccionada);
            const votables = iniciativasSeleccionadas.filter(i => i.requiere_votacion);
            
            let mensaje = `Vista Previa de Importaci√≥n:\n\n`;
            mensaje += `Total seleccionadas: ${iniciativasSeleccionadas.length}\n`;
            mensaje += `Requieren votaci√≥n: ${votables.length}\n`;
            mensaje += `A comisiones: ${iniciativasSeleccionadas.filter(i => i.tipo_votacion && i.tipo_votacion.toLowerCase().includes('comisi√≥n')).length}\n`;
            mensaje += `\n¬øProceder con la importaci√≥n?`;
            
            if (confirm(mensaje)) {
                guardarIniciativasSeleccionadas();
            }
        }
        
        // Funci√≥n para guardar iniciativas seleccionadas - MOVIDA M√ÅS ABAJO
        /* COMENTADA - FUNCI√ìN DUPLICADA
        async function guardarIniciativasSeleccionadas() {
            console.log('=== INICIANDO GUARDADO DE INICIATIVAS ===');
            console.log('Iniciativas en validaci√≥n:', iniciativasValidacion);
            console.log('Session ID actual:', sessionIdActual);
            
            // Validar que tengamos datos
            if (!iniciativasValidacion || iniciativasValidacion.length === 0) {
                alert('No hay iniciativas para importar');
                return;
            }
            
            if (!sessionIdActual) {
                alert('Error: No hay una sesi√≥n activa. Por favor recarga la p√°gina.');
                return;
            }
            
            // Verificar el modo de importaci√≥n
            const importarTodas = document.getElementById('importarTodasSwitch')?.checked ?? false;
            console.log('Modo importar todas:', importarTodas);
            
            let iniciativasAImportar = [];
            let iniciativasParaVotacion = [];
            
            if (importarTodas) {
                // Importar TODAS las iniciativas del documento
                iniciativasAImportar = [...iniciativasValidacion];
                // Las seleccionadas se marcan para votaci√≥n
                iniciativasParaVotacion = iniciativasValidacion.filter(i => i.seleccionada);
                
                // Marcar cu√°les van a votaci√≥n y asegurar categor√≠as correctas
                iniciativasAImportar.forEach(init => {
                    init.marcada_para_votacion = init.seleccionada;
                    
                    // Asegurar que cada iniciativa tenga su categor√≠a correcta
                    if (!init.categoria) {
                        // Determinar categor√≠a bas√°ndose en el tipo
                        if (init.tipo_votacion === 'votacion_dictamen' || init.tipo === 'segunda_lectura') {
                            init.categoria = 'segunda_lectura';
                            init.requiere_votacion = true;
                        } else if (init.tipo === 'primera_lectura') {
                            init.categoria = 'primera_lectura';
                            init.requiere_votacion = false;
                        } else if (init.tipo === 'punto_acuerdo' || init.tipo_votacion === 'punto_acuerdo') {
                            init.categoria = 'puntos_acuerdo';
                            init.requiere_votacion = true;
                        } else if (init.tipo === 'iniciativa' || init.tipo_votacion === 'turno_comision') {
                            init.categoria = 'iniciativas';
                            init.requiere_votacion = false;
                        } else if (init.tipo === 'dictamen' || init.tipo_votacion === 'votacion_dictamen') {
                            init.categoria = 'dictamenes';
                            init.requiere_votacion = true;
                        }
                    }
                    
                    // Si est√° seleccionada y es de una categor√≠a votable, marcar para votaci√≥n
                    if (init.seleccionada && 
                        (init.categoria === 'segunda_lectura' || 
                         init.categoria === 'puntos_acuerdo' || 
                         init.categoria === 'dictamenes' ||
                         init.categoria === 'urgente')) {
                        init.requiere_votacion = true;
                    }
                });
                
                console.log(`Importando TODAS las ${iniciativasAImportar.length} iniciativas`);
                console.log(`${iniciativasParaVotacion.length} marcadas para votaci√≥n`);
            } else {
                // Solo importar las seleccionadas
                const iniciativasSeleccionadas = iniciativasValidacion.filter(i => i.seleccionada);
                iniciativasAImportar = iniciativasSeleccionadas;
                iniciativasParaVotacion = iniciativasSeleccionadas;
                
                if (iniciativasAImportar.length === 0) {
                    alert('Por favor selecciona al menos una iniciativa para importar');
                    return;
                }
                
                console.log(`Importando solo ${iniciativasAImportar.length} iniciativas seleccionadas`);
            }
            
            // Obtener el tipo de carga seleccionado
            let tipoCarga = 'indefinida'; // Por defecto
            let fechaProgramada = null;
            
            if (document.getElementById('cargaInmediataVal') && document.getElementById('cargaInmediataVal').checked) {
                tipoCarga = 'inmediata';
            } else if (document.getElementById('cargaProgramadaVal') && document.getElementById('cargaProgramadaVal').checked) {
                tipoCarga = 'programada';
                const fechaInput = document.getElementById('fechaSesionVal');
                if (fechaInput && fechaInput.value) {
                    fechaProgramada = fechaInput.value;
                } else {
                    alert('Por favor selecciona una fecha para la sesi√≥n programada');
                    return;
                }
            }
            
            try {
                console.log('Iniciando proceso de guardado...');
                console.log('Iniciativas a importar:', iniciativasAImportar.length);
                console.log('Tipo de carga:', tipoCarga);
                console.log('Fecha programada:', fechaProgramada);
                
                // Mostrar loading
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'alert alert-info position-fixed top-0 end-0 m-3';
                loadingDiv.style.zIndex = '9999';
                loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando iniciativas...';
                document.body.appendChild(loadingDiv);
                
                // Llamar al API para guardar en la base de datos
                const url = `/api/validacion/validar-sesion/${sessionIdActual}`;
                console.log('URL de la API:', url);
                
                const bodyData = {
                    tipoCarga: tipoCarga,
                    fechaProgramada: fechaProgramada,
                    iniciativasSeleccionadas: iniciativasAImportar,
                    modoImportacion: importarTodas ? 'todas' : 'seleccionadas',
                    iniciativasVotacion: iniciativasParaVotacion.map(i => i.numero)
                };
                console.log('Datos a enviar:', bodyData);
                
                // Verificar que las descripciones completas se est√°n enviando
                if (iniciativasAImportar.length > 0) {
                    console.log('Primera iniciativa - descripci√≥n completa:');
                    console.log('Longitud:', iniciativasAImportar[0].descripcion?.length || 0);
                    console.log('Contenido:', iniciativasAImportar[0].descripcion);
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bodyData)
                });
                
                console.log('Respuesta recibida:', response.status, response.ok);
                
                // Remover loading
                loadingDiv.remove();
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al guardar las iniciativas');
                }
                
                const data = await response.json();
                
                // Cerrar modal de validaci√≥n (Apple o Bootstrap)
                const modalApple = document.getElementById('modalValidacionApple');
                if (modalApple && modalApple.style.display !== 'none') {
                    cerrarModalApple();
                } else {
                    const modalEl = document.getElementById('modalValidacion');
                    if (modalEl && typeof bootstrap !== 'undefined') {
                        const modalInstance = bootstrap.Modal.getInstance(modalEl);
                        if (modalInstance) modalInstance.hide();
                    }
                }
                
                // Mostrar mensaje de √©xito
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
                alertDiv.style.zIndex = '9999';
                let mensajeImportacion = '';
                if (importarTodas) {
                    mensajeImportacion = `
                        <strong>‚úÖ Importaci√≥n exitosa</strong><br>
                        Se importaron TODAS las ${iniciativasAImportar.length} iniciativas del documento.<br>
                        <span class="badge bg-warning text-dark">${iniciativasParaVotacion.length} marcadas para votaci√≥n</span><br>
                        <small>Sesi√≥n: ${data.sesion?.nombre || 'Nueva sesi√≥n'}</small>
                    `;
                } else {
                    mensajeImportacion = `
                        <strong>‚úÖ Importaci√≥n exitosa</strong><br>
                        Se importaron ${iniciativasAImportar.length} iniciativas seleccionadas.<br>
                        <small>Sesi√≥n: ${data.sesion?.nombre || 'Nueva sesi√≥n'}</small>
                    `;
                }
                alertDiv.innerHTML = mensajeImportacion + `<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                document.body.appendChild(alertDiv);
                
                setTimeout(() => alertDiv.remove(), 5000);
                
                // Recargar las sesiones pendientes y la sesi√≥n activa
                if (typeof loadSesionesPendientes === 'function') {
                    loadSesionesPendientes();
                }
                
                if (typeof loadActiveSession === 'function') {
                    loadActiveSession();
                }
                
                // SIEMPRE recargar la p√°gina despu√©s de importar para mostrar las iniciativas correctamente
                console.log('Recargando p√°gina despu√©s de importar iniciativas...');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('=== ERROR AL GUARDAR INICIATIVAS ===');
                console.error('Error completo:', error);
                console.error('Stack:', error.stack);
                console.error('Mensaje:', error.message);
                
                // Mostrar error m√°s detallado
                alert(`Error al importar las iniciativas:\n\nError: ${error.message}\n\nRevisa la consola para m√°s detalles.`);
                
                // Remover loading si existe
                const loadingDivs = document.querySelectorAll('.alert.alert-info.position-fixed');
                loadingDivs.forEach(div => div.remove());
            }
        }
        FIN DE FUNCI√ìN DUPLICADA */
        
        // Funciones de selecci√≥n de iniciativas
        function toggleIniciativaSeleccion(index) {
            iniciativasValidacion[index].seleccionada = !iniciativasValidacion[index].seleccionada;
            actualizarContadorSeleccionadas();
        }
        
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) {
                const checked = selectAll.checked;
                iniciativasValidacion.forEach(init => {
                    init.seleccionada = checked;
                });
                renderizarTablaValidacion(iniciativasValidacion);
            }
        }
        
        function seleccionarTodasVotables() {
            iniciativasValidacion.forEach(init => {
                if (init.requiere_votacion) {
                    init.seleccionada = true;
                }
            });
            renderizarTablaValidacion(iniciativasValidacion);
        }
        
        function seleccionarTodas() {
            iniciativasValidacion.forEach(init => {
                init.seleccionada = true;
            });
            renderizarTablaValidacion(iniciativasValidacion);
        }
        
        function deseleccionarTodas() {
            iniciativasValidacion.forEach(init => {
                init.seleccionada = false;
            });
            renderizarTablaValidacion(iniciativasValidacion);
        }
        
        // Nueva funci√≥n para seleccionar solo las recomendadas por el sistema
        function seleccionarRecomendadas() {
            let contadorRecomendadas = 0;
            iniciativasValidacion.forEach(init => {
                // Seleccionar si el sistema lo recomienda para votaci√≥n
                const debeSeleccionar = init.recomendado_para_votacion || init.requiere_votacion || false;
                if (debeSeleccionar) {
                    contadorRecomendadas++;
                    init.seleccionada = true;
                } else {
                    init.seleccionada = false;
                }
            });
            renderizarTablaValidacion(iniciativasValidacion);
            mostrarNotificacion(`Se han seleccionado ${contadorRecomendadas} iniciativas recomendadas por el sistema`, 'info');
        }
        
        // Funci√≥n para mostrar modal de validaci√≥n
        async function mostrarValidacionPDF(file) {
            console.log('Funci√≥n mostrarValidacionPDF llamada con archivo:', file.name);
            
            // Guardar el archivo PDF para el visor
            pdfActual = file;
            
            const formData = new FormData();
            formData.append('file', file);
            
            // Mostrar loading
            const statusDiv = document.getElementById('uploadStatus');
            if (statusDiv) {
                statusDiv.innerHTML = '<div class="alert alert-info">Procesando PDF para validaci√≥n...</div>';
            }
            
            try {
                console.log('Enviando a /api/validacion/preview-pdf');
                const response = await fetch('/api/validacion/preview-pdf', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                console.log('Respuesta recibida:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error del servidor:', errorText);
                    alert('Error al procesar el PDF: ' + response.status);
                    return;
                }
                
                const data = await response.json();
                console.log('=== DATOS RECIBIDOS DEL SERVIDOR ===');
                console.log('Success:', data.success);
                console.log('SessionId:', data.sessionId);
                console.log('N√∫mero de iniciativas:', data.iniciativas?.length || 0);
                console.log('Primera iniciativa:', data.iniciativas?.[0]);
                
                if (data.success) {
                    sessionIdActual = data.sessionId;
                    iniciativasValidacion = data.iniciativas || [];
                    
                    console.log(`Frontend recibi√≥ ${iniciativasValidacion.length} iniciativas`);
                    console.log(`Total elementos reportados: ${data.totalElementos}`);
                    
                    // Verificar estructura de las iniciativas
                    if (iniciativasValidacion.length > 0) {
                        console.log('Estructura de iniciativa ejemplo:');
                        const ejemplo = iniciativasValidacion[0];
                        console.log('- numero_sistema:', ejemplo.numero_sistema);
                        console.log('- titulo:', ejemplo.titulo);
                        console.log('- descripcion:', ejemplo.descripcion);
                        console.log('- contenido:', ejemplo.contenido);
                        console.log('- categoria:', ejemplo.categoria);
                        console.log('- requiere_votacion:', ejemplo.requiere_votacion);
                        
                        // Contar por categor√≠as
                        const categorias = {};
                        iniciativasValidacion.forEach(i => {
                            categorias[i.categoria] = (categorias[i.categoria] || 0) + 1;
                        });
                        console.log('Iniciativas por categor√≠a:', categorias);
                    }
                    
                    iniciativasOriginales = [...iniciativasValidacion]; // Guardar copia
                    filtroActual = 'todas'; // Resetear filtro
                    
                    console.log('Iniciativas para validaci√≥n:', iniciativasValidacion.length);
                    
                    // Actualizar estad√≠sticas
                    actualizarEstadisticasValidacion();
                    
                    // Renderizar tabla
                    renderizarTablaValidacion(iniciativasValidacion);
                    
                    // Limpiar filtro activo
                    const filtroActivoEl = document.getElementById('filtroActivo');
                    if (filtroActivoEl) {
                        filtroActivoEl.style.display = 'none';
                    }
                    
                    // Mostrar modal APPLE en lugar del de Bootstrap
                    console.log('Mostrando modal Apple de validaci√≥n...');
                    
                    // Usar el nuevo modal Apple
                    abrirModalApple();
                    console.log('Modal Apple abierto');
                    
                    // Ya no usamos Bootstrap - c√≥digo comentado del modal anterior
                    /* C√≥digo del modal Bootstrap anterior - ya no se usa
                    const modalElement = document.getElementById('modalValidacion');
                    if (modalElement) {
                        console.log('Elemento del modal encontrado, creando instancia de Bootstrap...');
                        try {
                            const modal = new bootstrap.Modal(modalElement, {
                                backdrop: 'static',
                                keyboard: false
                            });
                            modal.show();
                            console.log('Modal mostrado exitosamente');
                            
                            // Configurar el bot√≥n de guardar cuando el modal se muestre
                            setTimeout(() => {
                                const btnGuardarModal = document.getElementById('btnGuardarValidacion');
                                if (btnGuardarModal) {
                                    console.log('Configurando bot√≥n guardar del modal...');
                                    
                                    // Remover cualquier onclick existente
                                    btnGuardarModal.onclick = null;
                                    
                                    // Agregar nuevo evento
                                    btnGuardarModal.onclick = function(event) {
                                        console.log('>>> CLICK DIRECTO EN BOT√ìN (onclick) <<<');
                                        event.preventDefault();
                                        event.stopPropagation();
                                        
                                        // Deshabilitar bot√≥n
                                        this.disabled = true;
                                        const originalHTML = this.innerHTML;
                                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                                        
                                        // Llamar a la funci√≥n
                                        try {
                                            guardarIniciativasSeleccionadas();
                                        } catch (error) {
                                            console.error('Error:', error);
                                            this.disabled = false;
                                            this.innerHTML = originalHTML;
                                        }
                                        
                                        return false;
                                    };
                                    
                                    console.log('Bot√≥n configurado con onclick directo');
                                } else {
                                    console.error('Bot√≥n guardar no encontrado en el modal');
                                }
                            }, 500);
                            
                        } catch (modalError) {
                            console.error('Error al crear/mostrar el modal:', modalError);
                            alert('Error al mostrar el modal de validaci√≥n');
                        }
                    } else {
                        console.error('No se encontr√≥ el elemento del modal con ID: modalValidacion');
                        alert('Error: No se encontr√≥ el modal de validaci√≥n en la p√°gina');
                    }
                    */
                } else {
                    alert('Error al procesar el PDF: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al procesar el PDF');
            }
        }
        
        // Cargar sesi√≥n activa
        // Funci√≥n para obtener la clase CSS del partido
        function getPartidoBadgeClass(partido) {
            if (!partido) return '';
            const partidoLower = partido.toLowerCase().replace(/\s+/g, '-');
            
            const partidoClasses = {
                'morena': 'badge-morena',
                'pan': 'badge-pan',
                'pri': 'badge-pri',
                'pt': 'badge-pt',
                'pvem': 'badge-pvem',
                'mc': 'badge-mc',
                'nueva-alianza': 'badge-nueva-alianza',
                'nueva-alianza-morelos': 'badge-nueva-alianza-morelos'
            };
            
            return partidoClasses[partidoLower] || '';
        }
        
        async function loadActiveSession() {
            try {
                const response = await fetch('/api/operador/sesion-activa', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                console.log('=== DATOS DE SESI√ìN ACTIVA ===');
                console.log('Sesi√≥n:', data.sesion);
                console.log('N√∫mero de iniciativas:', data.iniciativas?.length || 0);
                
                if (data.sesion) {
                    document.getElementById('sessionStatus').innerHTML = `
                        <strong>Sesi√≥n:</strong> ${data.sesion.nombre}<br>
                        <strong>Fecha:</strong> ${new Date(data.sesion.fecha).toLocaleDateString()}<br>
                        <strong>Iniciativas:</strong> ${data.iniciativas.length}
                    `;
                    
                    // Iniciar cron√≥metro si la sesi√≥n est√° activa
                    if (data.sesion.fecha_inicio && !data.sesion.fecha_clausura) {
                        sessionStartTime = new Date(data.sesion.fecha_inicio).getTime();
                        startSessionTimer();
                    }
                    
                    displayInitiatives(data.iniciativas, data.textoOriginal);
                } else {
                    document.getElementById('sessionStatus').innerHTML = 
                        '<p class="text-muted">Sin sesi√≥n activa</p>';
                    document.getElementById('initiativesList').innerHTML = 
                        '<p class="text-muted text-center">No hay iniciativas cargadas</p>';
                    
                    // Ocultar cron√≥metro si no hay sesi√≥n
                    document.getElementById('sessionTimerContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Mostrar iniciativas con pesta√±as din√°micas
        function displayInitiatives(initiatives, textoOriginal = null) {
            console.log('=== MOSTRANDO INICIATIVAS ===');
            console.log('Total de iniciativas recibidas:', initiatives.length);
            if (initiatives.length > 0) {
                console.log('Primera iniciativa:', initiatives[0]);
                console.log('Categor√≠as encontradas:', [...new Set(initiatives.map(i => i.categoria))]);
            }
            
            // Mostrar/ocultar bot√≥n de notificar si hay iniciativas
            const notificarContainer = document.getElementById('notificarMesaContainer');
            if (notificarContainer) {
                notificarContainer.style.display = initiatives.length > 0 ? 'block' : 'none';
            }
            
            if (initiatives.length === 0) {
                document.getElementById('initiativesList').innerHTML = '<p class="text-muted text-center">No hay iniciativas</p>';
                document.getElementById('initiativesTabs').style.display = 'none';
                return;
            }
            
            // Categorizar iniciativas
            const categorias = categorizarIniciativas(initiatives);
            
            // Agregar texto original si est√° disponible
            if (textoOriginal) {
                categorias.textoOriginal = textoOriginal;
            }
            
            // Mostrar pesta√±as
            mostrarPestanas(categorias);
            
            // Mostrar contenido de la pesta√±a activa
            mostrarContenidoPestanas(categorias);
        }
        
        // Funci√≥n para escapar HTML
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // ========== FUNCIONES PARA EL MODAL ESTILO APPLE ==========
        
        // Abrir modal Apple
        function abrirModalApple() {
            console.log('Abriendo modal estilo Apple...');
            const modal = document.getElementById('modalValidacionApple');
            if (modal) {
                modal.style.display = 'block';
                // Animar entrada
                setTimeout(() => {
                    modal.style.opacity = '1';
                }, 10);
                
                // Actualizar estad√≠sticas
                actualizarEstadisticasValidacion();
                
                // Renderizar tabla
                renderizarTablaValidacion(iniciativasValidacion);
                
                // Configurar eventos de tipo de carga
                configurarEventosTipoCarga();
                
                // Resetear el visor de PDF (oculto por defecto)
                const visorContainer = document.getElementById('visorPDFContainerApple');
                const validacionContainer = document.getElementById('validacionContainerApple');
                if (visorContainer) {
                    visorContainer.style.display = 'none';
                }
                if (validacionContainer) {
                    validacionContainer.style.width = '100%';
                }
            }
        }
        
        // Cerrar modal Apple
        function cerrarModalApple() {
            console.log('Cerrando modal Apple...');
            const modal = document.getElementById('modalValidacionApple');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
                
                // Limpiar el visor de PDF
                const pdfViewer = document.getElementById('pdfViewerApple');
                if (pdfViewer && pdfViewer.src) {
                    URL.revokeObjectURL(pdfViewer.src);
                    pdfViewer.src = '';
                }
            }
        }
        
        // Toggle visor PDF Apple
        function toggleVisorPDFApple() {
            const visorContainer = document.getElementById('visorPDFContainerApple');
            const validacionContainer = document.getElementById('validacionContainerApple');
            
            if (!visorContainer || !validacionContainer) {
                console.error('No se encontraron los contenedores del visor PDF');
                return;
            }
            
            if (visorContainer.style.display === 'none' || !visorContainer.style.display) {
                // Mostrar visor PDF
                visorContainer.style.display = 'flex';
                validacionContainer.style.width = '50%';
                
                // Si hay un PDF cargado, mostrarlo
                if (pdfActual) {
                    const pdfURL = URL.createObjectURL(pdfActual);
                    const pdfViewer = document.getElementById('pdfViewerApple');
                    if (pdfViewer) {
                        pdfViewer.src = pdfURL;
                    }
                }
            } else {
                // Ocultar visor PDF
                cerrarVisorPDFApple();
            }
        }
        
        // Cerrar visor PDF Apple
        function cerrarVisorPDFApple() {
            const visorContainer = document.getElementById('visorPDFContainerApple');
            const validacionContainer = document.getElementById('validacionContainerApple');
            
            if (visorContainer) {
                visorContainer.style.display = 'none';
            }
            if (validacionContainer) {
                validacionContainer.style.width = '100%';
            }
        }
        
        // Configurar eventos de tipo de carga
        function configurarEventosTipoCarga() {
            const cargaProgramada = document.getElementById('cargaProgramadaVal');
            const cargaInmediata = document.getElementById('cargaInmediataVal');
            const cargaIndefinida = document.getElementById('cargaIndefinidaVal');
            const fechaProgramada = document.getElementById('fechaProgramadaVal');
            
            // Limpiar eventos anteriores para evitar duplicados
            if (cargaProgramada && !cargaProgramada.hasAttribute('data-configured')) {
                cargaProgramada.setAttribute('data-configured', 'true');
                cargaProgramada.addEventListener('change', function() {
                    if (this.checked && fechaProgramada) {
                        fechaProgramada.style.display = 'block';
                        const now = new Date();
                        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                        const fechaSesionVal = document.getElementById('fechaSesionVal');
                        if (fechaSesionVal) {
                            fechaSesionVal.min = now.toISOString().slice(0, 16);
                            fechaSesionVal.required = true;
                        }
                    }
                });
            }
            
            if (cargaInmediata && !cargaInmediata.hasAttribute('data-configured')) {
                cargaInmediata.setAttribute('data-configured', 'true');
                cargaInmediata.addEventListener('change', function() {
                    if (this.checked && fechaProgramada) {
                        fechaProgramada.style.display = 'none';
                    }
                });
            }
            
            if (cargaIndefinida && !cargaIndefinida.hasAttribute('data-configured')) {
                cargaIndefinida.setAttribute('data-configured', 'true');
                cargaIndefinida.addEventListener('change', function() {
                    if (this.checked && fechaProgramada) {
                        fechaProgramada.style.display = 'none';
                    }
                });
            }
        }
        
        // Vista previa Apple
        function vistaPreviewApple() {
            console.log('Vista previa Apple ejecutada');
            const seleccionadas = iniciativasValidacion.filter(i => i.seleccionada);
            alert(`Vista Previa\n\nTotal: ${iniciativasValidacion.length} iniciativas\nSeleccionadas: ${seleccionadas.length}\n\nAqu√≠ se mostrar√≠a el preview...`);
        }
        
        // Confirmar carga Apple
        function confirmarCargaApple() {
            console.log('\n=== CONFIRMAR CARGA APPLE ===');
            console.log('Bot√≥n Apple funcionando correctamente!');
            console.log('Iniciativas:', iniciativasValidacion);
            
            if (!iniciativasValidacion || iniciativasValidacion.length === 0) {
                alert('No hay iniciativas para cargar');
                return;
            }
            
            const seleccionadas = iniciativasValidacion.filter(i => i.seleccionada).length;
            
            if (seleccionadas === 0) {
                alert('Por favor selecciona al menos una iniciativa para cargar');
                return;
            }
            
            if (confirm(`¬øConfirmar la carga?\n\nTotal: ${iniciativasValidacion.length}\nSeleccionadas para votaci√≥n: ${seleccionadas}`)) {
                console.log('Procediendo con la carga...');
                // NO cerrar el modal aqu√≠ - se cerrar√° autom√°ticamente en guardarIniciativasSeleccionadas
                
                // Llamar a la funci√≥n de guardado
                try {
                    guardarIniciativasSeleccionadas();
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al guardar: ' + error.message);
                }
            }
        }
        
        // Actualizar contenido del modal Apple
        function actualizarContenidoModalApple() {
            const bodyEl = document.getElementById('modalBodyApple');
            const contadorEl = document.getElementById('contadorApple');
            
            if (!iniciativasValidacion || iniciativasValidacion.length === 0) {
                if (bodyEl) {
                    bodyEl.innerHTML = `
                        <div style="background: white; border-radius: 12px; padding: 40px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <p style="color: #8e8e93; font-size: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                                No hay iniciativas cargadas
                            </p>
                        </div>
                    `;
                }
                return;
            }
            
            const seleccionadas = iniciativasValidacion.filter(i => i.seleccionada).length;
            
            if (contadorEl) {
                contadorEl.textContent = `${seleccionadas} de ${iniciativasValidacion.length} iniciativas seleccionadas`;
            }
            
            if (bodyEl) {
                // Crear tabla simplificada estilo iOS
                let html = `
                    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <table style="width: 100%; border-collapse: collapse; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                            <thead>
                                <tr style="background: #f2f2f7; border-bottom: 1px solid #e5e5ea;">
                                    <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #8e8e93; text-transform: uppercase;">Sel.</th>
                                    <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #8e8e93; text-transform: uppercase;">N√∫m.</th>
                                    <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #8e8e93; text-transform: uppercase;">Descripci√≥n</th>
                                    <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #8e8e93; text-transform: uppercase;">Categor√≠a</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                iniciativasValidacion.forEach((init, index) => {
                    const descripcion = init.descripcion || init.contenido || init.titulo || 'Sin descripci√≥n';
                    const descripcionCorta = descripcion.length > 60 ? descripcion.substring(0, 60) + '...' : descripcion;
                    
                    // Determinar si requiere votaci√≥n
                    const requiereVotacion = init.requiere_votacion || false;
                    
                    // Estilo de fila con fondo verde claro para elementos votables
                    const rowStyle = requiereVotacion ? 
                        'border-bottom: 1px solid #f2f2f7; background-color: #f0fdf4; border-left: 4px solid #34c759;' : 
                        'border-bottom: 1px solid #f2f2f7;';
                    
                    // Mostrar n√∫mero dual si existe
                    const numeroDisplay = init.numero_seccion ? 
                        `${init.numero_general}/${init.numero_seccion}` : 
                        (index + 1).toString();
                    
                    // Determinar etiqueta de categor√≠a con colores apropiados
                    let categoriaLabel = '';
                    let categoriaColor = '#f2f2f7';
                    let textColor = '#8e8e93';
                    
                    if (init.categoria === 'dictamenes' || requiereVotacion) {
                        categoriaLabel = 'DICT√ÅMEN ‚ö°';
                        categoriaColor = '#34c759';
                        textColor = 'white';
                    } else if (init.categoria === 'segunda_lectura') {
                        categoriaLabel = 'DICTAMEN 2da ‚ö°';
                        categoriaColor = '#34c759';
                        textColor = 'white';
                    } else if (init.categoria === 'puntos_acuerdo') {
                        categoriaLabel = 'P. ACUERDO';
                        categoriaColor = '#007aff';
                        textColor = 'white';
                    } else if (init.categoria === 'primera_lectura') {
                        categoriaLabel = 'DICTAMEN 1era';
                        categoriaColor = '#ff9500';
                        textColor = 'white';
                    } else if (init.categoria === 'iniciativas') {
                        categoriaLabel = 'INICIATIVA';
                        categoriaColor = '#5856d6';
                        textColor = 'white';
                    } else {
                        categoriaLabel = (init.categoria || 'general').toUpperCase();
                    }
                    
                    html += `
                        <tr style="${rowStyle}">
                            <td style="padding: 12px;">
                                <input type="checkbox" 
                                       ${init.seleccionada ? 'checked' : ''}
                                       onchange="toggleIniciativaApple(${index})"
                                       style="width: 18px; height: 18px; cursor: pointer;">
                            </td>
                            <td style="padding: 12px; color: #1c1c1e; font-size: 14px; font-weight: 600;">${numeroDisplay}</td>
                            <td style="padding: 12px; color: #3c3c43; font-size: 14px;">
                                ${descripcionCorta}
                                ${requiereVotacion ? '<span style="color: #34c759; font-weight: 600;"> [‚úì Votaci√≥n]</span>' : ''}
                            </td>
                            <td style="padding: 12px;">
                                <span style="
                                    display: inline-block;
                                    padding: 4px 8px;
                                    border-radius: 6px;
                                    font-size: 11px;
                                    font-weight: 600;
                                    background: ${categoriaColor};
                                    color: ${textColor};
                                ">
                                    ${categoriaLabel}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                bodyEl.innerHTML = html;
            }
        }
        
        // Toggle iniciativa en modal Apple
        function toggleIniciativaApple(index) {
            if (iniciativasValidacion[index]) {
                iniciativasValidacion[index].seleccionada = !iniciativasValidacion[index].seleccionada;
                actualizarContenidoModalApple();
            }
        }
        
        // ========== FIN FUNCIONES MODAL APPLE ==========
        
        // Funci√≥n simple y directa para ejecutar el guardado
        function ejecutarGuardado() {
            console.log('\n\n=== EJECUTAR GUARDADO LLAMADO ===');
            console.log('Fecha/Hora:', new Date().toISOString());
            
            // Verificaci√≥n b√°sica
            if (!iniciativasValidacion || iniciativasValidacion.length === 0) {
                alert('No hay iniciativas cargadas. Por favor, importa un PDF primero.');
                return;
            }
            
            // Contar seleccionadas
            const seleccionadas = iniciativasValidacion.filter(i => i.seleccionada).length;
            const total = iniciativasValidacion.length;
            
            // Confirmaci√≥n simple
            const mensaje = `\u00bfConfirmar importaci√≥n?\n\nTotal: ${total} iniciativas\nSeleccionadas para votaci√≥n: ${seleccionadas}`;
            
            if (!confirm(mensaje)) {
                console.log('Cancelado por el usuario');
                return;
            }
            
            console.log('Confirmado, procediendo con el guardado...');
            
            // Llamar a la funci√≥n principal
            try {
                guardarIniciativasSeleccionadas();
            } catch (error) {
                console.error('ERROR AL LLAMAR guardarIniciativasSeleccionadas:', error);
                alert('Error: ' + error.message);
            }
        }
        
        // Funci√≥n para mostrar notificaciones
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const alertDiv = document.createElement('div');
            const bgColor = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[tipo] || 'alert-info';
            
            alertDiv.className = `alert ${bgColor} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-remover despu√©s de 3 segundos
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        // Funci√≥n para copiar texto original al portapapeles
        function copiarTextoOriginal() {
            const textoElement = document.getElementById('textoOriginalContent');
            if (textoElement) {
                const texto = textoElement.textContent;
                navigator.clipboard.writeText(texto).then(() => {
                    mostrarNotificacion('Texto copiado al portapapeles', 'success');
                }).catch(err => {
                    console.error('Error al copiar:', err);
                    mostrarNotificacion('Error al copiar el texto', 'danger');
                });
            }
        }
        
        // Funci√≥n para ver PDF desde Documento Original
        async function verPDFDocumentoOriginal() {
            if (!sessionData || !sessionData.id) {
                mostrarNotificacion('No hay sesi√≥n activa', 'warning');
                return;
            }
            
            try {
                // Obtener el PDF del servidor
                const response = await fetch(`/api/sesiones/${sessionData.id}/orden-dia-pdf`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('No se pudo obtener el PDF');
                }
                
                const blob = await response.blob();
                const pdfURL = URL.createObjectURL(blob);
                
                // Abrir modal con el PDF
                abrirModalPDF(pdfURL, 'Orden del D√≠a - Documento Original');
                
            } catch (error) {
                console.error('Error al obtener PDF:', error);
                mostrarNotificacion('Error al cargar el PDF', 'danger');
            }
        }
        
        // Funci√≥n gen√©rica para abrir modal con PDF
        function abrirModalPDF(pdfURL, titulo = 'Documento PDF') {
            // Crear modal si no existe
            let modal = document.getElementById('modalPDFViewer');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modalPDFViewer';
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-xl" style="max-width: 90%; height: 90vh;">
                        <div class="modal-content" style="height: 100%;">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-file-pdf text-danger"></i> 
                                    <span id="modalPDFTitle">${titulo}</span>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="cerrarModalPDF()"></button>
                            </div>
                            <div class="modal-body p-0" style="height: calc(100% - 60px);">
                                <iframe id="modalPDFFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                // Actualizar t√≠tulo si el modal ya existe
                document.getElementById('modalPDFTitle').textContent = titulo;
            }
            
            // Establecer la URL del PDF
            document.getElementById('modalPDFFrame').src = pdfURL;
            
            // Mostrar modal
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
        }
        
        // Funci√≥n para cerrar modal PDF
        function cerrarModalPDF() {
            const modal = document.getElementById('modalPDFViewer');
            if (modal) {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // Limpiar iframe
                const frame = document.getElementById('modalPDFFrame');
                if (frame && frame.src) {
                    if (frame.src.startsWith('blob:')) {
                        URL.revokeObjectURL(frame.src);
                    }
                    frame.src = '';
                }
            }
        }
        
        // Variables para el visor de PDF
        let pdfActual = null;
        
        // Funci√≥n para alternar el visor de PDF
        function toggleVisorPDF() {
            const visorContainer = document.getElementById('visorPDFContainer');
            const validacionContainer = document.getElementById('validacionContainer');
            
            if (visorContainer.style.display === 'none') {
                // Mostrar visor PDF
                visorContainer.style.display = 'block';
                validacionContainer.classList.remove('col-md-12');
                validacionContainer.classList.add('col-md-6');
                
                // Cargar el PDF si tenemos uno
                if (pdfActual) {
                    const pdfViewer = document.getElementById('pdfViewer');
                    // Si es un File object, crear URL del blob
                    if (pdfActual instanceof File || pdfActual instanceof Blob) {
                        const url = URL.createObjectURL(pdfActual);
                        pdfViewer.src = url;
                    } else {
                        // Si es un arraybuffer o similar
                        const blob = new Blob([pdfActual], { type: 'application/pdf' });
                        const url = URL.createObjectURL(blob);
                        pdfViewer.src = url;
                    }
                }
            } else {
                cerrarVisorPDF();
            }
        }
        
        // Funci√≥n para cerrar el visor de PDF
        function cerrarVisorPDF() {
            const visorContainer = document.getElementById('visorPDFContainer');
            const validacionContainer = document.getElementById('validacionContainer');
            
            visorContainer.style.display = 'none';
            validacionContainer.classList.remove('col-md-6');
            validacionContainer.classList.add('col-md-12');
            
            // Limpiar el iframe
            const pdfViewer = document.getElementById('pdfViewer');
            if (pdfViewer.src && pdfViewer.src.startsWith('blob:')) {
                URL.revokeObjectURL(pdfViewer.src);
            }
            pdfViewer.src = '';
        }
        
        // Funci√≥n para categorizar iniciativas por tipo con estructura jer√°rquica
        function categorizarIniciativas(initiatives) {
            const categorias = {
                todas: initiatives,
                procedimientos: [],
                dictamenes: [],  // Nueva categor√≠a para dict√°menes
                primeraLectura: [],
                segundaLectura: [],
                urgente: [],  // Nueva categor√≠a para urgente y obvia resoluci√≥n
                puntosAcuerdo: [],
                incisos: [],  // Nueva categor√≠a para incisos
                iniciativas: [],  // Iniciativas gen√©ricas
                otras: [],
                textoOriginal: null  // Para almacenar el texto original del PDF
            };
            
            // Agrupar por inciso principal y categor√≠a
            const incisosMap = {};
            
            initiatives.forEach(init => {
                const titulo = (init.titulo || '').toLowerCase();
                const contenido = (init.contenido || '').toLowerCase();
                const textoCompleto = titulo + ' ' + contenido;
                
                // Usar la categor√≠a asignada por el extractor
                const categoria = init.categoria || '';
                
                // Categorizaci√≥n basada en la categor√≠a del extractor
                // IMPORTANTE: Procesar categor√≠as espec√≠ficas primero antes de verificar requiere_votacion
                if (categoria === 'primera_lectura') {
                    categorias.primeraLectura.push(init);
                    console.log(`‚úÖ Elemento ${init.numero} ‚Üí PRIMERA LECTURA`);
                }
                else if (categoria === 'segunda_lectura') {
                    categorias.segundaLectura.push(init);
                    console.log(`‚úÖ Elemento ${init.numero} ‚Üí SEGUNDA LECTURA`);
                }
                else if (categoria === 'puntos_acuerdo') {
                    categorias.puntosAcuerdo.push(init);
                    console.log(`‚úÖ Elemento ${init.numero} ‚Üí PUNTOS DE ACUERDO`);
                }
                else if (categoria === 'iniciativas') {
                    categorias.iniciativas.push(init);
                    console.log(`‚úÖ Elemento ${init.numero} ‚Üí INICIATIVAS`);
                }
                else if (categoria === 'dictamenes') {
                    // Solo agregar a dict√°menes gen√©ricos si EXPL√çCITAMENTE tiene esa categor√≠a
                    // NO agregar si es primera o segunda lectura
                    categorias.dictamenes.push(init);
                    console.log(`‚úÖ Elemento ${init.numero} ‚Üí DICT√ÅMENES GEN√âRICOS`);
                }
                else if (categoria === 'urgente') {
                    categorias.urgente.push(init);
                    console.log(`‚ö° Elemento ${init.numero} ‚Üí URGENTE Y OBVIA`);
                }
                // Fallback a an√°lisis de texto SOLO si no hay categor√≠a asignada
                else if (!categoria) {
                    console.log(`‚ö†Ô∏è Elemento ${init.numero} sin categor√≠a, analizando texto...`);
                    
                    if (textoCompleto.includes('urgente') && 
                            (textoCompleto.includes('obvia') || textoCompleto.includes('resoluci√≥n'))) {
                        categorias.urgente.push(init);
                    }
                    else if (textoCompleto.includes('primera lectura')) {
                        categorias.primeraLectura.push(init);
                    }
                    else if (textoCompleto.includes('segunda lectura')) {
                        categorias.segundaLectura.push(init);
                    }
                    else if (textoCompleto.includes('dictamen') || textoCompleto.includes('dictamina')) {
                        categorias.dictamenes.push(init);
                    }
                    else if (textoCompleto.includes('punto de acuerdo') || 
                            textoCompleto.includes('puntos de acuerdo')) {
                        categorias.puntosAcuerdo.push(init);
                    }
                    else if (textoCompleto.includes('iniciativa')) {
                        categorias.iniciativas.push(init);
                    }
                }
                else if (init.es_procedimiento) {
                    categorias.procedimientos.push(init);
                }
                else if (init.inciso || /^[a-z]\)|^\([a-z]\)/.test(titulo) || init.es_subinciso) {
                    categorias.incisos.push(init);
                }
                else {
                    categorias.otras.push(init);
                }
                
                // Agrupar por inciso principal para estructura jer√°rquica
                if (init.inciso_principal) {
                    if (!incisosMap[init.inciso_principal]) {
                        incisosMap[init.inciso_principal] = {
                            letra: init.inciso_principal,
                            titulo: init.titulo_seccion || `Inciso ${init.inciso_principal}`,
                            elementos: []
                        };
                    }
                    incisosMap[init.inciso_principal].elementos.push(init);
                }
            });
            
            categorias.estructuraIncisos = Object.values(incisosMap);
            
            return categorias;
        }
        
        // Funci√≥n para mostrar las pesta√±as din√°micas con nueva estructura
        function mostrarPestanas(categorias) {
            const tabsContainer = document.getElementById('initiativesTabs');
            const tabsHtml = [];
            
            // ORDEN FIJO: TODAS, ACTA, INICIATIVAS, PRIMERA LECTURA, SEGUNDA LECTURA, PUNTOS DE ACUERDO, DOCUMENTO ORIGINAL
            
            // 1. TODAS - Siempre mostrar
            tabsHtml.push(`
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="todas-tab" data-bs-toggle="tab" 
                            data-bs-target="#todas" type="button" role="tab">
                        <i class="fas fa-list"></i> TODAS
                        <span class="badge bg-secondary ms-1">${categorias.todas.length}</span>
                    </button>
                </li>
            `);
            
            // 2. ACTA - Aprobaci√≥n del acta (manejable como cualquier iniciativa)
            const actaItems = categorias.todas.filter(i => 
                i.categoria === 'aprobacion_acta' || 
                i.es_aprobacion_acta === true ||
                (i.titulo && i.titulo.toLowerCase().includes('aprobaci√≥n') && 
                 (i.titulo.toLowerCase().includes('acta') || i.titulo.toLowerCase().includes('sesi√≥n')))
            );
            if (actaItems.length > 0) {
                tabsHtml.push(`
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="acta-tab" data-bs-toggle="tab" 
                                data-bs-target="#acta" type="button" role="tab">
                            <i class="fas fa-check-circle"></i> ACTA
                            <span class="badge bg-secondary ms-1">${actaItems.length}</span>
                        </button>
                    </li>
                `);
            }
            
            // 3. INICIATIVAS
            if (categorias.iniciativas.length > 0) {
                tabsHtml.push(`
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="iniciativas-tab" data-bs-toggle="tab" 
                                data-bs-target="#iniciativas" type="button" role="tab">
                            <i class="fas fa-file-alt"></i> INICIATIVAS
                            <span class="badge bg-primary ms-1">${categorias.iniciativas.length}</span>
                        </button>
                    </li>
                `);
            }
            
            // 4. PRIMERA LECTURA
            if (categorias.primeraLectura.length > 0) {
                tabsHtml.push(`
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="primeraLectura-tab" data-bs-toggle="tab" 
                                data-bs-target="#primeraLectura" type="button" role="tab">
                            <i class="fas fa-book-open"></i> PRIMERA LECTURA
                            <span class="badge bg-info ms-1">${categorias.primeraLectura.length}</span>
                        </button>
                    </li>
                `);
            }
            
            // 5. SEGUNDA LECTURA
            if (categorias.segundaLectura.length > 0) {
                tabsHtml.push(`
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="segundaLectura-tab" data-bs-toggle="tab" 
                                data-bs-target="#segundaLectura" type="button" role="tab">
                            <i class="fas fa-book"></i> SEGUNDA LECTURA ‚ö°
                            <span class="badge bg-success ms-1">${categorias.segundaLectura.length}</span>
                        </button>
                    </li>
                `);
            }
            
            // 6. PUNTOS DE ACUERDO
            if (categorias.puntosAcuerdo.length > 0) {
                tabsHtml.push(`
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="puntosAcuerdo-tab" data-bs-toggle="tab" 
                                data-bs-target="#puntosAcuerdo" type="button" role="tab">
                            <i class="fas fa-handshake"></i> PUNTOS DE ACUERDO
                            <span class="badge bg-purple ms-1">${categorias.puntosAcuerdo.length}</span>
                        </button>
                    </li>
                `);
            }
            
            // 7. DOCUMENTO ORIGINAL - Al final
            if (categorias.textoOriginal) {
                tabsHtml.push(`
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="documentoOriginal-tab" data-bs-toggle="tab" 
                                data-bs-target="#documentoOriginal" type="button" role="tab">
                            <i class="fas fa-file-pdf"></i> DOCUMENTO ORIGINAL
                            <span class="badge bg-secondary ms-1"><i class="fas fa-check"></i></span>
                        </button>
                    </li>
                `);
            }
            
            // Otras categor√≠as opcionales (solo si existen y no est√°n vac√≠as)
            
            // Dict√°menes (si hay y no est√°n en segunda lectura)
            if (categorias.dictamenes.length > 0) {
                // Solo mostrar si hay dict√°menes que no est√©n ya en segunda lectura
                const dictamenesUnicos = categorias.dictamenes.filter(d => 
                    !categorias.segundaLectura.some(s => s.descripcion === d.descripcion)
                );
                if (dictamenesUnicos.length > 0) {
                    tabsHtml.push(`
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="dictamenes-tab" data-bs-toggle="tab" 
                                    data-bs-target="#dictamenes" type="button" role="tab">
                                <i class="fas fa-vote-yea"></i> DICT√ÅMENES
                                <span class="badge bg-success ms-1">${dictamenesUnicos.length}</span>
                            </button>
                        </li>
                    `);
                }
            }
            
            // Urgente y Obvia Resoluci√≥n
            if (categorias.urgente.length > 0) {
                tabsHtml.push(`
                    <li class="nav-item" role="presentation">
                        <button class="nav-link text-danger fw-bold" id="urgente-tab" data-bs-toggle="tab" 
                                data-bs-target="#urgente" type="button" role="tab">
                            <i class="fas fa-exclamation-triangle"></i> URGENTE
                            <span class="badge bg-danger ms-1">${categorias.urgente.length}</span>
                        </button>
                    </li>
                `);
            }
            
            tabsContainer.innerHTML = tabsHtml.join('');
            tabsContainer.style.display = 'flex';
        }
        
        // Funci√≥n para mostrar el contenido de las pesta√±as con estructura jer√°rquica
        function mostrarContenidoPestanas(categorias) {
            const contentContainer = document.getElementById('initiativesTabContent');
            const contentHtml = [];
            
            // ORDEN FIJO: TODAS, ACTA, INICIATIVAS, PRIMERA LECTURA, SEGUNDA LECTURA, PUNTOS DE ACUERDO, DOCUMENTO ORIGINAL
            
            // 1. TODAS - Siempre mostrar
            contentHtml.push(`
                <div class="tab-pane fade show active" id="todas" role="tabpanel">
                    <div id="initiativesList">
                        ${renderizarIniciativasJerarquicas(categorias.todas, categorias.estructuraIncisos)}
                    </div>
                </div>
            `);
            
            // 2. ACTA - Aprobaci√≥n del acta (manejable como cualquier iniciativa)
            const actaItemsContent = categorias.todas.filter(i => 
                i.categoria === 'aprobacion_acta' || 
                i.es_aprobacion_acta === true ||
                (i.titulo && i.titulo.toLowerCase().includes('aprobaci√≥n') && 
                 (i.titulo.toLowerCase().includes('acta') || i.titulo.toLowerCase().includes('sesi√≥n')))
            );
            if (actaItemsContent.length > 0) {
                contentHtml.push(`
                    <div class="tab-pane fade" id="acta" role="tabpanel">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-check-circle"></i> 
                            <strong>Aprobaci√≥n del Acta</strong>
                            <br>
                            <small>Si el acta requiere votaci√≥n, m√°rquela y act√≠vela cuando corresponda</small>
                        </div>
                        ${renderizarIniciativas(actaItemsContent)}
                    </div>
                `);
            }
            
            // 3. INICIATIVAS
            if (categorias.iniciativas.length > 0) {
                contentHtml.push(`
                    <div class="tab-pane fade" id="iniciativas" role="tabpanel">
                        <div class="alert alert-primary mb-3">
                            <i class="fas fa-file-alt"></i> 
                            <strong>Iniciativas presentadas para turno a comisiones (NO se votan)</strong>
                        </div>
                        ${renderizarIniciativas(categorias.iniciativas)}
                    </div>
                `);
            }
            
            // 4. PRIMERA LECTURA
            if (categorias.primeraLectura.length > 0) {
                contentHtml.push(`
                    <div class="tab-pane fade" id="primeraLectura" role="tabpanel">
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-book-open"></i> 
                            <strong>Dict√°menes en primera lectura (NO se votan hoy, se votar√°n en pr√≥xima sesi√≥n)</strong>
                        </div>
                        ${renderizarIniciativas(categorias.primeraLectura)}
                    </div>
                `);
            }
            
            // 4. SEGUNDA LECTURA
            if (categorias.segundaLectura.length > 0) {
                contentHtml.push(`
                    <div class="tab-pane fade" id="segundaLectura" role="tabpanel">
                        <div class="alert alert-success mb-3">
                            <i class="fas fa-book-reader"></i> 
                            <strong>‚ö° Dict√°menes en segunda lectura - SE VOTAN HOY</strong>
                        </div>
                        ${renderizarIniciativas(categorias.segundaLectura)}
                    </div>
                `);
            }
            
            // 5. PUNTOS DE ACUERDO
            if (categorias.puntosAcuerdo.length > 0) {
                contentHtml.push(`
                    <div class="tab-pane fade" id="puntosAcuerdo" role="tabpanel">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-handshake"></i> 
                            <strong>‚ö° Puntos de Acuerdo - Los marcados con urgente y obvia resoluci√≥n requieren votaci√≥n</strong>
                        </div>
                        ${renderizarIniciativas(categorias.puntosAcuerdo)}
                    </div>
                `);
            }
            
            // 6. DOCUMENTO ORIGINAL
            if (categorias.textoOriginal) {
                contentHtml.push(`
                    <div class="tab-pane fade" id="documentoOriginal" role="tabpanel">
                        <div class="alert alert-secondary mb-3 d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-file-pdf"></i> 
                                <strong>Documento Original del PDF Importado</strong>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-primary me-2" onclick="verPDFDocumentoOriginal()">
                                    <i class="fas fa-eye"></i> Ver PDF
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copiarTextoOriginal()">
                                    <i class="fas fa-copy"></i> Copiar texto
                                </button>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem; max-height: 600px; overflow-y: auto;" id="textoOriginalContent">${escapeHtml(categorias.textoOriginal)}</pre>
                            </div>
                        </div>
                    </div>
                `);
            }
            
            // Otras categor√≠as adicionales (solo si existen)
            
            // Dict√°menes adicionales (si hay dict√°menes que no est√°n en segunda lectura)
            if (categorias.dictamenes.length > 0) {
                const dictamenesUnicos = categorias.dictamenes.filter(d => 
                    !categorias.segundaLectura.some(s => s.descripcion === d.descripcion)
                );
                if (dictamenesUnicos.length > 0) {
                    contentHtml.push(`
                        <div class="tab-pane fade" id="dictamenes" role="tabpanel">
                            <div class="alert alert-success mb-3">
                                <i class="fas fa-vote-yea"></i> 
                                <strong>‚ö° Dict√°menes adicionales para votaci√≥n</strong>
                            </div>
                            ${renderizarIniciativas(dictamenesUnicos)}
                        </div>
                    `);
                }
            }
            
            // Urgente y Obvia Resoluci√≥n
            if (categorias.urgente.length > 0) {
                contentHtml.push(`
                    <div class="tab-pane fade" id="urgente" role="tabpanel">
                        <div class="alert alert-danger mb-3">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>üö® DE URGENTE Y OBVIA RESOLUCI√ìN - Requieren votaci√≥n inmediata</strong>
                        </div>
                        ${renderizarIniciativas(categorias.urgente)}
                    </div>
                `);
            }
            
            // Procedimientos (si existen)
            if (categorias.procedimientos.length > 0) {
                contentHtml.push(`
                    <div class="tab-pane fade" id="procedimientos" role="tabpanel">
                        <div class="alert alert-dark mb-3">
                            <i class="fas fa-clipboard-list"></i> 
                            <strong>Estructura completa del Orden del D√≠a</strong>
                            ${renderizarEstructuraCompleta(categorias)}
                        </div>
                        ${renderizarIniciativas(categorias.procedimientos)}
                    </div>
                `);
            }
            
            // Incisos
            if (categorias.incisos.length > 0) {
                contentHtml.push(`
                    <div class="tab-pane fade" id="incisos" role="tabpanel">
                        <div class="alert alert-secondary mb-3">
                            <i class="fas fa-list-ol"></i> 
                            <strong>Estructura de incisos del documento</strong>
                        </div>
                        ${renderizarIniciativas(categorias.incisos)}
                    </div>
                `);
            }
            
            contentContainer.innerHTML = contentHtml.join('');
        }
        
        // Nueva funci√≥n para renderizar estructura completa de incisos
        function renderizarEstructuraCompleta(categorias) {
            let html = '<ul class="list-unstyled mt-3">';
            
            // Mapear todos los incisos posibles
            const letras = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'];
            const nombresIncisos = {
                'A': 'Pase de lista',
                'B': 'Declaraci√≥n del qu√≥rum',
                'C': 'Lectura del orden del d√≠a',
                'D': 'Aprobaci√≥n del acta',
                'E': 'Comunicaciones',
                'F': 'Iniciativas',
                'G': 'Dictamen de Primera Lectura',
                'H': 'Dict√°menes de Segunda Lectura',
                'I': 'Propuestas de Puntos de Acuerdo',
                'J': 'Correspondencia',
                'K': 'Asuntos generales',
                'L': 'Clausura de la Sesi√≥n'
            };
            
            letras.forEach(letra => {
                const nombre = nombresIncisos[letra] || `Inciso ${letra}`;
                const tieneContenido = categorias.estructuraIncisos?.some(e => e.letra === letra);
                const referencia = ['F', 'G', 'H', 'I'].includes(letra) ? 
                    `<small class="text-primary ms-2">(Ver pesta√±a correspondiente)</small>` : '';
                
                html += `<li><strong>${letra})</strong> ${nombre} ${referencia}</li>`;
            });
            
            html += '</ul>';
            return html;
        }
        
        // Nueva funci√≥n para renderizar iniciativas con su inciso principal
        function renderizarIniciativasConInciso(initiatives, incisoPrincipal) {
            if (initiatives.length === 0) {
                return '<p class="text-muted text-center">No hay iniciativas en esta categor√≠a</p>';
            }
            
            const titulo = initiatives[0]?.titulo_seccion || `Inciso ${incisoPrincipal}`;
            
            return `
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-folder-open"></i> ${incisoPrincipal}) ${titulo}
                            <span class="badge bg-secondary ms-2">${initiatives.length} elementos</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        ${renderizarIniciativas(initiatives)}
                    </div>
                </div>
            `;
        }
        
        // Nueva funci√≥n para renderizar con estructura jer√°rquica
        function renderizarIniciativasJerarquicas(initiatives, estructuraIncisos) {
            if (!estructuraIncisos || estructuraIncisos.length === 0) {
                return renderizarIniciativas(initiatives);
            }
            
            let html = '';
            
            estructuraIncisos.forEach(inciso => {
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-folder-open"></i> ${inciso.letra}) ${inciso.titulo}
                                <span class="badge bg-secondary ms-2">${inciso.elementos.length} elementos</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            ${renderizarIniciativas(inciso.elementos)}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // Funci√≥n auxiliar para renderizar las iniciativas
        function renderizarIniciativas(initiatives) {
            if (initiatives.length === 0) {
                return '<p class="text-muted text-center">No hay iniciativas en esta categor√≠a</p>';
            }
            
            // Agregar controles de selecci√≥n m√∫ltiple
            let html = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllInitiatives" onchange="toggleSelectAllInitiatives()">
                        <label class="form-check-label" for="selectAllInitiatives">
                            Seleccionar todas
                        </label>
                    </div>
                    <button class="btn btn-danger btn-sm" id="deleteSelectedBtn" style="display: none;" onclick="deleteSelectedInitiatives()">
                        <i class="fas fa-trash"></i> Eliminar seleccionadas (<span id="selectedCount">0</span>)
                    </button>
                </div>
            `;
            
            html += initiatives.map(init => {
                // Determinar si requiere votaci√≥n
                const requiereVotacion = init.requiere_votacion || 
                    (init.tipo_votacion && !init.tipo_votacion.toLowerCase().includes('comisi√≥n'));
                
                // Clase para resaltar si requiere votaci√≥n (borde verde)
                const borderClass = requiereVotacion ? 'border-success border-3' : '';
                const bgClass = requiereVotacion ? 'bg-light-green' : '';
                
                return `
                <div class="card mb-2 initiative-card ${init.activa ? 'active' : ''} ${init.tipo_iniciativa === 'extraordinaria' ? 'extraordinary' : ''} ${borderClass}" 
                     style="${requiereVotacion ? 'background-color: #f0fdf4;' : ''}" 
                     data-id="${init.id}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="d-flex align-items-start">
                                ${!init.activa ? `
                                    <div class="form-check me-3">
                                        <input class="form-check-input initiative-checkbox" type="checkbox" 
                                               value="${init.id}" onchange="updateSelectedCount()">
                                    </div>
                                ` : '<div style="width: 40px;"></div>'}
                                <div>
                                    <h6 class="mb-1">
                                        ${requiereVotacion ? '<i class="fas fa-vote-yea text-success me-2" title="Requiere votaci√≥n"></i>' : ''}
                                        <strong>${init.numero_orden_dia ? `${init.numero}/${init.numero_orden_dia}` : init.numero}.</strong> ${init.descripcion || init.titulo || 'Sin descripci√≥n'}
                                        ${init.tipo_iniciativa === 'extraordinaria' ? '<span class="badge badge-extraordinary ms-2">‚ö° EXTRAORDINARIA</span>' : ''}
                                    </h6>
                                    ${init.presentador ? `
                                        <div class="small mb-1">
                                            <i class="fas fa-user"></i> 
                                            <strong>Presentada por:</strong> ${init.presentador}
                                            ${init.partido_presentador ? `<span class="badge badge-partido ${getPartidoBadgeClass(init.partido_presentador)} ms-1">${init.partido_presentador}</span>` : ''}
                                        </div>
                                    ` : ''}
                                    ${init.incisos && init.incisos.length > 0 ? `
                                        <details class="small mt-1">
                                            <summary style="cursor: pointer;">Ver incisos</summary>
                                            <ul class="mb-0">
                                                ${init.incisos.map(inciso => `<li>${inciso.letra}) ${inciso.texto}</li>`).join('')}
                                            </ul>
                                        </details>
                                    ` : ''}
                                    <span class="badge bg-secondary">${init.tipo_mayoria || 'Simple'}</span>
                                    ${init.activa ? '<span class="badge bg-success ms-1">ACTIVA</span>' : ''}
                                    ${init.cerrada ? '<span class="badge bg-dark ms-1">CERRADA</span>' : ''}
                                </div>
                            </div>
                            <div class="btn-group">
                                ${!init.activa && !init.cerrada ? `
                                    <button class="btn btn-sm btn-success" 
                                            onclick="activateInitiative(${init.id})"
                                            title="Activar iniciativa">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning" 
                                            onclick="editInitiative(${init.id})"
                                            title="Editar iniciativa">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" 
                                            onclick="deleteInitiative(${init.id})"
                                            title="Eliminar iniciativa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                                ${init.activa ? `
                                    <button class="btn btn-sm btn-danger" 
                                            onclick="closeVoting(${init.id})"
                                            title="Cerrar votaci√≥n">
                                        <i class="fas fa-stop"></i> Cerrar
                                    </button>
                                ` : ''}
                                ${init.cerrada && !init.resultado ? `
                                    <button class="btn btn-sm btn-warning" 
                                            onclick="reopenVoting(${init.id})"
                                            title="Reabrir votaci√≥n">
                                        <i class="fas fa-undo"></i> Reabrir
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        ${init.cerrada ? `
                            <div class="mt-2">
                                <small class="text-muted">
                                    Resultado: <strong class="${init.resultado === 'aprobada' ? 'text-success' : 'text-danger'}">
                                        ${init.resultado ? init.resultado.toUpperCase() : 'PENDIENTE'}
                                    </strong> | 
                                    A favor: ${init.votos_favor} | 
                                    En contra: ${init.votos_contra} | 
                                    Abstenci√≥n: ${init.votos_abstencion}
                                </small>
                                ${!init.resultado ? '<br><small class="text-warning"><i class="fas fa-info-circle"></i> Votaci√≥n cerrada temporalmente - puede reabrirse</small>' : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            }).join('');
            
            return html;
        }
        
        // Funciones para selecci√≥n m√∫ltiple de iniciativas en lista principal
        function toggleSelectAllInitiatives() {
            const selectAll = document.getElementById('selectAllInitiatives');
            if (selectAll) {
                const checkboxes = document.querySelectorAll('.initiative-checkbox');
                checkboxes.forEach(cb => cb.checked = selectAll.checked);
                updateSelectedCount();
            }
        }
        
        function updateSelectedCount() {
            const checked = document.querySelectorAll('.initiative-checkbox:checked');
            const count = checked.length;
            
            // Actualizar contador si existe
            const selectedCountEl = document.getElementById('selectedCount');
            if (selectedCountEl) {
                selectedCountEl.textContent = count;
            }
            
            // Actualizar bot√≥n de eliminar si existe
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (deleteBtn) {
                deleteBtn.style.display = count > 0 ? 'block' : 'none';
            }
            
            // Tambi√©n actualizar el contador de la validaci√≥n si existe
            actualizarContadorSeleccionadas();
        }
        
        // Eliminar iniciativas seleccionadas
        async function deleteSelectedInitiatives() {
            const checked = document.querySelectorAll('.initiative-checkbox:checked');
            const ids = Array.from(checked).map(cb => cb.value);
            
            if (ids.length === 0) {
                alert('No hay iniciativas seleccionadas para eliminar');
                return;
            }
            
            // Obtener informaci√≥n sobre las iniciativas a eliminar
            const iniciativasAEliminar = [];
            checked.forEach(checkbox => {
                const card = checkbox.closest('.initiative-card');
                if (card) {
                    const titulo = card.querySelector('h6')?.textContent || 'Sin t√≠tulo';
                    iniciativasAEliminar.push(titulo.substring(0, 50));
                }
            });
            
            const mensaje = `¬øEliminar ${ids.length} iniciativa(s) seleccionada(s)?\n\n` +
                          (iniciativasAEliminar.length > 0 ? 
                           `Incluye:\n${iniciativasAEliminar.slice(0, 5).join('\n')}` +
                           (iniciativasAEliminar.length > 5 ? `\n... y ${iniciativasAEliminar.length - 5} m√°s` : '') +
                           '\n\n' : '') +
                          'Esta acci√≥n NO se puede deshacer.';
            
            if (!confirm(mensaje)) {
                return;
            }
            
            let eliminadas = 0;
            let errores = 0;
            
            for (const id of ids) {
                try {
                    const response = await fetch(`/api/operador/iniciativa/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        eliminadas++;
                    } else {
                        errores++;
                    }
                } catch (error) {
                    console.error('Error eliminando iniciativa:', error);
                    errores++;
                }
            }
            
            // Mostrar resultado
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${errores === 0 ? 'alert-success' : 'alert-warning'} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <strong>${eliminadas > 0 ? '‚úÖ' : '‚ö†Ô∏è'} Operaci√≥n completada</strong><br>
                ${eliminadas} iniciativa(s) eliminada(s)${errores > 0 ? `<br>${errores} error(es) al eliminar` : ''}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 5000);
            
            // Recargar lista
            loadActiveSession();
        }
        
        // Activar iniciativa
        async function activateInitiative(id) {
            if (!confirm('¬øActivar esta iniciativa para votaci√≥n?')) return;
            
            try {
                const response = await fetch(`/api/operador/activar-iniciativa/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    loadActiveSession();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al activar iniciativa');
            }
        }
        
        // Cerrar votaci√≥n
        async function closeVoting(id) {
            if (!confirm('¬øCerrar la votaci√≥n de esta iniciativa?')) return;
            
            try {
                const response = await fetch(`/api/operador/cerrar-votacion/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Votaci√≥n cerrada. Resultado: ${data.resultado.toUpperCase()}`);
                    loadActiveSession();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cerrar votaci√≥n');
            }
        }
        
        // Reabrir votaci√≥n
        async function reopenVoting(id) {
            if (!confirm('¬øReabrir la votaci√≥n de esta iniciativa? Los votos existentes se mantendr√°n.')) return;
            
            try {
                const response = await fetch(`/api/operador/reabrir-votacion/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Votaci√≥n reabierta exitosamente');
                    loadActiveSession();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al reabrir votaci√≥n');
            }
        }
        
        // Escuchar eventos de socket
        socket.on('iniciativa-activa', () => {
            loadActiveSession();
        });
        
        socket.on('votacion-cerrada', () => {
            loadActiveSession();
        });
        
        socket.on('iniciativa-actualizada', () => {
            loadActiveSession();
        });
        
        // Evento de inicio de sesi√≥n
        socket.on('sesion-iniciada', (data) => {
            console.log('Sesi√≥n iniciada:', data);
            
            // Iniciar cron√≥metro
            sessionStartTime = Date.now();
            startSessionTimer();
            
            // Mostrar notificaci√≥n mejorada
            const notification = `
                <div class="alert alert-success alert-dismissible fade show position-fixed shadow-lg" style="top: 20px; right: 20px; z-index: 9999; min-width: 350px;">
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    <h5 class="alert-heading"><i class="fas fa-play-circle"></i> ¬°Sesi√≥n Iniciada!</h5>
                    <hr>
                    <p class="mb-2"><strong>Nombre:</strong> ${data.nombre}</p>
                    <p class="mb-2"><strong>Iniciada por:</strong> ${data.iniciada_por}</p>
                    <p class="mb-0"><small class="text-muted">Hora: ${new Date(data.fecha).toLocaleTimeString('es-MX')}</small></p>
                </div>
            `;
            
            // Agregar notificaci√≥n al DOM
            const container = document.createElement('div');
            container.innerHTML = notification;
            document.body.appendChild(container.firstElementChild);
            
            // Auto-remover despu√©s de 10 segundos
            setTimeout(() => {
                const alert = document.querySelector('.alert.alert-success');
                if (alert) alert.remove();
            }, 10000);
            
            // Recargar la sesi√≥n activa
            loadActiveSession();
            
            // Forzar recarga despu√©s de un breve retraso para asegurar actualizaci√≥n
            setTimeout(() => {
                loadActiveSession();
            }, 1500);
        });
        
        // Evento de clausura de sesi√≥n
        socket.on('sesion-clausurada', (data) => {
            console.log('Sesi√≥n clausurada:', data);
            
            // Detener cron√≥metro
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            sessionStartTime = null;
            document.getElementById('sessionTimerContainer').style.display = 'none';
            
            // Mostrar notificaci√≥n mejorada
            const notification = `
                <div class="alert alert-warning alert-dismissible fade show position-fixed shadow-lg" style="top: 20px; right: 20px; z-index: 9999; min-width: 350px;">
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    <h5 class="alert-heading"><i class="fas fa-stop-circle"></i> ¬°Sesi√≥n Clausurada!</h5>
                    <hr>
                    <p class="mb-2"><strong>Clausurada por:</strong> ${data.clausurada_por}</p>
                    <strong>Estad√≠sticas finales:</strong><br>
                    - Iniciativas: ${data.estadisticas.total_iniciativas}<br>
                    - Aprobadas: ${data.estadisticas.aprobadas}<br>
                    - Rechazadas: ${data.estadisticas.rechazadas}<br>
                    <hr>
                    <button class="btn btn-primary btn-sm w-100" onclick="descargarReporteSesion(${data.sesion_id})">
                        <i class="fas fa-file-pdf"></i> Descargar Reporte PDF
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', notification);
            
            // Recargar sesi√≥n y sesiones finalizadas
            loadActiveSession();
            cargarSesionesFinalizadas();
        });
        
        // Funci√≥n para descargar reporte de sesi√≥n
        async function descargarReporteSesion(sesionId) {
            try {
                const response = await fetch(`/api/operador/reporte-sesion/${sesionId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `reporte_sesion_${sesionId}_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    alert('Error al generar el reporte');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al descargar el reporte');
            }
        }
        
        // Modal de edici√≥n
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        
        // Editar iniciativa
        async function editInitiative(id) {
            try {
                const response = await fetch(`/api/operador/iniciativa/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('editId').value = data.id;
                    document.getElementById('editNumero').value = data.numero;
                    document.getElementById('editDescripcion').value = data.descripcion || data.titulo || '';
                    document.getElementById('editPresentador').value = data.presentador || '';
                    document.getElementById('editPartidoPresentador').value = data.partido_presentador || '';
                    document.getElementById('editTipoMayoria').value = data.tipo_mayoria || 'simple';
                    
                    editModal.show();
                } else {
                    alert('Error al cargar la iniciativa');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar la iniciativa');
            }
        }
        
        // Guardar edici√≥n
        async function saveEdit() {
            const id = document.getElementById('editId').value;
            const data = {
                numero: parseInt(document.getElementById('editNumero').value),
                descripcion: document.getElementById('editDescripcion').value,
                presentador: document.getElementById('editPresentador').value,
                partido_presentador: document.getElementById('editPartidoPresentador').value,
                tipo_mayoria: document.getElementById('editTipoMayoria').value
            };
            
            try {
                const response = await fetch(`/api/operador/iniciativa/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    editModal.hide();
                    loadActiveSession();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Error al guardar los cambios');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar los cambios');
            }
        }
        
        // Eliminar iniciativa
        async function deleteInitiative(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta iniciativa? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/operador/iniciativa/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    loadActiveSession();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al eliminar la iniciativa');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar la iniciativa');
            }
        }
        
        // Cargar estad√≠sticas de sesiones
        async function loadEstadisticasSesiones() {
            try {
                const response = await fetch('/api/operador/estadisticas-sesiones', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // √öltima sesi√≥n
                    if (data.ultimaSesion) {
                        const fecha = new Date(data.ultimaSesion.fecha_clausura || data.ultimaSesion.fecha);
                        document.getElementById('ultimaSesion').textContent = fecha.toLocaleDateString('es-MX') + ' ' + fecha.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});
                    } else {
                        document.getElementById('ultimaSesion').textContent = 'Sin sesiones previas';
                    }
                    
                    // Pr√≥xima sesi√≥n programada
                    if (data.proximaSesion) {
                        const fecha = new Date(data.proximaSesion.fecha_programada);
                        document.getElementById('proximaSesion').textContent = fecha.toLocaleDateString('es-MX') + ' ' + fecha.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});
                    } else {
                        document.getElementById('proximaSesion').textContent = 'Sin programar';
                    }
                    
                    // Documentos pendientes
                    document.getElementById('documentosPendientes').textContent = data.documentosPendientes || 0;
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }
        
        // Ver historial de sesiones
        function verHistorial() {
            window.open('/historial-sesiones', '_blank');
        }
        
        // Cargar sesiones con documentos PDF
        async function loadSesionesConDocumentos() {
            try {
                const response = await fetch('/api/operador/sesiones-con-documentos', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('sesionesDocumentosList');
                    
                    if (!data.sesiones || data.sesiones.length === 0) {
                        container.innerHTML = '<p class="text-muted text-center">No hay sesiones con documentos disponibles</p>';
                        return;
                    }
                    
                    let html = '<div class="table-responsive"><table class="table table-sm table-hover">';
                    html += `
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Sesi√≥n</th>
                                <th>Estado</th>
                                <th>Iniciativas</th>
                                <th>Resultados</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    
                    data.sesiones.forEach(sesion => {
                        const fecha = new Date(sesion.fecha).toLocaleDateString('es-MX');
                        const estadoBadge = sesion.estado === 'clausurada' ? 
                            '<span class="badge bg-secondary">Clausurada</span>' :
                            '<span class="badge bg-info">Activa</span>';
                        
                        html += `
                            <tr>
                                <td>${fecha}</td>
                                <td>
                                    <strong>${sesion.nombre}</strong><br>
                                    <small class="text-muted">${sesion.codigo_sesion}</small>
                                </td>
                                <td>${estadoBadge}</td>
                                <td class="text-center">${sesion.total_iniciativas || 0}</td>
                                <td>
                                    <small>
                                        <span class="text-success">‚úì ${sesion.aprobadas || 0}</span> | 
                                        <span class="text-danger">‚úó ${sesion.rechazadas || 0}</span>
                                    </small>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="consultarDocumentoPDF('${sesion.archivo_pdf}')">
                                        <i class="fas fa-file-pdf"></i> Ver PDF
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error cargando sesiones con documentos:', error);
                document.getElementById('sesionesDocumentosList').innerHTML = 
                    '<p class="text-danger text-center">Error al cargar sesiones con documentos</p>';
            }
        }
        
        // Funci√≥n para consultar documento PDF
        function consultarDocumentoPDF(archivo) {
            if (archivo) {
                window.open(`/documentos-sesion/${archivo}`, '_blank');
            } else {
                alert('No hay documento PDF disponible');
            }
        }
        
        // Funci√≥n para notificar a la mesa directiva
        async function notificarMesaDirectiva(event) {
            try {
                const response = await fetch('/api/operador/notificar-mesa-directiva', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Mostrar notificaci√≥n de √©xito
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <strong>‚úÖ Notificaci√≥n enviada</strong><br>
                        Se notific√≥ al presidente y secretarios que hay ${data.totalIniciativas} iniciativas listas.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    // Deshabilitar el bot√≥n temporalmente
                    const btn = event && event.target ? event.target : document.querySelector('[onclick*="notificarMesaDirectiva"]');
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-check"></i> Notificaci√≥n Enviada';
                        
                        setTimeout(() => {
                            alertDiv.remove();
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-bell"></i> Notificar Mesa Directiva - Sesi√≥n Lista';
                        }, 5000);
                    }
                } else {
                    console.log('Respuesta del servidor:', data);
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        // Si lleg√≥ aqu√≠ pero funcion√≥, mostrar √©xito de todas formas
                        console.log('Notificaci√≥n enviada aunque response no fue ok');
                    }
                }
            } catch (error) {
                console.error('Error al procesar respuesta:', error);
                // No mostrar alert de error si la notificaci√≥n funcion√≥
                console.log('Posible error de formato en respuesta, pero la notificaci√≥n pudo haberse enviado');
            }
        }
        
        // Variables para paginaci√≥n
        let sesionesPendientesData = [];
        let paginaActualSesiones = 1;
        const sesionesPerPage = 5;
        
        // Cargar sesiones pendientes
        async function loadSesionesPendientes() {
            try {
                const response = await fetch('/api/operador/sesiones-pendientes', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    sesionesPendientesData = data.sesiones || [];
                    paginaActualSesiones = 1;
                    renderSesionesPendientesPaginadas();
                }
            } catch (error) {
                console.error('Error cargando sesiones pendientes:', error);
                document.getElementById('sesionesPendientesList').innerHTML = 
                    '<p class="text-danger text-center">Error al cargar sesiones pendientes</p>';
            }
        }
        
        // Renderizar sesiones pendientes con paginaci√≥n
        function renderSesionesPendientesPaginadas() {
            const container = document.getElementById('sesionesPendientesList');
            const paginacionDiv = document.getElementById('paginacionSesiones');
            
            if (!sesionesPendientesData || sesionesPendientesData.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No hay sesiones pendientes</p>';
                paginacionDiv.style.display = 'none';
                return;
            }
            
            // Calcular p√°ginas
            const totalPages = Math.ceil(sesionesPendientesData.length / sesionesPerPage);
            const startIndex = (paginaActualSesiones - 1) * sesionesPerPage;
            const endIndex = Math.min(startIndex + sesionesPerPage, sesionesPendientesData.length);
            const sesionesPagina = sesionesPendientesData.slice(startIndex, endIndex);
            
            // Actualizar rango mostrado
            document.getElementById('showingRange').textContent = `${startIndex + 1}-${endIndex}`;
            document.getElementById('totalSesiones').textContent = sesionesPendientesData.length;
            
            // Renderizar sesiones de la p√°gina actual
            container.innerHTML = sesionesPagina.map(sesion => {
                let tipoLabel = '';
                let borderColor = '';
                let descripcion = '';
                
                if (sesion.estado === 'indefinida') {
                    tipoLabel = '<span class="badge bg-secondary"><i class="fas fa-question-circle"></i> Fecha Indefinida</span>';
                    borderColor = 'secondary';
                    descripcion = '<br><small class="text-warning"><i class="fas fa-info-circle"></i> Sin fecha definida - Puede activarse cuando se requiera</small>';
                } else if (sesion.estado === 'programada') {
                    const fechaProg = new Date(sesion.fecha_programada);
                    tipoLabel = `<span class="badge bg-info"><i class="fas fa-calendar"></i> Programada: ${fechaProg.toLocaleString('es-MX')}</span>`;
                    borderColor = 'info';
                    descripcion = `<br><small class="text-info"><i class="fas fa-clock"></i> Se activar√° autom√°ticamente el ${fechaProg.toLocaleDateString('es-MX')}</small>`;
                } else {
                    tipoLabel = '<span class="badge bg-warning"><i class="fas fa-check"></i> Preparada</span>';
                    borderColor = 'warning';
                    descripcion = '<br><small class="text-success"><i class="fas fa-check-circle"></i> Lista para activar</small>';
                }
                
                const fechaCreacion = new Date(sesion.fecha).toLocaleDateString('es-MX');
                const nombreEscapado = sesion.nombre.replace(/'/g, "\\'");
                
                // Determinar color y etiqueta seg√∫n el creador
                let creadorBadge = '';
                let borderLeftColor = borderColor;
                
                if (sesion.creado_por_role === 'servicios_legislativos' || sesion.origen_tabla === 'sesion_precargada') {
                    creadorBadge = `
                        <span class="badge bg-primary">
                            <i class="fas fa-building"></i> Servicios Legislativos
                        </span>`;
                    borderLeftColor = 'primary';
                } else if (sesion.creado_por_nombre) {
                    creadorBadge = `
                        <span class="badge bg-dark">
                            <i class="fas fa-user"></i> Operador: ${sesion.creado_por_nombre}
                        </span>`;
                }
                
                // Badge de origen adicional si es precargada
                const origenBadge = sesion.origen_tabla === 'sesion_precargada' ? 
                    '<span class="badge bg-info ms-1"><i class="fas fa-database"></i> Precargada</span>' : '';
                
                // Informaci√≥n adicional del creador
                const infoCreador = sesion.creado_por_nombre ? 
                    `<br><small class="text-muted"><i class="fas fa-user-clock"></i> Cargada por: ${sesion.creado_por_nombre} el ${fechaCreacion}</small>` : 
                    `<br><small class="text-muted"><i class="fas fa-calendar-alt"></i> Cargada el ${fechaCreacion}</small>`;
                
                return `
                    <div class="card mb-2 border-start border-5 border-${borderLeftColor}">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${sesion.nombre} ${creadorBadge} ${origenBadge}</h6>
                                    <div class="mb-2">
                                        ${tipoLabel}
                                        <span class="badge bg-light text-dark"><i class="fas fa-file-alt"></i> ${sesion.total_iniciativas || 0} iniciativas</span>
                                    </div>
                                    <small class="text-muted">C√≥digo: <code>${sesion.codigo_sesion || 'SES-' + sesion.id}</code></small>
                                    ${infoCreador}
                                    ${descripcion}
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-info" 
                                            onclick="editarIniciativasSesion(${sesion.id}, '${nombreEscapado}', '${sesion.origen_tabla}')"
                                            title="Ver y editar las iniciativas de esta sesi√≥n">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-success" 
                                            onclick="activarSesionPendiente(${sesion.id}, '${nombreEscapado}', '${sesion.origen_tabla}')"
                                            title="Activar esta sesi√≥n para que el presidente pueda iniciarla">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" 
                                            onclick="eliminarSesionPendiente(${sesion.id}, '${nombreEscapado}', '${sesion.origen_tabla}')"
                                            title="Eliminar esta sesi√≥n">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Renderizar controles de paginaci√≥n
            renderPaginacionSesiones(totalPages);
            paginacionDiv.style.display = sesionesPendientesData.length > sesionesPerPage ? 'flex' : 'none';
        }
        
        // Renderizar controles de paginaci√≥n
        function renderPaginacionSesiones(totalPages) {
            const paginationControls = document.getElementById('paginationControls');
            let html = '';
            
            // Bot√≥n anterior
            html += `
                <li class="page-item ${paginaActualSesiones === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="cambiarPaginaSesiones(${paginaActualSesiones - 1}); return false;">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // N√∫meros de p√°gina
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= paginaActualSesiones - 1 && i <= paginaActualSesiones + 1)) {
                    html += `
                        <li class="page-item ${i === paginaActualSesiones ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="cambiarPaginaSesiones(${i}); return false;">${i}</a>
                        </li>
                    `;
                } else if (i === paginaActualSesiones - 2 || i === paginaActualSesiones + 2) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            // Bot√≥n siguiente
            html += `
                <li class="page-item ${paginaActualSesiones === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="cambiarPaginaSesiones(${paginaActualSesiones + 1}); return false;">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
            
            paginationControls.innerHTML = html;
        }
        
        // Cambiar p√°gina
        function cambiarPaginaSesiones(pagina) {
            const totalPages = Math.ceil(sesionesPendientesData.length / sesionesPerPage);
            if (pagina < 1 || pagina > totalPages) return;
            paginaActualSesiones = pagina;
            renderSesionesPendientesPaginadas();
        }
        
        // Eliminar sesi√≥n pendiente
        async function eliminarSesionPendiente(sesionId, nombre) {
            if (!confirm(`¬øEliminar la sesi√≥n "${nombre}"?\n\nEsta acci√≥n eliminar√° permanentemente la sesi√≥n y todas sus iniciativas.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/operador/sesion/${sesionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    // Mostrar mensaje de √©xito
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <strong>‚úÖ Sesi√≥n eliminada</strong><br>
                        La sesi√≥n "${nombre}" ha sido eliminada correctamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    setTimeout(() => alertDiv.remove(), 5000);
                    
                    // Recargar lista
                    loadSesionesPendientes();
                } else {
                    const data = await response.json();
                    alert('Error al eliminar la sesi√≥n: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar la sesi√≥n');
            }
        }
        
        // Activar sesi√≥n pendiente
        async function activarSesionPendiente(sesionId, nombre, origenTabla = 'sesion') {
            if (!confirm(`¬øActivar la sesi√≥n "${nombre}"?\n\nEsto desactivar√° cualquier otra sesi√≥n activa y permitir√° al presidente iniciar esta sesi√≥n inmediatamente.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/operador/activar-sesion-pendiente/${sesionId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ origen_tabla: origenTabla })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Sesi√≥n activada correctamente\n\nEl presidente ya puede iniciar la sesi√≥n desde su panel de control.');
                    // Recargar todas las secciones
                    loadSesionesPendientes();
                    loadActiveSession();
                    loadEstadisticasSesiones();
                } else {
                    alert('‚ùå ' + (data.error || 'Error al activar la sesi√≥n'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al activar la sesi√≥n');
            }
        }
        
        // Variables para edici√≥n de iniciativas
        let sesionEditandoId = null;
        let sesionEditandoOrigen = 'sesion';
        let iniciativasEditando = [];
        
        // Editar iniciativas de sesi√≥n
        async function editarIniciativasSesion(sesionId, nombreSesion, origenTabla = 'sesion') {
            sesionEditandoId = sesionId;
            sesionEditandoOrigen = origenTabla; // Guardar el origen
            document.getElementById('sesionNombreEdit').textContent = nombreSesion;
            
            try {
                const endpoint = origenTabla === 'sesion_precargada' 
                    ? `/api/operador/sesion-precargada/${sesionId}/iniciativas`
                    : `/api/operador/sesion/${sesionId}/iniciativas`;
                    
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    iniciativasEditando = data.iniciativas || [];
                    renderIniciativasEdit();
                    
                    const modal = new bootstrap.Modal(document.getElementById('editarIniciativasModal'));
                    modal.show();
                } else {
                    alert('Error al cargar las iniciativas');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar las iniciativas');
            }
        }
        
        // Renderizar iniciativas para edici√≥n
        function renderIniciativasEdit() {
            const tbody = document.getElementById('iniciativasEditList');
            
            if (iniciativasEditando.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay iniciativas en esta sesi√≥n</td></tr>';
                return;
            }
            
            // Separar por tipo
            const dictamenes = [];
            const iniciativas = [];
            const puntosAcuerdo = [];
            let contadorDictamenes = 0;
            let contadorIniciativas = 0;
            let contadorPuntos = 0;
            
            // Clasificar elementos
            iniciativasEditando.forEach((item, index) => {
                item.indexOriginal = index;
                const desc = item.descripcion || item.titulo || '';
                
                if (desc.match(/Dictamen emanado/i)) {
                    item.tipo = 'dictamen';
                    dictamenes.push(item);
                    contadorDictamenes++;
                } else if (desc.match(/Iniciativa/i)) {
                    item.tipo = 'iniciativa';
                    iniciativas.push(item);
                    contadorIniciativas++;
                } else if (desc.match(/Punto\s+de\s+Acuerdo/i)) {
                    item.tipo = 'punto_acuerdo';
                    puntosAcuerdo.push(item);
                    contadorPuntos++;
                }
            });
            
            // Actualizar contadores en badges si existen
            const badgeDictamenes = document.getElementById('editBadgeDictamenes');
            const badgeIniciativas = document.getElementById('editBadgeIniciativas');
            const badgePuntos = document.getElementById('editBadgePuntos');
            
            if (badgeDictamenes) badgeDictamenes.textContent = contadorDictamenes;
            if (badgeIniciativas) badgeIniciativas.textContent = contadorIniciativas;
            if (badgePuntos) badgePuntos.textContent = contadorPuntos;
            
            // Renderizar tabla con todos los elementos pero con identificaci√≥n visual
            tbody.innerHTML = iniciativasEditando.map((iniciativa, index) => {
                const desc = iniciativa.descripcion || iniciativa.titulo || '';
                let tipoColor = '';
                let tipoBadge = '';
                
                if (desc.match(/Dictamen emanado/i)) {
                    tipoColor = 'table-warning';
                    tipoBadge = '<span class="badge bg-warning">Dictamen</span>';
                } else if (desc.match(/Iniciativa/i)) {
                    tipoColor = 'table-info';
                    tipoBadge = '<span class="badge bg-info">Iniciativa</span>';
                } else if (desc.match(/Punto\s+de\s+Acuerdo/i)) {
                    tipoColor = 'table-success';
                    tipoBadge = '<span class="badge bg-success">P. Acuerdo</span>';
                }
                
                // Mostrar n√∫mero con formato numero_asignado/numero_original si existe
                const numeroDisplay = iniciativa.numero_display || 
                                    (iniciativa.numero_original ? `${index + 1}/${iniciativa.numero_original}` : (index + 1));
                
                return `
                <tr class="${tipoColor}">
                    <td>
                        <strong>${numeroDisplay}</strong>
                        ${tipoBadge}
                    </td>
                    <td style="display: none;">
                        <input type="text" class="form-control form-control-sm" 
                               value="" 
                               readonly
                               placeholder="(No usar t√≠tulo)">
                    </td>
                    <td colspan="2">
                        <textarea class="form-control form-control-sm" rows="3"
                                  onchange="actualizarIniciativa(${index}, 'descripcion', this.value)"
                                  placeholder="Descripci√≥n completa del elemento">${desc}</textarea>
                    </td>
                    <td>
                        <select class="form-select form-select-sm" 
                                onchange="actualizarIniciativa(${index}, 'tipo_mayoria', this.value)">
                            <option value="simple" ${iniciativa.tipo_mayoria === 'simple' ? 'selected' : ''}>Simple</option>
                            <option value="absoluta" ${iniciativa.tipo_mayoria === 'absoluta' ? 'selected' : ''}>Absoluta</option>
                            <option value="calificada" ${iniciativa.tipo_mayoria === 'calificada' ? 'selected' : ''}>Calificada</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="eliminarIniciativa(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        // Actualizar iniciativa
        function actualizarIniciativa(index, campo, valor) {
            iniciativasEditando[index][campo] = valor;
        }
        
        // Eliminar iniciativa
        function eliminarIniciativa(index) {
            if (confirm('¬øEliminar esta iniciativa?')) {
                iniciativasEditando.splice(index, 1);
                renderIniciativasEdit();
            }
        }
        
        // Agregar nueva iniciativa
        function agregarNuevaIniciativa() {
            const nuevaIniciativa = {
                numero: iniciativasEditando.length + 1,
                titulo: '',
                descripcion: '',
                tipo_mayoria: 'simple'
            };
            iniciativasEditando.push(nuevaIniciativa);
            renderIniciativasEdit();
        }
        
        // Guardar cambios en las iniciativas
        async function guardarCambiosIniciativas() {
            if (!sesionEditandoId) return;
            
            try {
                const endpoint = sesionEditandoOrigen === 'sesion_precargada' 
                    ? `/api/operador/sesion-precargada/${sesionEditandoId}/iniciativas`
                    : `/api/operador/sesion/${sesionEditandoId}/iniciativas`;
                    
                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ iniciativas: iniciativasEditando })
                });
                
                if (response.ok) {
                    alert('‚úÖ Iniciativas actualizadas correctamente');
                    bootstrap.Modal.getInstance(document.getElementById('editarIniciativasModal')).hide();
                    loadSesionesPendientes();
                } else {
                    const data = await response.json();
                    alert('‚ùå ' + (data.error || 'Error al guardar los cambios'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al guardar los cambios');
            }
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }
        
        // Cargar sesiones finalizadas para exportar
        async function cargarSesionesFinalizadas() {
            try {
                const response = await fetch('/api/operador/sesiones-finalizadas', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('sesionExportar');
                    
                    // Limpiar opciones existentes
                    select.innerHTML = '<option value="">-- Selecciona una sesi√≥n finalizada --</option>';
                    
                    // Si hay sesi√≥n activa finalizada, agregarla primero
                    if (sessionData && sessionData.estado === 'clausurada') {
                        select.innerHTML += `<option value="${sessionData.id}" selected>
                            ${sessionData.nombre} - ${sessionData.codigo_sesion} (Sesi√≥n Actual)
                        </option>`;
                    }
                    
                    // Agregar sesiones finalizadas
                    if (data.sesiones && data.sesiones.length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = 'Sesiones Anteriores';
                        
                        data.sesiones.forEach(sesion => {
                            // No duplicar la sesi√≥n actual
                            if (sessionData && sesion.id === sessionData.id) return;
                            
                            const option = document.createElement('option');
                            option.value = sesion.id;
                            const fecha = new Date(sesion.fecha).toLocaleDateString('es-MX');
                            option.textContent = `${sesion.nombre} - ${sesion.codigo_sesion} (${fecha})`;
                            optgroup.appendChild(option);
                        });
                        
                        if (optgroup.children.length > 0) {
                            select.appendChild(optgroup);
                        }
                    }
                    
                    // Actualizar estado de los botones
                    actualizarEstadoExportacion();
                }
            } catch (error) {
                console.error('Error cargando sesiones finalizadas:', error);
            }
        }
        
        // Actualizar estado de exportaci√≥n seg√∫n la sesi√≥n seleccionada
        function actualizarEstadoExportacion() {
            const select = document.getElementById('sesionExportar');
            const sesionId = select.value;
            const btnExcel = document.getElementById('btnExportExcel');
            const btnPDF = document.getElementById('btnExportPDF');
            const btnWord = document.getElementById('btnExportWord');
            const alerta = document.getElementById('alertaExportacion');
            
            if (sesionId) {
                // Habilitar botones
                btnExcel.disabled = false;
                btnPDF.disabled = false;
                btnWord.disabled = false;
                alerta.style.display = 'none';
            } else {
                // Deshabilitar botones
                btnExcel.disabled = true;
                btnPDF.disabled = true;
                btnWord.disabled = true;
                
                // Mostrar alerta solo si hay sesi√≥n activa no finalizada
                if (sessionData && sessionData.estado !== 'clausurada') {
                    alerta.style.display = 'block';
                } else {
                    alerta.style.display = 'none';
                }
            }
        }
        
        // Funci√≥n para exportar sesi√≥n seleccionada
        async function exportarSesionSeleccionada(formato) {
            const select = document.getElementById('sesionExportar');
            const sesionId = select.value;
            
            if (!sesionId) {
                alert('Por favor selecciona una sesi√≥n para exportar');
                return;
            }
            
            // Mostrar estado de descarga
            const statusDiv = document.getElementById('exportStatus');
            statusDiv.innerHTML = `<div class="alert alert-info p-2">
                <i class="fas fa-spinner fa-spin"></i> Generando ${formato.toUpperCase()}...
            </div>`;
            
            try {
                const response = await fetch(`/api/exportar/${formato}/${sesionId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al generar el archivo');
                }
                
                // Obtener el blob del archivo
                const blob = await response.blob();
                
                // Crear URL temporal para descarga
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // Obtener nombre de la sesi√≥n para el archivo
                const optionText = select.options[select.selectedIndex].text;
                const codigoSesion = optionText.match(/- ([A-Z0-9-]+)/)?.[1] || 'sesion';
                const fecha = new Date().toISOString().split('T')[0];
                const extension = formato === 'excel' ? 'xlsx' : formato === 'word' ? 'docx' : 'pdf';
                a.download = `Acta_${codigoSesion}_${fecha}.${extension}`;
                
                // Descargar archivo
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Limpiar URL temporal
                window.URL.revokeObjectURL(url);
                
                // Mostrar √©xito
                statusDiv.innerHTML = `<div class="alert alert-success p-2">
                    <i class="fas fa-check"></i> ${formato.toUpperCase()} descargado correctamente
                </div>`;
                
                // Limpiar mensaje despu√©s de 3 segundos
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
                
            } catch (error) {
                console.error('Error exportando:', error);
                statusDiv.innerHTML = `<div class="alert alert-danger p-2">
                    <i class="fas fa-times"></i> Error al generar ${formato.toUpperCase()}
                </div>`;
            }
        }
        
        // Abrir pantalla seg√∫n tipo
        function abrirPantalla(tipo) {
            const width = 774;
            const height = 518;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            // Opciones para ventana tipo popup minimalista
            const windowFeatures = [
                `width=${width}`,
                `height=${height}`,
                `left=${left}`,
                `top=${top}`,
                'resizable=yes',
                'scrollbars=no',
                'toolbar=no',
                'menubar=no',
                'location=no',  // Intenta ocultar barra de direcci√≥n (limitado por navegador)
                'directories=no',
                'status=no',
                'titlebar=yes',
                'popup=yes'     // Modo popup para aspecto m√°s limpio
            ].join(',');
            
            let url = '/pantalla';
            let windowName = 'PantallaPublica';
            
            if (tipo === 'asistencia') {
                url = '/pantalla-asistencia';
                windowName = 'PantallaAsistencia';
            }
            
            const ventana = window.open(url, windowName, windowFeatures);
            
            // Intentar modo pantalla completa autom√°ticamente (requiere interacci√≥n del usuario)
            if (ventana) {
                ventana.focus();
                // Sugerir pantalla completa despu√©s de cargar
                setTimeout(() => {
                    if (ventana && !ventana.closed) {
                        ventana.postMessage({ action: 'suggestFullscreen' }, '*');
                    }
                }, 1000);
            }
            
            event.preventDefault();
        }
        
        // Funci√≥n para actualizar URL personalizada basada en opciones (definida primero)
        function actualizarURLPersonalizada() {
            const params = [];
            const resolution = document.getElementById('obsResolution').value;
            
            if (resolution === 'custom') {
                const width = document.getElementById('obsWidth').value;
                const height = document.getElementById('obsHeight').value;
                if (width) params.push(`width=${width}`);
                if (height) params.push(`height=${height}`);
            } else if (resolution) {
                const [width, height] = resolution.split('x');
                params.push(`width=${width}`, `height=${height}`);
            }
            
            if (!document.getElementById('obsHeader').checked) params.push('header=false');
            if (!document.getElementById('obsSidebar').checked) params.push('sidebar=false');
            if (document.getElementById('obsTransparent').checked) params.push('transparent=true');
            if (document.getElementById('obsMinimal').checked) params.push('minimal=true');
            
            const baseURL = window.location.origin + (currentScreenType === 'asistencia' ? '/pantalla-asistencia' : '/pantalla');
            const fullURL = params.length > 0 ? `${baseURL}?${params.join('&')}` : baseURL;
            document.getElementById('obsCustomURL').value = fullURL;
        }
        
        // Funci√≥n para mostrar opciones OBS
        function mostrarOpcionesOBS(tipo) {
            currentScreenType = tipo || 'votacion';
            const modal = new bootstrap.Modal(document.getElementById('obsModal'));
            
            // Actualizar el t√≠tulo del modal seg√∫n el tipo
            const modalTitle = document.querySelector('#obsModal .modal-title');
            if (modalTitle) {
                modalTitle.innerHTML = `<i class="fas fa-video"></i> Configuraci√≥n OBS/Streaming - ${tipo === 'asistencia' ? 'Asistencia' : 'Votaci√≥n'}`;
            }
            
            // Actualizar los modos predefinidos seg√∫n el tipo
            actualizarModosOBS(tipo);
            actualizarURLPersonalizada();
            modal.show();
            event.preventDefault();
        }
        
        // Funci√≥n para actualizar los modos predefinidos de OBS
        function actualizarModosOBS(tipo) {
            const container = document.getElementById('obsPresetModes');
            let modos = [];
            
            if (tipo === 'asistencia') {
                modos = [
                    { url: '/pantalla-asistencia', titulo: 'Modo Normal', desc: 'Vista completa de asistencia' },
                    { url: '/pantalla-asistencia?transparent=true', titulo: 'Fondo Transparente', desc: 'Para superponer sobre otros elementos' },
                    { url: '/pantalla-asistencia?chromakey=true', titulo: 'Chromakey (Verde)', desc: 'Fondo verde para eliminaci√≥n por color' },
                    { url: '/pantalla-asistencia?chromakey=blue', titulo: 'Chromakey (Azul)', desc: 'Fondo azul para eliminaci√≥n por color' },
                    { url: '/pantalla-asistencia?minimal=true', titulo: 'Modo Minimalista', desc: 'Vista simplificada de asistencia' },
                    { url: '/pantalla-asistencia?header=false', titulo: 'Sin Encabezado', desc: 'Oculta el t√≠tulo y encabezado' },
                    { url: '/pantalla-asistencia?minimal=true&transparent=true', titulo: 'Minimalista Transparente', desc: 'Sin header y con fondo transparente' }
                ];
            } else {
                modos = [
                    { url: '/pantalla', titulo: 'Modo Normal', desc: 'Vista completa con todos los elementos' },
                    { url: '/pantalla?transparent=true', titulo: 'Fondo Transparente', desc: 'Para superponer sobre otros elementos' },
                    { url: '/pantalla?chromakey=true', titulo: 'Chromakey (Verde)', desc: 'Fondo verde para eliminaci√≥n por color' },
                    { url: '/pantalla?chromakey=blue', titulo: 'Chromakey (Azul)', desc: 'Fondo azul para eliminaci√≥n por color' },
                    { url: '/pantalla?voting-only=true', titulo: 'Solo Votaci√≥n', desc: 'Muestra √∫nicamente la tabla de votaci√≥n' },
                    { url: '/pantalla?results-only=true', titulo: 'Solo Resultados', desc: 'Panel de resumen √∫nicamente' },
                    { url: '/pantalla?initiative-only=true', titulo: 'Solo Iniciativa', desc: 'Muestra √∫nicamente el texto de la iniciativa' },
                    { url: '/pantalla?voting-only=true&transparent=true', titulo: 'Solo Votaci√≥n (Transparente)', desc: 'Tabla con fondo transparente' },
                    { url: '/pantalla?results-only=true&transparent=true', titulo: 'Solo Resultados (Transparente)', desc: 'Resumen con fondo transparente' }
                ];
            }
            
            container.innerHTML = modos.map(modo => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${modo.titulo}</strong>
                            <small class="d-block text-muted">${modo.desc}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="copiarURL('${modo.url}'); return false;">
                            <i class="fas fa-copy"></i> Copiar URL
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Copiar URL al portapapeles con feedback mejorado
        function copiarURL(path) {
            // Si el path contiene 'asistencia', usar la ruta correcta
            if (path.includes('asistencia') && !path.includes('pantalla-asistencia')) {
                path = path.replace('/pantalla', '/pantalla-asistencia');
            }
            
            // Usar IP real del servidor en lugar de localhost
            const host = window.location.hostname;
            const port = window.location.port;
            const protocol = window.location.protocol;
            const url = `${protocol}//${host}${port ? ':' + port : ''}${path}`;
            
            // Obtener el bot√≥n que se clicke√≥ para feedback visual
            const btn = event ? event.target.closest('button') : null;
            
            // Usar la API del portapapeles con manejo de errores
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => {
                    showNotification(`‚úÖ URL copiada: ${url}`, 'success');
                    
                    // Feedback visual en el bot√≥n
                    if (btn) {
                        const originalHTML = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-success');
                        
                        setTimeout(() => {
                            btn.innerHTML = originalHTML;
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-outline-primary');
                        }, 2000);
                    }
                }).catch(err => {
                    console.error('Error al copiar:', err);
                    // Fallback al m√©todo tradicional
                    copiarConFallback(url);
                });
            } else {
                // Fallback para navegadores sin soporte de clipboard API
                copiarConFallback(url);
            }
            
            if (event) event.preventDefault();
            return false;
        }
        
        // Fallback para copiar al portapapeles
        function copiarConFallback(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification('‚úÖ URL copiada al portapapeles', 'success');
            } catch (err) {
                console.error('Error al copiar:', err);
                prompt('Copia esta URL manualmente:', text);
            }
            document.body.removeChild(textArea);
        }
        
        function copiarCustomURL() {
            const url = document.getElementById('obsCustomURL').value;
            if (!url) {
                showNotification('‚ö†Ô∏è No hay URL para copiar', 'warning');
                return;
            }
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('‚úÖ URL personalizada copiada', 'success');
                }).catch(err => {
                    console.error('Error al copiar:', err);
                    copiarConFallback(url);
                });
            } else {
                copiarConFallback(url);
            }
        }
        
        // Abrir vista previa OBS
        function abrirPantallaOBS() {
            const url = document.getElementById('obsCustomURL').value;
            window.open(url, '_blank');
        }
        
        // Actualizar URL personalizada cuando cambian las opciones
        function actualizarURLPersonalizada() {
            if (!currentScreenType) return;
            
            const baseURL = currentScreenType === 'asistencia' ? '/pantalla-asistencia' : '/pantalla';
            const params = [];
            
            // Obtener configuraci√≥n
            const resolution = document.getElementById('obsResolution')?.value;
            const width = document.getElementById('obsWidth')?.value;
            const height = document.getElementById('obsHeight')?.value;
            const header = document.getElementById('obsHeader')?.checked;
            const sidebar = document.getElementById('obsSidebar')?.checked;
            const transparent = document.getElementById('obsTransparent')?.checked;
            const minimal = document.getElementById('obsMinimal')?.checked;
            
            // Agregar par√°metros seg√∫n configuraci√≥n
            if (resolution && resolution !== '' && resolution !== 'custom') {
                const [w, h] = resolution.split('x');
                params.push(`width=${w}`);
                params.push(`height=${h}`);
            } else if (resolution === 'custom' && width && height) {
                params.push(`width=${width}`);
                params.push(`height=${height}`);
            }
            
            if (!header) params.push('header=false');
            if (!sidebar) params.push('sidebar=false');
            if (transparent) params.push('transparent=true');
            if (minimal) params.push('minimal=true');
            params.push('obs=true');
            
            const url = `${window.location.origin}${baseURL}${params.length > 0 ? '?' + params.join('&') : ''}`;
            const customURLInput = document.getElementById('obsCustomURL');
            if (customURLInput) {
                customURLInput.value = url;
            }
        }
        
        // Event listeners para actualizaci√≥n de URL
        document.addEventListener('DOMContentLoaded', () => {
            // Listeners para actualizaci√≥n autom√°tica de URL
            ['obsResolution', 'obsWidth', 'obsHeight', 'obsHeader', 'obsSidebar', 'obsTransparent', 'obsMinimal'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', actualizarURLPersonalizada);
                    if (id === 'obsWidth' || id === 'obsHeight') {
                        element.addEventListener('input', actualizarURLPersonalizada);
                    }
                }
            });
            
            // Habilitar campos de resoluci√≥n personalizada
            const resolutionSelect = document.getElementById('obsResolution');
            if (resolutionSelect) {
                resolutionSelect.addEventListener('change', function() {
                    const isCustom = this.value === 'custom';
                    document.getElementById('obsWidth').disabled = !isCustom;
                    document.getElementById('obsHeight').disabled = !isCustom;
                    actualizarURLPersonalizada();
                });
            }
        });
        
        // Event listeners para actualizaci√≥n de URL
        // Funci√≥n para cargar estado de sesi√≥n y habilitar exportaci√≥n
        async function cargarEstadoSesion() {
            try {
                const response = await fetch('/api/operador/sesion-actual', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.sesion) {
                        sessionData = data.sesion;
                        
                        // Habilitar botones de exportaci√≥n con verificaci√≥n
                        const btnExportExcel = document.getElementById('btnExportExcel');
                        if (btnExportExcel) btnExportExcel.disabled = false;
                        
                        const btnExportPDF = document.getElementById('btnExportPDF');
                        if (btnExportPDF) btnExportPDF.disabled = false;
                        
                        const btnExportWord = document.getElementById('btnExportWord');
                        if (btnExportWord) btnExportWord.disabled = false;
                        
                        // Actualizar contadores del dashboard con verificaci√≥n de elementos
                        const votacionesActivasEl = document.getElementById('votacionesActivas');
                        if (votacionesActivasEl) {
                            votacionesActivasEl.textContent = data.votaciones_activas || 0;
                        }
                        
                        const votacionesCompletadasEl = document.getElementById('votacionesCompletadas');
                        if (votacionesCompletadasEl) {
                            votacionesCompletadasEl.textContent = data.votaciones_completadas || 0;
                        }
                        
                        const documentosPendientesEl = document.getElementById('documentosPendientes');
                        if (documentosPendientesEl) {
                            documentosPendientesEl.textContent = data.documentos_pendientes || 0;
                        }
                    } else {
                        // Deshabilitar botones si no hay sesi√≥n con verificaci√≥n
                        const btnExportExcel = document.getElementById('btnExportExcel');
                        if (btnExportExcel) btnExportExcel.disabled = true;
                        
                        const btnExportPDF = document.getElementById('btnExportPDF');
                        if (btnExportPDF) btnExportPDF.disabled = true;
                        
                        const btnExportWord = document.getElementById('btnExportWord');
                        if (btnExportWord) btnExportWord.disabled = true;
                    }
                }
            } catch (error) {
                console.error('Error cargando estado de sesi√≥n:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar estado inicial
            cargarEstadoSesion();
            
            // Actualizar cada 30 segundos
            setInterval(cargarEstadoSesion, 30000);
            
            // Agregar listener al bot√≥n de guardar validaci√≥n
            // Usar setTimeout para asegurar que el DOM est√© completamente cargado
            setTimeout(() => {
                const btnGuardar = document.getElementById('btnGuardarValidacion');
                if (btnGuardar) {
                    console.log('Bot√≥n de guardar encontrado, agregando listener...');
                    
                    // Clonar el bot√≥n para remover TODOS los event listeners
                    const newBtn = btnGuardar.cloneNode(true);
                    btnGuardar.parentNode.replaceChild(newBtn, btnGuardar);
                    
                    // Agregar nuestro listener al bot√≥n clonado
                    newBtn.onclick = null; // Limpiar onclick si existe
                    newBtn.addEventListener('click', function(e) {
                        console.log('=== CLICK EN BOT√ìN GUARDAR ===');
                        console.log('Event:', e);
                        console.log('Target:', e.target);
                        console.log('CurrentTarget:', e.currentTarget);
                        
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Llamar directamente a la funci√≥n
                        console.log('Llamando a guardarIniciativasSeleccionadas...');
                        
                        // Verificar que la funci√≥n existe
                        if (typeof guardarIniciativasSeleccionadas === 'function') {
                            guardarIniciativasSeleccionadas();
                        } else {
                            console.error('La funci√≥n guardarIniciativasSeleccionadas no est√° definida');
                        }
                    });
                    
                    console.log('Listener agregado exitosamente');
                } else {
                    console.error('Bot√≥n btnGuardarValidacion no encontrado');
                }
            }, 1000); // Esperar 1 segundo
            const resolutionSelect = document.getElementById('obsResolution');
            if (resolutionSelect) {
                resolutionSelect.addEventListener('change', (e) => {
                    const isCustom = e.target.value === 'custom';
                    document.getElementById('obsWidth').disabled = !isCustom;
                    document.getElementById('obsHeight').disabled = !isCustom;
                    actualizarURLPersonalizada();
                });
            }
            
            ['obsWidth', 'obsHeight', 'obsHeader', 'obsSidebar', 'obsTransparent', 'obsMinimal'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', actualizarURLPersonalizada);
                    element.addEventListener('input', actualizarURLPersonalizada);
                }
            });
        });
        
        // FUNCIONES PARA INICIATIVAS EXTRAORDINARIAS
        let iniciativasExtraordinariasTemp = [];
        
        function mostrarModalExtraordinarias() {
            cargarListaDiputadosParaExtraordinarias();
            cargarNumerosDisponibles();
            cargarPartidosDisponibles();
            const modal = new bootstrap.Modal(document.getElementById('extraordinariasModal'));
            modal.show();
        }
        
        // Cargar partidos disponibles
        async function cargarPartidosDisponibles() {
            try {
                const response = await fetch('/api/operador/partidos', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const partidos = await response.json();
                    const select = document.getElementById('extPartido');
                    if (select) {
                        select.innerHTML = '<option value="">Seleccionar...</option>';
                        
                        partidos.forEach(partido => {
                            const option = document.createElement('option');
                            option.value = partido.siglas || partido.nombre;
                            option.textContent = partido.siglas || partido.nombre;
                            select.appendChild(option);
                        });
                    }
                } else {
                    console.error('Error al cargar partidos:', response.status);
                }
            } catch (error) {
                console.error('Error cargando partidos:', error);
                // En caso de error, usar valores por defecto
                const select = document.getElementById('extPartido');
                if (select) {
                    select.innerHTML = `
                        <option value="">Seleccionar...</option>
                        <option value="MORENA">MORENA</option>
                        <option value="PAN">PAN</option>
                        <option value="PRI">PRI</option>
                        <option value="PT">PT</option>
                        <option value="PVEM">PVEM</option>
                        <option value="MC">MC</option>
                        <option value="Nueva Alianza Morelos">Nueva Alianza Morelos</option>
                    `;
                }
            }
        }
        
        async function cargarListaDiputadosParaExtraordinarias() {
            try {
                const response = await fetch('/api/operador/lista-diputados', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const diputados = await response.json();
                    const select = document.getElementById('extPresentador');
                    select.innerHTML = '<option value="">Seleccionar diputado...</option>';
                    
                    diputados.forEach(dip => {
                        const option = document.createElement('option');
                        option.value = dip.nombre || dip.nombre_completo;
                        option.textContent = dip.nombre || dip.nombre_completo;
                        option.dataset.partido = dip.partido;
                        select.appendChild(option);
                    });
                } else {
                    console.error('Error al cargar diputados:', response.status);
                }
            } catch (error) {
                console.error('Error cargando diputados:', error);
            }
        }
        
        async function cargarNumerosDisponibles() {
            try {
                const response = await fetch('/api/operador/sesion-activa', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('extNumero');
                    select.innerHTML = '<option value="">Seleccionar posici√≥n...</option>';
                    
                    // Obtener el m√°ximo n√∫mero de iniciativas actuales
                    const maxNum = (data.iniciativas ? data.iniciativas.length : 0) + 10;
                    
                    // Agregar opciones del 1 al total de iniciativas + 10
                    for (let i = 1; i <= maxNum; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Posici√≥n ${i}`;
                        select.appendChild(option);
                    }
                } else {
                    // Si no hay sesi√≥n activa, ofrecer posiciones del 1 al 20
                    const select = document.getElementById('extNumero');
                    select.innerHTML = '<option value="">Seleccionar posici√≥n...</option>';
                    for (let i = 1; i <= 20; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Posici√≥n ${i}`;
                        select.appendChild(option);
                    }
                }
            } catch (error) {
                console.error('Error cargando n√∫meros disponibles:', error);
                // En caso de error, ofrecer posiciones del 1 al 20
                const select = document.getElementById('extNumero');
                select.innerHTML = '<option value="">Seleccionar posici√≥n...</option>';
                for (let i = 1; i <= 20; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Posici√≥n ${i}`;
                    select.appendChild(option);
                }
            }
        }
        
        function actualizarPartidoAutomatico() {
            const select = document.getElementById('extPresentador');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.partido) {
                document.getElementById('extPartido').value = selectedOption.dataset.partido;
            }
        }
        
        function agregarExtraordinaria() {
            const iniciativa = {
                numero: document.getElementById('extNumero').value,
                descripcion: document.getElementById('extDescripcion').value,
                presentador: document.getElementById('extPresentador').value,
                partido_presentador: document.getElementById('extPartido').value,
                tipo_mayoria: document.getElementById('extTipoMayoria').value,
                tipo_iniciativa: 'extraordinaria'
            };
            
            if (!iniciativa.numero || !iniciativa.descripcion) {
                alert('Por favor complete los campos obligatorios');
                return;
            }
            
            iniciativasExtraordinariasTemp.push(iniciativa);
            actualizarListaExtraordinarias();
            
            // Limpiar formulario
            document.getElementById('extNumero').value = '';
            document.getElementById('extDescripcion').value = '';
            document.getElementById('extPresentador').value = '';
            document.getElementById('extPartido').value = '';
            document.getElementById('extTipoMayoria').value = 'simple';
        }
        
        // Guardar sesi√≥n actual
        async function guardarSesion() {
            try {
                const response = await fetch('/api/operador/sesion-activa', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (!data.sesion) {
                    alert('No hay sesi√≥n activa para guardar');
                    return;
                }
                
                if (!data.iniciativas || data.iniciativas.length === 0) {
                    alert('No hay iniciativas para guardar');
                    return;
                }
                
                const nombreSesion = prompt('Ingrese un nombre para guardar esta sesi√≥n:', 
                    `${data.sesion.nombre} - Respaldo ${new Date().toLocaleDateString('es-MX')}`);
                
                if (!nombreSesion) return;
                
                // Guardar como sesi√≥n precargada
                const saveResponse = await fetch('/api/operador/guardar-sesion-respaldo', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sesion_id: data.sesion.id,
                        nombre: nombreSesion,
                        descripcion: `Respaldo de ${data.sesion.nombre} con ${data.iniciativas.length} iniciativas`
                    })
                });
                
                if (saveResponse.ok) {
                    const result = await saveResponse.json();
                    
                    // Mostrar mensaje de √©xito
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <strong>‚úÖ Sesi√≥n guardada</strong><br>
                        "${nombreSesion}" guardada con ${data.iniciativas.length} iniciativas.
                        <br><small>Puede recuperarla desde "Sesiones Pendientes"</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    setTimeout(() => alertDiv.remove(), 7000);
                    
                    // Actualizar lista de sesiones pendientes
                    loadSesionesPendientes();
                } else {
                    const error = await saveResponse.json();
                    alert('Error al guardar la sesi√≥n: ' + (error.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar la sesi√≥n');
            }
        }
        
        // Limpiar/Eliminar todas las iniciativas de la sesi√≥n actual
        async function limpiarSesion() {
            try {
                const response = await fetch('/api/operador/sesion-activa', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (!data.sesion) {
                    alert('No hay sesi√≥n activa');
                    return;
                }
                
                if (!data.iniciativas || data.iniciativas.length === 0) {
                    alert('No hay iniciativas para eliminar');
                    return;
                }
                
                // Verificar si hay votaciones activas (NO cerradas, solo activas)
                const votacionesActivas = data.iniciativas.filter(i => i.activa);
                if (votacionesActivas.length > 0) {
                    alert('No se puede limpiar la sesi√≥n porque hay votaciones activas.\n\n' +
                          'Por favor, finalice todas las votaciones activas primero.');
                    return;
                }
                
                const confirmMessage = `¬øEst√° seguro de eliminar TODAS las iniciativas de la sesi√≥n actual?\n\n` +
                                      `Sesi√≥n: ${data.sesion.nombre}\n` +
                                      `Iniciativas a eliminar: ${data.iniciativas.length}\n\n` +
                                      `Esta acci√≥n NO se puede deshacer.`;
                
                if (!confirm(confirmMessage)) return;
                
                // Segunda confirmaci√≥n para mayor seguridad
                if (!confirm('¬øEst√° COMPLETAMENTE SEGURO? Se eliminar√°n todas las iniciativas.')) return;
                
                // Eliminar todas las iniciativas de la sesi√≥n
                const deleteResponse = await fetch(`/api/operador/limpiar-sesion/${data.sesion.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (deleteResponse.ok) {
                    const result = await deleteResponse.json();
                    
                    // Mostrar mensaje de √©xito
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 end-0 m-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <strong>üóëÔ∏è Sesi√≥n limpiada</strong><br>
                        Se eliminaron ${result.eliminadas} iniciativas de la sesi√≥n.
                        <br><small>La sesi√≥n est√° lista para cargar nuevas iniciativas</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    setTimeout(() => alertDiv.remove(), 5000);
                    
                    // Recargar completamente la p√°gina para limpiar todo el estado
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    const error = await deleteResponse.json();
                    alert('Error al limpiar la sesi√≥n: ' + (error.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al limpiar la sesi√≥n');
            }
        }
        
        // El formulario ya no necesita un event listener porque usamos onclick en el bot√≥n
        
        // Manejar formulario de PDF (si existe)
        const extraordinariaPdfForm = document.getElementById('extraordinariaPdfForm');
        if (extraordinariaPdfForm) {
            extraordinariaPdfForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('extPdfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor selecciona un archivo PDF');
                return;
            }
            
            const formData = new FormData();
            formData.append('pdf', file);
            formData.append('tipo_iniciativa', 'extraordinaria');
            
            const numeroInicio = document.getElementById('extNumeroInicio').value;
            const numeroFin = document.getElementById('extNumeroFin').value;
            
            if (numeroInicio) formData.append('numero_inicio', numeroInicio);
            if (numeroFin) formData.append('numero_fin', numeroFin);
            
            const statusDiv = document.getElementById('pdfExtraordinariasStatus');
            statusDiv.innerHTML = '<div class="alert alert-info">Procesando PDF...</div>';
            
            try {
                const response = await fetch('/api/operador/procesar-pdf-extraordinarias', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ PDF procesado: ${data.iniciativas.length} iniciativas extraordinarias extra√≠das
                        </div>
                    `;
                    
                    // Agregar a la lista temporal
                    data.iniciativas.forEach(init => {
                        init.tipo_iniciativa = 'extraordinaria';
                        iniciativasExtraordinariasTemp.push(init);
                    });
                    
                    actualizarListaExtraordinarias();
                    fileInput.value = '';
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = '<div class="alert alert-danger">Error al procesar el PDF</div>';
            }
        });
        } // Cierre del if (extraordinariaPdfForm)
        
        // Actualizar lista de iniciativas extraordinarias
        function actualizarListaExtraordinarias() {
            const lista = document.getElementById('listaExtraordinarias');
            
            if (iniciativasExtraordinariasTemp.length === 0) {
                lista.innerHTML = '<p class="text-muted">No hay iniciativas extraordinarias agregadas</p>';
                return;
            }
            
            lista.innerHTML = iniciativasExtraordinariasTemp.map((init, index) => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${init.numero}. ${init.titulo}</strong>
                            <small class="text-muted d-block">
                                ${init.presentador || 'Sin presentador'} 
                                ${init.partido_presentador ? `(${init.partido_presentador})` : ''}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="eliminarExtraordinariaTemporal(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Eliminar iniciativa extraordinaria temporal
        function eliminarExtraordinariaTemporal(index) {
            iniciativasExtraordinariasTemp.splice(index, 1);
            actualizarListaExtraordinarias();
        }
        
        // Guardar todas las iniciativas extraordinarias
        async function guardarTodasExtraordinarias() {
            if (iniciativasExtraordinariasTemp.length === 0) {
                alert('No hay iniciativas extraordinarias para guardar');
                return;
            }
            
            try {
                const response = await fetch('/api/operador/guardar-extraordinarias', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        iniciativas: iniciativasExtraordinariasTemp
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ ${data.guardadas} iniciativas extraordinarias guardadas exitosamente`);
                    
                    // Limpiar lista temporal
                    iniciativasExtraordinariasTemp = [];
                    actualizarListaExtraordinarias();
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('extraordinariasModal')).hide();
                    
                    // Recargar lista de iniciativas
                    loadActiveSession();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar las iniciativas extraordinarias');
            }
        }
        
        // Verificar si hay sesiones precargadas
        async function verificarSesionesPrecargadas() {
            try {
                const response = await fetch('/api/operador/sesiones-precargadas/disponibles', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.sesiones && data.sesiones.length > 0) {
                    document.getElementById('sesionesPrecargadasAlert').style.display = 'block';
                    document.getElementById('countSesionesPrecargadas').textContent = data.sesiones.length;
                } else {
                    document.getElementById('sesionesPrecargadasAlert').style.display = 'none';
                }
            } catch (error) {
                console.error('Error verificando sesiones precargadas:', error);
            }
        }
        
        // Ver sesiones precargadas
        async function verSesionesPrecargadas() {
            try {
                const response = await fetch('/api/operador/sesiones-precargadas/disponibles', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.sesiones && data.sesiones.length > 0) {
                    mostrarModalSesionesPrecargadas(data.sesiones);
                } else {
                    alert('No hay sesiones precargadas disponibles');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar sesiones precargadas');
            }
        }
        
        // Mostrar modal con sesiones precargadas
        function mostrarModalSesionesPrecargadas(sesiones) {
            const modalBody = document.getElementById('listaSesionesPrecargadas');
            
            modalBody.innerHTML = sesiones.map(sesion => `
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">${sesion.nombre_sesion}</h6>
                                <small class="text-muted">
                                    ${new Date(sesion.fecha_sesion).toLocaleDateString('es-MX')} | 
                                    ${sesion.iniciativas_count} iniciativas
                                </small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-info" onclick="verDetalleSesionPrecargada(${sesion.id})">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="usarSesionPrecargada(${sesion.id})">
                                    <i class="fas fa-check"></i> Usar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" id="detalleSesion${sesion.id}" style="display:none;">
                        <!-- Aqu√≠ se cargar√°n los detalles -->
                    </div>
                </div>
            `).join('');
            
            const modal = new bootstrap.Modal(document.getElementById('sesionesPrecargadasModal'));
            modal.show();
        }
        
        // Ver detalle de sesi√≥n precargada
        async function verDetalleSesionPrecargada(sesionId) {
            const detalleDiv = document.getElementById(`detalleSesion${sesionId}`);
            
            if (detalleDiv.style.display === 'block') {
                detalleDiv.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/operador/sesiones-precargadas/${sesionId}/iniciativas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const iniciativas = await response.json();
                
                detalleDiv.innerHTML = `
                    <h6>Iniciativas:</h6>
                    <div class="list-group">
                        ${iniciativas.map(init => `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>${init.numero}. ${init.titulo}</strong>
                                        <p class="mb-1 small">${init.descripcion || 'Sin descripci√≥n'}</p>
                                        ${init.presentador ? `
                                            <small class="text-muted">
                                                Presentador: ${init.presentador} 
                                                ${init.partido_presentador ? `(${init.partido_presentador})` : ''}
                                            </small>
                                        ` : ''}
                                    </div>
                                    <span class="badge bg-secondary">${init.tipo_mayoria || 'Simple'}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                detalleDiv.style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar detalles de la sesi√≥n');
            }
        }
        
        // Usar sesi√≥n precargada
        async function usarSesionPrecargada(sesionId) {
            if (!confirm('¬øDesea cargar esta sesi√≥n precargada? Esto reemplazar√° cualquier sesi√≥n activa actual.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/operador/cargar-sesion-precargada/${sesionId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Sesi√≥n cargada exitosamente');
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('sesionesPrecargadasModal')).hide();
                    
                    // Recargar sesi√≥n activa
                    loadActiveSession();
                    
                    // Ocultar alerta de sesiones precargadas
                    document.getElementById('sesionesPrecargadasAlert').style.display = 'none';
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar la sesi√≥n precargada');
            }
        }
        
        // Verificar sesiones precargadas al cargar la p√°gina
        verificarSesionesPrecargadas();
    </script>
    
    <!-- Modal de Validaci√≥n Estilo Apple/iOS Completo -->
    <div id="modalValidacionApple" style="display: none; opacity: 0; transition: opacity 0.3s ease;">
        <!-- Overlay con blur estilo iOS -->
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 9998;"></div>
        
        <!-- Modal con estilo Apple -->
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 1400px; height: 90vh; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.5) inset; z-index: 9999; overflow: hidden; display: flex; flex-direction: column;">
            
            <!-- Header estilo iOS con bot√≥n PDF -->
            <div style="background: linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(248,248,248,1) 100%); border-bottom: 1px solid rgba(0,0,0,0.1); padding: 20px 30px; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 20px; flex: 1;">
                    <div>
                        <h2 style="margin: 0; font-size: 22px; font-weight: 600; color: #1c1c1e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                            <i class="fas fa-check-circle" style="color: #34c759; margin-right: 8px;"></i>Validaci√≥n de Iniciativas
                        </h2>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #8e8e93; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">Revisa y confirma las iniciativas a importar</p>
                    </div>
                    <button type="button" onclick="toggleVisorPDFApple()" style="
                        background: #007aff;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                        font-weight: 500;
                        transition: all 0.2s;
                    " title="Ver PDF Original">
                        <i class="fas fa-file-pdf"></i> Ver PDF Original
                    </button>
                </div>
                <button onclick="cerrarModalApple()" style="width: 30px; height: 30px; border-radius: 50%; background: #e5e5e7; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #8e8e93; transition: all 0.2s;" onmouseover="this.style.background='#d1d1d3'" onmouseout="this.style.background='#e5e5e7'">
                    ‚úï
                </button>
            </div>
            
            <!-- Body con contenido dividido -->
            <div style="flex: 1; display: flex; overflow: hidden;">
                <!-- Visor de PDF (inicialmente oculto) -->
                <div id="visorPDFContainerApple" style="width: 50%; border-right: 1px solid rgba(0,0,0,0.1); background: #f5f5f7; display: none; flex-direction: column;">
                    <div style="padding: 15px; background: linear-gradient(180deg, #fafafa 0%, #f0f0f0 100%); border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: #1c1c1e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                            <i class="fas fa-file-pdf" style="color: #dc3545;"></i> Documento Original
                        </span>
                        <button onclick="cerrarVisorPDFApple()" style="background: rgba(220, 53, 69, 0.1); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-times" style="color: #dc3545;"></i>
                        </button>
                    </div>
                    <iframe id="pdfViewerApple" src="" style="flex: 1; width: 100%; border: none;"></iframe>
                </div>
                
                <!-- Contenedor principal de validaci√≥n -->
                <div id="validacionContainerApple" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; width: 100%;">
                    <div style="flex: 1; overflow-y: auto; padding: 20px; background: #f2f2f7; -webkit-overflow-scrolling: touch;">
                        
                        <!-- Estad√≠sticas con dise√±o Apple -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div onclick="filtrarIniciativas('todas')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="color: white; text-align: center;">
                                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Total Iniciativas</div>
                                    <div id="totalIniciativas" style="font-size: 28px; font-weight: bold;">0</div>
                                </div>
                            </div>
                            <div onclick="filtrarIniciativas('votacion')" style="background: linear-gradient(135deg, #34c759 0%, #30d158 100%); padding: 15px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="color: white; text-align: center;">
                                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Requieren Votaci√≥n</div>
                                    <div id="requierenVotacion" style="font-size: 28px; font-weight: bold;">0</div>
                                </div>
                            </div>
                            <div onclick="filtrarIniciativas('comisiones')" style="background: linear-gradient(135deg, #ff9500 0%, #ffcc00 100%); padding: 15px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(255, 149, 0, 0.3);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="color: white; text-align: center;">
                                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">A Comisiones</div>
                                    <div id="aComisiones" style="font-size: 28px; font-weight: bold;">0</div>
                                </div>
                            </div>
                            <div onclick="filtrarIniciativas('otros')" style="background: linear-gradient(135deg, #8e8e93 0%, #636366 100%); padding: 15px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(142, 142, 147, 0.3);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="color: white; text-align: center;">
                                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Otros</div>
                                    <div id="otros" style="font-size: 28px; font-weight: bold;">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtro activo -->
                        <div id="filtroActivo" style="display: none; background: linear-gradient(135deg, #007aff 0%, #5856d6 100%); color: white; padding: 12px 20px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-filter"></i> Filtro activo: <strong id="textoFiltro">Todas</strong></span>
                            <button onclick="filtrarIniciativas('todas')" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 5px 12px; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-times"></i> Limpiar
                            </button>
                        </div>
                        
                        <!-- Tipo de Carga -->
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <label style="font-weight: 600; color: #1c1c1e; margin-bottom: 15px; display: block;">Tipo de Carga:</label>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="tipoCargaValidacion" id="cargaInmediataVal" value="inmediata" checked style="margin-right: 8px;">
                                    <span><i class="fas fa-play" style="color: #34c759;"></i> Sesi√≥n Inmediata</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="tipoCargaValidacion" id="cargaProgramadaVal" value="programada" style="margin-right: 8px;">
                                    <span><i class="fas fa-calendar" style="color: #007aff;"></i> Sesi√≥n Programada</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="tipoCargaValidacion" id="cargaIndefinidaVal" value="indefinida" style="margin-right: 8px;">
                                    <span><i class="fas fa-question" style="color: #8e8e93;"></i> Fecha Indefinida</span>
                                </label>
                            </div>
                            <div id="fechaProgramadaVal" style="display: none; margin-top: 15px;">
                                <label for="fechaSesionVal" style="display: block; margin-bottom: 5px; font-weight: 500;">Fecha y Hora de la Sesi√≥n:</label>
                                <input type="datetime-local" id="fechaSesionVal" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d1d6; border-radius: 8px; font-size: 16px;">
                            </div>
                        </div>
                        
                        <!-- Modo de Importaci√≥n IMPORTANTE -->
                        <div style="background: linear-gradient(135deg, #ff9500 0%, #ff6200 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 149, 0, 0.3);">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <input type="checkbox" id="importarTodasSwitch" checked style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                                <label for="importarTodasSwitch" style="font-weight: 600; font-size: 16px; cursor: pointer;">
                                    <i class="fas fa-database"></i> Importar TODAS las iniciativas del documento
                                </label>
                            </div>
                            <div style="background: rgba(255, 255, 255, 0.2); padding: 10px; border-radius: 8px; font-size: 14px;">
                                ‚ö†Ô∏è <strong>Activado:</strong> Se importar√°n TODAS las iniciativas y las seleccionadas se marcar√°n para votaci√≥n.<br>
                                <strong>Desactivado:</strong> Solo se importar√°n las iniciativas que selecciones.
                            </div>
                        </div>
                        
                        <!-- Controles de selecci√≥n -->
                        <div style="background: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="display: flex; gap: 10px;">
                                <button onclick="seleccionarRecomendadas()" style="background: linear-gradient(135deg, #34c759 0%, #30d158 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-robot"></i> Usar Recomendaciones
                                </button>
                                <button onclick="seleccionarTodasVotables()" style="background: white; color: #34c759; border: 1px solid #34c759; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-check-square"></i> Votables
                                </button>
                                <button onclick="seleccionarTodas()" style="background: white; color: #8e8e93; border: 1px solid #8e8e93; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-check-double"></i> Todas
                                </button>
                                <button onclick="deseleccionarTodas()" style="background: white; color: #ff9500; border: 1px solid #ff9500; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-times"></i> Ninguna
                                </button>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <span style="background: linear-gradient(135deg, #007aff 0%, #5856d6 100%); color: white; padding: 6px 12px; border-radius: 20px; font-weight: 500;">
                                    <span id="contadorSeleccionadas">0</span> seleccionadas
                                </span>
                                <span style="background: #8e8e93; color: white; padding: 6px 12px; border-radius: 20px; font-weight: 500;">
                                    <span id="contadorTotal">0</span> total
                                </span>
                                <span id="contadorRecomendadas" style="display: none; background: linear-gradient(135deg, #34c759 0%, #30d158 100%); color: white; padding: 6px 12px; border-radius: 20px; font-weight: 500;">
                                    <span id="numRecomendadas">0</span> recomendadas
                                </span>
                            </div>
                        </div>
                        
                        <!-- Tabla de Iniciativas -->
                        <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background: linear-gradient(180deg, #f5f5f7 0%, #e5e5ea 100%); position: sticky; top: 0; z-index: 10;">
                                        <tr>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #1c1c1e; width: 40px;">
                                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" title="Seleccionar todas">
                                            </th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #1c1c1e; width: 60px;">N√∫m.</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #1c1c1e; width: 60px;">Orden</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #1c1c1e;">Descripci√≥n / Contenido</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #1c1c1e; width: 120px;">Tipo</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #1c1c1e; width: 100px;">Categor√≠a</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #1c1c1e; width: 80px;">Mayor√≠a</th>
                                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #1c1c1e; width: 80px;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaValidacion" style="background: white;">
                                        <!-- Se llenar√° din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer con botones estilo iOS -->
            <div style="background: linear-gradient(180deg, rgba(248,248,248,1) 0%, rgba(255,255,255,1) 100%); border-top: 1px solid rgba(0,0,0,0.1); padding: 20px 30px; display: flex; justify-content: flex-end; gap: 12px;">
                <!-- Bot√≥n Cancelar -->
                <button onclick="cancelarValidacion()" style="padding: 12px 24px; background: #f2f2f7; color: #3c3c43; border: none; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: 500; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; transition: all 0.2s; min-width: 100px;" onmouseover="this.style.background='#e5e5ea'" onmouseout="this.style.background='#f2f2f7'">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                
                <!-- Bot√≥n Vista Previa -->
                <button onclick="mostrarVistaPrevia()" style="padding: 12px 24px; background: #FF1493; color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: 500; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; transition: all 0.2s; min-width: 120px;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 15px rgba(255,20,147,0.3)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                    <i class="fas fa-eye"></i> Vista Previa
                </button>
                
                <!-- Bot√≥n Confirmar -->
                <button id="btnGuardarValidacionApple" onclick="guardarIniciativasSeleccionadas()" style="padding: 12px 30px; background: linear-gradient(135deg, #FF8C00 0%, #FFA500 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: 600; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; transition: all 0.2s; min-width: 180px; box-shadow: 0 2px 10px rgba(255,140,0,0.3);" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 20px rgba(255,140,0,0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 10px rgba(255,140,0,0.3)'">
                    <i class="fas fa-save"></i> CONFIRMAR Y CARGAR
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal original de Bootstrap (lo mantenemos pero oculto) -->
    <div class="modal fade" id="modalValidacion" data-bs-backdrop="static" data-bs-keyboard="false" style="display: none !important;">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle"></i> Validaci√≥n de Iniciativas
                    </h5>
                    <div class="ms-auto me-2">
                        <button type="button" class="btn btn-light btn-sm" onclick="toggleVisorPDF()" title="Ver PDF Original">
                            <i class="fas fa-file-pdf"></i> Ver PDF Original
                        </button>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Contenedor para vista dividida -->
                    <div id="vistaValidacion" class="row">
                        <!-- Visor de PDF (inicialmente oculto) -->
                        <div id="visorPDFContainer" class="col-md-6" style="display: none;">
                            <div class="card h-100">
                                <div class="card-header bg-secondary text-white">
                                    <i class="fas fa-file-pdf"></i> Documento Original
                                    <button type="button" class="btn btn-sm btn-light float-end" onclick="cerrarVisorPDF()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="card-body p-0" style="height: 600px; overflow: hidden;">
                                    <iframe id="pdfViewer" src="" style="width: 100%; height: 100%; border: none;"></iframe>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Contenedor de validaci√≥n (inicialmente completo) -->
                        <div id="validacionContainer" class="col-md-12">
                    <!-- Estad√≠sticas -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="card border-info" style="cursor: pointer; background-color: #d1ecf1;" onclick="filtrarIniciativas('todas')">
                                <div class="card-body p-2 text-center">
                                    <h6 class="text-info">Total Iniciativas</h6>
                                    <h3 id="totalIniciativas" class="text-info">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-success" style="cursor: pointer; background-color: #d4edda;" onclick="filtrarIniciativas('votacion')">
                                <div class="card-body p-2 text-center">
                                    <h6 class="text-success">Requieren Votaci√≥n</h6>
                                    <h3 id="requierenVotacion" class="text-success">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-warning" style="cursor: pointer; background-color: #fff3cd;" onclick="filtrarIniciativas('comisiones')">
                                <div class="card-body p-2 text-center">
                                    <h6 class="text-warning-emphasis">A Comisiones</h6>
                                    <h3 id="aComisiones" class="text-warning-emphasis">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-secondary" style="cursor: pointer; background-color: #e2e3e5;" onclick="filtrarIniciativas('otros')">
                                <div class="card-body p-2 text-center">
                                    <h6 class="text-secondary">Otros</h6>
                                    <h3 id="otros" class="text-secondary">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtro activo -->
                    <div id="filtroActivo" class="alert alert-info mb-2" style="display: none;">
                        <i class="fas fa-filter"></i> Filtro activo: <strong id="textoFiltro">Todas</strong>
                        <button class="btn btn-sm btn-light float-end" onclick="filtrarIniciativas('todas')">
                            <i class="fas fa-times"></i> Limpiar filtro
                        </button>
                    </div>
                    
                    <!-- Tipo de Carga -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tipo de Carga:</label>
                        <div class="form-check form-check-inline" id="tipoCargaValidacionGroup">
                            <input class="form-check-input" type="radio" name="tipoCargaValidacion" id="cargaInmediataVal" value="inmediata" checked>
                            <label class="form-check-label" for="cargaInmediataVal">
                                <i class="fas fa-play"></i> Sesi√≥n Inmediata
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoCargaValidacion" id="cargaProgramadaVal" value="programada">
                            <label class="form-check-label" for="cargaProgramadaVal">
                                <i class="fas fa-calendar"></i> Sesi√≥n Programada
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoCargaValidacion" id="cargaIndefinidaVal" value="indefinida">
                            <label class="form-check-label" for="cargaIndefinidaVal">
                                <i class="fas fa-question"></i> Fecha Indefinida
                            </label>
                        </div>
                        
                        <div id="fechaProgramadaVal" style="display: none;" class="mt-2">
                            <label for="fechaSesionVal" class="form-label">Fecha y Hora de la Sesi√≥n:</label>
                            <input type="datetime-local" class="form-control" id="fechaSesionVal">
                        </div>
                    </div>
                    
                    <!-- Modo de Importaci√≥n -->
                    <div class="alert alert-warning mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="importarTodasSwitch" checked>
                            <label class="form-check-label fw-bold" for="importarTodasSwitch">
                                <i class="fas fa-database"></i> Importar TODAS las iniciativas del documento
                            </label>
                        </div>
                        <small class="text-muted d-block mt-1">
                            ‚ö†Ô∏è Si est√° activado: Se importar√°n TODAS las iniciativas y las seleccionadas se marcar√°n para votaci√≥n.<br>
                            Si est√° desactivado: Solo se importar√°n las iniciativas que selecciones.
                        </small>
                    </div>
                    
                    <!-- Controles de selecci√≥n -->
                    <div class="mb-2 d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-sm btn-success" onclick="seleccionarRecomendadas()" title="Seleccionar las que el sistema recomienda para votaci√≥n">
                                <i class="fas fa-robot"></i> Usar Recomendaciones
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="seleccionarTodasVotables()">
                                <i class="fas fa-check-square"></i> Votables
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="seleccionarTodas()">
                                <i class="fas fa-check-double"></i> Todas
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="deseleccionarTodas()">
                                <i class="fas fa-times"></i> Ninguna
                            </button>
                        </div>
                        <div>
                            <span class="badge bg-primary">
                                <span id="contadorSeleccionadas">0</span> seleccionadas
                            </span>
                            <span class="badge bg-secondary ms-1">
                                <span id="contadorTotal">0</span> total
                            </span>
                            <span class="badge bg-success ms-1" id="contadorRecomendadas" style="display:none;">
                                <span id="numRecomendadas">0</span> recomendadas
                            </span>
                        </div>
                    </div>
                    
                    <!-- Tabla de Iniciativas -->
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover table-sm">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" title="Seleccionar todas">
                                    </th>
                                    <th width="60">N√∫m.</th>
                                    <th width="60">Orden</th>
                                    <th>Descripci√≥n / Contenido</th>
                                    <th width="120">Tipo</th>
                                    <th width="100">Categor√≠a</th>
                                    <th width="80">Mayor√≠a</th>
                                    <th width="80">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaValidacion">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                        </div><!-- Cierre de validacionContainer -->
                    </div><!-- Cierre de vistaValidacion -->
                </div><!-- Cierre de modal-body -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cancelarValidacion()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn" style="background-color: #FF1493; color: white; border: 2px solid #FF1493;" onclick="mostrarVistaPrevia()" onmouseover="this.style.backgroundColor='#FF69B4'" onmouseout="this.style.backgroundColor='#FF1493'">
                        <i class="fas fa-eye"></i> Vista Previa
                    </button>
                    <button type="button" class="btn" style="background-color: #FF8C00; color: white; border: 2px solid #FF8C00; font-weight: bold;" id="btnGuardarValidacion" onclick="ejecutarGuardado()" onmouseover="this.style.backgroundColor='#FFA500'" onmouseout="this.style.backgroundColor='#FF8C00'">
                        <i class="fas fa-save"></i> CONFIRMAR Y CARGAR
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Edici√≥n de Iniciativa con z-index alto -->
    <div class="modal fade" id="modalEditarIniciativa" tabindex="-1" style="z-index: 10000 !important;">
        <div class="modal-dialog" style="z-index: 10001 !important;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Iniciativa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarIniciativa">
                        <input type="hidden" id="editNumeroSistema">
                        
                        <div class="mb-3">
                            <label for="editNumeroOrden" class="form-label">N√∫mero Orden del D√≠a:</label>
                            <input type="number" class="form-control" id="editNumeroOrden" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editDescripcionModal" class="form-label">Descripci√≥n:</label>
                            <textarea class="form-control" id="editDescripcionModal" rows="5" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editPresentadorModal" class="form-label">Presentador:</label>
                            <input type="text" class="form-control" id="editPresentadorModal">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editPartidoModal" class="form-label">Partido:</label>
                            <input type="text" class="form-control" id="editPartidoModal">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editTipoMayoriaModal" class="form-label">Tipo de Mayor√≠a:</label>
                            <select class="form-select" id="editTipoMayoriaModal">
                                <option value="simple">Simple</option>
                                <option value="calificada">Calificada</option>
                                <option value="especial">Especial</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarEdicionIniciativa()">Guardar</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Variables para validaci√≥n (ya declaradas globalmente al inicio)
        
        // Funci√≥n para filtrar iniciativas
        function filtrarIniciativas(tipo) {
            filtroActual = tipo;
            const filtroDiv = document.getElementById('filtroActivo');
            const tbody = document.getElementById('tablaValidacion');
            
            let iniciativasFiltradas = [...iniciativasValidacion];
            let textoFiltro = 'Todas';
            
            switch(tipo) {
                case 'votacion':
                    iniciativasFiltradas = iniciativasValidacion.filter(i => i.requiere_votacion);
                    textoFiltro = 'Requieren Votaci√≥n';
                    break;
                case 'comisiones':
                    iniciativasFiltradas = iniciativasValidacion.filter(i => 
                        i.tipo_votacion && i.tipo_votacion.toLowerCase().includes('comisi√≥n'));
                    textoFiltro = 'A Comisiones';
                    break;
                case 'otros':
                    iniciativasFiltradas = iniciativasValidacion.filter(i => 
                        !i.requiere_votacion && 
                        (!i.tipo_votacion || !i.tipo_votacion.toLowerCase().includes('comisi√≥n')));
                    textoFiltro = 'Otros';
                    break;
                case 'todas':
                default:
                    filtroDiv.style.display = 'none';
                    break;
            }
            
            if (tipo !== 'todas') {
                filtroDiv.style.display = 'block';
                document.getElementById('textoFiltro').textContent = textoFiltro;
            }
            
            renderizarTablaValidacion(iniciativasFiltradas);
        }
        
        // Funci√≥n para eliminar iniciativa en validaci√≥n
        function eliminarIniciativaValidacion(index) {
            if (!confirm('¬øEliminar esta iniciativa? No se importar√° a la sesi√≥n.')) return;
            
            // Eliminar de la lista
            iniciativasValidacion.splice(index, 1);
            
            // Actualizar estad√≠sticas
            actualizarEstadisticasValidacion();
            
            // Re-renderizar tabla con filtro actual
            if (filtroActual !== 'todas') {
                filtrarIniciativas(filtroActual);
            } else {
                renderizarTablaValidacion(iniciativasValidacion);
            }
        }
        
        // Funciones de selecci√≥n de iniciativas
        function toggleIniciativaSeleccion(index) {
            iniciativasValidacion[index].seleccionada = !iniciativasValidacion[index].seleccionada;
            actualizarContadorSeleccionadas();
        }
        
        // Funci√≥n toggleSelectAll ya est√° definida arriba, no duplicar
        
        function seleccionarTodasVotables() {
            iniciativasValidacion.forEach(init => {
                if (init.requiere_votacion) {
                    init.seleccionada = true;
                }
            });
            renderizarTablaValidacion(iniciativasValidacion);
        }
        
        function seleccionarTodas() {
            iniciativasValidacion.forEach(init => {
                init.seleccionada = true;
            });
            renderizarTablaValidacion(iniciativasValidacion);
        }
        
        function deseleccionarTodas() {
            iniciativasValidacion.forEach(init => {
                init.seleccionada = false;
            });
            renderizarTablaValidacion(iniciativasValidacion);
        }
        
        // Funci√≥n para guardar las iniciativas seleccionadas
        async function guardarIniciativasSeleccionadas() {
            console.log('=== GUARDAR INICIATIVAS SELECCIONADAS ===');
            console.log('Iniciativas en validaci√≥n:', iniciativasValidacion.length);
            
            const iniciativasSeleccionadas = iniciativasValidacion.filter(i => i.seleccionada);
            console.log('Iniciativas seleccionadas:', iniciativasSeleccionadas.length);
            
            if (iniciativasSeleccionadas.length === 0) {
                alert('Por favor selecciona al menos una iniciativa para importar');
                return;
            }
            
            // Marcar las iniciativas votables para que se muestren con el icono verde
            iniciativasSeleccionadas.forEach(init => {
                if (init.categoria === 'segunda_lectura' || 
                    init.categoria === 'dictamenes' ||
                    init.categoria === 'puntos_acuerdo') {
                    init.requiere_votacion = true;
                }
            });
            
            console.log('Iniciativas a importar:', iniciativasSeleccionadas);
            
            // CONFIRMACI√ìN EXPL√çCITA con el n√∫mero correcto de iniciativas seleccionadas
            if (!confirm(`¬øConfirmar la carga de ${iniciativasSeleccionadas.length} iniciativas seleccionadas?\n\nTotal disponibles: ${iniciativasValidacion.length}\nSeleccionadas: ${iniciativasSeleccionadas.length}\n\nEsta acci√≥n NO se puede deshacer.`)) {
                return;
            }
            
            console.log('SessionID actual:', sessionIdActual);
            if (!sessionIdActual) {
                alert('Error: No hay una sesi√≥n de validaci√≥n activa. Por favor, vuelve a cargar el PDF.');
                return;
            }
            
            const tipoCargaElement = document.querySelector('input[name="tipoCargaValidacion"]:checked');
            if (!tipoCargaElement) {
                alert('Por favor selecciona un tipo de carga (Inmediata, Programada o Indefinida)');
                return;
            }
            const tipoCarga = tipoCargaElement.value;
            console.log('Tipo de carga seleccionado:', tipoCarga);
            
            let fechaProgramada = null;
            
            if (tipoCarga === 'programada') {
                fechaProgramada = document.getElementById('fechaSesionVal').value;
                if (!fechaProgramada) {
                    alert('Por favor selecciona una fecha para la sesi√≥n programada');
                    return;
                }
            }
            
            // Obtener referencia al bot√≥n
            const btnGuardar = document.getElementById('btnGuardarValidacionApple');
            if (btnGuardar) {
                btnGuardar.disabled = true;
                btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            }
            
            try {
                const url = `/api/validacion/validar-sesion/${sessionIdActual}`;
                const bodyData = {
                    tipoCarga: tipoCarga,
                    fechaProgramada: fechaProgramada,
                    iniciativasSeleccionadas: iniciativasSeleccionadas
                };
                
                console.log('Enviando request a:', url);
                console.log('Datos a enviar:', {
                    tipoCarga,
                    fechaProgramada,
                    cantidadIniciativas: iniciativasSeleccionadas.length
                });
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(bodyData)
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (response.ok && data.success) {
                    // Cerrar modal Apple
                    cerrarModalApple();
                    
                    // Limpiar PDF y datos
                    pdfActual = null;
                    cerrarVisorPDF();
                    
                    // Mostrar mensaje de √©xito
                    const statusDiv = document.getElementById('uploadStatus');
                    let mensaje = '';
                    if (tipoCarga === 'inmediata') {
                        mensaje = 'Las iniciativas est√°n listas para que el presidente inicie la sesi√≥n';
                    } else if (tipoCarga === 'programada') {
                        mensaje = `Sesi√≥n programada para ${new Date(fechaProgramada).toLocaleString('es-MX')}`;
                    } else if (tipoCarga === 'indefinida') {
                        mensaje = 'Sesi√≥n guardada con fecha indefinida. Se podr√° activar cuando se decida';
                    }
                    
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ Sesi√≥n validada y guardada correctamente<br>
                            ${data.iniciativas_guardadas} iniciativas guardadas<br>
                            <small class="text-muted">${mensaje}</small>
                        </div>
                    `;
                    
                    // Limpiar formulario
                    document.getElementById('pdfFile').value = '';
                    
                    // Solo recargar si es carga inmediata
                    if (tipoCarga === 'inmediata') {
                        loadActiveSession();
                    } else {
                        // Para carga programada o indefinida, solo actualizar
                        console.log('Sesi√≥n guardada como programada/indefinida');
                    }
                } else {
                    // Mostrar error m√°s detallado
                    let mensajeError = data.error || 'Error desconocido';
                    if (data.detalles) {
                        console.error('Detalles del error:', data.detalles);
                    }
                    alert('Error al guardar la sesi√≥n: ' + mensajeError + '\n\nPor favor, intente nuevamente.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar la sesi√≥n: ' + error.message);
            } finally {
                if (btnGuardar) {
                    btnGuardar.disabled = false;
                    btnGuardar.innerHTML = '<i class="fas fa-save"></i> CONFIRMAR Y CARGAR';
                }
            }
        }
        
        // Configurar eventos de tipo de carga en modal de validaci√≥n
        document.getElementById('cargaProgramadaVal').addEventListener('change', function() {
            document.getElementById('fechaProgramadaVal').style.display = this.checked ? 'block' : 'none';
            if (this.checked) {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('fechaSesionVal').min = now.toISOString().slice(0, 16);
                document.getElementById('fechaSesionVal').required = true;
            }
        });
        
        document.getElementById('cargaInmediataVal').addEventListener('change', function() {
            document.getElementById('fechaProgramadaVal').style.display = 'none';
        });
        
        document.getElementById('cargaIndefinidaVal').addEventListener('change', function() {
            document.getElementById('fechaProgramadaVal').style.display = 'none';
        });
        
        // Funci√≥n para editar iniciativa
        function editarIniciativaValidacion(index) {
            const init = iniciativasValidacion[index];
            
            document.getElementById('editNumeroSistema').value = init.numero_sistema;
            document.getElementById('editNumeroOrden').value = init.numero_orden_dia;
            document.getElementById('editDescripcionModal').value = init.descripcion || '';
            document.getElementById('editPresentadorModal').value = init.presentador || '';
            document.getElementById('editPartidoModal').value = init.partido || '';
            document.getElementById('editTipoMayoriaModal').value = init.tipo_mayoria || 'simple';
            
            const modalEdit = new bootstrap.Modal(document.getElementById('modalEditarIniciativa'));
            modalEdit.show();
        }
        
        // Funci√≥n para guardar edici√≥n
        async function guardarEdicionIniciativa() {
            const numeroSistema = document.getElementById('editNumeroSistema').value;
            
            const datosActualizados = {
                numero_orden_dia: parseInt(document.getElementById('editNumeroOrden').value),
                descripcion: document.getElementById('editDescripcionModal').value,
                presentador: document.getElementById('editPresentadorModal').value,
                partido: document.getElementById('editPartidoModal').value,
                tipo_mayoria: document.getElementById('editTipoMayoriaModal').value
            };
            
            try {
                const response = await fetch(`/api/validacion/preview-pdf/${sessionIdActual}/iniciativa/${numeroSistema}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(datosActualizados)
                });
                
                if (response.ok) {
                    // Actualizar array local
                    const index = iniciativasValidacion.findIndex(i => i.numero_sistema == numeroSistema);
                    if (index !== -1) {
                        iniciativasValidacion[index] = { ...iniciativasValidacion[index], ...datosActualizados };
                        
                        // Actualizar estad√≠sticas
                        actualizarEstadisticasValidacion();
                        
                        // Re-renderizar tabla con filtro actual
                        if (filtroActual !== 'todas') {
                            filtrarIniciativas(filtroActual);
                        } else {
                            renderizarTablaValidacion(iniciativasValidacion);
                        }
                    }
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('modalEditarIniciativa')).hide();
                } else {
                    alert('Error al actualizar la iniciativa');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar la iniciativa');
            }
        }
        
        // Cancelar validaci√≥n sin guardar
        function cancelarValidacion() {
            if (confirm('¬øEst√°s seguro de cancelar? Se perder√°n todos los cambios no guardados.')) {
                console.log('Cancelando validaci√≥n...');
                
                // Limpiar todo
                iniciativasValidacion = [];
                sessionIdActual = null;
                pdfActual = null;
                
                // Intentar cerrar el modal Apple primero
                const modalApple = document.getElementById('modalValidacionApple');
                if (modalApple) {
                    console.log('Cerrando modal Apple...');
                    modalApple.style.opacity = '0';
                    setTimeout(() => {
                        modalApple.style.display = 'none';
                    }, 300);
                    
                    // Limpiar el visor de PDF del modal Apple
                    const pdfViewerApple = document.getElementById('pdfViewerApple');
                    if (pdfViewerApple && pdfViewerApple.src) {
                        URL.revokeObjectURL(pdfViewerApple.src);
                        pdfViewerApple.src = '';
                    }
                }
                
                // Tambi√©n intentar cerrar el modal Bootstrap si existe
                const modalBootstrap = document.getElementById('modalValidacion');
                if (modalBootstrap) {
                    console.log('Cerrando modal Bootstrap...');
                    // Intentar con Bootstrap 5
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const modalInstance = bootstrap.Modal.getInstance(modalBootstrap);
                        if (modalInstance) {
                            modalInstance.hide();
                        } else {
                            // Si no hay instancia, ocultar directamente
                            modalBootstrap.style.display = 'none';
                            modalBootstrap.classList.remove('show');
                            document.body.classList.remove('modal-open');
                            // Remover backdrop si existe
                            const backdrop = document.querySelector('.modal-backdrop');
                            if (backdrop) {
                                backdrop.remove();
                            }
                        }
                    } else {
                        // Sin Bootstrap, ocultar directamente
                        modalBootstrap.style.display = 'none';
                    }
                    
                    // Limpiar el visor de PDF del modal Bootstrap
                    const pdfViewerBootstrap = document.getElementById('pdfViewer');
                    if (pdfViewerBootstrap && pdfViewerBootstrap.src) {
                        URL.revokeObjectURL(pdfViewerBootstrap.src);
                        pdfViewerBootstrap.src = '';
                    }
                }
                
                console.log('Validaci√≥n cancelada exitosamente');
                
                // Cerrar visor PDF si existe
                if (typeof cerrarVisorPDF === 'function') {
                    cerrarVisorPDF();
                }
                if (typeof cerrarVisorPDFApple === 'function') {
                    cerrarVisorPDFApple();
                }
            }
        }
        
        // Mostrar vista previa antes de confirmar
        function mostrarVistaPrevia() {
            alert(`Vista Previa:\n\nTotal de iniciativas: ${iniciativasValidacion.length}\nIniciativas para votaci√≥n: ${iniciativasValidacion.filter(i => i.requiere_votacion).length}\n\n¬øProceder con la carga?`);
        }
        
        // ============ FUNCIONES PARA INICIATIVAS EXTRAORDINARIAS ============
        // Variables ya declaradas arriba, no redeclarar
        // let iniciativasExtraordinariasTemp = [];
        // let listaDiputados = [];
        
        // NOTA: Las funciones mostrarModalExtraordinarias, cargarListaDiputados y cargarNumerosDisponibles
        // ya est√°n definidas arriba en el c√≥digo. Estas eran duplicadas y han sido eliminadas.
        
        // Actualizar partido autom√°ticamente cuando se selecciona diputado
        function actualizarPartidoAutomatico() {
            const select = document.getElementById('extPresentador');
            const partidoSelect = document.getElementById('extPartido');
            
            if (select && partidoSelect) {
                const selectedOption = select.options[select.selectedIndex];
                if (selectedOption && selectedOption.dataset.partido) {
                    partidoSelect.value = selectedOption.dataset.partido;
                }
            }
        }
        
        // NOTA: La funci√≥n agregarExtraordinaria ya est√° definida arriba. Esta era duplicada y ha sido eliminada.
        
        // NOTA: Las funciones actualizarListaExtraordinarias y eliminarExtraordinaria ya est√°n definidas arriba. 
        // Estas eran duplicadas y han sido eliminadas.
        
        // Procesar PDF de extraordinarias
        async function procesarPDFExtraordinarias() {
            const fileInput = document.getElementById('pdfExtraordinarias');
            const statusDiv = document.getElementById('pdfExtraordinariasStatus');
            
            if (!fileInput || !fileInput.files[0]) {
                alert('Por favor seleccione un archivo PDF');
                return;
            }
            
            const formData = new FormData();
            formData.append('pdf', fileInput.files[0]);
            
            if (statusDiv) {
                statusDiv.innerHTML = '<div class="alert alert-info">Procesando PDF...</div>';
            }
            
            try {
                const response = await fetch('/api/operador/procesar-pdf-extraordinarias', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.iniciativas) {
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="alert alert-success">
                                <strong>PDF procesado exitosamente</strong><br>
                                Se encontraron ${data.iniciativas.length} iniciativas extraordinarias
                            </div>
                        `;
                    }
                    
                    // Agregar las iniciativas procesadas a la lista temporal
                    data.iniciativas.forEach(init => {
                        init.tipo_iniciativa = 'extraordinaria';
                        iniciativasExtraordinariasTemp.push(init);
                    });
                    
                    actualizarListaExtraordinarias();
                } else {
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="alert alert-danger">
                                Error al procesar PDF: ${data.error || 'Error desconocido'}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                if (statusDiv) {
                    statusDiv.innerHTML = '<div class="alert alert-danger">Error al procesar el PDF</div>';
                }
            }
        }
        
        // Guardar todas las iniciativas extraordinarias
        async function guardarTodasExtraordinarias() {
            if (iniciativasExtraordinariasTemp.length === 0) {
                alert('No hay iniciativas para guardar');
                return;
            }
            
            try {
                const response = await fetch('/api/operador/guardar-extraordinarias', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        iniciativas: iniciativasExtraordinariasTemp
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Se guardaron ${data.guardadas} iniciativas extraordinarias`);
                    iniciativasExtraordinariasTemp = [];
                    actualizarListaExtraordinarias();
                    bootstrap.Modal.getInstance(document.getElementById('extraordinariasModal')).hide();
                    loadInitiatives();
                } else {
                    alert(data.error || 'Error al guardar iniciativas');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar iniciativas extraordinarias');
            }
        }
        
        // Guardar iniciativas validadas CON CONFIRMACI√ìN
        // NOTA: El bot√≥n usa onclick="guardarIniciativasSeleccionadas()"
        
    </script>
    
    <script src="/js/theme-switcher.js"></script>
</body>
</html>