<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Secretario - Sistema de Votaci√≥n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/apple-theme.css">
    <link rel="stylesheet" href="/css/dark-theme.css">
    <script src="/js/theme-loader.js"></script>
    <style>
        body {
            background: var(--bg-primary);
        }
        .navbar { 
            background: var(--navbar-bg) !important;
            border-bottom: 1px solid var(--border-color);
        }
        .edit-mode { background-color: var(--bg-hover); }
        .vote-progress {
            height: 30px;
            position: relative;
            background: var(--bg-tertiary);
            border-radius: 5px;
            overflow: hidden;
        }
        .vote-bar {
            height: 100%;
            display: flex;
            transition: all 0.3s;
        }
        .vote-favor { background: #28a745; }
        .vote-contra { background: #dc3545; }
        .vote-abstencion { background: #6c757d; }
        
        /* Estilos mejorados para iniciativas extraordinarias */
        .card.extraordinary {
            background: linear-gradient(135deg, #fff8e1 0%, #fffdf7 100%);
            border: 2px solid #ffa000 !important;
            box-shadow: 0 0 10px rgba(255, 160, 0, 0.2);
            position: relative;
        }
        
        .card.extraordinary::before {
            content: "‚ö†";
            position: absolute;
            top: -10px;
            right: 15px;
            background: #ff9800;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .card.extraordinary.border-success {
            background: linear-gradient(135deg, #fff3cd 0%, #f0fff4 100%);
            border-color: #ff6b00 !important;
            box-shadow: 0 0 15px rgba(255, 107, 0, 0.3);
        }
        
        .badge-extraordinary {
            background: linear-gradient(135deg, #ff9800 0%, #ff6b00 100%);
            color: white;
            font-weight: bold;
            animation: pulse 2s infinite;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Animaci√≥n para bot√≥n de pase de lista */
        .pulse-animation {
            animation: pulse-btn 2s infinite;
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
        }
        
        @keyframes pulse-btn {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
            }
        }
        
        /* Bot√≥n de activar pase de lista removido - se activa autom√°ticamente al iniciar sesi√≥n */
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-user-tie"></i> Panel Secretario Legislativo
            </span>
            <div class="d-flex align-items-center">
                <span class="text-white me-3">
                    <i class="fas fa-clock"></i> <span id="currentTime">00:00:00</span>
                </span>
                <span class="text-white me-3" id="sessionTimerContainer" style="display: none;">
                    <i class="fas fa-hourglass-half"></i> Sesi√≥n: <span id="sessionTimer">00:00:00</span>
                    <span id="sessionStatus" class="badge bg-success ms-2">ACTIVA</span>
                </span>
                <span class="text-white me-3" id="userName"></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Panel de estad√≠sticas -->
            <div class="col-md-3">
                <!-- Logo Principal -->
                <div class="text-center mb-3" id="logoContainer">
                    <img src="" id="logoCongreso" alt="Logo Congreso" style="max-width: 200px; height: auto;">
                </div>
                
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <h5 class="text-primary mb-1" id="totalDiputados">20</h5>
                        <small class="text-muted">Total Diputados</small>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <h5 class="text-success mb-1" id="totalIniciativas">0</h5>
                        <small class="text-muted">Iniciativas Totales</small>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <h5 class="text-info mb-1" id="iniciativasVotadas">0</h5>
                        <small class="text-muted">Iniciativas Votadas</small>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header bg-warning">
                        <h6 class="mb-0">Sesi√≥n Actual</h6>
                    </div>
                    <div class="card-body">
                        <div id="sessionInfo" class="small">
                            <p class="text-muted">Sin sesi√≥n activa</p>
                        </div>
                        <button id="btnConsultarPDF" class="btn btn-outline-primary btn-sm mt-2" style="display: none;" onclick="consultarDocumentoOriginal()">
                            <i class="fas fa-file-pdf"></i> Consultar Sesi√≥n Impresa
                        </button>
                        <hr>
                        <div class="small">
                            <p class="mb-1"><i class="fas fa-history text-info"></i> <strong>√öltima sesi√≥n:</strong><br>
                            <span id="ultimaSesion" class="text-muted">Cargando...</span></p>
                            <p class="mb-0"><i class="fas fa-calendar-alt text-warning"></i> <strong>Pr√≥xima programada:</strong><br>
                            <span id="proximaSesion" class="text-muted">Cargando...</span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de Control del Secretario -->
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0"><i class="fas fa-tools"></i> Acciones R√°pidas</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <!-- Bot√≥n de activar pase de lista removido - se activa autom√°ticamente al iniciar sesi√≥n -->
                            <button class="btn btn-primary btn-lg" onclick="abrirPaseListaMejorado()" id="btnPaseLista">
                                <i class="fas fa-user-check"></i> Realizar Pase de Lista
                            </button>
                            <div id="alertaPaseListaNoActivo" class="alert alert-warning" style="display: none;">
                                <i class="fas fa-info-circle"></i> Esperando que el presidente inicie la sesi√≥n
                            </div>
                            <button class="btn btn-info" onclick="abrirGestionPaseLista()">
                                <i class="fas fa-clipboard-check"></i> Gesti√≥n de Asistencia
                            </button>
                            <!-- Control de Sesi√≥n del Presidente -->
                            <div id="controlSesionPresidente" style="display: none;">
                                <div class="alert alert-info mb-2" id="alertaIniciativasCargadas" style="display: none;">
                                    <i class="fas fa-bell animate-pulse"></i> 
                                    <strong>¬°Iniciativas Listas!</strong><br>
                                    <small>El operador ha cargado las iniciativas. Puede iniciar la sesi√≥n.</small>
                                </div>
                                
                                <button class="btn btn-success btn-lg w-100 mb-2" id="btnIniciarSesion" onclick="iniciarSesion()">
                                    <i class="fas fa-play"></i> Iniciar Sesi√≥n
                                </button>
                                
                                <div id="controlesActivos" style="display: none;">
                                    <button class="btn btn-warning w-100 mb-2" id="btnPausarSesion" onclick="pausarSesion()">
                                        <i class="fas fa-pause"></i> Declarar Receso
                                    </button>
                                    
                                    <button class="btn btn-success w-100 mb-2" id="btnReanudarSesion" onclick="reanudarSesion()" style="display: none;">
                                        <i class="fas fa-play"></i> Reanudar Sesi√≥n
                                    </button>
                                    
                                    <button class="btn btn-danger w-100" id="btnClausurarSesion" onclick="clausurarSesion()">
                                        <i class="fas fa-stop"></i> Clausurar Sesi√≥n
                                    </button>
                                </div>
                                
                                <div class="mt-2 small text-muted" id="tiempoReceso" style="display: none;">
                                    <i class="fas fa-coffee"></i> En receso: <span id="tiempoRecesoContador">00:00</span>
                                </div>
                            </div>
                            <button class="btn btn-secondary" id="btnAutorizarVice" onclick="toggleAutorizacionVicepresidente()">
                                <i class="fas fa-user-check"></i> <span id="btnAutorizarViceText">Autorizar Vicepresidente</span>
                            </button>
                            <button class="btn btn-info" onclick="verEstadisticas()">
                                <i class="fas fa-chart-bar"></i> Estad√≠sticas
                            </button>
                            <button class="btn btn-warning" onclick="exportarReporte()">
                                <i class="fas fa-file-export"></i> Exportar Reporte
                            </button>
                            <button class="btn btn-dark" onclick="verHistorial()">
                                <i class="fas fa-history"></i> Historial Completo
                            </button>
                            <hr>
                            <button class="btn btn-secondary" onclick="abrirGestionDiputados()">
                                <i class="fas fa-users-cog"></i> Gestionar Diputados
                            </button>
                        </div>
                        
                        <!-- Logo Secundario -->
                        <div class="text-center mt-3" id="logoSecundarioContainer">
                            <img src="" id="logoSecundario" alt="Logo Secundario" style="max-width: 150px; height: auto;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lista de iniciativas -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list-check"></i> Gesti√≥n de Iniciativas</h5>
                        <div>
                            <button class="btn btn-sm btn-success me-2" onclick="mostrarModalAgregarIniciativa()">
                                <i class="fas fa-plus"></i> Agregar Iniciativa
                            </button>
                            <button class="btn btn-sm btn-warning me-2" onclick="mostrarModalExtraordinarias()">
                                <i class="fas fa-exclamation-triangle"></i> Agregar Extraordinarias
                            </button>
                            <button class="btn btn-sm btn-light" onclick="loadInitiatives()">
                                <i class="fas fa-sync"></i> Actualizar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="initiativesList">
                            <p class="text-muted text-center">Cargando iniciativas...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de votaci√≥n activa -->
                <div class="card mt-3" id="activeVotingPanel" style="display: none;">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Votaci√≥n en Curso</h5>
                        <div>
                            <button class="btn btn-sm btn-info" onclick="mostrarDiputadosSinVoto()">
                                <i class="fas fa-bell"></i> Recordatorios
                            </button>
                            <button class="btn btn-sm btn-light" onclick="pausarVotacion()" id="btnPausar">
                                <i class="fas fa-pause"></i> Pausar
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="cerrarVotacion()">
                                <i class="fas fa-lock"></i> Cerrar Votaci√≥n
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 id="activeInitiativeTitle"></h6>
                        <div class="vote-progress mb-3">
                            <div class="vote-bar">
                                <div class="vote-favor" id="favorBar" style="width: 0%"></div>
                                <div class="vote-contra" id="contraBar" style="width: 0%"></div>
                                <div class="vote-abstencion" id="abstencionBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col">
                                <h4 class="text-success" id="votosFavor">0</h4>
                                <small>A Favor</small>
                            </div>
                            <div class="col">
                                <h4 class="text-danger" id="votosContra">0</h4>
                                <small>En Contra</small>
                            </div>
                            <div class="col">
                                <h4 class="text-secondary" id="votosAbstencion">0</h4>
                                <small>Abstenci√≥n</small>
                            </div>
                            <div class="col">
                                <h4 class="text-warning" id="votosPendientes">20</h4>
                                <small>Pendientes</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar iniciativa -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Iniciativa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n de la Iniciativa</label>
                            <textarea class="form-control" id="editDescripcion" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Mayor√≠a</label>
                            <select class="form-select" id="editTipoMayoria" required>
                                <option value="simple">Mayor√≠a Simple</option>
                                <option value="absoluta">Mayor√≠a Absoluta</option>
                                <option value="calificada">Mayor√≠a Calificada (2/3)</option>
                                <option value="unanime">Unanimidad</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Iniciativa Normal -->
    <div class="modal fade" id="agregarIniciativaModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-plus"></i> Agregar Nueva Iniciativa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="nuevaIniciativaForm">
                        <div class="mb-3">
                            <label class="form-label">N√∫mero de Iniciativa</label>
                            <select class="form-select" id="numeroIniciativa" required>
                                <option value="">Seleccionar posici√≥n...</option>
                            </select>
                            <small class="text-muted">Si selecciona un n√∫mero ocupado, las iniciativas se recorrer√°n autom√°ticamente</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n de la Iniciativa</label>
                            <textarea class="form-control" id="descripcionIniciativa" rows="3" required 
                                placeholder="Ej: Iniciativa con proyecto de decreto por el que se reforma..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Presentada por</label>
                                    <select class="form-select" id="presentadorIniciativa" required onchange="actualizarPartidoNuevaIniciativa()">
                                        <option value="">Seleccionar diputado...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Partido</label>
                                    <input type="text" class="form-control" id="partidoIniciativa" readonly 
                                        placeholder="Se llenar√° autom√°ticamente">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Mayor√≠a Requerida</label>
                            <select class="form-select" id="tipoMayoriaIniciativa" required>
                                <option value="simple">Mayor√≠a Simple</option>
                                <option value="absoluta">Mayor√≠a Absoluta</option>
                                <option value="calificada">Mayor√≠a Calificada (2/3)</option>
                                <option value="unanime">Unanimidad</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="guardarNuevaIniciativa()">
                        <i class="fas fa-save"></i> Guardar Iniciativa
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Iniciativas Extraordinarias -->
    <div class="modal fade" id="extraordinariasModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Agregar Iniciativas Extraordinarias</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i> Las iniciativas extraordinarias se agregan a la sesi√≥n activa sin pausar las votaciones en curso.
                    </div>
                    
                    <!-- Tabs para manual o PDF -->
                    <ul class="nav nav-tabs mb-3" id="extraordinariasTab">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#manualTab">
                                <i class="fas fa-keyboard"></i> Captura Manual
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pdfTab">
                                <i class="fas fa-file-pdf"></i> Desde PDF
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content">
                        <!-- Tab de Captura Manual -->
                        <div class="tab-pane fade show active" id="manualTab">
                            <form id="extraordinariaForm">
                                <div class="mb-3">
                                    <label class="form-label">N√∫mero de Iniciativa</label>
                                    <select class="form-select" id="extNumero" required>
                                        <option value="">Seleccionar posici√≥n...</option>
                                    </select>
                                    <small class="text-muted">La iniciativa extraordinaria se insertar√° en esta posici√≥n y recorrer√° las dem√°s</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Descripci√≥n de la Iniciativa</label>
                                    <textarea class="form-control" id="extDescripcion" rows="3" required></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Presentada por</label>
                                            <select class="form-select" id="extPresentador" onchange="actualizarPartidoAutomatico()">
                                                <option value="">Seleccionar diputado...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Partido</label>
                                            <select class="form-select" id="extPartido">
                                                <option value="">Seleccionar...</option>
                                                <option value="MORENA">MORENA</option>
                                                <option value="PAN">PAN</option>
                                                <option value="PRI">PRI</option>
                                                <option value="PT">PT</option>
                                                <option value="PVEM">PVEM</option>
                                                <option value="MC">MC</option>
                                                <option value="PRD">PRD</option>
                                                <option value="PNA">PNA</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Mayor√≠a</label>
                            <select class="form-select" id="extTipoMayoria" required>
                                <option value="simple">Mayor√≠a Simple</option>
                                <option value="absoluta">Mayor√≠a Absoluta</option>
                                <option value="calificada">Mayor√≠a Calificada (2/3)</option>
                                <option value="unanime">Unanimidad</option>
                            </select>
                        </div>
                                <button type="button" class="btn btn-warning" onclick="agregarExtraordinaria()">
                                    <i class="fas fa-plus"></i> Agregar a la lista
                                </button>
                            </form>
                        </div>
                        
                        <!-- Tab de PDF -->
                        <div class="tab-pane fade" id="pdfTab">
                            <div class="mb-3">
                                <label class="form-label">Archivo PDF con Iniciativas Extraordinarias</label>
                                <input type="file" class="form-control" id="pdfExtraordinarias" accept=".pdf">
                                <small class="text-muted">El PDF debe contener las iniciativas extraordinarias en formato estructurado</small>
                            </div>
                            <button type="button" class="btn btn-warning" onclick="procesarPDFExtraordinarias()">
                                <i class="fas fa-file-import"></i> Procesar PDF
                            </button>
                            <div id="pdfExtraordinariasStatus" class="mt-3"></div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6>Iniciativas Extraordinarias Agregadas:</h6>
                    <div id="listaExtraordinarias" class="list-group">
                        <p class="text-muted">No hay iniciativas extraordinarias agregadas</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="guardarTodasExtraordinarias()">
                        <i class="fas fa-save"></i> Guardar todas las extraordinarias
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Estad√≠sticas -->
    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-chart-pie"></i> Estad√≠sticas de Sesi√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="statsContent">
                    <!-- Se llenar√° din√°micamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="imprimirEstadisticas()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Diputados Sin Voto -->
    <div class="modal fade" id="diputadosSinVotoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="fas fa-bell"></i> Diputados Sin Emitir Voto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Los siguientes diputados no han emitido su voto en la iniciativa actual.
                    </div>
                    <div id="listaDiputadosSinVoto">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-warning" onclick="enviarRecordatorioTodos()">
                        <i class="fas fa-bell"></i> Enviar Recordatorio a Todos
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Gesti√≥n de Diputados -->
    <div class="modal fade" id="gestionDiputadosModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-users-cog"></i> Gesti√≥n de Habilitaci√≥n de Diputados</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        Esta funci√≥n permite habilitar o deshabilitar a los diputados para votar. 
                        Los diputados deshabilitados no podr√°n acceder a su sesi√≥n ni emitir votos.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Partido</th>
                                    <th>Estado Actual</th>
                                    <th>En el Pleno</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaDiputadosGestion">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarCambiosHabilitacion()">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');
        let sessionStartTime = null;
        let timerInterval = null;
        let viceAutorizado = false;
        let sesionActualInfo = null;
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        
        // Identificar usuario al conectarse
        if (user) {
            socket.emit('identificar-usuario', {
                nombre: user.nombre_completo || user.username,
                rol: 'Secretario Legislativo'
            });
        }
        
        if (!token || !user || user.role !== 'secretario') {
            window.location.href = '/';
        }
        
        document.getElementById('userName').textContent = user.nombre;
        
        // Cargar datos al iniciar
        loadDashboard();
        loadInitiatives();
        loadSystemConfig();
        loadEstadisticasSesiones();
        updateClock();
        
        // Funci√≥n para consultar el documento PDF original
        function consultarDocumentoOriginal() {
            if (sesionActualInfo && sesionActualInfo.archivo_pdf) {
                // Abrir el PDF en una nueva ventana
                window.open(`/documentos-sesion/${sesionActualInfo.archivo_pdf}`, '_blank');
            } else {
                alert('No hay documento PDF disponible para esta sesi√≥n');
            }
        }
        
        // Verificar estado del pase de lista al cargar
        verificarEstadoPaseLista();
        
        // Funci√≥n para verificar si el pase de lista est√° activo
        async function verificarEstadoPaseLista() {
            try {
                const response = await fetch('/api/secretario/estado-pase-lista', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const btnPaseLista = document.getElementById('btnPaseLista');
                    const alertaNoActivo = document.getElementById('alertaPaseListaNoActivo');
                    
                    // Verificar si la sesi√≥n est√° iniciada
                    if (!data.sesion_iniciada && data.sesion_activa) {
                        // La sesi√≥n existe pero no est√° iniciada
                        btnPaseLista.style.display = 'none';
                        alertaNoActivo.style.display = 'block';
                        alertaNoActivo.className = 'alert alert-warning';
                        alertaNoActivo.innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i>
                            ${data.mensaje}
                        `;
                        console.log('‚ö†Ô∏è Sesi√≥n no iniciada - Esperando al Presidente');
                    } else if (data.pase_lista_activo) {
                        // Pase de lista est√° activo, mostrar bot√≥n
                        btnPaseLista.style.display = 'block';
                        btnPaseLista.classList.add('pulse-animation');
                        alertaNoActivo.style.display = 'none';
                        console.log('‚úÖ Pase de lista activo - Puede proceder');
                    } else {
                        // Pase de lista no activo, mostrar alerta
                        btnPaseLista.style.display = 'none';
                        alertaNoActivo.style.display = 'block';
                        alertaNoActivo.className = 'alert alert-info';
                        alertaNoActivo.innerHTML = `
                            <i class="fas fa-info-circle"></i>
                            ${data.mensaje || 'El pase de lista no est√° activo. Solicite al operador que lo active desde el panel de control.'}
                        `;
                        console.log('‚è≥ Esperando activaci√≥n del pase de lista');
                    }
                }
            } catch (error) {
                console.error('Error verificando estado del pase de lista:', error);
            }
        }
        
        // Cargar dashboard
        async function loadDashboard() {
            try {
                const response = await fetch('/api/secretario/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                document.getElementById('totalDiputados').textContent = data.total_diputados || 20;
                document.getElementById('totalIniciativas').textContent = data.total_iniciativas || 0;
                document.getElementById('iniciativasVotadas').textContent = data.iniciativas_votadas || 0;
                
                if (data.sesion_actual) {
                    document.getElementById('sessionInfo').innerHTML = `
                        <strong>${data.sesion_actual}</strong>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Cargar iniciativas
        async function loadInitiatives() {
            try {
                const response = await fetch('/api/secretario/iniciativas', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                displayInitiatives(data.iniciativas);
                
                // Cargar resumen de votaci√≥n si hay iniciativa activa
                const activeInit = data.iniciativas.find(i => i.activa);
                if (activeInit) {
                    loadVotingStatus();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Mostrar iniciativas
        function displayInitiatives(initiatives) {
            const container = document.getElementById('initiativesList');
            
            if (!initiatives || initiatives.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No hay iniciativas cargadas</p>';
                return;
            }
            
            container.innerHTML = initiatives.map(init => `
                <div class="card mb-2 ${init.activa ? 'border-success border-3' : ''} ${init.tipo_iniciativa === 'extraordinaria' ? 'extraordinary' : ''}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    ${init.numero}. ${init.descripcion || init.titulo || 'Sin descripci√≥n'}
                                    ${init.tipo_iniciativa === 'extraordinaria' ? '<span class="badge badge-extraordinary ms-2">‚ö° EXTRAORDINARIA</span>' : ''}
                                    ${init.activa ? '<span class="badge bg-success ms-2">üî¥ EN VOTACI√ìN</span>' : ''}
                                </h6>
                                ${init.presentador ? `
                                    <div class="small mb-1">
                                        <i class="fas fa-user"></i> 
                                        <strong>Presentada por:</strong> ${init.presentador}
                                        ${init.partido_presentador ? `<span class="badge bg-info ms-1">${init.partido_presentador}</span>` : ''}
                                    </div>
                                ` : ''}
                                <div>
                                    <span class="badge bg-${getMajorityColor(init.tipo_mayoria)}">
                                        ${getMajorityLabel(init.tipo_mayoria)}
                                    </span>
                                    ${init.activa ? '<span class="badge bg-success ms-1">ACTIVA</span>' : ''}
                                    ${init.cerrada ? '<span class="badge bg-dark ms-1">CERRADA</span>' : ''}
                                </div>
                            </div>
                            <div class="ms-2">
                                ${!init.cerrada ? `
                                    <button class="btn btn-sm btn-warning" onclick="editInitiative(${init.id}, '${escapeHtml(init.descripcion || init.titulo || '')}', '', '${init.tipo_mayoria}')" title="Editar iniciativa">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                ` : ''}
                                ${!init.activa && !init.cerrada ? `
                                    <button class="btn btn-sm btn-success" onclick="activateInitiative(${init.id})" title="Activar para votaci√≥n">
                                        <i class="fas fa-play"></i> Activar
                                    </button>
                                ` : ''}
                                ${init.activa ? `
                                    <button class="btn btn-sm btn-danger" onclick="closeVoting(${init.id})" title="Cerrar votaci√≥n">
                                        <i class="fas fa-stop"></i> Cerrar
                                    </button>
                                ` : ''}
                                ${init.cerrada && !init.resultado ? `
                                    <button class="btn btn-sm btn-info" onclick="reopenVoting(${init.id})" title="Reabrir votaci√≥n">
                                        <i class="fas fa-undo"></i> Reabrir
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Editar iniciativa
        function editInitiative(id, titulo, descripcion, tipoMayoria) {
            document.getElementById('editId').value = id;
            document.getElementById('editDescripcion').value = descripcion || titulo;
            document.getElementById('editTipoMayoria').value = tipoMayoria;
            editModal.show();
        }
        
        // Guardar edici√≥n
        async function saveEdit() {
            const id = document.getElementById('editId').value;
            const descripcion = document.getElementById('editDescripcion').value;
            const tipo_mayoria = document.getElementById('editTipoMayoria').value;
            
            try {
                const response = await fetch(`/api/secretario/actualizar-iniciativa/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ descripcion, tipo_mayoria })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    editModal.hide();
                    loadInitiatives();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar iniciativa');
            }
        }
        
        // Activar iniciativa
        async function activateInitiative(id) {
            if (!confirm('¬øActivar esta iniciativa para votaci√≥n?')) return;
            
            try {
                const response = await fetch(`/api/secretario/activar-iniciativa/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    loadInitiatives();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al activar iniciativa');
            }
        }
        
        // Cerrar votaci√≥n
        async function closeVoting(id) {
            if (!confirm('¬øCerrar la votaci√≥n de esta iniciativa?')) return;
            
            try {
                const response = await fetch(`/api/secretario/cerrar-votacion/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Votaci√≥n cerrada. Resultado: ${data.resultado.toUpperCase()}`);
                    loadInitiatives();
                    loadVotingStatus();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cerrar votaci√≥n');
            }
        }
        
        // Reabrir votaci√≥n
        async function reopenVoting(id) {
            if (!confirm('¬øReabrir la votaci√≥n de esta iniciativa? Los votos existentes se mantendr√°n.')) return;
            
            try {
                const response = await fetch(`/api/secretario/reabrir-votacion/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Votaci√≥n reabierta exitosamente');
                    loadInitiatives();
                    loadVotingStatus();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al reabrir votaci√≥n');
            }
        }
        
        // Cargar estado de votaci√≥n
        async function loadVotingStatus() {
            try {
                const response = await fetch('/api/secretario/resumen-votacion', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.iniciativa) {
                    document.getElementById('activeVotingPanel').style.display = 'block';
                    document.getElementById('activeInitiativeTitle').textContent = 
                        `${data.iniciativa.numero}. ${data.iniciativa.descripcion || data.iniciativa.titulo || 'Sin descripci√≥n'}`;
                    
                    updateVotingBars(data.conteo);
                } else {
                    document.getElementById('activeVotingPanel').style.display = 'none';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Actualizar barras de votaci√≥n
        function updateVotingBars(conteo) {
            const total = 20;
            document.getElementById('votosFavor').textContent = conteo.favor;
            document.getElementById('votosContra').textContent = conteo.contra;
            document.getElementById('votosAbstencion').textContent = conteo.abstencion;
            document.getElementById('votosPendientes').textContent = total - conteo.total;
            
            document.getElementById('favorBar').style.width = `${(conteo.favor / total) * 100}%`;
            document.getElementById('contraBar').style.width = `${(conteo.contra / total) * 100}%`;
            document.getElementById('abstencionBar').style.width = `${(conteo.abstencion / total) * 100}%`;
        }
        
        // Utilidades
        function getMajorityColor(tipo) {
            const colors = {
                'simple': 'secondary',
                'absoluta': 'info',
                'calificada': 'warning',
                'unanime': 'danger'
            };
            return colors[tipo] || 'secondary';
        }
        
        function getMajorityLabel(tipo) {
            const labels = {
                'simple': 'Mayor√≠a Simple',
                'absoluta': 'Mayor√≠a Absoluta',
                'calificada': 'Mayor√≠a Calificada',
                'unanime': 'Unanimidad'
            };
            return labels[tipo] || 'Mayor√≠a Simple';
        }
        
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // Eventos de socket
        socket.on('iniciativa-activa', () => {
            loadInitiatives();
            loadVotingStatus();
        });
        
        socket.on('voto-emitido', () => {
            loadVotingStatus();
        });
        
        socket.on('votacion-cerrada', () => {
            loadInitiatives();
            loadDashboard();
            document.getElementById('activeVotingPanel').style.display = 'none';
        });
        
        // Actualizar peri√≥dicamente
        setInterval(() => {
            loadVotingStatus();
        }, 5000);
        
        // Funciones adicionales del Secretario Legislativo
        
        // Variables para el cron√≥metro mejorado
        let sessionPausedTime = 0;  // Tiempo total en pausa
        let pauseStartTime = null;   // Momento cuando se inici√≥ la pausa
        let sessionState = 'inactive'; // 'inactive', 'active', 'paused'
        let recesoInterval = null;
        
        // Iniciar sesi√≥n
        async function iniciarSesion() {
            if (!confirm('¬øIniciar nueva sesi√≥n legislativa?\n\nEsto iniciar√° el cron√≥metro oficial de la sesi√≥n.')) return;
            
            try {
                const response = await fetch('/api/diputado/iniciar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Mostrar notificaci√≥n exitosa
                    mostrarNotificacion('Sesi√≥n iniciada correctamente', 'success');
                    
                    // Actualizar estado de la sesi√≥n
                    sessionState = 'active';
                    sessionStartTime = Date.now();
                    sessionPausedTime = 0;
                    
                    // Actualizar interfaz
                    document.getElementById('btnIniciarSesion').style.display = 'none';
                    document.getElementById('controlesActivos').style.display = 'block';
                    document.getElementById('alertaIniciativasCargadas').style.display = 'none';
                    document.getElementById('sessionStatus').textContent = 'ACTIVA';
                    document.getElementById('sessionStatus').className = 'badge bg-success ms-2';
                    
                    // Notificar al operador
                    socket.emit('sesion-iniciada-presidente', {
                        sesion_id: data.sesion_id,
                        mensaje: 'El presidente ha iniciado la sesi√≥n'
                    });
                    
                    checkSessionStatus();
                    loadDashboard();
                    startSessionTimer();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al iniciar sesi√≥n');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al iniciar sesi√≥n');
            }
        }
        
        // Pausar sesi√≥n (receso)
        async function pausarSesion() {
            if (!confirm('¬øDeclarar un receso?\n\nEsto pausar√° el cron√≥metro de la sesi√≥n.')) return;
            
            try {
                const response = await fetch('/api/secretario/pausar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    sessionState = 'paused';
                    pauseStartTime = Date.now();
                    
                    // Actualizar interfaz
                    document.getElementById('btnPausarSesion').style.display = 'none';
                    document.getElementById('btnReanudarSesion').style.display = 'block';
                    document.getElementById('sessionStatus').textContent = 'EN RECESO';
                    document.getElementById('sessionStatus').className = 'badge bg-warning ms-2';
                    document.getElementById('tiempoReceso').style.display = 'block';
                    
                    // Iniciar contador de receso
                    iniciarContadorReceso();
                    
                    // Notificar a todos
                    socket.emit('sesion-pausada', {
                        mensaje: 'La sesi√≥n est√° en receso'
                    });
                    
                    mostrarNotificacion('Sesi√≥n en receso', 'warning');
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al pausar sesi√≥n');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al pausar sesi√≥n');
            }
        }
        
        // Reanudar sesi√≥n
        async function reanudarSesion() {
            if (!confirm('¬øReanudar la sesi√≥n?')) return;
            
            try {
                const response = await fetch('/api/secretario/reanudar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    // Acumular tiempo pausado
                    if (pauseStartTime) {
                        sessionPausedTime += Date.now() - pauseStartTime;
                        pauseStartTime = null;
                    }
                    
                    sessionState = 'active';
                    
                    // Actualizar interfaz
                    document.getElementById('btnPausarSesion').style.display = 'block';
                    document.getElementById('btnReanudarSesion').style.display = 'none';
                    document.getElementById('sessionStatus').textContent = 'ACTIVA';
                    document.getElementById('sessionStatus').className = 'badge bg-success ms-2';
                    document.getElementById('tiempoReceso').style.display = 'none';
                    
                    // Detener contador de receso
                    if (recesoInterval) {
                        clearInterval(recesoInterval);
                        recesoInterval = null;
                    }
                    
                    // Notificar a todos
                    socket.emit('sesion-reanudada', {
                        mensaje: 'La sesi√≥n ha sido reanudada'
                    });
                    
                    mostrarNotificacion('Sesi√≥n reanudada', 'success');
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al reanudar sesi√≥n');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al reanudar sesi√≥n');
            }
        }
        
        // Contador de tiempo en receso
        function iniciarContadorReceso() {
            let tiempoInicio = Date.now();
            
            recesoInterval = setInterval(() => {
                const elapsed = Date.now() - tiempoInicio;
                const minutos = Math.floor(elapsed / 60000);
                const segundos = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('tiempoRecesoContador').textContent = 
                    `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // Funci√≥n auxiliar para mostrar notificaciones
        function mostrarNotificacion(mensaje, tipo) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Clausurar sesi√≥n
        async function clausurarSesion() {
            if (!confirm('¬øClausurar la sesi√≥n actual? Esto cerrar√° todas las votaciones activas.')) return;
            
            try {
                const response = await fetch('/api/diputado/clausurar-sesion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Sesi√≥n clausurada.\n\nEstad√≠sticas:\n- Iniciativas: ${data.estadisticas.total_iniciativas}\n- Aprobadas: ${data.estadisticas.aprobadas}\n- Rechazadas: ${data.estadisticas.rechazadas}`);
                    checkSessionStatus();
                    loadDashboard();
                } else {
                    alert(data.error || 'Error al clausurar sesi√≥n');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al clausurar sesi√≥n');
            }
        }
        
        // Verificar estado de sesi√≥n
        async function checkSessionStatus() {
            try {
                const response = await fetch('/api/secretario/estado-sesion', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    console.error('Error obteniendo estado de sesi√≥n');
                    return;
                }
                
                const data = await response.json();
                
                if (data.sesion_activa) {
                    // Guardar informaci√≥n de la sesi√≥n
                    sesionActualInfo = {
                        archivo_pdf: data.sesion.archivo_pdf
                    };
                    
                    // Mostrar/ocultar bot√≥n de PDF
                    const btnPDF = document.getElementById('btnConsultarPDF');
                    if (btnPDF) {
                        btnPDF.style.display = data.sesion.archivo_pdf ? 'block' : 'none';
                    }
                    
                    document.getElementById('sessionInfo').innerHTML = `
                        <strong>Sesi√≥n #${data.sesion.id}</strong><br>
                        Iniciada: ${new Date(data.sesion.fecha_inicio).toLocaleString()}<br>
                        Iniciativas: ${data.estadisticas.total_iniciativas}
                    `;
                    
                    // Mostrar controles activos
                    document.getElementById('controlSesionPresidente').style.display = 'none';
                    document.getElementById('controlesActivos').style.display = 'block';
                    document.getElementById('btnIniciarSesion').style.display = 'none';
                    
                    // Iniciar cron√≥metro si hay sesi√≥n activa
                    sessionStartTime = new Date(data.sesion.fecha_inicio).getTime();
                    sessionState = 'active';
                    startSessionTimer();
                } else {
                    document.getElementById('sessionInfo').innerHTML = '<p class="text-muted">Sin sesi√≥n activa</p>';
                    
                    // Verificar si es presidente y puede iniciar sesi√≥n
                    if (data.puede_iniciar) {
                        document.getElementById('controlSesionPresidente').style.display = 'block';
                        document.getElementById('btnIniciarSesion').style.display = 'block';
                        document.getElementById('controlesActivos').style.display = 'none';
                        
                        // Verificar si hay iniciativas cargadas
                        if (data.iniciativas_cargadas) {
                            document.getElementById('alertaIniciativasCargadas').style.display = 'block';
                        }
                    } else {
                        document.getElementById('controlSesionPresidente').style.display = 'none';
                    }
                    
                    document.getElementById('sessionTimerContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Ver estad√≠sticas detalladas
        function verEstadisticas() {
            const modal = new bootstrap.Modal(document.getElementById('statsModal'));
            
            fetch('/api/secretario/estadisticas-completas', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('statsContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Sesi√≥n Actual</h6>
                            <ul>
                                <li>Total de iniciativas: ${data.total_iniciativas || 0}</li>
                                <li>Votadas: ${data.iniciativas_votadas || 0}</li>
                                <li>Aprobadas: ${data.aprobadas || 0}</li>
                                <li>Rechazadas: ${data.rechazadas || 0}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Participaci√≥n</h6>
                            <ul>
                                <li>Diputados presentes: ${data.presentes || 0}</li>
                                <li>Participaci√≥n promedio: ${data.participacion_promedio || 0}%</li>
                                <li>Qu√≥rum: ${data.quorum ? 'S√≠' : 'No'}</li>
                            </ul>
                        </div>
                    </div>
                    <hr>
                    <h6>Detalles por Iniciativa</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Descripci√≥n</th>
                                    <th>Favor</th>
                                    <th>Contra</th>
                                    <th>Abstenci√≥n</th>
                                    <th>Resultado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(data.detalle_iniciativas || []).map(init => `
                                    <tr>
                                        <td>${init.numero}</td>
                                        <td>${init.descripcion || init.titulo || 'Sin descripci√≥n'}</td>
                                        <td>${init.votos_favor || 0}</td>
                                        <td>${init.votos_contra || 0}</td>
                                        <td>${init.abstenciones || 0}</td>
                                        <td><span class="badge bg-${init.resultado === 'aprobada' ? 'success' : init.resultado === 'rechazada' ? 'danger' : 'secondary'}">${init.resultado || 'Pendiente'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar estad√≠sticas');
            });
        }
        
        // Exportar reporte
        async function exportarReporte() {
            try {
                const response = await fetch('/api/secretario/exportar-reporte', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `reporte_sesion_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else {
                    alert('Error al exportar reporte');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al exportar');
            }
        }
        
        // Pausar votaci√≥n
        async function pausarVotacion() {
            if (!confirm('¬øPausar temporalmente la votaci√≥n actual?')) return;
            
            try {
                const response = await fetch('/api/secretario/pausar-votacion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    alert('Votaci√≥n pausada');
                    document.getElementById('btnPausar').innerHTML = '<i class="fas fa-play"></i> Reanudar';
                    document.getElementById('btnPausar').onclick = reanudarVotacion;
                } else {
                    alert('Error al pausar votaci√≥n');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Reanudar votaci√≥n
        async function reanudarVotacion() {
            try {
                const response = await fetch('/api/secretario/reanudar-votacion', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    alert('Votaci√≥n reanudada');
                    document.getElementById('btnPausar').innerHTML = '<i class="fas fa-pause"></i> Pausar';
                    document.getElementById('btnPausar').onclick = pausarVotacion;
                } else {
                    alert('Error al reanudar votaci√≥n');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Imprimir estad√≠sticas
        function imprimirEstadisticas() {
            const content = document.getElementById('statsContent').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Estad√≠sticas de Sesi√≥n</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="container mt-3">');
            printWindow.document.write('<h3>Estad√≠sticas de Sesi√≥n Legislativa</h3>');
            printWindow.document.write(content);
            printWindow.document.write('</div></body></html>');
            printWindow.document.close();
            printWindow.print();
        }
        
        // Cargar configuraci√≥n del sistema (logos)
        async function loadSystemConfig() {
            try {
                const response = await fetch('/api/configuracion/public');
                const config = await response.json();
                
                if (config.logo_congreso) {
                    document.getElementById('logoCongreso').src = config.logo_congreso;
                }
                if (config.logo_secundario) {
                    document.getElementById('logoSecundario').src = config.logo_secundario;
                }
            } catch (error) {
                console.error('Error cargando configuraci√≥n:', error);
            }
        }
        
        // Reloj en tiempo real
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-MX', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
            setTimeout(updateClock, 1000);
        }
        
        // Cron√≥metro de sesi√≥n mejorado con pausas
        function startSessionTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            if (sessionStartTime) {
                document.getElementById('sessionTimerContainer').style.display = 'inline-block';
                
                timerInterval = setInterval(() => {
                    let elapsed;
                    
                    // Si est√° pausado, no actualizar el tiempo
                    if (sessionState === 'paused') {
                        // Mostrar el tiempo hasta la pausa
                        elapsed = pauseStartTime - sessionStartTime - sessionPausedTime;
                    } else {
                        // Calcular tiempo activo (descontando pausas)
                        elapsed = Date.now() - sessionStartTime - sessionPausedTime;
                    }
                    
                    const hours = Math.floor(elapsed / 3600000);
                    const minutes = Math.floor((elapsed % 3600000) / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    
                    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    document.getElementById('sessionTimer').textContent = timeString;
                }, 1000);
            }
        }
        
        // Eventos de socket para el timer
        socket.on('sesion-iniciada', (data) => {
            console.log('Sesi√≥n iniciada:', data);
            sessionStartTime = Date.now();
            startSessionTimer();
            // Verificar estado del pase de lista
            verificarEstadoPaseLista();
            // Recargar el dashboard para actualizar el estado
            loadDashboard();
            // Forzar recarga despu√©s de un breve retraso
            setTimeout(() => {
                verificarEstadoPaseLista();
                loadDashboard();
            }, 1500);
            // Recargar sesi√≥n activa
            loadActiveSession();
        });
        
        // Notificaci√≥n cuando el operador carga iniciativas
        socket.on('iniciativas-cargadas', (data) => {
            console.log('Iniciativas cargadas por el operador:', data);
            
            // Mostrar alerta al presidente
            if (user.role === 'diputado' && user.es_presidente) {
                document.getElementById('alertaIniciativasCargadas').style.display = 'block';
                
                // Notificaci√≥n visual y sonora
                mostrarNotificacion('¬°Las iniciativas est√°n listas! Puede iniciar la sesi√≥n.', 'info');
                
                // Sonido de notificaci√≥n (opcional)
                const audio = new Audio('/sounds/notification.mp3');
                audio.play().catch(e => console.log('No se pudo reproducir sonido:', e));
            }
            
            // Actualizar contador de iniciativas
            checkSessionStatus();
        });
        
        // Eventos de receso
        socket.on('sesion-pausada', (data) => {
            console.log('Sesi√≥n pausada:', data);
            if (user.role !== 'diputado' || !user.es_presidente) {
                mostrarNotificacion('La sesi√≥n est√° en receso', 'warning');
            }
        });
        
        socket.on('sesion-reanudada', (data) => {
            console.log('Sesi√≥n reanudada:', data);
            if (user.role !== 'diputado' || !user.es_presidente) {
                mostrarNotificacion('La sesi√≥n ha sido reanudada', 'success');
            }
        });
        
        // Escuchar evento de pase de lista activado
        socket.on('pase-lista-activado', (data) => {
            console.log('Pase de lista activado:', data);
            const btnPaseLista = document.getElementById('btnPaseLista');
            const alertaNoActivo = document.getElementById('alertaPaseListaNoActivo');
            
            // Mostrar bot√≥n y ocultar alerta
            if (btnPaseLista && alertaNoActivo) {
                btnPaseLista.style.display = 'block';
                btnPaseLista.classList.add('pulse-animation');
                alertaNoActivo.style.display = 'none';
            }
            
            // Mostrar notificaci√≥n
            const notification = `
                <div class="alert alert-success alert-dismissible fade show position-fixed" style="top: 80px; right: 20px; z-index: 9999; min-width: 350px;">
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    <h5><i class="fas fa-check-circle"></i> Pase de Lista Activado</h5>
                    <p>${data.mensaje}</p>
                    <button class="btn btn-primary btn-sm w-100 mt-2" onclick="abrirPaseListaMejorado()">
                        <i class="fas fa-user-check"></i> Ir a Pase de Lista
                    </button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', notification);
            
            // Auto-remover despu√©s de 10 segundos
            setTimeout(() => {
                const alert = document.querySelector('.alert.alert-success.position-fixed');
                if (alert) alert.remove();
            }, 10000);
        });
        
        socket.on('sesion-clausurada', () => {
            sessionStartTime = null;
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('sessionTimer').textContent = '00:00:00';
            document.getElementById('sessionTimerContainer').style.display = 'none';
        });
        
        // Autorizar/Desautorizar Vicepresidente
        async function toggleAutorizacionVicepresidente() {
            const nuevoEstado = !viceAutorizado;
            const accion = nuevoEstado ? 'autorizar' : 'desautorizar';
            
            if (!confirm(`¬øDesea ${accion} al Vicepresidente para usar funciones del Presidente?`)) return;
            
            try {
                const response = await fetch('/api/secretario/autorizar-vicepresidente', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ autorizado: nuevoEstado })
                });
                
                if (response.ok) {
                    viceAutorizado = nuevoEstado;
                    actualizarBotonAutorizacion();
                    
                    // Notificar a trav√©s de socket
                    socket.emit('vicepresidente-autorizado', {
                        autorizado: viceAutorizado,
                        autorizado_por: user.nombre
                    });
                    
                    alert(`Vicepresidente ${accion === 'autorizar' ? 'autorizado' : 'desautorizado'} correctamente`);
                } else {
                    alert('Error al cambiar autorizaci√≥n');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cambiar autorizaci√≥n');
            }
        }
        
        // Actualizar estado del bot√≥n de autorizaci√≥n
        function actualizarBotonAutorizacion() {
            const btn = document.getElementById('btnAutorizarVice');
            const btnText = document.getElementById('btnAutorizarViceText');
            
            if (viceAutorizado) {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-success');
                btnText.textContent = 'Vicepresidente Autorizado ‚úì';
            } else {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
                btnText.textContent = 'Autorizar Vicepresidente';
            }
        }
        
        // Verificar estado de autorizaci√≥n al cargar
        async function verificarAutorizacionVice() {
            try {
                const response = await fetch('/api/secretario/estado-autorizacion-vice', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    viceAutorizado = data.autorizado;
                    actualizarBotonAutorizacion();
                }
            } catch (error) {
                console.error('Error verificando autorizaci√≥n:', error);
            }
        }
        
        // Cargar estad√≠sticas de sesiones
        async function loadEstadisticasSesiones() {
            try {
                const response = await fetch('/api/secretario/estadisticas-sesiones', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // √öltima sesi√≥n
                    if (data.ultimaSesion) {
                        const fecha = new Date(data.ultimaSesion.fecha_clausura || data.ultimaSesion.fecha);
                        document.getElementById('ultimaSesion').innerHTML = 
                            `${fecha.toLocaleDateString('es-MX')}<br>${fecha.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'})}`;
                    } else {
                        document.getElementById('ultimaSesion').textContent = 'Sin sesiones previas';
                    }
                    
                    // Pr√≥xima sesi√≥n programada
                    if (data.proximaSesion) {
                        const fecha = new Date(data.proximaSesion.fecha_programada);
                        document.getElementById('proximaSesion').innerHTML = 
                            `${fecha.toLocaleDateString('es-MX')}<br>${fecha.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'})}`;
                    } else {
                        document.getElementById('proximaSesion').textContent = 'Sin programar';
                    }
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }
        
        // Ver historial completo
        function verHistorial() {
            window.open('/historial-sesiones', '_blank');
        }
        
        function abrirPaseListaMejorado() {
            window.location.href = '/pase-lista';
        }
        
        // Funciones para iniciativas extraordinarias
        let iniciativasExtraordinariasTemp = [];
        let listaDiputados = [];
        
        async function cargarListaDiputados() {
            try {
                const response = await fetch('/api/secretario/lista-diputados', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    listaDiputados = await response.json();
                    const select = document.getElementById('extPresentador');
                    select.innerHTML = '<option value="">Seleccionar diputado...</option>';
                    
                    listaDiputados.forEach(diputado => {
                        const option = document.createElement('option');
                        option.value = diputado.nombre_completo;
                        option.dataset.partido = diputado.partido;
                        option.textContent = diputado.nombre_completo;
                        select.appendChild(option);
                    });
                    
                    // Tambi√©n cargar n√∫meros disponibles
                    await cargarNumerosDisponibles();
                }
            } catch (error) {
                console.error('Error cargando diputados:', error);
            }
        }
        
        function actualizarPartidoAutomatico() {
            const select = document.getElementById('extPresentador');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.partido) {
                document.getElementById('extPartido').value = selectedOption.dataset.partido;
            }
        }
        
        function mostrarModalExtraordinarias() {
            cargarListaDiputados();
            const modalElement = document.getElementById('extraordinariasModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement, {
                    backdrop: 'static',
                    keyboard: true
                });
                modal.show();
            }
        }
        
        function agregarExtraordinaria() {
            const iniciativa = {
                numero: document.getElementById('extNumero').value,
                descripcion: document.getElementById('extDescripcion').value,
                presentador: document.getElementById('extPresentador').value,
                partido_presentador: document.getElementById('extPartido').value,
                tipo_mayoria: document.getElementById('extTipoMayoria').value,
                tipo_iniciativa: 'extraordinaria'
            };
            
            if (!iniciativa.numero || !iniciativa.descripcion) {
                alert('Por favor complete los campos obligatorios');
                return;
            }
            
            iniciativasExtraordinariasTemp.push(iniciativa);
            actualizarListaExtraordinarias();
            
            // Limpiar formulario
            document.getElementById('extNumero').value = '';
            document.getElementById('extDescripcion').value = '';
            document.getElementById('extPresentador').value = '';
            document.getElementById('extPartido').value = '';
            document.getElementById('extTipoMayoria').value = 'simple';
        }
        
        function actualizarListaExtraordinarias() {
            const lista = document.getElementById('listaExtraordinarias');
            
            if (iniciativasExtraordinariasTemp.length === 0) {
                lista.innerHTML = '<p class="text-muted">No hay iniciativas extraordinarias agregadas</p>';
                return;
            }
            
            lista.innerHTML = iniciativasExtraordinariasTemp.map((init, index) => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>#${init.numero}</strong> - ${init.descripcion}
                            <br>
                            <small class="text-muted">
                                ${init.presentador ? `Por: ${init.presentador}` : ''}
                                ${init.partido_presentador ? `(${init.partido_presentador})` : ''}
                                | ${init.tipo_mayoria === 'simple' ? 'Mayor√≠a Simple' : 
                                    init.tipo_mayoria === 'absoluta' ? 'Mayor√≠a Absoluta' :
                                    init.tipo_mayoria === 'calificada' ? 'Mayor√≠a Calificada' : 'Unanimidad'}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="eliminarExtraordinaria(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function eliminarExtraordinaria(index) {
            iniciativasExtraordinariasTemp.splice(index, 1);
            actualizarListaExtraordinarias();
        }
        
        async function procesarPDFExtraordinarias() {
            const fileInput = document.getElementById('pdfExtraordinarias');
            const statusDiv = document.getElementById('pdfExtraordinariasStatus');
            
            if (!fileInput.files[0]) {
                alert('Por favor seleccione un archivo PDF');
                return;
            }
            
            const formData = new FormData();
            formData.append('pdf', fileInput.files[0]);
            
            statusDiv.innerHTML = '<div class="alert alert-info">Procesando PDF...</div>';
            
            try {
                const response = await fetch('/api/secretario/procesar-pdf-extraordinarias', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.iniciativas) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>PDF procesado exitosamente</strong><br>
                            Se encontraron ${data.iniciativas.length} iniciativas extraordinarias
                        </div>
                    `;
                    
                    // Agregar las iniciativas extra√≠das a la lista temporal
                    data.iniciativas.forEach(init => {
                        init.tipo_iniciativa = 'extraordinaria';
                        iniciativasExtraordinariasTemp.push(init);
                    });
                    
                    actualizarListaExtraordinarias();
                    fileInput.value = '';
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            Error al procesar PDF: ${data.error || 'Error desconocido'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error al procesar el archivo PDF
                    </div>
                `;
            }
        }
        
        async function guardarTodasExtraordinarias() {
            if (iniciativasExtraordinariasTemp.length === 0) {
                alert('No hay iniciativas para guardar');
                return;
            }
            
            try {
                const response = await fetch('/api/secretario/guardar-extraordinarias', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        iniciativas: iniciativasExtraordinariasTemp
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Se guardaron ${data.guardadas} iniciativas extraordinarias`);
                    iniciativasExtraordinariasTemp = [];
                    actualizarListaExtraordinarias();
                    bootstrap.Modal.getInstance(document.getElementById('extraordinariasModal')).hide();
                    loadInitiatives();
                } else {
                    alert(data.error || 'Error al guardar iniciativas');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar iniciativas extraordinarias');
            }
        }
        
        // Inicializar al cargar
        checkSessionStatus();
        verificarAutorizacionVice();
        
        function logout() {
            if (timerInterval) clearInterval(timerInterval);
            localStorage.clear();
            window.location.href = '/';
        }
        // Modal de recordatorios
        const recordatoriosModal = new bootstrap.Modal(document.getElementById('recordatoriosModal'));
        
        // Mostrar diputados sin voto
        async function mostrarDiputadosSinVoto() {
            try {
                const response = await fetch('/api/secretario/diputados-sin-voto', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (!data.iniciativa) {
                    alert('No hay votaci√≥n activa');
                    return;
                }
                
                // Mostrar info de iniciativa
                const numeroFormato = data.iniciativa.numero_orden_dia ? 
                    `${data.iniciativa.numero}/${data.iniciativa.numero_orden_dia}` : 
                    data.iniciativa.numero;
                document.getElementById('iniciativaInfo').innerHTML = `
                    <strong>Iniciativa ${numeroFormato}:</strong> ${data.iniciativa.titulo || data.iniciativa.descripcion || 'Sin descripci√≥n'}
                `;
                
                // Actualizar contador
                document.getElementById('totalSinVoto').textContent = data.total_sin_voto;
                
                // Mostrar lista de diputados
                const tbody = document.getElementById('listaDiputadosSinVoto');
                if (data.diputados_sin_voto.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-success">Todos los diputados han votado</td></tr>';
                } else {
                    tbody.innerHTML = data.diputados_sin_voto.map(dip => `
                        <tr>
                            <td>${dip.nombre_completo}</td>
                            <td><span class="badge bg-secondary">${dip.partido}</span></td>
                            <td>${dip.cargo_mesa_directiva || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="enviarRecordatorio(${dip.id}, ${data.iniciativa.id}, '${dip.nombre_completo}')">
                                    <i class="fas fa-bell"></i> Recordar
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
                
                // Guardar ID de iniciativa para uso posterior
                window.currentIniciativaId = data.iniciativa.id;
                
                recordatoriosModal.show();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar diputados sin voto');
            }
        }
        
        // Enviar recordatorio individual
        async function enviarRecordatorio(diputadoId, iniciativaId, nombreDiputado) {
            if (!confirm(`¬øEnviar recordatorio a ${nombreDiputado}?`)) return;
            
            try {
                const response = await fetch('/api/secretario/enviar-recordatorio', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        diputado_id: diputadoId,
                        iniciativa_id: iniciativaId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(data.mensaje);
                    // Actualizar lista
                    mostrarDiputadosSinVoto();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al enviar recordatorio');
            }
        }
        
        // Mostrar diputados sin voto
        async function mostrarDiputadosSinVoto() {
            try {
                const response = await fetch('/api/secretario/diputados-sin-voto', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.diputados && data.diputados.length > 0) {
                    const listHtml = data.diputados.map(dip => `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${dip.nombre_completo}</strong>
                                <small class="text-muted d-block">${dip.partido || 'Sin partido'}</small>
                                ${dip.cargo_mesa_directiva ? `<span class="badge bg-info">${dip.cargo_mesa_directiva}</span>` : ''}
                            </div>
                            <button class="btn btn-sm btn-warning" onclick="enviarRecordatorioIndividual(${dip.id}, '${dip.nombre_completo}')">
                                <i class="fas fa-bell"></i> Recordar
                            </button>
                        </div>
                    `).join('');
                    
                    document.getElementById('listaDiputadosSinVoto').innerHTML = listHtml;
                    
                    const modal = new bootstrap.Modal(document.getElementById('diputadosSinVotoModal'));
                    modal.show();
                } else {
                    alert('Todos los diputados han emitido su voto');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al obtener diputados sin voto');
            }
        }
        
        // Enviar recordatorio individual
        async function enviarRecordatorioIndividual(diputadoId, nombre) {
            if (!confirm(`¬øEnviar recordatorio de voto a ${nombre}?`)) return;
            
            try {
                const response = await fetch(`/api/secretario/enviar-recordatorio/${diputadoId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Recordatorio enviado a ${nombre}`);
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al enviar recordatorio');
            }
        }
        
        // Enviar recordatorio a todos
        async function enviarRecordatorioTodos() {
            if (!confirm('¬øEnviar recordatorio a todos los diputados que no han votado?')) return;
            
            try {
                const response = await fetch('/api/secretario/enviar-recordatorio-todos', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(data.mensaje || 'Recordatorios enviados');
                    bootstrap.Modal.getInstance(document.getElementById('diputadosSinVotoModal')).hide();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al enviar recordatorios');
            }
        }
        
        // Abrir gesti√≥n de diputados
        async function abrirGestionDiputados() {
            try {
                const response = await fetch('/api/secretario/lista-diputados-gestion', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.diputados) {
                    const tableHtml = data.diputados.map(dip => `
                        <tr data-id="${dip.id}">
                            <td>${dip.nombre_completo}</td>
                            <td>${dip.partido || 'Sin partido'}</td>
                            <td>
                                <span class="badge bg-${dip.habilitado_voto ? 'success' : 'danger'}">
                                    ${dip.habilitado_voto ? 'Habilitado' : 'Deshabilitado'}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-${dip.en_pleno ? 'primary' : 'secondary'}">
                                    ${dip.en_pleno ? 'Presente' : 'Ausente'}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-${dip.habilitado_voto ? 'danger' : 'success'}" 
                                            onclick="toggleHabilitacion(${dip.id}, ${!dip.habilitado_voto})">
                                        <i class="fas fa-${dip.habilitado_voto ? 'ban' : 'check'}"></i>
                                        ${dip.habilitado_voto ? 'Deshabilitar' : 'Habilitar'}
                                    </button>
                                    <button class="btn btn-${dip.en_pleno ? 'warning' : 'info'}" 
                                            onclick="togglePleno(${dip.id}, ${!dip.en_pleno})">
                                        <i class="fas fa-${dip.en_pleno ? 'user-minus' : 'user-plus'}"></i>
                                        ${dip.en_pleno ? 'Marcar Ausente' : 'Marcar Presente'}
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                    
                    document.getElementById('tablaDiputadosGestion').innerHTML = tableHtml;
                    
                    const modal = new bootstrap.Modal(document.getElementById('gestionDiputadosModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar lista de diputados');
            }
        }
        
        // Toggle habilitaci√≥n de diputado
        async function toggleHabilitacion(diputadoId, habilitar) {
            try {
                const response = await fetch(`/api/secretario/toggle-habilitacion/${diputadoId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ habilitar })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Actualizar la tabla
                    abrirGestionDiputados();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cambiar habilitaci√≥n');
            }
        }
        
        // Toggle presencia en pleno
        async function togglePleno(diputadoId, presente) {
            try {
                const response = await fetch(`/api/secretario/toggle-pleno/${diputadoId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ presente })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Actualizar la tabla
                    abrirGestionDiputados();
                } else {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cambiar estado de presencia');
            }
        }
        
        // Guardar cambios de habilitaci√≥n
        function guardarCambiosHabilitacion() {
            bootstrap.Modal.getInstance(document.getElementById('gestionDiputadosModal')).hide();
            alert('Cambios guardados exitosamente');
        }
        
        // ===== FUNCIONES DE GESTI√ìN DE PASE DE LISTA =====
        
        let paseListaActual = null;
        let diputadosLista = [];
        let asistenciasActuales = {};
        
        // Abrir modal de gesti√≥n de pase de lista
        async function abrirGestionPaseLista() {
            const modal = new bootstrap.Modal(document.getElementById('gestionPaseListaModal'));
            modal.show();
            
            // Cargar datos iniciales
            await cargarDiputadosParaPase();
            await verificarEstadoPaseLista();
            await cargarSesionesParaHistorial();
        }
        
        // Cargar lista de diputados para pase de lista
        async function cargarDiputadosParaPase() {
            try {
                const response = await fetch('/api/pase-lista/diputados', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    diputadosLista = await response.json();
                    mostrarTablaPaseLista();
                }
            } catch (error) {
                console.error('Error cargando diputados:', error);
            }
        }
        
        // Verificar estado del pase de lista actual
        async function verificarEstadoPaseLista() {
            try {
                const response = await fetch('/api/pase-lista/actual', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    paseListaActual = data.pase_lista;
                    asistenciasActuales = data.asistencias || {};
                    
                    actualizarEstadoPaseLista(data);
                    actualizarContadores();
                    
                    if (paseListaActual) {
                        // Actualizar tabla con asistencias existentes
                        Object.keys(asistenciasActuales).forEach(diputadoId => {
                            const asistencia = asistenciasActuales[diputadoId];
                            actualizarFilaAsistencia(diputadoId, asistencia);
                        });
                    }
                }
            } catch (error) {
                console.error('Error verificando pase de lista:', error);
            }
        }
        
        // Actualizar estado del pase de lista en la UI
        function actualizarEstadoPaseLista(data) {
            const estadoDiv = document.getElementById('estadoPaseLista');
            const btnIniciar = document.getElementById('btnIniciarPase');
            const btnConfirmar = document.getElementById('btnConfirmarPase');
            
            if (!data.sesion_activa) {
                estadoDiv.className = 'alert alert-warning';
                estadoDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> No hay sesi√≥n activa. Debe iniciar una sesi√≥n primero.';
                btnIniciar.disabled = true;
                btnConfirmar.style.display = 'none';
            } else if (data.pase_lista) {
                if (data.pase_lista.confirmado) {
                    estadoDiv.className = 'alert alert-success';
                    estadoDiv.innerHTML = '<i class="fas fa-check-circle"></i> Pase de lista confirmado. Puede seguir editando si es necesario.';
                } else {
                    estadoDiv.className = 'alert alert-info';
                    estadoDiv.innerHTML = '<i class="fas fa-info-circle"></i> Pase de lista en progreso. Marque las asistencias.';
                }
                btnIniciar.style.display = 'none';
                btnConfirmar.style.display = 'inline-block';
            } else {
                estadoDiv.className = 'alert alert-secondary';
                estadoDiv.innerHTML = '<i class="fas fa-clipboard"></i> No hay pase de lista activo. Presione "Iniciar" para comenzar.';
                btnIniciar.style.display = 'inline-block';
                btnConfirmar.style.display = 'none';
            }
        }
        
        // Mostrar tabla de pase de lista
        function mostrarTablaPaseLista() {
            const tbody = document.getElementById('tablaPaseLista');
            
            tbody.innerHTML = diputadosLista.map(dip => `
                <tr data-diputado-id="${dip.id}">
                    <td>
                        ${dip.foto_url ? 
                            `<img src="${dip.foto_url}" class="rounded-circle" width="40" height="40">` : 
                            '<i class="fas fa-user-circle fa-2x text-muted"></i>'}
                    </td>
                    <td><strong>${dip.nombre_completo}</strong></td>
                    <td><span class="badge bg-secondary">${dip.partido || 'Sin partido'}</span></td>
                    <td>${dip.cargo_mesa_directiva || '-'}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-success" onclick="marcarAsistencia(${dip.id}, 'presente')" 
                                    id="btn-presente-${dip.id}">
                                <i class="fas fa-check"></i> Presente
                            </button>
                            <button class="btn btn-outline-danger" onclick="marcarAsistencia(${dip.id}, 'ausente')" 
                                    id="btn-ausente-${dip.id}">
                                <i class="fas fa-times"></i> Ausente
                            </button>
                        </div>
                        <span class="ms-2 badge" id="estado-${dip.id}"></span>
                    </td>
                </tr>
            `).join('');
        }
        
        // Marcar asistencia
        async function marcarAsistencia(diputadoId, asistencia) {
            try {
                const response = await fetch('/api/pase-lista/marcar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        diputado_id: diputadoId,
                        asistencia: asistencia
                    })
                });
                
                if (response.ok) {
                    asistenciasActuales[diputadoId] = asistencia;
                    actualizarFilaAsistencia(diputadoId, asistencia);
                    actualizarContadores();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al marcar asistencia');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al marcar asistencia');
            }
        }
        
        // Actualizar fila de asistencia en la tabla
        function actualizarFilaAsistencia(diputadoId, asistencia) {
            const btnPresente = document.getElementById(`btn-presente-${diputadoId}`);
            const btnAusente = document.getElementById(`btn-ausente-${diputadoId}`);
            const estado = document.getElementById(`estado-${diputadoId}`);
            
            if (btnPresente && btnAusente) {
                btnPresente.classList.remove('btn-success');
                btnPresente.classList.add('btn-outline-success');
                btnAusente.classList.remove('btn-danger');
                btnAusente.classList.add('btn-outline-danger');
                
                if (asistencia === 'presente') {
                    btnPresente.classList.remove('btn-outline-success');
                    btnPresente.classList.add('btn-success');
                    estado.className = 'ms-2 badge bg-success';
                    estado.textContent = 'PRESENTE';
                } else if (asistencia === 'ausente') {
                    btnAusente.classList.remove('btn-outline-danger');
                    btnAusente.classList.add('btn-danger');
                    estado.className = 'ms-2 badge bg-danger';
                    estado.textContent = 'AUSENTE';
                }
            }
        }
        
        // Actualizar contadores
        function actualizarContadores() {
            let presentes = 0;
            let ausentes = 0;
            let sinMarcar = diputadosLista.length;
            
            Object.values(asistenciasActuales).forEach(asistencia => {
                if (asistencia === 'presente') {
                    presentes++;
                    sinMarcar--;
                } else if (asistencia === 'ausente') {
                    ausentes++;
                    sinMarcar--;
                }
            });
            
            document.getElementById('totalPresentes').textContent = presentes;
            document.getElementById('totalAusentes').textContent = ausentes;
            document.getElementById('totalSinMarcar').textContent = sinMarcar;
        }
        
        // Activar el pase de lista y mostrar en pantalla p√∫blica
        async function activarPaseLista() {
            if (!confirm('¬øActivar el pase de lista?\n\nEsto mostrar√° la pantalla de asistencia p√∫blica.')) return;
            
            try {
                const response = await fetch('/api/pase-lista/activar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Cambiar botones
                    document.getElementById('btnActivarPaseLista').style.display = 'none';
                    document.getElementById('btnPaseLista').style.display = 'block';
                    
                    // Emitir evento para actualizar pantalla p√∫blica
                    socket.emit('pase-lista-activado', {
                        activo: true,
                        sesion_id: data.sesion_id
                    });
                    
                    // Mostrar notificaci√≥n
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <strong>‚úÖ Pase de lista activado</strong><br>
                        La pantalla de asistencia est√° ahora visible.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    setTimeout(() => alertDiv.remove(), 5000);
                    
                    // Abrir ventana de pantalla de asistencia (opcional)
                    if (confirm('¬øDesea abrir la pantalla de asistencia en una nueva ventana?')) {
                        window.open('/pantalla-asistencia', '_blank');
                    }
                } else {
                    const data = await response.json();
                    alert('Error al activar pase de lista: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al activar pase de lista');
            }
        }
        
        // Iniciar pase de lista
        async function iniciarPaseLista() {
            if (!confirm('¬øIniciar un nuevo pase de lista?')) return;
            
            // Simplemente recargamos el estado, el backend crear√° el pase si es necesario
            await verificarEstadoPaseLista();
        }
        
        // Confirmar pase de lista
        async function confirmarPaseLista() {
            if (!confirm('¬øConfirmar el pase de lista actual?')) return;
            
            try {
                const response = await fetch('/api/pase-lista/confirmar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Pase de lista confirmado\nPresentes: ${data.presentes}\nAusentes: ${data.ausentes}`);
                    await verificarEstadoPaseLista();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al confirmar pase de lista');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al confirmar pase de lista');
            }
        }
        
        // Mostrar en pantalla
        async function mostrarEnPantalla() {
            try {
                const response = await fetch('/api/pase-lista/mostrar-pantalla', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ visible: true })
                });
                
                if (response.ok) {
                    alert('Pase de lista visible en pantalla p√∫blica');
                } else {
                    alert('Error al mostrar en pantalla');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al mostrar en pantalla');
            }
        }
        
        // Cargar sesiones para historial
        async function cargarSesionesParaHistorial() {
            try {
                const response = await fetch('/api/secretario/historial-sesiones-con-asistencia', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const sesiones = await response.json();
                    
                    const selectHistorial = document.getElementById('selectSesionHistorial');
                    const selectModificar = document.getElementById('selectSesionModificar');
                    
                    const options = sesiones.map(s => 
                        `<option value="${s.id}">Sesi√≥n #${s.id} - ${new Date(s.fecha_inicio || s.fecha).toLocaleDateString('es-MX')}</option>`
                    ).join('');
                    
                    selectHistorial.innerHTML = '<option value="">Seleccione una sesi√≥n...</option>' + options;
                    selectModificar.innerHTML = '<option value="">Seleccione una sesi√≥n...</option>' + options;
                }
            } catch (error) {
                console.error('Error cargando sesiones:', error);
            }
        }
        
        // Cargar historial de asistencia
        async function cargarHistorialAsistencia() {
            const sesionId = document.getElementById('selectSesionHistorial').value;
            if (!sesionId) return;
            
            try {
                const response = await fetch(`/api/secretario/asistencia-sesion/${sesionId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    mostrarHistorialAsistencia(data);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Mostrar historial de asistencia
        function mostrarHistorialAsistencia(data) {
            const contenido = document.getElementById('contenidoHistorialAsistencia');
            
            contenido.innerHTML = `
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">Sesi√≥n #${data.sesion.id} - ${new Date(data.sesion.fecha_inicio || data.sesion.fecha).toLocaleString('es-MX')}</h6>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col text-center">
                                <h3 class="text-success">${data.resumen.presentes}</h3>
                                <p>Presentes</p>
                            </div>
                            <div class="col text-center">
                                <h3 class="text-danger">${data.resumen.ausentes}</h3>
                                <p>Ausentes</p>
                            </div>
                            <div class="col text-center">
                                <h3 class="text-primary">${data.resumen.total}</h3>
                                <p>Total</p>
                            </div>
                        </div>
                        
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Diputado</th>
                                    <th>Partido</th>
                                    <th>Asistencia</th>
                                    <th>Hora de Registro</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.asistencias.map(a => `
                                    <tr>
                                        <td>${a.nombre_completo}</td>
                                        <td><span class="badge bg-secondary">${a.partido}</span></td>
                                        <td>
                                            <span class="badge bg-${a.asistencia === 'presente' ? 'success' : 'danger'}">
                                                ${a.asistencia === 'presente' ? 'PRESENTE' : 'AUSENTE'}
                                            </span>
                                        </td>
                                        <td>${a.hora ? new Date(a.hora).toLocaleTimeString('es-MX') : '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // Cargar asistencia para modificar
        async function cargarAsistenciaParaModificar() {
            const sesionId = document.getElementById('selectSesionModificar').value;
            if (!sesionId) return;
            
            document.getElementById('btnGuardarModificaciones').disabled = false;
            
            try {
                const response = await fetch(`/api/secretario/asistencia-sesion/${sesionId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    mostrarAsistenciaParaModificar(data);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Mostrar asistencia para modificar
        function mostrarAsistenciaParaModificar(data) {
            const contenido = document.getElementById('contenidoModificarAsistencia');
            
            contenido.innerHTML = `
                <div class="alert alert-info">
                    <strong>Sesi√≥n #${data.sesion.id}</strong> - ${new Date(data.sesion.fecha_inicio || data.sesion.fecha).toLocaleString('es-MX')}
                </div>
                
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Diputado</th>
                            <th>Partido</th>
                            <th>Asistencia Actual</th>
                            <th>Cambiar a</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.asistencias.map(a => `
                            <tr>
                                <td>${a.nombre_completo}</td>
                                <td><span class="badge bg-secondary">${a.partido}</span></td>
                                <td>
                                    <span class="badge bg-${a.asistencia === 'presente' ? 'success' : a.asistencia === 'ausente' ? 'danger' : 'secondary'}">
                                        ${a.asistencia === 'presente' ? 'PRESENTE' : a.asistencia === 'ausente' ? 'AUSENTE' : 'SIN MARCAR'}
                                    </span>
                                </td>
                                <td>
                                    <select class="form-select form-select-sm asistencia-modificar" 
                                            data-diputado-id="${a.diputado_id}" 
                                            data-pase-lista-id="${data.pase_lista_id}">
                                        <option value="">Sin cambios</option>
                                        <option value="presente" ${a.asistencia === 'presente' ? 'selected' : ''}>Presente</option>
                                        <option value="ausente" ${a.asistencia === 'ausente' ? 'selected' : ''}>Ausente</option>
                                    </select>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Guardar modificaciones de asistencia
        async function guardarModificacionesAsistencia() {
            const razon = document.getElementById('razonModificacion').value.trim();
            if (!razon) {
                alert('Por favor indique la raz√≥n de la modificaci√≥n');
                return;
            }
            
            const modificaciones = [];
            document.querySelectorAll('.asistencia-modificar').forEach(select => {
                if (select.value) {
                    modificaciones.push({
                        diputado_id: parseInt(select.dataset.diputadoId),
                        pase_lista_id: parseInt(select.dataset.paseListaId),
                        asistencia: select.value
                    });
                }
            });
            
            if (modificaciones.length === 0) {
                alert('No hay cambios para guardar');
                return;
            }
            
            if (!confirm(`¬øGuardar ${modificaciones.length} modificaciones?\nRaz√≥n: ${razon}`)) return;
            
            try {
                const response = await fetch('/api/secretario/modificar-asistencias', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        modificaciones,
                        razon,
                        modificado_por: user.nombre
                    })
                });
                
                if (response.ok) {
                    alert('Asistencias modificadas correctamente');
                    document.getElementById('selectSesionModificar').value = '';
                    document.getElementById('razonModificacion').value = '';
                    document.getElementById('contenidoModificarAsistencia').innerHTML = 
                        '<p class="text-center text-muted">Seleccione una sesi√≥n para modificar la asistencia</p>';
                    document.getElementById('btnGuardarModificaciones').disabled = true;
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error al modificar asistencias');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar modificaciones');
            }
        }
        
        // Exportar asistencia
        async function exportarAsistencia() {
            const sesionId = document.getElementById('selectSesionHistorial').value;
            if (!sesionId) {
                alert('Seleccione una sesi√≥n para exportar');
                return;
            }
            
            try {
                const response = await fetch(`/api/secretario/exportar-asistencia/${sesionId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `asistencia_sesion_${sesionId}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else {
                    alert('Error al exportar asistencia');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al exportar');
            }
        }
        
        // Imprimir asistencia
        function imprimirAsistencia() {
            const contenido = document.getElementById('contenidoHistorialAsistencia').innerHTML;
            if (!contenido || contenido.includes('Seleccione una sesi√≥n')) {
                alert('Seleccione una sesi√≥n para imprimir');
                return;
            }
            
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Reporte de Asistencia</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="container mt-3">');
            printWindow.document.write('<h3>Reporte de Asistencia</h3>');
            printWindow.document.write(contenido);
            printWindow.document.write('</div></body></html>');
            printWindow.document.close();
            printWindow.print();
        }
        
        // Funciones para el nuevo modal de Agregar Iniciativa
        async function mostrarModalAgregarIniciativa() {
            await cargarListaDiputadosNuevaIniciativa();
            await cargarNumerosDisponibles();
            const modalElement = document.getElementById('agregarIniciativaModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement, {
                    backdrop: 'static',
                    keyboard: true
                });
                modal.show();
            }
        }
        
        async function cargarListaDiputadosNuevaIniciativa() {
            try {
                const response = await fetch('/api/secretario/lista-diputados', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const diputados = await response.json();
                    const select = document.getElementById('presentadorIniciativa');
                    select.innerHTML = '<option value="">Seleccionar diputado...</option>';
                    
                    diputados.forEach(diputado => {
                        const option = document.createElement('option');
                        option.value = diputado.nombre_completo;
                        option.dataset.partido = diputado.partido;
                        option.dataset.id = diputado.id;
                        option.textContent = diputado.nombre_completo;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error cargando diputados:', error);
            }
        }
        
        function actualizarPartidoNuevaIniciativa() {
            const select = document.getElementById('presentadorIniciativa');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.partido) {
                document.getElementById('partidoIniciativa').value = selectedOption.dataset.partido;
            } else {
                document.getElementById('partidoIniciativa').value = '';
            }
        }
        
        async function cargarNumerosDisponibles() {
            try {
                const response = await fetch('/api/secretario/iniciativas', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                const iniciativas = data.iniciativas || [];
                const totalIniciativas = iniciativas.length;
                
                // Llenar selector de n√∫meros para nueva iniciativa
                const selectNumero = document.getElementById('numeroIniciativa');
                selectNumero.innerHTML = '<option value="">Seleccionar posici√≥n...</option>';
                
                // Agregar opciones del 1 al total + 1
                for (let i = 1; i <= totalIniciativas + 1; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    if (i <= totalIniciativas) {
                        const iniciativaExistente = iniciativas.find(init => init.numero === i);
                        if (iniciativaExistente) {
                            option.textContent = `${i} (ocupado - se recorrer√°n las siguientes)`;
                        } else {
                            option.textContent = `${i} (disponible)`;
                        }
                    } else {
                        option.textContent = `${i} (al final)`;
                    }
                    selectNumero.appendChild(option);
                }
                
                // Tambi√©n llenar selector para extraordinarias
                const selectExtNumero = document.getElementById('extNumero');
                selectExtNumero.innerHTML = '<option value="">Seleccionar posici√≥n...</option>';
                
                for (let i = 1; i <= totalIniciativas + 1; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    if (i <= totalIniciativas) {
                        option.textContent = `${i} (las siguientes se recorrer√°n)`;
                    } else {
                        option.textContent = `${i} (al final)`;
                    }
                    selectExtNumero.appendChild(option);
                }
                
            } catch (error) {
                console.error('Error cargando n√∫meros disponibles:', error);
            }
        }
        
        async function guardarNuevaIniciativa() {
            const numero = document.getElementById('numeroIniciativa').value;
            const descripcion = document.getElementById('descripcionIniciativa').value;
            const presentador = document.getElementById('presentadorIniciativa').value;
            const partido = document.getElementById('partidoIniciativa').value;
            const tipoMayoria = document.getElementById('tipoMayoriaIniciativa').value;
            
            if (!numero || !descripcion || !presentador || !tipoMayoria) {
                alert('Por favor complete todos los campos requeridos');
                return;
            }
            
            const iniciativa = {
                numero: parseInt(numero),
                descripcion: descripcion,
                presentador: presentador,
                partido_presentador: partido,
                tipo_mayoria: tipoMayoria,
                tipo_iniciativa: 'normal',
                recorrer_numeros: true
            };
            
            try {
                const response = await fetch('/api/secretario/agregar-iniciativa', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(iniciativa)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Iniciativa agregada correctamente');
                    bootstrap.Modal.getInstance(document.getElementById('agregarIniciativaModal')).hide();
                    
                    // Limpiar formulario
                    document.getElementById('nuevaIniciativaForm').reset();
                    document.getElementById('partidoIniciativa').value = '';
                    
                    // Recargar lista de iniciativas
                    loadInitiatives();
                } else {
                    alert(data.error || 'Error al agregar iniciativa');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar la iniciativa');
            }
        }
        
    </script>

    <!-- Modal de Gesti√≥n de Pase de Lista -->
    <div class="modal fade" id="gestionPaseListaModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-clipboard-check"></i> Revisi√≥n de Asistencia - Secretario Legislativo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Nota:</strong> El pase de lista es responsabilidad principal del <strong>Diputado-Secretario 1</strong>. 
                        Como Secretario Legislativo, puede revisar y corregir la asistencia solo en caso de errores.
                    </div>
                    <ul class="nav nav-tabs" id="paseListaTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabPaseActual">
                                <i class="fas fa-list-check"></i> Revisar Pase de Lista
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabHistorialAsistencia">
                                <i class="fas fa-history"></i> Historial de Asistencias
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabModificarAsistencia">
                                <i class="fas fa-edit"></i> Modificar Asistencia
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3">
                        <!-- Tab Pase de Lista Actual -->
                        <div class="tab-pane fade show active" id="tabPaseActual">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <div id="estadoPaseLista" class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> Cargando estado del pase de lista...
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-success" onclick="iniciarPaseLista()" id="btnIniciarPase">
                                        <i class="fas fa-play"></i> Iniciar Pase de Lista
                                    </button>
                                    <button class="btn btn-warning" onclick="confirmarPaseLista()" id="btnConfirmarPase" style="display:none;">
                                        <i class="fas fa-check"></i> Confirmar Pase
                                    </button>
                                    <button class="btn btn-info" onclick="mostrarEnPantalla()" id="btnMostrarPantalla">
                                        <i class="fas fa-tv"></i> Mostrar en Pantalla
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Foto</th>
                                            <th>Nombre</th>
                                            <th>Partido</th>
                                            <th>Cargo</th>
                                            <th>Asistencia</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaPaseLista">
                                        <tr><td colspan="5" class="text-center">Cargando diputados...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col text-center">
                                    <h5>Resumen de Asistencia</h5>
                                    <div class="d-flex justify-content-center gap-4">
                                        <div>
                                            <span class="badge bg-success fs-5" id="totalPresentes">0</span>
                                            <p class="mb-0">Presentes</p>
                                        </div>
                                        <div>
                                            <span class="badge bg-danger fs-5" id="totalAusentes">0</span>
                                            <p class="mb-0">Ausentes</p>
                                        </div>
                                        <div>
                                            <span class="badge bg-secondary fs-5" id="totalSinMarcar">20</span>
                                            <p class="mb-0">Sin Marcar</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab Historial de Asistencias -->
                        <div class="tab-pane fade" id="tabHistorialAsistencia">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Filtrar por sesi√≥n:</label>
                                    <select class="form-select" id="selectSesionHistorial" onchange="cargarHistorialAsistencia()">
                                        <option value="">Seleccione una sesi√≥n...</option>
                                    </select>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button class="btn btn-primary" onclick="exportarAsistencia()">
                                        <i class="fas fa-download"></i> Exportar a Excel
                                    </button>
                                    <button class="btn btn-info" onclick="imprimirAsistencia()">
                                        <i class="fas fa-print"></i> Imprimir
                                    </button>
                                </div>
                            </div>
                            
                            <div id="contenidoHistorialAsistencia">
                                <p class="text-center text-muted">Seleccione una sesi√≥n para ver el historial de asistencia</p>
                            </div>
                        </div>
                        
                        <!-- Tab Modificar Asistencia -->
                        <div class="tab-pane fade" id="tabModificarAsistencia">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> <strong>Atenci√≥n:</strong> Esta funci√≥n permite modificar registros de asistencia ya confirmados. Use con precauci√≥n.
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Seleccionar sesi√≥n a modificar:</label>
                                    <select class="form-select" id="selectSesionModificar" onchange="cargarAsistenciaParaModificar()">
                                        <option value="">Seleccione una sesi√≥n...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Raz√≥n de la modificaci√≥n:</label>
                                    <input type="text" class="form-control" id="razonModificacion" placeholder="Ej: Error en el registro inicial">
                                </div>
                            </div>
                            
                            <div id="contenidoModificarAsistencia">
                                <p class="text-center text-muted">Seleccione una sesi√≥n para modificar la asistencia</p>
                            </div>
                            
                            <div class="text-end mt-3">
                                <button class="btn btn-danger" onclick="guardarModificacionesAsistencia()" id="btnGuardarModificaciones" disabled>
                                    <i class="fas fa-save"></i> Guardar Modificaciones
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Recordatorios -->
    <div class="modal fade" id="recordatoriosModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-bell"></i> Enviar Recordatorios de Votaci√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="iniciativaInfo" class="alert alert-light mb-3"></div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Diputados que no han votado: <span id="totalSinVoto" class="badge bg-danger">0</span></h6>
                        <button class="btn btn-warning" onclick="enviarRecordatorioTodos()">
                            <i class="fas fa-bell"></i> Notificar a Todos
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Diputado</th>
                                    <th>Partido</th>
                                    <th>Cargo</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="listaDiputadosSinVoto">
                                <tr><td colspan="4" class="text-center">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/theme-switcher.js"></script>
</body>
</html>