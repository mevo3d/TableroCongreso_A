<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pase de Lista - Sistema de Votación</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/apple-theme.css">
    <link rel="stylesheet" href="/css/dark-theme.css">
    <link rel="stylesheet" href="/css/global-background.css">
    <script src="/js/theme-loader.js"></script>
    <style>
        /* Estilo Apple */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #f5f5f7 0%, #e1e1e3 100%);
            min-height: 100vh;
            color: #1d1d1f;
            transition: all 0.3s ease;
        }
        
        [data-theme="dark"] body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2e 100%);
            color: #f5f5f7;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        [data-theme="dark"] .navbar {
            background: rgba(29, 29, 31, 0.85);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .attendance-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
        }
        
        .attendance-header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        [data-theme="dark"] .attendance-header {
            background: rgba(45, 45, 47, 0.7) !important;
            color: #f5f5f7 !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        [data-theme="dark"] .attendance-header h2 {
            color: #e0e0e0 !important;
        }
        
        [data-theme="dark"] .attendance-header .text-muted {
            color: #b0b0b0 !important;
        }
        
        .attendance-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .stat-card {
            text-align: center;
            padding: 16px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            min-width: 150px;
            border: 1px solid rgba(0, 0, 0, 0.04);
            transition: all 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        [data-theme="dark"] .stat-card {
            background: rgba(61, 61, 63, 0.6) !important;
            color: #f5f5f7 !important;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }
        
        [data-theme="dark"] .stat-card h3 {
            color: inherit !important;
        }
        
        [data-theme="dark"] .stat-card small {
            color: #b0b0b0 !important;
        }
        
        .stat-card h3 {
            font-size: 2.8em;
            margin: 0;
            font-weight: bold;
        }
        
        .stat-card.present { color: #28a745; }
        .stat-card.absent { color: #dc3545; }
        .stat-card.total { color: #6c757d; }
        
        .deputies-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 10px;
        }
        
        @media (max-width: 768px) {
            .deputies-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
        
        .deputy-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
            border: 2px solid rgba(0, 0, 0, 0.08);
            min-height: 100px;
            min-width: 0; /* Evitar overflow de texto */
        }
        
        [data-theme="dark"] .deputy-card {
            background: rgba(45, 45, 47, 0.7) !important;
            color: #f5f5f7 !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .deputy-card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9);
        }
        
        [data-theme="dark"] .deputy-card:hover {
            background: rgba(61, 61, 63, 0.8) !important;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .deputy-card.present {
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.1), rgba(48, 209, 88, 0.15));
            border: 1px solid rgba(52, 199, 89, 0.3);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.15);
        }
        
        [data-theme="dark"] .deputy-card.present {
            background: linear-gradient(135deg, rgba(48, 209, 88, 0.15), rgba(52, 199, 89, 0.2));
            border: 1px solid rgba(48, 209, 88, 0.4);
        }
        
        [data-theme="dark"] .deputy-card.present {
            background: rgba(40, 167, 69, 0.15) !important;
        }
        
        .deputy-card.absent {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.1), rgba(255, 69, 58, 0.15));
            border: 1px solid rgba(255, 59, 48, 0.3);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.15);
        }
        
        [data-theme="dark"] .deputy-card.absent {
            background: linear-gradient(135deg, rgba(255, 69, 58, 0.15), rgba(255, 59, 48, 0.2));
            border: 1px solid rgba(255, 69, 58, 0.4);
        }
        
        .deputy-card.justified {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 179, 0, 0.15));
            border: 1px solid rgba(255, 193, 7, 0.3);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15);
        }
        
        [data-theme="dark"] .deputy-card.justified {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 179, 0, 0.2));
            border: 1px solid rgba(255, 193, 7, 0.4);
        }
        
        .deputy-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .deputy-photo {
            width: 58px; /* Ligeramente más grande */
            height: 58px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e0e0e0;
            flex-shrink: 0;
        }
        
        [data-theme="dark"] .deputy-photo {
            border-color: #505050;
        }
        
        .deputy-photo-placeholder {
            width: 58px; /* Mismo tamaño que la foto */
            height: 58px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 19px;
            color: white;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        
        .deputy-details {
            flex: 1;
            min-width: 0; /* Importante para text-overflow */
        }
        
        .deputy-name {
            font-weight: 600;
            font-size: 1.05em; /* Aumentado tamaño de fuente */
            margin-bottom: 5px;
            line-height: 1.4; /* Mejor espaciado */
            white-space: nowrap; /* Forzar una sola línea */
            overflow: hidden;
            text-overflow: ellipsis; /* Puntos suspensivos si es muy largo */
        }
        
        [data-theme="dark"] .deputy-name {
            color: #e0e0e0 !important;
        }
        
        .deputy-party {
            font-size: 0.75em;
            color: #6c757d;
        }
        
        [data-theme="dark"] .deputy-party {
            color: #b0b0b0 !important;
        }
        
        .deputy-party .badge {
            font-size: 0.7em;
            padding: 2px 5px;
        }
        
        .attendance-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .attendance-buttons button {
            flex: 1;
            padding: 10px 8px;
            font-size: 0.85em;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .btn-present {
            background: linear-gradient(135deg, #34c759, #30d158);
            color: white;
            box-shadow: 0 2px 6px rgba(52, 199, 89, 0.2);
        }
        
        .btn-present:hover {
            background: linear-gradient(135deg, #30d158, #34c759);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
        }
        
        .btn-absent {
            background: linear-gradient(135deg, #ff3b30, #ff453a);
            color: white;
            border: none;
            box-shadow: 0 2px 6px rgba(255, 59, 48, 0.2);
        }
        
        .btn-absent:hover {
            background: linear-gradient(135deg, #ff453a, #ff3b30);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
        }
        
        .btn-present.active {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.6);
            transform: scale(1.05);
            animation: pulse-green 1.5s infinite;
        }
        
        @keyframes pulse-green {
            0% { box-shadow: 0 0 20px rgba(40, 167, 69, 0.6); }
            50% { box-shadow: 0 0 30px rgba(40, 167, 69, 0.8); }
            100% { box-shadow: 0 0 20px rgba(40, 167, 69, 0.6); }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        /* Efecto pulse para cuando un diputado confirma asistencia */
        @keyframes pulseOnce {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 20px 10px rgba(40, 167, 69, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }
        
        .pulse-once {
            animation: pulseOnce 1s ease-in-out;
        }
        
        .btn-absent.active {
            background-color: #bd2130 !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.5);
        }
        
        .btn-justified {
            background: linear-gradient(135deg, #ffc107, #ffb300);
            color: #000;
            border: none;
            box-shadow: 0 2px 6px rgba(255, 193, 7, 0.2);
        }
        
        .btn-justified:hover {
            background: linear-gradient(135deg, #ffb300, #ffc107);
            color: #000;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }
        
        .btn-justified.active {
            background: linear-gradient(135deg, #ffa000, #ff8f00) !important;
            color: #000 !important;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
            transform: scale(1.05);
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        [data-theme="dark"] .control-panel {
            background: rgba(45, 45, 47, 0.7) !important;
            color: #f5f5f7 !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        [data-theme="dark"] .control-panel h5 {
            color: #e0e0e0 !important;
        }
        
        [data-theme="dark"] .control-panel .text-muted {
            color: #b0b0b0 !important;
        }
        
        /* Badges en modo oscuro */
        [data-theme="dark"] .badge {
            opacity: 0.9;
        }
        
        [data-theme="dark"] .badge.bg-secondary {
            background-color: #495057 !important;
        }
        
        [data-theme="dark"] .badge.bg-info {
            background-color: #0dcaf0 !important;
            color: #000 !important;
        }
        
        /* Readonly badge */
        [data-theme="dark"] .readonly-badge {
            background: rgba(255, 193, 7, 0.9) !important;
        }
        
        /* Botones en modo oscuro */
        [data-theme="dark"] .btn-success {
            background-color: #198754 !important;
            border-color: #198754 !important;
        }
        
        [data-theme="dark"] .btn-info {
            background-color: #0dcaf0 !important;
            border-color: #0dcaf0 !important;
            color: #000 !important;
        }
        
        [data-theme="dark"] .btn-primary {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
        }
        
        /* Asegurar que todos los textos sean visibles */
        [data-theme="dark"] p, 
        [data-theme="dark"] span,
        [data-theme="dark"] div {
            color: inherit;
        }
        
        .btn-finalize {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1em;
            border-radius: 10px;
        }
        
        .btn-finalize:hover {
            opacity: 0.9;
            color: white;
        }
        
        /* Vista solo lectura */
        .readonly-mode .attendance-buttons {
            display: none;
        }
        
        .readonly-mode .attendance-control-buttons {
            display: none;
        }
        
        .readonly-mode .btn-finalize {
            display: none;
        }
        
        .readonly-badge {
            background: #ffc107;
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark" style="background: linear-gradient(135deg, #1a2332, #263241) !important; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0, 0, 0, 0.3); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-clipboard-check"></i> Pase de Lista
            </span>
            <div class="d-flex align-items-center">
                <span class="text-white me-3" id="userName"></span>
                <span id="readonlyBadge" class="readonly-badge me-3" style="display: none;">
                    <i class="fas fa-eye"></i> Solo Lectura
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Regresar
                </button>
            </div>
        </div>
    </nav>
    
    <div class="attendance-container">
        <!-- Header con estadísticas -->
        <div class="attendance-header">
            <h2 class="text-center mb-3">
                <i class="fas fa-users"></i> Control de Asistencia
            </h2>
            <p class="text-center text-muted mb-4">
                <i class="fas fa-info-circle"></i> 
                <strong>Responsable Principal: Diputado-Secretario 1</strong>
            </p>
            <div class="attendance-stats">
                <div class="stat-card present">
                    <h3 id="presentCount">0</h3>
                    <small>Presentes</small>
                </div>
                <div class="stat-card absent">
                    <h3 id="absentCount">0</h3>
                    <small>Inasistencias</small>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 179, 0, 0.15)); border-color: #ffc107;">
                    <h3 id="justifiedCount" style="color: #ffc107;">0</h3>
                    <small>Justificados</small>
                </div>
                <div class="stat-card total">
                    <h3 id="totalCount">20</h3>
                    <small>Total</small>
                </div>
            </div>
        </div>
        
        <!-- Panel de control -->
        <div class="control-panel" id="controlPanel">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1">Estado del Pase de Lista</h5>
                    <p class="text-muted mb-0" id="attendanceStatus">Sin iniciar</p>
                </div>
                <div class="attendance-control-buttons">
                    <button class="btn btn-primary" onclick="habilitarAutoAsistencia()" id="enableAutoBtn">
                        <i class="fas fa-user-check"></i> Habilitar Auto-Asistencia
                    </button>
                    <button class="btn btn-success ms-2" onclick="confirmAttendance()" id="confirmBtn">
                        <i class="fas fa-check"></i> Confirmar Pase de Lista
                    </button>
                    <button class="btn btn-warning ms-2" onclick="reiniciarPaseLista()" id="resetBtn"
                            title="Reiniciar el pase de lista (borra todas las asistencias marcadas)">
                        <i class="fas fa-redo"></i> Reiniciar Pase de Lista
                    </button>
                    <button class="btn btn-info ms-2" onclick="showOnScreen()" id="showScreenBtn" 
                            title="Forzar actualización de la pantalla pública (normalmente se actualiza automáticamente)">
                        <i class="fas fa-tv"></i> Actualizar Pantalla
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Grid de diputados -->
        <div class="deputies-grid" id="deputiesGrid">
            <!-- Se llenará dinámicamente -->
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');
        let attendanceData = {};
        let isReadonly = true;
        
        // Verificar autenticación
        if (!token || !user) {
            window.location.href = '/';
        }
        
        document.getElementById('userName').textContent = user.nombre;
        
        // Verificar permisos y estado de sesión
        async function checkPermissions() {
            console.log('=== checkPermissions iniciado ===');
            console.log('Usuario actual:', user);
            console.log('Nombre completo:', user.nombre_completo);
            console.log('Nombre:', user.nombre);
            console.log('Cargo:', user.cargo_mesa_directiva);
            console.log('Role:', user.role);
            
            // Primero verificar si la sesión está iniciada
            try {
                const sessionResponse = await fetch('/api/diputado/sesion-actual', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (sessionResponse.ok) {
                    const sessionData = await sessionResponse.json();
                    
                    // Verificar si hay sesión activa e iniciada
                    if (!sessionData.sesion_activa) {
                        console.error('No hay sesión activa');
                        alert('No hay sesión activa. El Operador debe preparar una sesión primero.');
                        goBack();
                        return false;
                    }
                    
                    // Verificar si la sesión está iniciada (tiene fecha_inicio)
                    if (sessionData.sesion && !sessionData.sesion.fecha_inicio) {
                        console.error('Sesión no iniciada por el presidente');
                        alert('La sesión debe ser iniciada por el Presidente antes de realizar el pase de lista.');
                        goBack();
                        return false;
                    }
                    
                    console.log('Sesión activa e iniciada encontrada');
                }
            } catch (error) {
                console.error('Error verificando estado de sesión:', error);
            }
            
            // Ahora verificar permisos de usuario
            // Secretario1, secretario2, secretario legislativo y usuarios especiales pueden editar
            if (user.cargo_mesa_directiva === 'secretario1' || 
                user.cargo_mesa_directiva === 'secretario2' ||
                user.role === 'secretario' ||
                user.nombre_completo === 'Alberto Sánchez Ortega' ||
                user.nombre === 'Alberto Sánchez Ortega' ||
                user.nombre_completo === 'Guillermina Maya') {
                console.log('✅ Usuario con permisos de edición detectado');
                isReadonly = false;
                document.body.classList.remove('readonly-mode');
                // Asegurar que los botones sean visibles
                const controlButtons = document.querySelector('.attendance-control-buttons');
                if (controlButtons) {
                    controlButtons.style.display = 'block';
                }
            } else if (user.role === 'superadmin' ||
                       user.cargo_mesa_directiva === 'presidente' ||
                       user.cargo_mesa_directiva === 'vicepresidente') {
                // Pueden ver pero no modificar
                isReadonly = true;
                document.body.classList.add('readonly-mode');
                document.getElementById('readonlyBadge').style.display = 'inline-block';
            } else {
                // No tienen acceso
                console.error('Usuario sin permisos:', user.role, user.cargo_mesa_directiva);
                alert('No tienes permisos para acceder a esta sección');
                goBack();
                return false;
            }
            
            console.log('=== checkPermissions completado exitosamente ===');
            return true;
        }
        
        // Función para obtener lista de diputados por defecto
        function obtenerDiputadosPorDefecto() {
            console.log('Generando lista de diputados por defecto...');
            return [
                { id: 18, nombre_completo: 'Eduardo Abarca Peña', partido: 'MORENA', cargo_mesa_directiva: null },
                { id: 12, nombre_completo: 'Andrea Domínguez Mandujano', partido: 'PAN', cargo_mesa_directiva: null },
                { id: 17, nombre_completo: 'Luis Fernando Espinoza López', partido: 'PRI', cargo_mesa_directiva: null },
                { id: 6, nombre_completo: 'Juan Carlos Gordillo Vega', partido: 'MC', cargo_mesa_directiva: 'Presidente' },
                { id: 7, nombre_completo: 'Mónica Livera Chavarría', partido: 'MORENA', cargo_mesa_directiva: null },
                { id: 22, nombre_completo: 'Roberto Martínez Gómez', partido: 'PT', cargo_mesa_directiva: null },
                { id: 5, nombre_completo: 'Carlos Martínez Terrazas', partido: 'PAN', cargo_mesa_directiva: 'Vicepresidente' },
                { id: 8, nombre_completo: 'Ana Patricia Maya Rendón', partido: 'PRI', cargo_mesa_directiva: null },
                { id: 15, nombre_completo: 'Alejandra Montes de Oca', partido: 'MC', cargo_mesa_directiva: null },
                { id: 21, nombre_completo: 'Miguel Pedrero González', partido: 'MORENA', cargo_mesa_directiva: null },
                { id: 16, nombre_completo: 'Jorge Pimentel Mejía', partido: 'PT', cargo_mesa_directiva: null },
                { id: 19, nombre_completo: 'Diana Quevedo Maldonado', partido: 'PAN', cargo_mesa_directiva: null },
                { id: 10, nombre_completo: 'Alejandro Reyes Reyes', partido: 'PRI', cargo_mesa_directiva: 'Secretario' },
                { id: 23, nombre_completo: 'Fernando Rodríguez López', partido: 'MC', cargo_mesa_directiva: null },
                { id: 20, nombre_completo: 'Carmen Rodríguez Ruiz', partido: 'MORENA', cargo_mesa_directiva: null },
                { id: 11, nombre_completo: 'José Luis Ruiz Rodríguez', partido: 'PT', cargo_mesa_directiva: 'Secretario' },
                { id: 24, nombre_completo: 'Gabriela Sánchez Ortega', partido: 'PAN', cargo_mesa_directiva: null },
                { id: 13, nombre_completo: 'Ricardo Sánchez Zavala', partido: 'PRI', cargo_mesa_directiva: null },
                { id: 9, nombre_completo: 'María Elena Solano López', partido: 'MC', cargo_mesa_directiva: null },
                { id: 14, nombre_completo: 'Claudia Sotelo Martínez', partido: 'MORENA', cargo_mesa_directiva: null }
            ];
        }
        
        // Cargar diputados
        async function loadDeputies() {
            console.log('=== Iniciando loadDeputies ===');
            console.log('Token disponible:', token ? 'Sí' : 'No');
            
            // Verificar que el grid existe
            const grid = document.getElementById('deputiesGrid');
            if (!grid) {
                console.error('ERROR: No se encuentra el elemento deputiesGrid en el DOM');
                return;
            }
            console.log('Grid encontrado:', grid);
            
            if (!token) {
                console.error('No hay token disponible');
                grid.innerHTML = '<div class="alert alert-danger">Error: No hay token de autenticación</div>';
                return;
            }
            
            try {
                console.log('Haciendo fetch a /api/pase-lista/diputados');
                const response = await fetch('/api/pase-lista/diputados', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Respuesta recibida:', response.status);
                console.log('Respuesta OK:', response.ok);
                
                if (response.ok) {
                    const deputies = await response.json();
                    console.log('Diputados recibidos:', deputies);
                    console.log('Cantidad de diputados:', deputies.length);
                    console.log('Primer diputado:', deputies[0]); // Ver estructura del primer diputado
                    
                    if (!deputies || deputies.length === 0) {
                        console.warn('ADVERTENCIA: La respuesta no contiene diputados');
                        grid.innerHTML = '<div class="alert alert-warning">No se encontraron diputados en la base de datos</div>';
                        
                        // Intentar cargar desde la API alternativa
                        console.log('Intentando cargar desde /api/secretario/diputados');
                        const altResponse = await fetch('/api/secretario/diputados', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (altResponse.ok) {
                            const altDeputies = await altResponse.json();
                            console.log('Diputados desde API alternativa:', altDeputies.length);
                            if (altDeputies.length > 0) {
                                displayDeputies(altDeputies);
                            } else {
                                // Si tampoco hay diputados en la API alternativa, usar lista por defecto
                                console.log('Usando lista de diputados por defecto');
                                const defaultDeputies = obtenerDiputadosPorDefecto();
                                displayDeputies(defaultDeputies);
                            }
                        } else {
                            // Si la API alternativa falla, usar lista por defecto
                            console.log('API alternativa falló, usando lista por defecto');
                            const defaultDeputies = obtenerDiputadosPorDefecto();
                            displayDeputies(defaultDeputies);
                        }
                    } else {
                        displayDeputies(deputies);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Error cargando diputados:', response.status, errorText);
                    console.log('Error en API principal, usando lista por defecto');
                    
                    // Usar lista por defecto cuando falla la API
                    const defaultDeputies = obtenerDiputadosPorDefecto();
                    displayDeputies(defaultDeputies);
                    
                    // Mostrar advertencia pero cargar los diputados
                    mostrarNotificacion('⚠️ Usando lista de diputados por defecto', 'warning', 5000);
                }
            } catch (error) {
                console.error('Error en loadDeputies:', error);
                console.log('Error de conexión, usando lista por defecto');
                
                // Usar lista por defecto cuando hay error de conexión
                const defaultDeputies = obtenerDiputadosPorDefecto();
                displayDeputies(defaultDeputies);
                
                mostrarNotificacion('⚠️ Error de conexión. Usando lista por defecto', 'warning', 5000);
            }
        }
        
        // Mostrar diputados
        function displayDeputies(deputies) {
            console.log('=== displayDeputies llamado con', deputies ? deputies.length : 0, 'diputados ===');
            const grid = document.getElementById('deputiesGrid');
            
            if (!grid) {
                console.error('No se encontró el elemento deputiesGrid');
                return;
            }
            
            grid.innerHTML = '';
            
            // Si no hay diputados, usar lista por defecto
            if (!deputies || deputies.length === 0) {
                console.warn('No hay diputados, usando lista por defecto');
                deputies = obtenerDiputadosPorDefecto();
            }
            
            // Lista ordenada de diputados con sus IDs correctos
            const DIPUTADOS_ORDEN = [
                { apellidos: 'Abarca Peña', id: 18, orden: 1 },
                { apellidos: 'Domínguez Mandujano', id: 12, orden: 2 },
                { apellidos: 'Espinoza López', id: 17, orden: 3 },
                { apellidos: 'Gordillo Vega', id: 6, orden: 4 },
                { apellidos: 'Livera Chavarría', id: 7, orden: 5 },
                { apellidos: 'Martínez Gómez', id: 22, orden: 6 },
                { apellidos: 'Martínez Terrazas', id: 5, orden: 7 },
                { apellidos: 'Maya Rendón', id: 8, orden: 8 },
                { apellidos: 'Montes de Oca', id: 15, orden: 9 },
                { apellidos: 'Pedrero González', id: 21, orden: 10 },
                { apellidos: 'Pimentel Mejía', id: 16, orden: 11 },
                { apellidos: 'Quevedo Maldonado', id: 19, orden: 12 },
                { apellidos: 'Reyes Reyes', id: 10, orden: 13 },
                { apellidos: 'Rodríguez López', id: 23, orden: 14 },
                { apellidos: 'Rodríguez Ruiz', id: 20, orden: 15 },
                { apellidos: 'Ruiz Rodríguez', id: 11, orden: 16 },
                { apellidos: 'Sánchez Ortega', id: 24, orden: 17 },
                { apellidos: 'Sánchez Zavala', id: 13, orden: 18 },
                { apellidos: 'Solano López', id: 9, orden: 19 },
                { apellidos: 'Sotelo Martínez', id: 14, orden: 20 }
            ];
            
            // Función para obtener la información del diputado basado en el nombre
            function getDiputadoInfo(nombreCompleto) {
                for (let diputado of DIPUTADOS_ORDEN) {
                    if (nombreCompleto.includes(diputado.apellidos)) {
                        return diputado;
                    }
                }
                return null;
            }
            
            // Función para obtener el orden basado en el nombre
            function getOrdenIndex(nombreCompleto) {
                const info = getDiputadoInfo(nombreCompleto);
                return info ? info.orden : 999;
            }
            
            // Ordenar diputados según el orden correcto
            const sortedDeputies = [...deputies].sort((a, b) => {
                const ordenA = getOrdenIndex(a.nombre_completo);
                const ordenB = getOrdenIndex(b.nombre_completo);
                return ordenA - ordenB;
            });
            
            sortedDeputies.forEach(deputy => {
                // Obtener el ID correcto del mapeo
                const diputadoInfo = getDiputadoInfo(deputy.nombre_completo);
                const correctId = diputadoInfo ? diputadoInfo.id : deputy.id;
                
                const attendance = attendanceData[correctId] || 'pending';
                const card = document.createElement('div');
                card.className = `deputy-card ${attendance === 'presente' ? 'present' : attendance === 'ausente' ? 'absent' : ''}`;
                
                // Crear el HTML de la foto o placeholder
                let photoHtml = '';
                if (deputy.foto_url) {
                    photoHtml = `<img src="${deputy.foto_url}" class="deputy-photo" alt="${deputy.nombre_completo}">`;
                } else {
                    const partyColor = getPartyColor(deputy.partido);
                    const initials = getInitials(deputy.nombre_completo);
                    photoHtml = `<div class="deputy-photo-placeholder" style="background-color: ${partyColor}">${initials}</div>`;
                }
                
                // Crear el badge del cargo si existe
                let cargoHtml = '';
                if (deputy.cargo_mesa_directiva) {
                    const cargoShort = getCargoShort(deputy.cargo_mesa_directiva);
                    cargoHtml = `<span class="badge bg-warning text-dark ms-1" style="font-size: 0.75em;">${cargoShort}</span>`;
                }
                
                // Crear el HTML de los botones con estados
                const presentClass = attendance === 'presente' ? 'active' : '';
                const absentClass = attendance === 'ausente' ? 'active' : '';
                const justifiedClass = attendance === 'justificado' ? 'active' : '';
                const disabledAttr = isReadonly ? 'disabled' : '';
                
                card.innerHTML = `
                    <div class="deputy-info">
                        <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                            ${photoHtml}
                            <div class="deputy-details" style="flex: 1; min-width: 0;">
                                <div class="deputy-name" title="${deputy.nombre_completo}" style="font-size: 0.92em;">${formatNameLastNameFirst(deputy.nombre_completo)}</div>
                                <div class="deputy-party" style="margin-top: 4px;">
                                    <span class="badge" style="background-color: ${getPartyColor(deputy.partido)}; font-size: 0.75em;">${deputy.partido || 'SP'}</span>
                                    ${cargoHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="attendance-buttons">
                        <button class="btn btn-present ${presentClass}" 
                                onclick="markAttendance(${correctId}, 'presente', this)"
                                ${disabledAttr}>
                            <i class="fas fa-check"></i> <span style="font-size: 0.85em;">PRESENTE</span>
                        </button>
                        <button class="btn btn-absent ${absentClass}" 
                                onclick="markAttendance(${correctId}, 'ausente', this)"
                                ${disabledAttr}>
                            <i class="fas fa-times"></i> <span style="font-size: 0.85em;">INASISTENCIA</span>
                        </button>
                        <button class="btn btn-justified ${justifiedClass}" 
                                onclick="markAttendance(${correctId}, 'justificado', this)"
                                ${disabledAttr}>
                            <i class="fas fa-exclamation-triangle"></i> <span style="font-size: 0.85em;">JUSTIFICADO</span>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            updateStats();
        }
        
        // Variable para controlar si ya se activó la pantalla
        let pantallaActivada = false;
        
        // Función para activar la pantalla de pase de lista
        async function activarPantallaPaseLista() {
            try {
                const response = await fetch('/api/pase-lista/activar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Pantalla de pase de lista activada:', data);
                    
                    // Emitir evento para activar pantalla pública
                    socket.emit('pase-lista-activado', {
                        activo: true,
                        sesion_id: data.sesion_id
                    });
                    
                    // Mostrar notificación de éxito
                    mostrarNotificacion('✅ Pantalla de asistencia activada', 'success');
                } else {
                    console.error('Error activando pantalla:', await response.json());
                }
            } catch (error) {
                console.error('Error activando pantalla de pase de lista:', error);
            }
        }
        
        // Sistema mejorado de notificaciones con desplazamiento
        let notificacionesActivas = [];
        
        function mostrarNotificacion(mensaje, tipo = 'info', duracion = 3000) {
            // Crear elemento de notificación
            const notificacion = document.createElement('div');
            notificacion.className = `alert alert-${tipo} position-fixed start-50 translate-middle-x shadow-lg`;
            notificacion.style.cssText = `
                z-index: 9999;
                min-width: 300px;
                max-width: 500px;
                transition: all 0.3s ease;
                animation: slideIn 0.3s ease;
            `;
            notificacion.innerHTML = `
                <div class="d-flex align-items-center">
                    <span class="flex-grow-1">${mensaje}</span>
                    <button type="button" class="btn-close btn-sm ms-2" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            // Calcular posición basada en notificaciones existentes
            const alturaNotificacion = 60;
            const espacioEntre = 10;
            const topInicial = 20;
            
            // Desplazar notificaciones existentes hacia abajo
            notificacionesActivas.forEach((notif, index) => {
                if (notif && notif.parentNode) {
                    notif.style.top = `${topInicial + (index + 1) * (alturaNotificacion + espacioEntre)}px`;
                }
            });
            
            // Posicionar nueva notificación arriba
            notificacion.style.top = `${topInicial}px`;
            
            // Agregar al DOM y al array de notificaciones activas
            document.body.appendChild(notificacion);
            notificacionesActivas.unshift(notificacion);
            
            // Remover después del tiempo especificado
            setTimeout(() => {
                notificacion.style.opacity = '0';
                setTimeout(() => {
                    const index = notificacionesActivas.indexOf(notificacion);
                    if (index > -1) {
                        notificacionesActivas.splice(index, 1);
                    }
                    notificacion.remove();
                    
                    // Reposicionar notificaciones restantes
                    notificacionesActivas.forEach((notif, idx) => {
                        if (notif && notif.parentNode) {
                            notif.style.top = `${topInicial + idx * (alturaNotificacion + espacioEntre)}px`;
                        }
                    });
                }, 300);
            }, duracion);
        }
        
        // Marcar asistencia
        async function markAttendance(deputyId, status, buttonElement) {
            if (isReadonly) return;
            
            // Feedback visual inmediato
            if (buttonElement) {
                const card = buttonElement.closest('.deputy-card');
                const buttons = card.querySelectorAll('.attendance-buttons button');
                
                // Remover active de todos los botones
                buttons.forEach(btn => btn.classList.remove('active'));
                
                // Agregar active al botón clickeado
                buttonElement.classList.add('active');
                
                // Actualizar la tarjeta visualmente
                card.classList.remove('present', 'absent', 'justified');
                if (status === 'presente') {
                    card.classList.add('present');
                } else if (status === 'ausente') {
                    card.classList.add('absent');
                } else if (status === 'justificado') {
                    card.classList.add('justified');
                }
            }
            
            try {
                const response = await fetch('/api/pase-lista/marcar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        diputado_id: deputyId,
                        asistencia: status
                    })
                });
                
                if (response.ok) {
                    attendanceData[deputyId] = status;
                    
                    // Emitir evento socket para actualizar pantalla en tiempo real
                    socket.emit('asistencia-marcada', {
                        diputado_id: deputyId,
                        asistencia: status,
                        estado: status
                    });
                    
                    loadDeputies(); // Recargar para actualizar vista
                } else {
                    const error = await response.json();
                    console.error('Error del servidor:', error);
                    
                    // Mostrar mensaje específico para sesión no activa
                    if (error.error === 'Sesión no activa') {
                        mostrarNotificacion('⚠️ ' + (error.message || 'Esperando a ser activada por el Presidente de la Mesa Directiva'), 'warning');
                    } else {
                        mostrarNotificacion('❌ Error al marcar asistencia: ' + (error.error || 'Error desconocido'), 'danger');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('❌ Error al marcar asistencia', 'danger');
            }
        }
        
        // Confirmar pase de lista (guardar estado actual pero mantener editable)
        async function confirmAttendance() {
            if (isReadonly) return;
            
            // Deshabilitar botón temporalmente para evitar doble click
            const confirmBtn = document.getElementById('confirmBtn');
            if (confirmBtn) {
                confirmBtn.disabled = true;
            }
            
            try {
                const response = await fetch('/api/pase-lista/confirmar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Mostrar alerta de éxito con resumen
                    const mensaje = `✅ PASE DE LISTA CONFIRMADO\n\n` +
                                  `📊 Resumen:\n` +
                                  `• Presentes: ${data.presentes || 0}\n` +
                                  `• Inasistencias: ${data.ausentes || 0}\n` +
                                  `• Total: ${(data.presentes || 0) + (data.ausentes || 0)} diputados\n\n` +
                                  `Regresando al panel de diputado...`;
                    
                    alert(mensaje);
                    
                    // Actualizar estado en la página
                    document.getElementById('attendanceStatus').textContent = 'Confirmado ✓';
                    
                    // Mostrar notificación adicional
                    mostrarNotificacion('✅ Pase de lista guardado exitosamente', 'success');
                    
                    // Redirigir al panel del diputado después de 2 segundos
                    setTimeout(() => {
                        window.location.href = '/diputado';
                    }, 2000);
                    
                } else {
                    mostrarNotificacion('❌ Error al confirmar pase de lista', 'danger');
                    alert('Error al confirmar el pase de lista. Por favor, intente nuevamente.');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('❌ Error al confirmar', 'danger');
            } finally {
                // Rehabilitar botón
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                }
            }
        }
        
        // Mostrar en pantalla
        async function showOnScreen() {
            try {
                const response = await fetch('/api/pase-lista/mostrar-pantalla', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    mostrarNotificacion('📺 Pase de lista visible en pantalla', 'success');
                } else {
                    mostrarNotificacion('❌ Error al mostrar en pantalla', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('❌ Error al mostrar en pantalla', 'danger');
            }
        }
        
        // Función para mostrar modal de opciones de reinicio
        function reiniciarPaseLista() {
            // Crear modal si no existe
            let modal = document.getElementById('modalReinicioOpciones');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'modalReinicioOpciones';
                modal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="fas fa-redo"></i> Opciones de Reinicio
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p class="mb-4">Seleccione el tipo de reinicio que desea realizar:</p>
                                
                                <div class="d-grid gap-3">
                                    <!-- Reinicio Suave -->
                                    <button class="btn btn-outline-warning btn-lg text-start p-3" onclick="ejecutarReinicio('suave')">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-sync-alt fa-2x me-3 mt-1" style="color: #ffc107;"></i>
                                            <div>
                                                <h6 class="mb-1">Reinicio Parcial</h6>
                                                <small class="text-muted">
                                                    • Mantiene a los diputados PRESENTES<br>
                                                    • Solo resetea AUSENTES y SIN MARCAR<br>
                                                    • Los presentes conservan su derecho a votar
                                                </small>
                                            </div>
                                        </div>
                                    </button>
                                    
                                    <!-- Reinicio Duro -->
                                    <button class="btn btn-outline-danger btn-lg text-start p-3" onclick="ejecutarReinicio('duro')">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-trash-alt fa-2x me-3 mt-1" style="color: #dc3545;"></i>
                                            <div>
                                                <h6 class="mb-1">Reinicio Total</h6>
                                                <small class="text-muted">
                                                    • Borra TODAS las asistencias<br>
                                                    • TODOS pierden derecho a votar<br>
                                                    • Requiere validación manual completa
                                                </small>
                                            </div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Mostrar el modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // Función para ejecutar el reinicio según el tipo
        async function ejecutarReinicio(tipo) {
            // Cerrar el modal
            const modal = document.getElementById('modalReinicioOpciones');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) bsModal.hide();
            }
            
            // Confirmar la acción
            const mensaje = tipo === 'suave' 
                ? '¿Confirma el reinicio parcial?\n\nSe mantendrán los diputados presentes y solo se resetearán los ausentes.'
                : '¿Confirma el reinicio total?\n\nSe borrarán TODAS las asistencias y los diputados perderán el derecho a votar.';
            
            if (!confirm(mensaje)) {
                return;
            }
            
            try {
                const response = await fetch('/api/pase-lista/reiniciar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tipo_reinicio: tipo
                    })
                });
                
                const data = await response.json();
                console.log('Respuesta del servidor:', data);
                
                // Verificar si el reinicio fue exitoso (aunque el status no sea 200)
                if (response.ok || data.success || data.mensaje?.includes('reiniciado')) {
                    console.log('Pase de lista reiniciado exitosamente');
                    
                    // Limpiar datos locales
                    attendanceData = {};
                    
                    // Recargar diputados
                    await loadDeputies();
                    
                    // Actualizar estado
                    document.getElementById('attendanceStatus').textContent = 'Reiniciado - Sin iniciar';
                    
                    // Emitir evento para actualizar pantalla pública
                    socket.emit('pase-lista-reiniciado', {
                        sesion_id: currentSessionId,
                        mensaje: 'Pase de lista reiniciado'
                    });
                    
                    // Mostrar notificación de éxito
                    mostrarNotificacion('✅ Pase de lista reiniciado correctamente', 'success');
                } else if (data.error) {
                    // Solo mostrar error si realmente hay un problema
                    console.error('Error al reiniciar:', data.error);
                    alert('Error al reiniciar: ' + data.error);
                } else {
                    // Si no hay error pero tampoco éxito claro, asumir que funcionó
                    console.log('Reinicio completado (sin confirmación explícita)');
                    attendanceData = {};
                    await loadDeputies();
                    mostrarNotificacion('✅ Pase de lista reiniciado', 'success');
                }
            } catch (error) {
                console.error('Error procesando respuesta:', error);
                // Incluso si hay error al procesar, intentar recargar
                attendanceData = {};
                await loadDeputies();
                mostrarNotificacion('⚠️ Pase de lista reiniciado (verificar estado)', 'warning');
            }
        }
        
        // Función anterior (mantener por compatibilidad pero sin usar)
        async function finalizeAttendance() {
            // Ya no se usa, ahora es confirmAttendance
            confirmAttendance();
        }
        
        async function rectifyAttendance() {
            // Ya no es necesario, siempre es editable
            return;
            
            try {
                const response = await fetch('/api/pase-lista/finalizar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                // Esta parte ya no se ejecuta con la nueva lógica
                if (response.ok) {
                    // Mantener por compatibilidad
                } else {
                    alert('Error en el proceso');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al finalizar');
            }
        }
        
        // Función auxiliar para obtener el nombre del diputado por ID
        function obtenerNombreDiputado(diputadoId) {
            // Buscar el nombre en las tarjetas del grid
            const cards = document.querySelectorAll('.deputy-card');
            for (let card of cards) {
                const buttons = card.querySelectorAll('.attendance-buttons button');
                for (let btn of buttons) {
                    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`markAttendance(${diputadoId},`)) {
                        const nameElement = card.querySelector('.deputy-name');
                        if (nameElement) {
                            return nameElement.textContent.trim();
                        }
                        break;
                    }
                }
            }
            return `Diputado ${diputadoId}`;
        }
        
        // Función para actualizar un diputado en el grid
        function actualizarDiputadoEnGrid(diputadoId, estado) {
            // Buscar la tarjeta del diputado
            const cards = document.querySelectorAll('.deputy-card');
            
            cards.forEach(card => {
                const buttons = card.querySelectorAll('.attendance-buttons button');
                buttons.forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes(`markAttendance(${diputadoId}`)) {
                        // Actualizar estado visual de la tarjeta
                        card.classList.remove('present', 'absent', 'justified');
                        
                        // Remover estado activo de todos los botones
                        const allButtons = card.querySelectorAll('.attendance-buttons button');
                        allButtons.forEach(b => b.classList.remove('active'));
                        
                        // Activar el botón correspondiente y actualizar la tarjeta
                        if (estado === 'presente') {
                            card.classList.add('present');
                            const presentBtn = card.querySelector('.btn-present');
                            if (presentBtn) presentBtn.classList.add('active');
                        } else if (estado === 'ausente') {
                            card.classList.add('absent');
                            const absentBtn = card.querySelector('.btn-absent');
                            if (absentBtn) absentBtn.classList.add('active');
                        } else if (estado === 'justificado') {
                            card.classList.add('justified');
                            const justifiedBtn = card.querySelector('.btn-justified');
                            if (justifiedBtn) justifiedBtn.classList.add('active');
                        }
                        
                        // Agregar efecto visual de actualización
                        card.style.animation = 'pulseOnce 0.6s ease';
                        setTimeout(() => {
                            card.style.animation = '';
                        }, 600);
                        
                        return;
                    }
                });
            });
        }
        
        // Actualizar estadísticas
        function updateStats() {
            const present = Object.values(attendanceData).filter(a => a === 'presente').length;
            const absent = Object.values(attendanceData).filter(a => a === 'ausente').length;
            const justified = Object.values(attendanceData).filter(a => a === 'justificado').length;
            
            document.getElementById('presentCount').textContent = present;
            document.getElementById('absentCount').textContent = absent;
            
            // Si existe el contador de justificados, actualizarlo
            const justifiedCount = document.getElementById('justifiedCount');
            if (justifiedCount) {
                justifiedCount.textContent = justified;
            }
        }
        
        // Función para actualizar un botón específico de diputado
        function updateDeputyButton(button, status) {
            // Remover todas las clases de estado
            button.classList.remove('btn-success', 'btn-danger', 'btn-outline-secondary');
            
            // Aplicar la clase según el estado
            if (status === 'presente') {
                button.classList.add('btn-success');
                const icon = button.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-check-circle';
                }
                const statusText = button.querySelector('small');
                if (statusText) {
                    statusText.textContent = 'PRESENTE';
                }
            } else if (status === 'ausente') {
                button.classList.add('btn-danger');
                const icon = button.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-times-circle';
                }
                const statusText = button.querySelector('small');
                if (statusText) {
                    statusText.textContent = 'AUSENTE';
                }
            } else {
                button.classList.add('btn-outline-secondary');
                const icon = button.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-user';
                }
                const statusText = button.querySelector('small');
                if (statusText) {
                    statusText.textContent = 'SIN MARCAR';
                }
            }
        }
        
        // Cargar estado actual
        async function loadCurrentAttendance() {
            try {
                const response = await fetch('/api/pase-lista/actual', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.pase_lista) {
                        // Convertir el objeto de asistencias al formato esperado
                        const asistenciasTemp = data.asistencias || {};
                        attendanceData = {};
                        
                        // Extraer solo el estado de cada asistencia
                        Object.keys(asistenciasTemp).forEach(diputadoId => {
                            const asistencia = asistenciasTemp[diputadoId];
                            // Si es un objeto, tomar el estado; si es string, usarlo directamente
                            if (typeof asistencia === 'object' && asistencia !== null) {
                                attendanceData[diputadoId] = asistencia.estado || 'pending';
                            } else {
                                attendanceData[diputadoId] = asistencia || 'pending';
                            }
                        });
                        
                        // Si ya hay un pase de lista, asegurar que esté activado
                        if (!pantallaActivada) {
                            pantallaActivada = true;
                            // Emitir evento para asegurar que la pantalla esté activada
                            socket.emit('pase-lista-activado', {
                                activo: true,
                                sesion_id: data.pase_lista.sesion_id
                            });
                        }
                        
                        // Siempre mantener editable durante la sesión activa
                        if (data.sesion_activa) {
                            if (user.cargo_mesa_directiva === 'secretario1' || 
                                user.cargo_mesa_directiva === 'secretario2' ||
                                user.role === 'secretario') {
                                // Pueden editar
                                isReadonly = false;
                                document.body.classList.remove('readonly-mode');
                                document.getElementById('attendanceStatus').textContent = data.pase_lista.confirmado ? 'Confirmado - Editable' : 'En proceso';
                            } else {
                                // Solo lectura para otros
                                isReadonly = true;
                                document.body.classList.add('readonly-mode');
                                document.getElementById('readonlyBadge').style.display = 'inline-block';
                                document.getElementById('attendanceStatus').textContent = data.pase_lista.confirmado ? 'Confirmado' : 'En proceso';
                            }
                        } else {
                            // Sin sesión activa, solo lectura
                            isReadonly = true;
                            document.body.classList.add('readonly-mode');
                            document.getElementById('attendanceStatus').textContent = 'Sesión no activa';
                        }
                    }
                    loadDeputies();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Utilidades
        function getPartyColor(party) {
            const colors = {
                'MORENA': '#8B1B1B',
                'PAN': '#1B4788',
                'PRI': '#CD1C22',
                'PT': '#E31E24',
                'PVEM': '#00A550',
                'MC': '#FF6B00',
                'NUEVA ALIANZA': '#00B8B2'
            };
            return colors[party] || '#6c757d';
        }
        
        function getCargo(cargo) {
            const cargos = {
                'presidente': 'Presidente',
                'vicepresidente': 'Vicepresidente',
                'secretario1': 'Secretario 1',
                'secretario2': 'Secretario 2'
            };
            return cargos[cargo] || cargo;
        }
        
        function getCargoShort(cargo) {
            const cargos = {
                'presidente': 'Pdte',
                'vicepresidente': 'VPdte',
                'secretario1': 'Sec1',
                'secretario2': 'Sec2'
            };
            return cargos[cargo] || cargo;
        }
        
        function getInitials(name) {
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return parts[0].charAt(0) + parts[1].charAt(0);
            }
            return name.substring(0, 2).toUpperCase();
        }
        
        function getShortName(name) {
            // Retornar el nombre completo sin modificar
            return name;
        }
        
        function formatNameLastNameFirst(name) {
            // Mapeo específico de nombres para formato correcto sin comas
            const ORDEN_DIPUTADOS = {
                'Gerardo Abarca Peña': 'Abarca Peña Gerardo',
                'Alfredo Domínguez Mandujano': 'Domínguez Mandujano Alfredo',
                'Brenda Espinoza López': 'Espinoza López Brenda',
                'Andrea Valentina Guadalupe Gordillo Vega': 'Gordillo Vega Andrea Valentina Guadalupe',
                'Sergio Omar Livera Chavarría': 'Livera Chavarría Sergio Omar',
                'Gonzala Eleonor Martínez Gómez': 'Martínez Gómez Gonzala Eleonor',
                'Óscar Daniel Martínez Terrazas': 'Martínez Terrazas Óscar Daniel',
                'Guillermina Maya Rendón': 'Maya Rendón Guillermina',
                'Martha Melissa Montes de Oca Montoya': 'Montes de Oca Montoya Martha Melissa',
                'Luis Eduardo Pedrero González': 'Pedrero González Luis Eduardo',
                'Isaac Pimentel Mejía': 'Pimentel Mejía Isaac',
                'Luz Dary Quevedo Maldonado': 'Quevedo Maldonado Luz Dary',
                'Rafael Reyes Reyes': 'Reyes Reyes Rafael',
                'Ruth Cleotilde Rodríguez López': 'Rodríguez López Ruth Cleotilde',
                'Tania Valentina Rodríguez Ruiz': 'Rodríguez Ruiz Tania Valentina',
                'Nayla Carolina Ruíz Rodríguez': 'Ruíz Rodríguez Nayla Carolina',
                'Alberto Sánchez Ortega': 'Sánchez Ortega Alberto',
                'Francisco Erik Sánchez Zavala': 'Sánchez Zavala Francisco Erik',
                'Jazmín Juana Solano López': 'Solano López Jazmín Juana',
                'Alfonso de Jesús Sotelo Martínez': 'Sotelo Martínez Alfonso de Jesús'
            };
            
            return ORDEN_DIPUTADOS[name] || name;
        }
        
        function goBack() {
            if (user.role === 'diputado') {
                window.location.href = '/diputado';
            } else if (user.role === 'secretario') {
                window.location.href = '/secretario';
            } else if (user.role === 'superadmin') {
                window.location.href = '/superadmin';
            } else {
                window.location.href = '/';
            }
        }
        
        // Eventos de socket
        socket.on('asistencia-marcada', (data) => {
            console.log('Asistencia marcada:', data);
            attendanceData[data.diputado_id] = data.asistencia;
            
            // Actualizar el grid visual del diputado
            actualizarDiputadoEnGrid(data.diputado_id, data.asistencia);
            
            // Mostrar notificación según el tipo de registro
            const nombreDiputado = data.nombre_diputado || obtenerNombreDiputado(data.diputado_id);
            
            if (data.auto_registro) {
                // Auto-registro del diputado
                let mensaje = '';
                let tipo = 'info';
                
                if (data.llegada_tardia) {
                    mensaje = `🕑 ${nombreDiputado} - Asistencia con retardo`;
                    tipo = 'warning';
                } else if (data.asistencia === 'presente') {
                    mensaje = `✅ ${nombreDiputado} - Confirmó asistencia`;
                    tipo = 'success';
                } else if (data.asistencia === 'ausente') {
                    mensaje = `❌ ${nombreDiputado} - Ausente`;
                    tipo = 'danger';
                }
                
                if (mensaje) {
                    mostrarNotificacion(mensaje, tipo, 5000);
                }
            } else if (data.marcado_por === 'secretario') {
                // Marcado manualmente por secretario
                let mensaje = '';
                let tipo = 'info';
                
                if (data.asistencia === 'presente') {
                    mensaje = `✅ ${nombreDiputado} - Marcado presente`;
                    tipo = 'success';
                } else if (data.asistencia === 'ausente') {
                    mensaje = `❌ ${nombreDiputado} - Marcado ausente`;
                    tipo = 'danger';
                } else if (data.asistencia === 'justificado') {
                    mensaje = `📄 ${nombreDiputado} - Inasistencia justificada`;
                    tipo = 'warning';
                }
                
                if (mensaje && data.llegada_tardia) {
                    mensaje = `🕑 ${nombreDiputado} - Asistencia con retardo (marcado por secretario)`;
                    tipo = 'warning';
                }
                
                if (mensaje) {
                    mostrarNotificacion(mensaje, tipo, 4000);
                }
            }
            
            updateStats();
        });
        
        // Escuchar cuando un diputado confirma su propia asistencia
        socket.on('asistencia-confirmada', (data) => {
            console.log('Diputado confirmó asistencia:', data);
            
            // Marcar como presente
            attendanceData[data.diputado_id] = 'presente';
            
            // Actualizar el grid visual
            actualizarDiputadoEnGrid(data.diputado_id, 'presente');
            
            // Mostrar notificación
            const nombreDiputado = obtenerNombreDiputado(data.diputado_id);
            mostrarNotificacion(`✅ ${nombreDiputado} confirmó asistencia`, 'success', 4000);
            
            updateStats();
            
            // Mostrar notificación
            showNotification('success', `✅ ${data.nombre} confirmó su asistencia`);
        });
        
        socket.on('pase-lista-confirmado', () => {
            document.getElementById('attendanceStatus').textContent = 'Confirmado - Editable';
            // NO bloquear edición
        });
        
        // Escuchar cuando se reinicia el pase de lista
        socket.on('pase-lista-reiniciado', (data) => {
            console.log('Pase de lista reiniciado:', data);
            
            // Limpiar todas las asistencias
            attendanceData = {};
            
            // Recargar la vista
            loadDeputies();
            updateStats();
            
            // Mostrar notificación
            showNotification('warning', `🔄 ${data.mensaje}`);
        });
        
        // Escuchar cuando se reabre el pase de lista
        socket.on('pase-lista-reabierto', (data) => {
            console.log('Pase de lista reabierto:', data);
            
            // Mostrar notificación
            showNotification('info', `📋 ${data.mensaje}`);
            
            // Recargar para obtener el estado actual
            loadCurrentAttendance();
        });
        
        socket.on('pase-lista-en-pantalla', (data) => {
            if (data.visible) {
                console.log('Pase de lista visible en pantalla');
            }
        });
        
        // Función para activar la pantalla al cargar la página
        async function activarPantallaAlCargar() {
            // Solo activar si el usuario tiene permisos
            if (user.cargo_mesa_directiva === 'secretario1' || 
                user.cargo_mesa_directiva === 'secretario2' ||
                user.role === 'secretario') {
                
                console.log('Activando pantalla de pase de lista al cargar...');
                
                // Esperar un momento para asegurar que todo esté cargado
                setTimeout(async () => {
                    if (!pantallaActivada) {
                        await activarPantallaPaseLista();
                        pantallaActivada = true;
                    }
                }, 500);
            }
        }
        
        // Función para habilitar auto-asistencia
        let autoAsistenciaHabilitada = false;
        async function habilitarAutoAsistencia() {
            if (autoAsistenciaHabilitada) {
                alert('La auto-asistencia ya está habilitada');
                return;
            }
            
            try {
                const response = await fetch('/api/pase-lista/habilitar-auto-asistencia', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        iniciado_por: user.id,
                        tipo_usuario: user.role === 'secretario' ? 'secretario_legislativo' : 
                                     user.cargo_mesa_directiva
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    autoAsistenciaHabilitada = true;
                    
                    // Cambiar botón a estado deshabilitado
                    const btnHabilitar = document.getElementById('enableAutoBtn');
                    if (btnHabilitar) {
                        btnHabilitar.classList.remove('btn-primary');
                        btnHabilitar.classList.add('btn-secondary');
                        btnHabilitar.innerHTML = '<i class="fas fa-check-circle"></i> Auto-Asistencia Habilitada';
                        btnHabilitar.disabled = true;
                    }
                    
                    // Emitir evento por socket
                    socket.emit('auto-asistencia-habilitada', {
                        iniciado_por: user.id,
                        nombre_iniciador: user.nombre_completo,
                        tipo_usuario: user.role === 'secretario' ? 'secretario_legislativo' : 
                                     user.cargo_mesa_directiva
                    });
                    
                    showNotification('success', 'Auto-Asistencia habilitada correctamente');
                } else {
                    const error = await response.json();
                    showNotification('error', error.message || 'Error al habilitar auto-asistencia');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('error', 'Error al conectar con el servidor');
            }
        }
        
        // Función auxiliar para mostrar notificaciones
        function showNotification(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 70px; right: 20px; z-index: 10000; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }
        
        // Verificar si el usuario actual puede confirmar el pase de lista
        async function verificarPermisoConfirmacion() {
            try {
                const response = await fetch('/api/diputado/sesion/estado-auto-asistencia', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const btnConfirmar = document.getElementById('confirmBtn');
                    
                    if (data.auto_asistencia_habilitada) {
                        // Si se habilitó auto-asistencia, verificar quién puede confirmar
                        if (data.auto_asistencia_tipo_usuario === 'secretario_legislativo') {
                            // Solo el secretario legislativo puede confirmar
                            if (user.role !== 'secretario') {
                                btnConfirmar.style.display = 'none';
                            }
                        } else if (data.auto_asistencia_tipo_usuario === 'secretario1' || 
                                   data.auto_asistencia_tipo_usuario === 'secretario2') {
                            // Solo el secretario que habilitó puede confirmar
                            if (data.auto_asistencia_iniciada_por !== user.id) {
                                btnConfirmar.style.display = 'none';
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error verificando permisos de confirmación:', error);
            }
        }
        
        // Inicializar
        async function inicializar() {
            console.log('=== INICIANDO PASE-LISTA ===');
            
            // Verificar que tenemos token antes de continuar
            if (!token) {
                console.error('No hay token, redirigiendo al login');
                window.location.href = '/';
                return;
            }
            
            console.log('Token encontrado, iniciando funciones...');
            
            try {
                // Esperar a que checkPermissions termine
                const permisosConcedidos = await checkPermissions();
                console.log('checkPermissions result:', permisosConcedidos);
                
                if (permisosConcedidos === false) {
                    console.log('Permisos denegados, deteniendo inicialización');
                    return;
                }
                
                loadCurrentAttendance();
                console.log('loadCurrentAttendance completado');
                
                await loadDeputies();  // Cargar el grid de diputados
                console.log('loadDeputies completado');
                
                activarPantallaAlCargar();
                console.log('activarPantallaAlCargar completado');
                
                verificarPermisoConfirmacion();
                console.log('verificarPermisoConfirmacion completado');
            } catch (error) {
                console.error('Error durante la inicialización:', error);
            }
        }
        
        // Llamar a la función de inicialización
        inicializar();
    </script>
    
    <script src="/js/theme-switcher.js"></script>
    <script>
        // Cargar tema guardado al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        });
    </script>
</body>
</html>