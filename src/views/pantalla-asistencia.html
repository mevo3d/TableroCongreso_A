<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Asistencia - Congreso del Estado de Morelos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Verdana&display=swap');
        
        body {
            background: #2c2c2c;
            color: white;
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
        }
        
        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Contenedor principal */
        .content-wrapper-full {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #2c2c2c;
        }
        
        /* Lista de diputados - estilo similar a voting-table-container-full */
        .attendance-table-container-full {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
        }
        
        .attendance-columns-wrapper {
            display: flex;
            gap: 30px;
            justify-content: center;
            min-height: 100%;
        }
        
        /* Columnas de votaci√≥n */
        .voting-column {
            width: 480px;
        }
        
        .voting-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .voting-table tr {
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
        }
        
        .voting-table tr:nth-child(even) {
            background-color: #333;
        }
        
        .voting-table tr:nth-child(odd) {
            background-color: #2a2a2a;
        }
        
        .voting-table td {
            padding: 3px 8px; /* Reducido padding vertical de 8px a 6px */
        }
        
        /* Columna de partido con icono */
        .party-logo {
            width: 45px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .party-icon {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
            margin: 0 auto;
            color: white;
        }
        
        /* Colores de partidos seg√∫n pantalla de votaci√≥n */
        .party-morena .party-icon { 
            background-color: #8B1B1B;
            font-size: 16px;
        }
        .party-pan .party-icon { 
            background-color: #1B4788;
        }
        .party-mc .party-icon { 
            background-color: #FF6B00;
        }
        .party-pt .party-icon { 
            background-color: #E31E24;
            font-size: 24px;
        }
        .party-pvem .party-icon { 
            background-color: #00A550;
        }
        .party-pri .party-icon { 
            background-color: #CD1C22;
        }
        .party-nueva-alianza .party-icon { 
            background-color: #00B8B2;
        }
        
        /* Nombre del diputado */
        .deputy-name {
            color: white;
            font-family: 'Verdana', sans-serif;
            font-size: 0.80em; /* 30% m√°s peque√±o */
            padding-left: 5px;
            padding-right: 20px; /* Aumentado de 15px a 30px */
            font-weight: bold;
            line-height: 1.3;
            max-height: 2.6em;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 300px; /* Aumentado de 260px a 280px */
            max-width: 310px; /* Aumentado de 260px a 280px */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            flex: 1;
        }
        
        /* Columnas de estado de asistencia */
        .attendance-status {
            width: 100px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 0 10px;
            flex-shrink: 0;
        }
        
        /* Bot√≥n de asistencia */
        .attendance-btn {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.72em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: white;
            min-width: 110px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* Estado por defecto - sin marcar */
        .attendance-default {
            background-color: #4a4a4a;
            border: 1px solid #666;
            opacity: 0.5;
        }
        
        /* Presente */
        .attendance-present {
            background-color: #28A745 !important;
            border: 1px solid #1e7e34 !important;
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.4) !important;
            opacity: 1 !important;
        }
        
        /* Inasistencia */
        .attendance-absent {
            background-color: #DC3545 !important;
            border: 1px solid #bd2130 !important;
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4) !important;
            opacity: 1 !important;
        }
        
        /* Justificado */
        .attendance-justified {
            background-color: #FFC107 !important;
            border: 1px solid #e0a800 !important;
            box-shadow: 0 2px 6px rgba(255, 193, 7, 0.4) !important;
            color: #000 !important;
            opacity: 1 !important;
        }
        
        /* Estad√≠sticas en la parte inferior */
        .results-bottom {
            background: #1a1a1a;
            padding: 10px;
            border-top: 2px solid #444;
            min-height: auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .results-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .logo-left, .logo-right {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100px;
        }
        
        .logo-left img, .logo-right img {
            max-height: 40px;
            max-width: 90px;
            object-fit: contain;
        }
        
        .results-container {
            display: flex;
            justify-content: center;
            gap: 60px;
            align-items: center;
            flex: 1;
        }
        
        .result-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
        }
        
        .result-label {
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .result-circle {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .result-circle-present {
            background-color: #28A745;
        }
        
        .result-circle-absent {
            background-color: #DC3545;
        }
        
        .result-circle-justified {
            background-color: #FFC107;
        }
        
        .result-circle-pending {
            background-color: #FFC107;
        }
        
        .result-number {
            font-size: 1em;
            min-width: 30px;
            text-align: right;
        }
        
        /* Indicador de qu√≥rum */
        .quorum-indicator {
            margin-top: 5px;
            text-align: center;
            padding: 6px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1em;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .quorum-yes {
            background: linear-gradient(135deg, #28A745, #20c947);
            color: white;
            box-shadow: 0 2px 10px rgba(40, 167, 69, 0.4);
        }
        
        .quorum-no {
            background: linear-gradient(135deg, #DC3545, #ff4757);
            color: white;
            box-shadow: 0 2px 10px rgba(220, 53, 69, 0.4);
        }
        
        .quorum-text {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .quorum-text i {
            font-size: 1.2em;
        }
        
        /* Animaci√≥n para nuevas asistencias */
        @keyframes attendanceAnimation {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .attendance-animated {
            animation: attendanceAnimation 0.4s ease-out;
        }
        
        /* Scrollbar personalizada */
        .attendance-table-container-full::-webkit-scrollbar {
            width: 8px;
        }
        
        .attendance-table-container-full::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        .attendance-table-container-full::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 4px;
        }
        
        .attendance-table-container-full::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        
        /* Pantalla de sin actividad mejorada */
        .no-attendance {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
            padding: 20px;
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 50px;
            margin-bottom: 40px;
        }
        
        .logo-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .logo-item img {
            width: 200px;
            height: 200px;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .system-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 2.5em;
            color: white;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-top: 20px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .status-message {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2em;
            color: #aaa;
            margin-top: 20px;
            text-align: center;
        }
        
        /* Modos para streaming con vMix/OBS */
        
        /* Fondo transparente real para vMix */
        body.transparent-bg {
            background: rgba(0, 0, 0, 0) !important;
        }
        
        body.transparent-bg .main-container,
        body.transparent-bg .content-wrapper-full,
        body.transparent-bg .attendance-table-container-full {
            background: rgba(0, 0, 0, 0) !important;
            box-shadow: none !important;
        }
        
        body.transparent-bg .attendance-column {
            background: rgba(51, 51, 51, 0.9) !important;
        }
        
        /* Modo chromakey - Verde puro para key */
        body.chromakey-mode {
            background: #00ff00 !important;
        }
        
        body.chromakey-mode.chromakey-blue {
            background: #0000ff !important;
        }
        
        body.chromakey-mode .main-container,
        body.chromakey-mode .content-wrapper-full,
        body.chromakey-mode .attendance-table-container-full {
            background: #00ff00 !important;
            box-shadow: none !important;
        }
        
        body.chromakey-mode.chromakey-blue .main-container,
        body.chromakey-mode.chromakey-blue .content-wrapper-full,
        body.chromakey-mode.chromakey-blue .attendance-table-container-full {
            background: #0000ff !important;
            box-shadow: none !important;
        }
        
        /* Modo minimalista - sin header ni logos */
        body.minimal-mode .header-section {
            display: none !important;
        }
        
        body.minimal-mode .attendance-table-container-full {
            padding-top: 30px;
        }
    </style>
    <link rel="stylesheet" href="/css/global-background.css">
</head>
<body>
    <div class="main-container">
        <div class="content-wrapper-full">
            <!-- Lista de diputados -->
            <div class="attendance-table-container-full" id="attendanceContainer">
                <div id="deputiesContent">
                    <div class="no-attendance">
                        <i class="fas fa-clock"></i>
                        <h2>Esperando activaci√≥n del pase de lista</h2>
                        <p>El pase de lista ser√° iniciado por el Secretario Legislativo</p>
                    </div>
                </div>
            </div>
            
            <!-- Estad√≠sticas en la parte inferior con logos -->
            <div class="results-bottom" id="statsContainer" style="display: none;">
                <div class="results-wrapper">
                    <div class="logo-left" id="logoLeft">
                        <img src="/uploads/logo-congreso.png" alt="Logo Congreso" onerror="this.style.display='none'">
                    </div>
                    <div class="results-container">
                        <div class="result-item">
                            <span class="result-label">PRESENTES</span>
                            <span class="result-circle result-circle-present"></span>
                            <span class="result-number" id="presentCount">00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">INASISTENCIAS</span>
                            <span class="result-circle result-circle-absent"></span>
                            <span class="result-number" id="absentCount">00</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">JUSTIFICADOS</span>
                            <span class="result-circle result-circle-justified"></span>
                            <span class="result-number" id="justifiedCount">00</span>
                        </div>
                    </div>
                    <div class="logo-right" id="logoRight">
                        <img src="/uploads/logo-secundario.png" alt="Logo Secundario" onerror="this.style.display='none'">
                    </div>
                </div>
                <!-- Indicador de Qu√≥rum -->
                <div class="quorum-indicator" id="quorumIndicator" style="display: none;">
                    <span class="quorum-text">
                        <i class="fas fa-check-circle"></i>
                        <span id="quorumText">VERIFICANDO QU√ìRUM...</span>
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        // Verificar conexi√≥n socket
        socket.on('connect', () => {
            console.log('‚úÖ Pantalla de asistencia conectada al servidor - Socket ID:', socket.id);
        });
        
        socket.on('disconnect', () => {
            console.log('‚ùå Pantalla de asistencia desconectada del servidor');
        });
        
        socket.on('reconnect', () => {
            console.log('üîÑ Pantalla de asistencia reconectada al servidor');
        });
        let paseListaActivo = false;
        let diputadosData = [];
        let asistenciaData = {};
        let previousAttendance = {};
        let configuracionSistema = {};
        let partidosData = {};
        
        // Detectar par√°metros de URL para modos especiales (vMix/OBS)
        function applyStreamingModes() {
            const params = new URLSearchParams(window.location.search);
            
            // Fondo transparente
            if (params.get('transparent') === 'true' || params.get('bg') === 'transparent') {
                document.body.classList.add('transparent-bg');
            }
            
            // Modo chromakey
            if (params.get('chromakey') === 'true' || params.get('greenscreen') === 'true') {
                document.body.classList.add('chromakey-mode');
                
                // Chromakey azul si se especifica
                if (params.get('chromakey') === 'blue') {
                    document.body.classList.add('chromakey-blue');
                }
                
                // Color chromakey personalizado
                const chromaColor = params.get('chromacolor');
                if (chromaColor) {
                    document.body.style.backgroundColor = `#${chromaColor}`;
                }
            }
            
            // Modo minimalista
            if (params.get('minimal') === 'true' || params.get('header') === 'false') {
                document.body.classList.add('minimal-mode');
            }
        }
        
        // Aplicar modos al cargar
        applyStreamingModes();
        
        // Lista predefinida de los 20 diputados - Con IDs REALES de la base de datos
        const DIPUTADOS_DEFAULT = [
            { id: 18, nombre_completo: 'Abarca Pe√±a Gerardo', apellidos: 'Abarca Pe√±a', partido: 'PAN', orden: 1 },
            { id: 12, nombre_completo: 'Dom√≠nguez Mandujano Alfredo', apellidos: 'Dom√≠nguez Mandujano', partido: 'Morena', orden: 2 },
            { id: 17, nombre_completo: 'Espinoza L√≥pez Brenda', apellidos: 'Espinoza L√≥pez', partido: 'Morena', orden: 3 },
            { id: 6, nombre_completo: 'Gordillo Vega Andrea Valentina Guadalupe', apellidos: 'Gordillo Vega', partido: 'PAN', orden: 4 },
            { id: 7, nombre_completo: 'Livera Chavarr√≠a Sergio Omar', apellidos: 'Livera Chavarr√≠a', partido: 'Morena', orden: 5 },
            { id: 22, nombre_completo: 'Mart√≠nez G√≥mez Gonzala Eleonor', apellidos: 'Mart√≠nez G√≥mez', partido: 'PRI', orden: 6 },
            { id: 5, nombre_completo: 'Mart√≠nez Terrazas √ìscar Daniel', apellidos: 'Mart√≠nez Terrazas', partido: 'PAN', orden: 7 },
            { id: 8, nombre_completo: 'Maya Rend√≥n Guillermina', apellidos: 'Maya Rend√≥n', partido: 'Morena', orden: 8 },
            { id: 15, nombre_completo: 'Montes de Oca Montoya Martha Melissa', apellidos: 'Montes de Oca Montoya', partido: 'Morena', orden: 9 },
            { id: 21, nombre_completo: 'Pedrero Gonz√°lez Luis Eduardo', apellidos: 'Pedrero Gonz√°lez', partido: 'PVEM', orden: 10 },
            { id: 16, nombre_completo: 'Pimentel Mej√≠a Isaac', apellidos: 'Pimentel Mej√≠a', partido: 'Morena', orden: 11 },
            { id: 19, nombre_completo: 'Quevedo Maldonado Luz Dary', apellidos: 'Quevedo Maldonado', partido: 'MC', orden: 12 },
            { id: 10, nombre_completo: 'Reyes Reyes Rafael', apellidos: 'Reyes Reyes', partido: 'Morena', orden: 13 },
            { id: 23, nombre_completo: 'Rodr√≠guez L√≥pez Ruth Cleotilde', apellidos: 'Rodr√≠guez L√≥pez', partido: 'Nueva Alianza Morelos', orden: 14 },
            { id: 20, nombre_completo: 'Rodr√≠guez Ru√≠z Tania Valentina', apellidos: 'Rodr√≠guez Ru√≠z', partido: 'PT', orden: 15 },
            { id: 11, nombre_completo: 'Ru√≠z Rodr√≠guez Nayla Carolina', apellidos: 'Ru√≠z Rodr√≠guez', partido: 'Morena', orden: 16 },
            { id: 24, nombre_completo: 'S√°nchez Ortega Alberto', apellidos: 'S√°nchez Ortega', partido: 'PT', orden: 17 },
            { id: 13, nombre_completo: 'S√°nchez Zavala Francisco Erik', apellidos: 'S√°nchez Zavala', partido: 'PAN', orden: 18 },
            { id: 9, nombre_completo: 'Solano L√≥pez Jazm√≠n Juana', apellidos: 'Solano L√≥pez', partido: 'Morena', orden: 19 },
            { id: 14, nombre_completo: 'Sotelo Mart√≠nez Alfonso de Jes√∫s', apellidos: 'Sotelo Mart√≠nez', partido: 'Morena', orden: 20 }
        ];
        
        
        // Actualizar logos
        function updateLogos() {
            const logoLeft = document.getElementById('logoLeft');
            const logoRight = document.getElementById('logoRight');
            
            if (logoLeft) {
                logoLeft.innerHTML = configuracionSistema.logo_congreso ? 
                    `<img src="${configuracionSistema.logo_congreso}" alt="Logo Congreso" 
                         style="height: 70px; max-width: 100px; object-fit: contain;">` :
                    `<img src="/uploads/logo-1754407608820.png" alt="Logo Congreso" 
                         style="height: 70px; max-width: 100px; object-fit: contain;">`;
            }
            
            if (logoRight) {
                logoRight.innerHTML = configuracionSistema.logo_secundario ? 
                    `<img src="${configuracionSistema.logo_secundario}" alt="Logo Secundario" 
                         style="height: 70px; max-width: 100px; object-fit: contain;">` :
                    '';
            }
        }
        
        
        // Conectar al servidor
        socket.on('connect', () => {
            console.log('Conectado al servidor - Pantalla de asistencia');
            // Cargar configuraci√≥n y partidos primero
            Promise.all([cargarConfiguracion(), cargarPartidos()]).then(() => {
                console.log('Configuraci√≥n y partidos cargados, verificando estado...');
                verificarEstado();
            }).catch(error => {
                console.error('Error cargando configuraci√≥n inicial:', error);
                verificarEstado(); // Intentar verificar estado de todos modos
            });
            
            // Verificar peri√≥dicamente si no est√° activo
            const checkInterval = setInterval(() => {
                if (!paseListaActivo) {
                    console.log('Verificando estado del pase de lista...');
                    verificarEstado();
                } else {
                    clearInterval(checkInterval);
                }
            }, 3000);
        });
        
        // Escuchar activaci√≥n del pase de lista
        socket.on('pase-lista-activado', (data) => {
            console.log('üîî Evento pase-lista-activado recibido:', data);
            console.log('üìä Estado actual - paseListaActivo:', paseListaActivo);
            console.log('üìä Datos recibidos:', JSON.stringify(data, null, 2));
            
            // Activar siempre que se reciba este evento
            paseListaActivo = true;
            console.log('‚úÖ Pase de lista activado en pantalla de asistencia');
            
            // Usar el mapeo fijo de diputados
            diputadosData = DIPUTADOS_DEFAULT;
            console.log('Usando mapeo fijo de diputados para pantalla p√∫blica');
            
            // Mostrar el contenedor de estad√≠sticas
            document.getElementById('statsContainer').style.display = 'flex';
            
            // IMPORTANTE: Verificar si ya hay datos de asistencia
            if (Object.keys(asistenciaData).length > 0) {
                console.log('üìã Manteniendo estados existentes:', Object.keys(asistenciaData).length, 'diputados con asistencia');
                // Renderizar directamente con los datos existentes
                renderizarDiputados();
                actualizarEstadisticas();
            } else {
                // Solo cargar datos nuevos si no existen
                console.log('üì• Cargando datos de asistencia por primera vez...');
                cargarDiputados().then(() => {
                    console.log('‚úÖ Pantalla de asistencia activada correctamente');
                }).catch(error => {
                    console.error('Error al cargar diputados:', error);
                    // Renderizar con datos por defecto
                    renderizarDiputados();
                    actualizarEstadisticas();
                });
            }
        });
        
        // Escuchar actualizaciones de asistencia
        socket.on('asistencia-marcada', (data) => {
            console.log('Asistencia marcada:', data);
            if (paseListaActivo && data.diputado_id) {
                actualizarAsistencia(data.diputado_id, data.asistencia || data.estado);
            }
        });
        
        // Escuchar cuando un diputado confirma su propia asistencia
        socket.on('asistencia-confirmada', (data) => {
            console.log('Asistencia confirmada por diputado:', data);
            if (paseListaActivo && data.diputado_id) {
                // Marcar como presente cuando el diputado confirma
                actualizarAsistencia(data.diputado_id, 'presente');
            }
        });
        
        socket.on('asistencia-actualizada', (data) => {
            console.log('Asistencia actualizada:', data);
            if (paseListaActivo) {
                actualizarAsistencia(data.diputado_id, data.asistencia);
            }
        });
        
        // Escuchar cuando se modifica asistencia sin necesidad de confirmar
        socket.on('asistencia-modificada-sin-confirmar', (data) => {
            console.log('Asistencia modificada sin reconfirmar:', data);
            
            // Actualizar el estado del diputado SIEMPRE
            if (data.diputado_id && data.asistencia_nueva) {
                actualizarAsistencia(data.diputado_id, data.asistencia_nueva);
            }
            
            // Si estamos en la vista de resumen final, volver a la lista para ver los cambios
            const container = document.getElementById('deputiesContent');
            if (container && container.querySelector('.no-attendance')) {
                console.log('Regresando a la vista de lista para mostrar cambios');
                renderizarDiputados();
                actualizarEstadisticas();
            }
            
            // Solo mostrar notificaci√≥n si NO es silencioso (llegadas tard√≠as no muestran notificaci√≥n)
            if (!data.silencioso) {
                const notification = document.createElement('div');
                notification.className = 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 400px; text-align: center;';
                notification.innerHTML = `
                    <i class="fas fa-check-circle"></i> <strong>Asistencia Actualizada</strong>
                    <br>${data.mensaje || 'Cambio aplicado sin necesidad de confirmar'}
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 4000);
            } else {
                // Si es silencioso (llegada tard√≠a), solo actualizar sin notificar
                console.log('üîá Actualizaci√≥n silenciosa de llegada tard√≠a:', data.nombre_diputado);
            }
        });
        
        // Escuchar cuando se confirma el pase de lista
        socket.on('pase-lista-confirmado', (data) => {
            console.log('Pase de lista confirmado:', data);
            mostrarResumenFinal(data);
        });
        
        // Escuchar activaci√≥n solo para pantalla (cuando el pase ya est√° confirmado)
        socket.on('pase-lista-activado-pantalla', (data) => {
            console.log('üîî Evento pase-lista-activado-pantalla recibido (solo pantalla):', data);
            // Activar la pantalla pero sin afectar a los diputados
            paseListaActivo = true;
            
            // Usar el mapeo fijo de diputados
            diputadosData = DIPUTADOS_DEFAULT;
            console.log('Activando pantalla con pase de lista confirmado');
            
            // Mostrar el contenedor de estad√≠sticas
            document.getElementById('statsContainer').style.display = 'flex';
            
            // Cargar los datos actuales y renderizar
            cargarDiputados().then(() => {
                console.log('‚úÖ Pantalla de asistencia activada (modo confirmado)');
            }).catch(error => {
                console.error('Error al cargar diputados:', error);
                renderizarDiputados();
                actualizarEstadisticas();
            });
        });
        
        // Escuchar cuando se reabre el pase de lista (sin borrar asistencias)
        socket.on('pase-lista-reabierto', (data) => {
            console.log('Pase de lista reabierto:', data);
            // Mantener el pase de lista activo
            paseListaActivo = true;
            
            // IMPORTANTE: NO borrar asistenciaData
            console.log('Manteniendo estados existentes:', Object.keys(asistenciaData).length);
            
            // Si ya estamos mostrando el resumen, volver a la lista
            const deputiesContent = document.getElementById('deputiesContent');
            if (deputiesContent && deputiesContent.querySelector('.no-attendance')) {
                // Renderizar la lista manteniendo los estados
                renderizarDiputados();
                actualizarEstadisticas();
            }
            
            // Mostrar notificaci√≥n de reapertura
            const notification = document.createElement('div');
            notification.className = 'alert alert-info position-fixed';
            notification.style.cssText = 'top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 400px; text-align: center;';
            notification.innerHTML = `
                <i class="fas fa-unlock"></i> <strong>Pase de Lista Reabierto</strong>
                <br>Puede modificar asistencias sin necesidad de confirmar nuevamente
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        });
        
        // Escuchar cuando se reinicia el pase de lista
        socket.on('pase-lista-reiniciado', async (data) => {
            console.log('Pase de lista reiniciado:', data);
            
            // Limpiar COMPLETAMENTE todos los datos de asistencia
            asistenciaData = {};
            previousAttendance = {};
            
            // El pase de lista sigue activo pero sin asistencias
            paseListaActivo = true;
            
            // Renderizar inmediatamente con todos sin marcar
            renderizarDiputados();
            
            // Actualizar estad√≠sticas a cero
            document.getElementById('presentCount').textContent = '0';
            document.getElementById('absentCount').textContent = '0';
            document.getElementById('unmarkedCount').textContent = diputadosData ? diputadosData.length : '20';
            
            // Mostrar mensaje de reinicio
            const messageDiv = document.createElement('div');
            messageDiv.className = 'alert alert-warning position-fixed';
            messageDiv.style.cssText = 'top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 400px; text-align: center;';
            messageDiv.innerHTML = `
                <i class="fas fa-redo"></i> <strong>Pase de Lista Reiniciado</strong>
                <br>Todas las asistencias han sido borradas
            `;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
            
            // Recargar datos desde el servidor para asegurar sincronizaci√≥n
            try {
                const response = await fetch('/api/pase-lista/pantalla');
                const serverData = await response.json();
                
                if (serverData.diputados) {
                    // Actualizar con datos frescos del servidor
                    asistenciaData = {};
                    serverData.diputados.forEach(dip => {
                        if (dip.asistencia && dip.asistencia !== 'sin_marcar') {
                            asistenciaData[dip.id] = dip.asistencia;
                        }
                    });
                }
            } catch (error) {
                console.error('Error recargando datos:', error);
            }
            
            // Recargar los diputados y actualizar la vista
            renderizarDiputados();
            actualizarEstadisticas();
            
            // Mostrar notificaci√≥n visual
            const notification = document.createElement('div');
            notification.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            notification.style.zIndex = '9999';
            notification.innerHTML = `
                <strong>‚ö†Ô∏è Pase de lista reiniciado</strong>
                <br>Se han borrado todas las asistencias marcadas.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // Auto-ocultar despu√©s de 5 segundos
            setTimeout(() => {
                notification.remove();
            }, 5000);
        });
        
        // Escuchar cuando se inicia sesi√≥n (aunque el pase de lista se activa autom√°ticamente)
        socket.on('sesion-iniciada', (data) => {
            console.log('üîî Sesi√≥n iniciada detectada:', data);
            // El pase de lista se activar√° autom√°ticamente por el evento pase-lista-activado
            // Solo actualizamos el mensaje mientras esperamos
            if (!paseListaActivo) {
                const logoPrincipal = configuracionSistema.logo_congreso || '/uploads/logo-1754407608820.png';
                const logoSecundario = configuracionSistema.logo_secundario || '/uploads/logo-secundario.png';
                
                document.getElementById('deputiesContent').innerHTML = `
                    <div class="no-attendance">
                        <div class="logo-container">
                            <div class="logo-item">
                                <img src="${logoPrincipal}" alt="Logo Principal" 
                                     onerror="this.style.display='none'">
                            </div>
                            ${logoSecundario ? `
                            <div class="logo-item">
                                <img src="${logoSecundario}" alt="Logo Secundario"
                                     onerror="this.style.display='none'">
                            </div>` : ''}
                        </div>
                        <h1 class="system-title">PASE DE LISTA ELECTR√ìNICO</h1>
                        <p class="status-message" style="color: #28a745;">
                            <i class="fas fa-check-circle"></i> Sesi√≥n Legislativa Activa
                        </p>
                        <p class="status-message">Preparando pase de lista...</p>
                    </div>
                `;
            }
        });
        
        // Escuchar fin de sesi√≥n
        socket.on('sesion-clausurada', () => {
            paseListaActivo = false;
            
            const logoPrincipal = configuracionSistema.logo_congreso || '/uploads/logo-1754407608820.png';
            const logoSecundario = configuracionSistema.logo_secundario || '/uploads/logo-secundario.png';
            
            document.getElementById('deputiesContent').innerHTML = `
                <div class="no-attendance">
                    <div class="logo-container">
                        <div class="logo-item">
                            <img src="${logoPrincipal}" alt="Logo Principal" 
                                 onerror="this.style.display='none'">
                        </div>
                        ${logoSecundario ? `
                        <div class="logo-item">
                            <img src="${logoSecundario}" alt="Logo Secundario"
                                 onerror="this.style.display='none'">
                        </div>` : ''}
                    </div>
                    <h1 class="system-title">SESI√ìN CLAUSURADA</h1>
                    <p class="status-message" style="color: #28a745;">
                        <i class="fas fa-check-circle"></i> La sesi√≥n legislativa ha finalizado
                    </p>
                </div>
            `;
            document.getElementById('statsContainer').style.display = 'none';
        });
        
        // Verificar estado inicial y cargar asistencias persistentes
        async function verificarEstado() {
            try {
                console.log('=== Verificando estado persistente de asistencia ===');
                
                // Primero verificar si hay un pase de lista activo
                const response = await fetch('/api/pase-lista/actual');
                if (response.ok) {
                    const paseListaData = await response.json();
                    
                    if (paseListaData.paseListaActivo) {
                        console.log('Pase de lista activo encontrado:', paseListaData.id);
                        paseListaActivo = true;
                        
                        // Usar el mapeo fijo con IDs correctos
                        diputadosData = DIPUTADOS_DEFAULT;
                        console.log('Usando mapeo fijo de diputados con IDs correctos');
                        
                        // SIEMPRE cargar datos del servidor si existen (para mantener persistencia)
                        let totalCargadas = 0;
                        
                        // Cargar asistencias del servidor si existen
                        if (paseListaData.asistencias && paseListaData.asistencias.length > 0) {
                            console.log('');
                            console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                            console.log('‚ïë  üìã CARGANDO ASISTENCIAS ACUMULADAS EN BACKGROUND  ‚ïë');
                            console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
                            console.log(`Total de registros acumulados: ${paseListaData.asistencias.length}`);
                            console.log('');
                            
                            // Limpiar asistenciaData para cargar datos frescos del servidor
                            asistenciaData = {};
                            
                            paseListaData.asistencias.forEach(asistencia => {
                                // Mapear el estado de asistencia correctamente
                                let estado = 'sin_marcar';
                                
                                // Priorizar el campo 'asistencia' si existe
                                if (asistencia.asistencia) {
                                    estado = asistencia.asistencia;
                                } else {
                                    // Determinar por campos individuales
                                    if (asistencia.justificado === 1) {
                                        estado = 'justificado';
                                    } else if (asistencia.presente === 1) {
                                        estado = 'presente';
                                    } else if (asistencia.presente === 0) {
                                        estado = 'ausente';
                                    }
                                }
                                
                                // Guardar TODOS los estados, incluyendo ausentes
                                if (estado !== 'sin_marcar') {
                                    asistenciaData[asistencia.diputado_id] = estado;
                                    totalCargadas++;
                                    console.log(`Diputado ID ${asistencia.diputado_id}: ${estado}`);
                                }
                            });
                            console.log(`‚úÖ Total asistencias procesadas: ${totalCargadas} (Presentes, Ausentes y Justificados)`);
                            console.log('Todas las asistencias registradas mientras la pantalla estaba cerrada han sido cargadas.');
                        } else {
                            console.log('');
                            console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                            console.log('‚ïë  ‚è≥ ESPERANDO ASISTENCIAS EN BACKGROUND        ‚ïë');
                            console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
                            console.log('No hay asistencias registradas a√∫n.');
                            console.log('Los diputados pueden marcar asistencia desde sus paneles.');
                            console.log('Esta pantalla se actualizar√° autom√°ticamente.');
                        }
                        
                        document.getElementById('statsContainer').style.display = 'flex';
                        renderizarDiputados();
                        actualizarEstadisticas();
                        
                        console.log('=== Estado persistente cargado exitosamente ===');
                        console.log('Total asistencias cargadas:', Object.keys(asistenciaData).length);
                    } else {
                        // No hay pase de lista activo
                        mostrarEsperandoPaseLista();
                    }
                } else {
                    // Fallback: intentar cargar desde /api/pase-lista/pantalla
                    const pantallaResponse = await fetch('/api/pase-lista/pantalla');
                    const data = await pantallaResponse.json();
                    
                    if (data.activo !== false || (data.diputados && data.diputados.length > 0)) {
                        paseListaActivo = true;
                        diputadosData = DIPUTADOS_DEFAULT;
                        
                        asistenciaData = {};
                        if (data.diputados) {
                            data.diputados.forEach(diputado => {
                                if (diputado.asistencia && diputado.asistencia !== 'sin_marcar') {
                                    asistenciaData[diputado.id] = diputado.asistencia;
                                }
                            });
                        }
                        
                        document.getElementById('statsContainer').style.display = 'flex';
                        renderizarDiputados();
                        actualizarEstadisticas();
                    } else {
                        mostrarEsperandoPaseLista();
                    }
                }
            } catch (error) {
                console.error('Error verificando estado:', error);
                // En caso de error, usar el mapeo fijo
                diputadosData = DIPUTADOS_DEFAULT;
                mostrarEsperandoPaseLista();
            }
        }
        
        // Funci√≥n auxiliar para mostrar mensaje de espera con logos
        function mostrarEsperandoPaseLista() {
            paseListaActivo = false;
            
            // Obtener logos de configuraci√≥n o usar valores por defecto
            const logoPrincipal = configuracionSistema.logo_congreso || '/uploads/logo-1754407608820.png';
            const logoSecundario = configuracionSistema.logo_secundario || '/uploads/logo-secundario.png';
            
            document.getElementById('deputiesContent').innerHTML = `
                <div class="no-attendance">
                    <div class="logo-container">
                        <div class="logo-item">
                            <img src="${logoPrincipal}" alt="Logo Principal" 
                                 onerror="this.style.display='none'">
                        </div>
                        ${logoSecundario ? `
                        <div class="logo-item">
                            <img src="${logoSecundario}" alt="Logo Secundario"
                                 onerror="this.style.display='none'">
                        </div>` : ''}
                    </div>
                    <h1 class="system-title">PASE DE LISTA ELECTR√ìNICO</h1>
                    <p class="status-message">Esperando activaci√≥n por el Secretario Legislativo</p>
                </div>
            `;
            document.getElementById('statsContainer').style.display = 'none';
        }
        
        // Cargar diputados reales desde la API
        async function cargarDiputadosReales() {
            try {
                const response = await fetch('/api/pase-lista/diputados');
                if (response.ok) {
                    const diputados = await response.json();
                    diputadosData = diputados.map((dip, index) => ({
                        id: dip.id, // ID REAL de la base de datos
                        nombre_completo: dip.nombre_completo,
                        partido: dip.partido,
                        orden: index + 1
                    }));
                    console.log('Diputados reales cargados:', diputadosData);
                } else {
                    // Fallback a lista por defecto si falla
                    diputadosData = DIPUTADOS_DEFAULT;
                }
            } catch (error) {
                console.error('Error cargando diputados reales:', error);
                diputadosData = DIPUTADOS_DEFAULT;
            }
        }
        
        // Cargar configuraci√≥n del sistema
        async function cargarConfiguracion() {
            try {
                const response = await fetch('/api/configuracion/public');
                if (response.ok) {
                    configuracionSistema = await response.json();
                    console.log('Configuraci√≥n cargada:', configuracionSistema);
                    updateLogos();
                }
            } catch (error) {
                console.error('Error cargando configuraci√≥n:', error);
            }
        }
        
        // Cargar informaci√≥n de partidos
        async function cargarPartidos() {
            try {
                const response = await fetch('/api/pantalla/partidos');
                if (response.ok) {
                    const partidos = await response.json();
                    console.log('Partidos cargados:', partidos);
                    // Crear mapa de partidos por siglas
                    partidos.forEach(partido => {
                        partidosData[partido.siglas] = partido;
                    });
                }
            } catch (error) {
                console.error('Error cargando partidos:', error);
            }
        }
        
        // Cargar lista de diputados
        async function cargarDiputados() {
            try {
                console.log('=== Cargando diputados para pantalla p√∫blica ===');
                
                // Siempre usar el mapeo fijo para consistencia
                diputadosData = DIPUTADOS_DEFAULT;
                console.log('Usando mapeo fijo de 20 diputados');
                
                // Intentar cargar el estado actual del pase de lista
                try {
                    const response = await fetch('/api/pase-lista/pantalla');
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Datos de pase de lista recibidos:', data);
                        
                        // NO reiniciar si ya hay datos - solo actualizar con nuevos
                        if (Object.keys(asistenciaData).length === 0) {
                            asistenciaData = {};
                        }
                        let presentes = 0, ausentes = 0, justificados = 0;
                        
                        // Cargar asistencias si existen
                        if (data.asistencias) {
                            asistenciaData = data.asistencias;
                            console.log('Asistencias cargadas (objeto):', Object.keys(asistenciaData).length);
                        } else if (data.diputados && Array.isArray(data.diputados)) {
                            // Formato alternativo con array de diputados
                            console.log('Procesando array de diputados:', data.diputados.length);
                            data.diputados.forEach(dip => {
                                // Procesar TODOS los estados, no solo los marcados
                                if (dip.asistencia) {
                                    asistenciaData[dip.id] = dip.asistencia;
                                    
                                    // Contar por tipo
                                    if (dip.asistencia === 'presente') presentes++;
                                    else if (dip.asistencia === 'ausente') ausentes++;
                                    else if (dip.asistencia === 'justificado') justificados++;
                                }
                            });
                            console.log(`Asistencias procesadas: ${presentes} presentes, ${ausentes} ausentes, ${justificados} justificados`);
                        } else {
                            console.log('No hay asistencias registradas a√∫n');
                        }
                    } else {
                        console.warn('Error en respuesta del servidor:', response.status);
                        asistenciaData = {};
                    }
                } catch (fetchError) {
                    console.error('Error obteniendo datos del servidor:', fetchError);
                    asistenciaData = {};
                }
                
                // Renderizar la pantalla
                renderizarDiputados();
                actualizarEstadisticas();
                
                console.log('=== Pantalla de asistencia actualizada ===');
            } catch (error) {
                console.error('Error general cargando diputados:', error);
                // En caso de error, usar valores por defecto
                diputadosData = DIPUTADOS_DEFAULT;
                asistenciaData = {};
                renderizarDiputados();
                actualizarEstadisticas();
            }
        }
        
        // Renderizar columnas de asistencia
        function renderAttendanceColumns(diputados) {
            // Dividir en dos columnas - ahora en orden alfab√©tico de arriba hacia abajo
            const column1 = diputados.slice(0, 10); // Del 1 al 10 (orden natural)
            const column2 = diputados.slice(10, 20); // Del 11 al 20 (orden natural)
            
            const renderTable = (diputadosColumn) => {
                return `
                    <div class="voting-column">
                        <table class="voting-table">
                            ${diputadosColumn.map(d => {
                                const partyClass = d.partido ? `party-${d.partido.toLowerCase().replace(/\s+/g, '-')}` : '';
                                const asistencia = asistenciaData[d.id] || 'sin_marcar';
                                const isNewAttendance = previousAttendance[d.id] !== asistencia && asistencia !== 'sin_marcar';
                                
                                // Obtener datos del partido desde la configuraci√≥n
                                let partyLogo = null;
                                let partyColor = '#666';
                                
                                // Buscar en los datos de partidos cargados
                                const partidoData = partidosData[d.partido];
                                if (partidoData) {
                                    partyLogo = partidoData.logo_url;
                                    partyColor = partidoData.color || '#666';
                                } else {
                                    // Fallback a logos predefinidos si no hay datos del partido
                                    const partyLogosDefault = {
                                        'Morena': '/images/partidos/morena.svg',
                                        'PAN': '/images/partidos/pan.svg',
                                        'MC': '/images/partidos/mc.svg',
                                        'PT': '/images/partidos/pt.svg',
                                        'PVEM': '/images/partidos/pvem.svg',
                                        'PRI': '/images/partidos/pri.svg',
                                        'Nueva Alianza Morelos': '/images/partidos/nueva-alianza.svg'
                                    };
                                    
                                    const partyColorsDefault = {
                                        'Morena': '#8B1B1B',
                                        'PAN': '#1B4788',
                                        'MC': '#FF6B00',
                                        'PT': '#E31E24',
                                        'PVEM': '#00A550',
                                        'PRI': '#CD1C22',
                                        'Nueva Alianza Morelos': '#00B8B2'
                                    };
                                    
                                    partyLogo = partyLogosDefault[d.partido] || null;
                                    partyColor = partyColorsDefault[d.partido] || '#666';
                                }
                                
                                // Actualizar registro de asistencias previas
                                if (asistencia !== 'sin_marcar') {
                                    previousAttendance[d.id] = asistencia;
                                }
                                
                                return `
                                    <tr>
                                        <td class="party-logo ${partyClass}">
                                            ${partyLogo ? 
                                                `<img src="${partyLogo}" alt="${d.partido}" 
                                                     style="height: 35px; max-width: 40px; object-fit: contain;" 
                                                     onerror="this.outerHTML='<div class=\\'party-icon\\' style=\\'background-color: ${partyColor}\\'>${d.partido ? (d.partido === 'Morena' ? 'M' : d.partido.charAt(0)) : '?'}</div>'">` :
                                                `<div class="party-icon" style="background-color: ${partyColor}">
                                                    ${d.partido ? (d.partido === 'Morena' ? 'M' : d.partido.charAt(0)) : '?'}
                                                </div>`
                                            }
                                        </td>
                                        <td class="deputy-name" title="${d.nombre_completo}">${d.nombre_completo}</td>
                                        <td class="attendance-status">
                                            ${asistencia === 'presente' ? 
                                                `<span class="attendance-btn attendance-present ${isNewAttendance ? 'attendance-animated' : ''}">Presente</span>` :
                                              asistencia === 'ausente' ?
                                                `<span class="attendance-btn attendance-absent ${isNewAttendance ? 'attendance-animated' : ''}">Inasistencia</span>` :
                                              asistencia === 'justificado' ?
                                                `<span class="attendance-btn attendance-justified ${isNewAttendance ? 'attendance-animated' : ''}">‚ö†Ô∏è Justificado</span>` :
                                                `<span class="attendance-btn attendance-default">---</span>`
                                            }
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </table>
                    </div>
                `;
            };
            
            let html = '<div class="attendance-columns-wrapper">';
            if (column1.length > 0) html += renderTable(column1);
            if (column2.length > 0) html += renderTable(column2);
            html += '</div>';
            
            return html;
        }
        
        // Renderizar lista de diputados
        function renderizarDiputados() {
            const container = document.getElementById('deputiesContent');
            
            // SIEMPRE usar el mapeo fijo si no hay datos
            if (!diputadosData || diputadosData.length === 0) {
                diputadosData = DIPUTADOS_DEFAULT;
                console.log('Usando mapeo fijo por defecto en renderizarDiputados');
            }
            
            // Usar los diputados con el mapeo correcto
            container.innerHTML = renderAttendanceColumns(diputadosData);
        }
        
        // Actualizar asistencia de un diputado
        function actualizarAsistencia(diputadoId, asistencia) {
            console.log(`Actualizando asistencia - ID: ${diputadoId}, Asistencia: ${asistencia}`);
            
            // Buscar el diputado en nuestra lista para verificar
            const diputado = diputadosData.find(d => d.id === parseInt(diputadoId));
            if (diputado) {
                console.log(`Diputado encontrado: ${diputado.nombre_completo}`);
            } else {
                console.warn(`No se encontr√≥ diputado con ID ${diputadoId} en la lista local`);
            }
            
            asistenciaData[diputadoId] = asistencia;
            renderizarDiputados();
            actualizarEstadisticas();
        }
        
        // Actualizar estad√≠sticas
        function actualizarEstadisticas() {
            let presentes = 0;
            let ausentes = 0;
            let justificados = 0;
            let sinMarcar = 0;
            
            // Usar los diputados reales cargados
            const diputadosParaContar = diputadosData && diputadosData.length > 0 ? diputadosData : DIPUTADOS_DEFAULT;
            
            diputadosParaContar.forEach(diputado => {
                const asistencia = asistenciaData[diputado.id];
                if (asistencia === 'presente') {
                    presentes++;
                } else if (asistencia === 'ausente') {
                    ausentes++;
                } else if (asistencia === 'justificado') {
                    justificados++;
                } else {
                    sinMarcar++;
                }
            });
            
            document.getElementById('presentCount').textContent = String(presentes).padStart(2, '0');
            document.getElementById('absentCount').textContent = String(ausentes).padStart(2, '0');
            document.getElementById('justifiedCount').textContent = String(justificados).padStart(2, '0');
            document.getElementById('pendingCount').textContent = String(sinMarcar).padStart(2, '0');
            
            // Calcular y mostrar qu√≥rum (necesita 11 de 20 diputados = mayor√≠a simple)
            const quorumMinimo = 11;
            const hayQuorum = presentes >= quorumMinimo;
            
            const quorumIndicator = document.getElementById('quorumIndicator');
            const quorumText = document.getElementById('quorumText');
            
            if (quorumIndicator && quorumText) {
                quorumIndicator.style.display = 'block';
                
                if (hayQuorum) {
                    quorumIndicator.className = 'quorum-indicator quorum-yes';
                    quorumText.innerHTML = `<i class="fas fa-check-circle"></i> HAY QU√ìRUM (${presentes}/20)`;
                } else {
                    quorumIndicator.className = 'quorum-indicator quorum-no';
                    quorumText.innerHTML = `<i class="fas fa-times-circle"></i> SIN QU√ìRUM (${presentes}/20 - M√≠nimo: ${quorumMinimo})`;
                }
            }
        }
        
        // Mostrar resumen final con todos los estados
        function mostrarResumenFinal(data) {
            const container = document.getElementById('deputiesContent');
            const presentes = data.presentes || 0;
            const ausentes = data.ausentes || 0;
            const justificados = data.justificados || 0;
            const total = data.total || (presentes + ausentes + justificados);
            const quorumMinimo = 11;
            const hayQuorum = presentes >= quorumMinimo;
            
            // Si hay detalle de diputados, actualizar asistenciaData
            if (data.detalle && Array.isArray(data.detalle)) {
                console.log('Actualizando asistencias desde detalle:', data.detalle.length);
                data.detalle.forEach(dip => {
                    if (dip.estado && dip.estado !== 'sin_marcar') {
                        asistenciaData[dip.id] = dip.estado;
                    }
                });
            }
            
            // Obtener logos de la configuraci√≥n
            const logoPrincipal = configuracionSistema.logo_congreso || '/uploads/logo-1754407608820.png';
            const logoSecundario = configuracionSistema.logo_secundario || '';
            
            container.innerHTML = `
                <div class="no-attendance" style="padding: 20px; background: #2c2c2c;">
                    <div style="background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%); padding: 25px; border-radius: 20px;">
                        <!-- Logos en la parte superior -->
                        ${(logoPrincipal || logoSecundario) ? `
                        <div style="display: flex; justify-content: center; align-items: center; gap: 40px; margin-bottom: 25px;">
                            ${logoPrincipal ? `<img src="${logoPrincipal}" alt="Logo Principal" style="height: 60px; max-width: 120px; object-fit: contain;" onerror="this.style.display='none'">` : ''}
                            ${logoSecundario ? `<img src="${logoSecundario}" alt="Logo Secundario" style="height: 60px; max-width: 120px; object-fit: contain;" onerror="this.style.display='none'">` : ''}
                        </div>` : ''}
                        
                        <i class="fas fa-check-circle" style="color: #4CAF50; font-size: 3.5em;"></i>
                        <h2 style="color: white; margin: 15px 0;">Pase de Lista Confirmado</h2>
                        
                        <!-- Cards de resultados con colores correctos y tama√±o reducido -->
                        <div style="display: flex; gap: 15px; justify-content: center; margin: 25px 0; flex-wrap: wrap;">
                            <!-- Card Presentes - VERDE -->
                            <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
                                        padding: 20px; border-radius: 12px; min-width: 160px; 
                                        box-shadow: 0 6px 20px rgba(0,0,0,0.4); text-align: center;">
                                <i class="fas fa-user-check" style="color: white; font-size: 2.2em; margin-bottom: 12px;"></i>
                                <h1 style="color: white; font-size: 3em; margin: 8px 0; font-weight: bold;">${presentes}</h1>
                                <h4 style="color: white; text-transform: uppercase; letter-spacing: 1.5px; margin: 0; font-size: 0.85em;">Presentes</h4>
                            </div>
                            
                            <!-- Card Ausentes - ROJO -->
                            <div style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
                                        padding: 20px; border-radius: 12px; min-width: 160px;
                                        box-shadow: 0 6px 20px rgba(0,0,0,0.4); text-align: center;">
                                <i class="fas fa-user-times" style="color: white; font-size: 2.2em; margin-bottom: 12px;"></i>
                                <h1 style="color: white; font-size: 3em; margin: 8px 0; font-weight: bold;">${ausentes}</h1>
                                <h4 style="color: white; text-transform: uppercase; letter-spacing: 1.5px; margin: 0; font-size: 0.85em;">Inasistencias</h4>
                            </div>
                            
                            <!-- Card Justificados - AMARILLO -->
                            ${justificados > 0 ? `
                            <div style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); 
                                        padding: 20px; border-radius: 12px; min-width: 160px;
                                        box-shadow: 0 6px 20px rgba(0,0,0,0.4); text-align: center;">
                                <i class="fas fa-file-medical" style="color: white; font-size: 2.2em; margin-bottom: 12px;"></i>
                                <h1 style="color: white; font-size: 3em; margin: 8px 0; font-weight: bold;">${justificados}</h1>
                                <h4 style="color: white; text-transform: uppercase; letter-spacing: 1.5px; margin: 0; font-size: 0.85em;">Justificados</h4>
                            </div>` : ''}
                            
                            <!-- Card Total - GRIS -->
                            <div style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); 
                                        padding: 20px; border-radius: 12px; min-width: 160px;
                                        box-shadow: 0 6px 20px rgba(0,0,0,0.4); text-align: center;">
                                <i class="fas fa-users" style="color: white; font-size: 2.2em; margin-bottom: 12px;"></i>
                                <h1 style="color: white; font-size: 3em; margin: 8px 0; font-weight: bold;">${total}</h1>
                                <h4 style="color: white; text-transform: uppercase; letter-spacing: 1.5px; margin: 0; font-size: 0.85em;">Total</h4>
                            </div>
                        </div>
                        
                        <!-- Indicador de Qu√≥rum en la parte inferior centrado -->
                        <div style="position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 1000;">
                            <div style="background: ${hayQuorum ? 
                                        'linear-gradient(135deg, #28a745 0%, #20c997 100%)' : 
                                        'linear-gradient(135deg, #dc3545 0%, #c82333 100%)'}; 
                                        padding: 20px 40px; border-radius: 15px;
                                        box-shadow: 0 6px 20px rgba(0,0,0,0.4);
                                        border: 2px solid ${hayQuorum ? '#1e7e34' : '#bd2130'};">
                                <h2 style="color: white; margin: 0; display: flex; align-items: center; gap: 15px; font-size: 2em;">
                                    <i class="fas ${hayQuorum ? 'fa-check-circle' : 'fa-times-circle'}" style="color: white; font-size: 1em;"></i>
                                    ${hayQuorum ? 
                                        `HAY QU√ìRUM` : 
                                        `NO HAY QU√ìRUM`
                                    }
                                </h2>
                                <p style="color: white; margin: 10px 0 0 0; opacity: 0.95; font-size: 1.1em; text-align: center;">
                                    <strong>${presentes}</strong> de 20 diputados ‚Ä¢ M√≠nimo requerido: <strong>${quorumMinimo}</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Mantener el indicador de qu√≥rum en la parte inferior actualizado
            actualizarEstadisticas();
            
            // Agregar temporizador para regresar a la lista despu√©s de 5 segundos (temporal para pruebas)
            console.log('‚è∞ Iniciando temporizador de 5 segundos para retorno autom√°tico...');
            const timerReturn = setTimeout(() => {
                console.log('‚è±Ô∏è Tiempo cumplido - Regresando a la lista de asistencia...');
                
                try {
                    // Verificar que tengamos los datos necesarios
                    if (!diputadosData || diputadosData.length === 0) {
                        diputadosData = DIPUTADOS_DEFAULT;
                        console.log('Restaurando datos de diputados por defecto');
                    }
                    
                    // Renderizar la lista de diputados directamente
                    const deputiesContainer = document.getElementById('deputiesContent');
                    if (deputiesContainer) {
                        deputiesContainer.innerHTML = renderAttendanceColumns(diputadosData);
                        console.log('‚úÖ Lista de diputados renderizada correctamente');
                        console.log('üìã Estados de asistencia preservados:', Object.keys(asistenciaData).length);
                        
                        // Actualizar estad√≠sticas tambi√©n
                        actualizarEstadisticas();
                    } else {
                        console.error('‚ùå No se encontr√≥ el contenedor deputiesContent');
                    }
                } catch (error) {
                    console.error('‚ùå Error al regresar a la lista:', error);
                    // Como fallback, recargar la p√°gina
                    location.reload();
                }
            }, 5000); // 5000 ms = 5 segundos (TEMPORAL PARA PRUEBAS - cambiar a 60000 para producci√≥n)
            
            // Guardar referencia del timer por si necesitamos cancelarlo
            window.currentReturnTimer = timerReturn;
        }
    </script>
</body>
</html>